<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>AI 챗봇 - 피닉스치과</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="css/chatbot.css" />
</head>
<body>
  <div id="chatbot-root"></div>
  <button id="adminLoginBtn" style="position:fixed;top:20px;right:20px;z-index:2000;padding:10px 18px;font-size:15px;border-radius:8px;background:#4facfe;color:#fff;border:none;cursor:pointer;">👤 관리자 로그인</button>
  <div id="adminPanel" style="display:none;position:fixed;top:60px;right:20px;z-index:2100;width:370px;background:#fff;border-radius:12px;box-shadow:0 4px 24px rgba(0,0,0,0.15);padding:24px 20px;max-height:90vh;overflow-y:auto;">
    <div style="font-weight:bold;font-size:18px;margin-bottom:12px;">AI챗봇 관리자 설정</div>
    <div id="adminPanelContent"></div>
    <button onclick="document.getElementById('adminPanel').style.display='none'" style="margin-top:18px;width:100%;padding:10px 0;border:none;background:#eee;border-radius:8px;cursor:pointer;">닫기</button>
  </div>
  <script src="js/ai-core.js"></script>
  <script src="js/chatbot.js"></script>
  <script>
    // 관리자 로그인/설정 UI
    const adminBtn = document.getElementById('adminLoginBtn');
    const adminPanel = document.getElementById('adminPanel');
    const adminPanelContent = document.getElementById('adminPanelContent');
    let adminLoggedIn = false;
    
    adminBtn.onclick = function() {
      if (!adminLoggedIn) {
        const id = prompt('관리자 아이디를 입력하세요:');
        const pw = prompt('비밀번호를 입력하세요:');
        if (window.AICore && window.AICore.adminLogin(id, pw)) {
          adminLoggedIn = true;
          showAdminPanel();
          adminPanel.style.display = 'block';
        } else {
          alert('로그인 실패!');
        }
      } else {
        showAdminPanel();
        adminPanel.style.display = 'block';
      }
    };
    
    function showAdminPanel() {
      adminPanelContent.innerHTML = `
        <div style='margin-bottom:18px;'>
          <label style='font-weight:bold;'>ChatGPT API Key<br><input type='password' id='adminChatgptKey' style='width:100%;margin-top:4px;'></label>
          <label style='font-weight:bold;display:block;margin-top:8px;'>ChatGPT 모델
            <select id='adminChatgptModel' style='width:100%;margin-top:4px;'>
              <option value=''>-- ChatGPT 모델 선택 --</option>
              <option value='gpt-4o'>GPT-4o (최신)</option>
              <option value='gpt-4o-mini'>GPT-4o Mini</option>
            </select>
          </label>
        </div>
        <div style='margin-bottom:18px;'>
          <label style='font-weight:bold;'>Gemini API Key<br><input type='password' id='adminGeminiKey' style='width:100%;margin-top:4px;'></label>
          <label style='font-weight:bold;display:block;margin-top:8px;'>Gemini 모델
            <select id='adminGeminiModel' style='width:100%;margin-top:4px;'>
              <option value=''>-- Gemini 모델 선택 --</option>
              <option value='gemini-1.5-flash'>Gemini 1.5 Flash</option>
              <option value='gemini-1.5-pro'>Gemini 1.5 Pro</option>
            </select>
          </label>
        </div>
        <div style='margin-bottom:18px;'>
          <label style='font-weight:bold;'>Claude API Key<br><input type='password' id='adminClaudeKey' style='width:100%;margin-top:4px;'></label>
          <label style='font-weight:bold;display:block;margin-top:8px;'>Claude 모델
            <select id='adminClaudeModel' style='width:100%;margin-top:4px;'>
              <option value=''>-- Claude 모델 선택 --</option>
              <option value='claude-3-haiku'>Claude 3 Haiku</option>
              <option value='claude-3-sonnet'>Claude 3 Sonnet</option>
            </select>
          </label>
        </div>
        <div style='margin-bottom:18px;'>
          <label style='font-weight:bold;'>지식 파일 업로드<br><input type='file' id='adminKnowledgeFile' accept='.txt' multiple></label>
          <div id='knowledgeFileList' style='margin-top:8px;'></div>
          <button onclick='clearKnowledgeFiles()' style='margin-top:8px;width:100%;padding:7px 0;background:#eee;color:#333;border:none;border-radius:7px;cursor:pointer;'>🗑️ 모든 지식 삭제</button>
        </div>
        <div style='margin-bottom:18px;'>
          <button onclick='saveAdminSettings()' style='width:49%;padding:10px 0;background:#4facfe;color:#fff;border:none;border-radius:8px;font-weight:bold;cursor:pointer;'>설정 저장</button>
          <button onclick='testAdminSettings()' style='width:49%;padding:10px 0;background:#28a745;color:#fff;border:none;border-radius:8px;font-weight:bold;cursor:pointer;float:right;'>연결 테스트</button>
        </div>
        <div id='adminStatus' style='margin-top:10px;font-size:13px;color:#333;'></div>
      `;
      
      // 값 설정
      if (window.AICore) {
        document.getElementById('adminChatgptKey').value = window.AICore.apiSettings.chatgpt.apiKey || '';
        document.getElementById('adminChatgptModel').value = window.AICore.apiSettings.chatgpt.model || '';
        document.getElementById('adminGeminiKey').value = window.AICore.apiSettings.gemini.apiKey || '';
        document.getElementById('adminGeminiModel').value = window.AICore.apiSettings.gemini.model || '';
        document.getElementById('adminClaudeKey').value = window.AICore.apiSettings.claude.apiKey || '';
        document.getElementById('adminClaudeModel').value = window.AICore.apiSettings.claude.model || '';
      }
      
      // 파일 업로드
      document.getElementById('adminKnowledgeFile').onchange = function(e) {
        const files = e.target.files;
        for (let i=0; i<files.length; i++) {
          const reader = new FileReader();
          reader.onload = function(ev) {
            const fileObj = {name:files[i].name, content:ev.target.result};
            if (window.AICore) {
              window.AICore.knowledgeBase.files.push(fileObj);
              const parsed = window.AICore.parseKnowledgeFile(fileObj);
              parsed.forEach(qa=>window.AICore.knowledgeBase.parsedData.push(qa));
              window.AICore.knowledgeBase.enabled = true;
              updateKnowledgeFileList();
              document.getElementById('adminStatus').innerText = `지식 파일 업로드 완료 (Q&A ${window.AICore.knowledgeBase.parsedData.length}개)`;
            }
          };
          reader.readAsText(files[i]);
        }
      };
      updateKnowledgeFileList();
    }
    
    window.saveAdminSettings = function() {
      if (window.AICore) {
        window.AICore.apiSettings.chatgpt.apiKey = document.getElementById('adminChatgptKey').value;
        window.AICore.apiSettings.chatgpt.model = document.getElementById('adminChatgptModel').value;
        window.AICore.apiSettings.chatgpt.enabled = !!(window.AICore.apiSettings.chatgpt.apiKey && window.AICore.apiSettings.chatgpt.model);
        
        window.AICore.apiSettings.gemini.apiKey = document.getElementById('adminGeminiKey').value;
        window.AICore.apiSettings.gemini.model = document.getElementById('adminGeminiModel').value;
        window.AICore.apiSettings.gemini.enabled = !!(window.AICore.apiSettings.gemini.apiKey && window.AICore.apiSettings.gemini.model);
        
        window.AICore.apiSettings.claude.apiKey = document.getElementById('adminClaudeKey').value;
        window.AICore.apiSettings.claude.model = document.getElementById('adminClaudeModel').value;
        window.AICore.apiSettings.claude.enabled = !!(window.AICore.apiSettings.claude.apiKey && window.AICore.apiSettings.claude.model);
        
        // 활성 프로바이더 설정
        if (window.AICore.apiSettings.chatgpt.enabled) {
          window.AICore.apiSettings.activeProvider = 'chatgpt';
        } else if (window.AICore.apiSettings.gemini.enabled) {
          window.AICore.apiSettings.activeProvider = 'gemini';
        } else if (window.AICore.apiSettings.claude.enabled) {
          window.AICore.apiSettings.activeProvider = 'claude';
        }
        
        document.getElementById('adminStatus').innerText = '설정이 저장되었습니다!';
      }
    };
    
    window.testAdminSettings = function() {
      document.getElementById('adminStatus').innerText = '연결 테스트(모의) 완료!';
    };
    
    window.clearKnowledgeFiles = function() {
      if (window.AICore) {
        window.AICore.knowledgeBase.files = [];
        window.AICore.knowledgeBase.parsedData = [];
        window.AICore.knowledgeBase.enabled = false;
        updateKnowledgeFileList();
        document.getElementById('adminStatus').innerText = '모든 지식 파일이 삭제되었습니다!';
      }
    };
    
    function updateKnowledgeFileList() {
      if (!window.AICore) return;
      
      const list = window.AICore.knowledgeBase.files;
      let html = '';
      if (list.length===0) {
        html = '<div style="color:#888;font-size:13px;">업로드된 파일 없음</div>';
      } else {
        list.forEach((f,i)=>{
          const qaCount = window.AICore.parseKnowledgeFile(f).length;
          html += `<div style='background:#f8f9fa;padding:7px 10px;border-radius:7px;margin-bottom:4px;display:flex;justify-content:space-between;align-items:center;'><span>📄 ${f.name} <span style='color:#888;font-size:12px;'>(Q&A ${qaCount}개)</span></span><button onclick='removeKnowledgeFile(${i})' style='background:#eee;border:none;border-radius:5px;padding:2px 8px;cursor:pointer;'>삭제</button></div>`;
        });
      }
      document.getElementById('knowledgeFileList').innerHTML = html;
    }
    
    window.removeKnowledgeFile = function(idx) {
      if (window.AICore) {
        const file = window.AICore.knowledgeBase.files[idx];
        const parsed = window.AICore.parseKnowledgeFile(file);
        window.AICore.knowledgeBase.files.splice(idx,1);
        window.AICore.knowledgeBase.parsedData = window.AICore.knowledgeBase.parsedData.filter(qa=>qa.source!==file.name);
        if (window.AICore.knowledgeBase.files.length===0) window.AICore.knowledgeBase.enabled = false;
        updateKnowledgeFileList();
      }
    };
  </script>
</body>
</html> 