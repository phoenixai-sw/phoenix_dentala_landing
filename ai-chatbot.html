<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>AI 챗봇 - 피닉스치과</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="css/chatbot.css" />
</head>
<body>
  <div id="chatbot-root"></div>
  <button id="adminLoginBtn" style="position:fixed;top:20px;right:20px;z-index:2000;padding:10px 18px;font-size:15px;border-radius:8px;background:#4facfe;color:#fff;border:none;cursor:pointer;">👤 관리자 로그인</button>
  <div id="adminPanel" style="display:none;position:fixed;top:60px;right:20px;z-index:2100;width:370px;background:#fff;border-radius:12px;box-shadow:0 4px 24px rgba(0,0,0,0.15);padding:24px 20px;max-height:90vh;overflow-y:auto;">
    <div style="font-weight:bold;font-size:18px;margin-bottom:12px;">AI챗봇 관리자 설정</div>
    <div id="adminPanelContent"></div>
    <button onclick="document.getElementById('adminPanel').style.display='none'" style="margin-top:18px;width:100%;padding:10px 0;border:none;background:#eee;border-radius:8px;cursor:pointer;">닫기</button>
  </div>
  <script src="js/ai-core.js"></script>
  <script src="js/chatbot.js"></script>
  <script>
    // 관리자 로그인/설정 UI 로직 (고도화)
    const adminBtn = document.getElementById('adminLoginBtn');
    const adminPanel = document.getElementById('adminPanel');
    const adminPanelContent = document.getElementById('adminPanelContent');
    let adminLoggedIn = false;
    adminBtn.onclick = function() {
      if (!adminLoggedIn) {
        const id = prompt('관리자 아이디를 입력하세요:');
        const pw = prompt('비밀번호를 입력하세요:');
        if (window.AICore.adminLogin(id, pw)) {
          adminLoggedIn = true;
          showAdminPanel();
          adminPanel.style.display = 'block';
        } else {
          alert('로그인 실패!');
        }
      } else {
        showAdminPanel();
        adminPanel.style.display = 'block';
      }
    };
    function showAdminPanel() {
      adminPanelContent.innerHTML = `
        <div style='margin-bottom:18px;'>
          <label style='font-weight:bold;'>ChatGPT API Key<br><input type='password' id='adminChatgptKey' style='width:100%;margin-top:4px;'></label>
          <label style='font-weight:bold;display:block;margin-top:8px;'>ChatGPT 모델
            <select id='adminChatgptModel' style='width:100%;margin-top:4px;'>
              <option value=''>-- ChatGPT 모델 선택 --</option>
              <option value='gpt-4o'>GPT-4o (최신)</option>
              <option value='gpt-4o-mini'>GPT-4o Mini</option>
              <option value='finetuning'>Finetuning Model</option>
            </select>
          </label>
          <input type='text' id='adminChatgptFinetune' style='width:100%;margin-top:4px;display:none;' placeholder='Finetuning 모델명 입력'>
        </div>
        <div style='margin-bottom:18px;'>
          <label style='font-weight:bold;'>Gemini API Key<br><input type='password' id='adminGeminiKey' style='width:100%;margin-top:4px;'></label>
          <label style='font-weight:bold;display:block;margin-top:8px;'>Gemini 모델
            <select id='adminGeminiModel' style='width:100%;margin-top:4px;'>
              <option value=''>-- Gemini 모델 선택 --</option>
              <option value='gemini-1.5-flash'>Gemini 1.5 Flash</option>
              <option value='gemini-1.5-pro'>Gemini 1.5 Pro</option>
              <option value='gemini-1.0-pro'>Gemini 1.0 Pro</option>
            </select>
          </label>
        </div>
        <div style='margin-bottom:18px;'>
          <label style='font-weight:bold;'>Claude API Key<br><input type='password' id='adminClaudeKey' style='width:100%;margin-top:4px;'></label>
          <label style='font-weight:bold;display:block;margin-top:8px;'>Claude 모델
            <select id='adminClaudeModel' style='width:100%;margin-top:4px;'>
              <option value=''>-- Claude 모델 선택 --</option>
              <option value='claude-3-haiku'>Claude 3 Haiku</option>
              <option value='claude-3-sonnet'>Claude 3 Sonnet</option>
              <option value='claude-3-opus'>Claude 3 Opus</option>
              <option value='claude-3-5-sonnet'>Claude 3.5 Sonnet</option>
            </select>
          </label>
        </div>
        <div style='margin-bottom:18px;'>
          <label style='font-weight:bold;'>지식 파일 업로드<br><input type='file' id='adminKnowledgeFile' accept='.txt' multiple></label>
          <div id='knowledgeFileList' style='margin-top:8px;'></div>
          <button onclick='clearKnowledgeFiles()' style='margin-top:8px;width:100%;padding:7px 0;background:#eee;color:#333;border:none;border-radius:7px;cursor:pointer;'>🗑️ 모든 지식 삭제</button>
        </div>
        <div style='margin-bottom:18px;'>
          <button onclick='saveAdminSettings()' style='width:49%;padding:10px 0;background:#4facfe;color:#fff;border:none;border-radius:8px;font-weight:bold;cursor:pointer;'>설정 저장</button>
          <button onclick='testAdminSettings()' style='width:49%;padding:10px 0;background:#28a745;color:#fff;border:none;border-radius:8px;font-weight:bold;cursor:pointer;float:right;'>연결 테스트</button>
        </div>
        <div id='adminStatus' style='margin-top:10px;font-size:13px;color:#333;'></div>
        <div id='parsedQAView' style='display:none;margin-top:16px;background:#f8f9fa;border-radius:8px;padding:12px;max-height:180px;overflow-y:auto;'></div>
        <button onclick='toggleParsedQAView()' style='margin-top:8px;width:100%;padding:7px 0;background:#f0f8ff;color:#4facfe;border:1px solid #4facfe;border-radius:7px;cursor:pointer;'>📋 파싱된 Q&A 보기</button>
      `;
      // 값 세팅
      document.getElementById('adminChatgptKey').value = window.AICore.apiSettings.chatgpt.apiKey;
      document.getElementById('adminChatgptModel').value = window.AICore.apiSettings.chatgpt.model;
      document.getElementById('adminGeminiKey').value = window.AICore.apiSettings.gemini.apiKey;
      document.getElementById('adminGeminiModel').value = window.AICore.apiSettings.gemini.model;
      document.getElementById('adminClaudeKey').value = window.AICore.apiSettings.claude.apiKey;
      document.getElementById('adminClaudeModel').value = window.AICore.apiSettings.claude.model;
      // Finetuning 입력란 표시
      document.getElementById('adminChatgptModel').onchange = function() {
        document.getElementById('adminChatgptFinetune').style.display = (this.value==='finetuning')?'block':'none';
      };
      // 파일 업로드
      document.getElementById('adminKnowledgeFile').onchange = function(e) {
        const files = e.target.files;
        for (let i=0; i<files.length; i++) {
          const reader = new FileReader();
          reader.onload = function(ev) {
            const fileObj = {name:files[i].name, content:ev.target.result};
            window.AICore.knowledgeBase.files.push(fileObj);
            const parsed = window.AICore.parseKnowledgeFile(fileObj);
            parsed.forEach(qa=>window.AICore.knowledgeBase.parsedData.push(qa));
            window.AICore.knowledgeBase.enabled = true;
            updateKnowledgeFileList();
            document.getElementById('adminStatus').innerText = `지식 파일 업로드 완료 (Q&A ${window.AICore.knowledgeBase.parsedData.length}개)`;
          };
          reader.readAsText(files[i]);
        }
      };
      updateKnowledgeFileList();
    }
    window.saveAdminSettings = function() {
      window.AICore.apiSettings.chatgpt.apiKey = document.getElementById('adminChatgptKey').value;
      let chatgptModel = document.getElementById('adminChatgptModel').value;
      if (chatgptModel==='finetuning') chatgptModel = document.getElementById('adminChatgptFinetune').value;
      window.AICore.apiSettings.chatgpt.model = chatgptModel;
      window.AICore.apiSettings.chatgpt.enabled = !!(window.AICore.apiSettings.chatgpt.apiKey && chatgptModel);
      window.AICore.apiSettings.gemini.apiKey = document.getElementById('adminGeminiKey').value;
      window.AICore.apiSettings.gemini.model = document.getElementById('adminGeminiModel').value;
      window.AICore.apiSettings.gemini.enabled = !!(window.AICore.apiSettings.gemini.apiKey && window.AICore.apiSettings.gemini.model);
      window.AICore.apiSettings.claude.apiKey = document.getElementById('adminClaudeKey').value;
      window.AICore.apiSettings.claude.model = document.getElementById('adminClaudeModel').value;
      window.AICore.apiSettings.claude.enabled = !!(window.AICore.apiSettings.claude.apiKey && window.AICore.apiSettings.claude.model);
      document.getElementById('adminStatus').innerText = '설정이 저장되었습니다!';
    };
    window.testAdminSettings = function() {
      document.getElementById('adminStatus').innerText = '연결 테스트(모의) 완료!';
    };
    window.clearKnowledgeFiles = function() {
      window.AICore.knowledgeBase.files = [];
      window.AICore.knowledgeBase.parsedData = [];
      window.AICore.knowledgeBase.enabled = false;
      updateKnowledgeFileList();
      document.getElementById('adminStatus').innerText = '모든 지식 파일이 삭제되었습니다!';
    };
    function updateKnowledgeFileList() {
      const list = window.AICore.knowledgeBase.files;
      let html = '';
      if (list.length===0) html = '<div style="color:#888;font-size:13px;">업로드된 파일 없음</div>';
      else list.forEach((f,i)=>{
        const qaCount = window.AICore.parseKnowledgeFile(f).length;
        html += `<div style='background:#f8f9fa;padding:7px 10px;border-radius:7px;margin-bottom:4px;display:flex;justify-content:space-between;align-items:center;'><span>📄 ${f.name} <span style='color:#888;font-size:12px;'>(Q&A ${qaCount}개)</span></span><button onclick='removeKnowledgeFile(${i})' style='background:#eee;border:none;border-radius:5px;padding:2px 8px;cursor:pointer;'>삭제</button></div>`;
      });
      document.getElementById('knowledgeFileList').innerHTML = html;
    }
    window.removeKnowledgeFile = function(idx) {
      // 파일 삭제 시 해당 파일의 Q&A도 같이 삭제
      const file = window.AICore.knowledgeBase.files[idx];
      const parsed = window.AICore.parseKnowledgeFile(file);
      window.AICore.knowledgeBase.files.splice(idx,1);
      // parsedData에서 해당 파일 Q&A만 제거
      window.AICore.knowledgeBase.parsedData = window.AICore.knowledgeBase.parsedData.filter(qa=>qa.source!==file.name);
      if (window.AICore.knowledgeBase.files.length===0) window.AICore.knowledgeBase.enabled = false;
      updateKnowledgeFileList();
    };
    window.toggleParsedQAView = function() {
      const view = document.getElementById('parsedQAView');
      if (view.style.display==='none') {
        let html = '';
        if (window.AICore.knowledgeBase.parsedData.length===0) html = '<div style="color:#888;font-size:13px;">파싱된 Q&A 없음</div>';
        else window.AICore.knowledgeBase.parsedData.forEach((qa,i)=>{
          html += `<div style='margin-bottom:8px;'><b>Q${i+1}:</b> ${qa.question}<br><b>A:</b> ${qa.answer.length>100?qa.answer.substring(0,100)+'...':qa.answer}<span style='color:#aaa;font-size:11px;'> [${qa.source}]</span></div>`;
        });
        view.innerHTML = html;
        view.style.display = 'block';
      } else {
        view.style.display = 'none';
      }
    };
  </script>
</body>
</html> 