<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>피닉스 치과 병원</title>
    
    <!-- 카카오톡 인앱 브라우저 캐시 방지 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="format-detection" content="telephone=no">
    <meta name="format-detection" content="address=no">
    <meta name="format-detection" content="email=no">
    
    <!-- SheetJS 라이브러리 추가 (엑셀 파일 생성용) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f8f9fa;
            -webkit-text-size-adjust: 100%;
            -webkit-touch-callout: none;
        }

        /* 배너 스타일 */
        .top-banner, .bottom-banner {
            position: fixed;
            left: 0;
            right: 0;
            background: #ffd700;
            color: #333;
            padding: 15px 20px;
            text-align: center;
            z-index: 1000;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-weight: bold;
            font-size: 18px;
        }

        .top-banner {
            top: 0;
            animation: pulse 2s infinite;
        }

        .bottom-banner {
            bottom: 0;
        }

        .top-banner:hover, .bottom-banner:hover {
            background: #ffed4e;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        /* 메인 컨텐츠 */
        .container {
            max-width: 800px;
            margin: 70px auto 80px;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 40px 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: white;
        }

        .hospital-name {
            font-size: 28px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #7f8c8d;
            font-size: 16px;
        }

        .hospital-description {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            text-align: left;
        }

        .hospital-description p {
            margin: 8px 0;
            font-size: 14px;
            line-height: 1.5;
        }

        .info-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .info-title {
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .info-title::before {
            content: "📋";
            margin-right: 10px;
        }

        .info-item {
            margin-bottom: 10px;
            padding: 10px 0;
            border-bottom: 1px solid #ecf0f1;
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .time-info {
            color: #27ae60;
            font-weight: bold;
        }

        .location-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            align-items: start;
        }

        .address-text p {
            margin: 10px 0;
            font-size: 14px;
        }

        .map-container {
            min-height: 200px;
        }

        .services {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .service-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s;
            cursor: pointer;
        }

        .service-item:hover {
            border-color: #4facfe;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
        }

        .service-icon {
            font-size: 30px;
            margin-bottom: 10px;
        }

        .contact-info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: black;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
        }

        .phone {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .address {
            opacity: 0.9;
        }

        /* 로그인 버튼 */
        .admin-buttons {
            text-align: center;
            margin-top: 30px;
        }

        .admin-btn {
            background: #4facfe;
            color: white;
            border: none;
            padding: 12px 20px;
            margin: 5px 10px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .admin-btn:hover {
            background: #3d8bfe;
            transform: translateY(-2px);
        }

        .admin-btn.customer {
            background: #ff69b4;
            color: black;
        }

        .admin-btn.customer:hover {
            background: #ff1493;
            color: black;
        }

        .admin-btn.chatbot {
            background: #90EE90;
            color: black;
        }

        .admin-btn.chatbot:hover {
            background: #32CD32;
            color: black;
        }

        /* 무료 검진 확인 버튼 */
        .dental-checkup-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
            color: white;
            border: none;
            padding: 18px 36px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .dental-checkup-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(255, 107, 107, 0.4);
            background: linear-gradient(135deg, #ff5252 0%, #fdd835 100%);
        }

        .dental-checkup-btn:active {
            transform: translateY(-1px);
        }

        /* 팝업 페이지 공통 스타일 */
        .popup-page {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 2000;
            overflow-y: auto;
        }

        .popup-header {
            background: white;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .popup-content {
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }

        /* 관리자 페이지 스타일 */
        .admin-header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-title {
            font-size: 24px;
            font-weight: bold;
        }

        .admin-nav {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .nav-btn:hover {
            background: #2980b9;
        }

        .nav-btn.logout {
            background: #e74c3c;
        }

        .nav-btn.logout:hover {
            background: #c0392b;
        }

        .admin-content {
            padding: 30px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .admin-section {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-header h3 {
            margin: 0;
            color: #2c3e50;
            font-size: 20px;
        }

        /* API 설정 스타일 */
        .api-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4facfe;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }

        .btn-primary {
            background: #4facfe;
            color: white;
        }

        .btn-primary:hover {
            background: #3d8bfe;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-warning.message-send {
            background: #ff69b4;
            border-color: #ff69b4;
            color: white;
        }

        .btn-warning.message-send:hover {
            background: #ff1493;
            border-color: #ff1493;
        }

        /* 로딩 모달 스타일 */
        .loading-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
        }

        .loading-content h3 {
            margin: 0 0 20px 0;
            color: #2c3e50;
            font-size: 24px;
        }

        .loading-progress {
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #f0f0f0;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #4facfe, #00f2fe);
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 14px;
            color: #666;
            font-weight: bold;
        }

        .loading-spinner {
            font-size: 32px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 결과 모달 스타일 */
        .result-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .result-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .result-content h3 {
            margin: 0 0 20px 0;
            color: #2c3e50;
            font-size: 24px;
            text-align: center;
        }

        .result-summary {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .success-count {
            color: #28a745;
            font-weight: bold;
            font-size: 16px;
        }

        .fail-count {
            color: #dc3545;
            font-weight: bold;
            font-size: 16px;
        }

        .result-section {
            margin-bottom: 20px;
        }

        .result-section h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 18px;
        }

        .result-list {
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
        }

        .result-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            flex-direction: column;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-item.success {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }

        .result-item.fail {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
        }

        .result-item strong {
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .result-item small {
            color: #666;
            font-size: 12px;
        }

        /* 발송 결과 추가 스타일 */
        .send-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #4facfe;
        }

        .info-item {
            margin-bottom: 8px;
            font-size: 14px;
            color: #2c3e50;
        }

        .info-item:last-child {
            margin-bottom: 0;
        }

        .cost-info {
            color: #e67e22;
            font-weight: bold;
            font-size: 16px;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .phone {
            color: #666;
            font-size: 13px;
            font-family: monospace;
        }

        .result-details {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 10px;
        }

        .message-preview {
            margin-top: 10px;
        }

        .message-preview details {
            cursor: pointer;
        }

        .message-preview summary {
            color: #4facfe;
            font-size: 13px;
            margin-bottom: 8px;
        }

        .message-content {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            line-height: 1.4;
            white-space: pre-line;
            border-left: 3px solid #4facfe;
            margin-top: 5px;
        }

        .result-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .result-actions .btn {
            padding: 12px 20px;
            font-size: 14px;
        }

        .status-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
            display: none;
            white-space: pre-line;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* 파일 업로드 스타일 */
        .upload-area {
            border: 2px dashed #4facfe;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: #3d8bfe;
            background: #f0f8ff;
        }

        .upload-area.dragover {
            border-color: #28a745;
            background: #f8fff8;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 48px;
            color: #4facfe;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 16px;
            color: #666;
            margin-bottom: 10px;
        }

        .upload-types {
            font-size: 12px;
            color: #999;
        }

        .file-input {
            display: none;
        }

        .file-list {
            margin-top: 20px;
        }

        .file-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .file-details {
            font-size: 12px;
            color: #666;
        }

        .file-actions {
            display: flex;
            gap: 10px;
        }

        .file-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        /* 통계 카드 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #333;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        /* 테이블 스타일 */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #2c3e50;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }



        .reservation-link-btn {
            background: #ffd700;
            color: #333;
            border: none;
            border-radius: 20px;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            display: inline-block;
            transition: all 0.2s;
        }

        .reservation-link-btn:hover {
            background: #ffed4e;
            transform: translateY(-1px);
        }

        /* 예약 페이지 스타일 */
        .reservation-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* 캘린더 스타일 */
        .calendar-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 10px;
        }

        .calendar-title {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }

        .calendar-nav {
            background: none;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            color: #666;
        }

        .calendar-nav:hover {
            background: #f8f9fa;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0;
        }

        .calendar-day-header {
            text-align: center;
            padding: 10px 0;
            font-size: 14px;
            color: #666;
            font-weight: bold;
        }

        .calendar-day-header:first-child {
            color: #e74c3c;
        }

        .calendar-day-header:last-child {
            color: #3498db;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #eee;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .calendar-day:hover:not(.disabled):not(.selected) {
            background: #f8f9fa;
        }

        .calendar-day.disabled {
            color: #ccc;
            cursor: not-allowed;
        }

        .calendar-day.selected {
            background: #4facfe;
            color: white;
            font-weight: bold;
        }

        .calendar-day.sunday {
            color: #e74c3c;
        }

        .calendar-day.saturday {
            color: #3498db;
        }

        /* 시간 선택 스타일 */
        .time-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .time-header {
            font-size: 16px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .time-header::before {
            content: "🕐";
            margin-right: 8px;
        }

        .time-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .time-slot {
            padding: 12px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .time-slot:hover:not(.disabled):not(.selected) {
            border-color: #4facfe;
            background: #f0f8ff;
        }

        .time-slot.selected {
            background: #4facfe;
            color: white;
            border-color: #4facfe;
        }

        .time-slot.disabled {
            background: #f8f9fa;
            color: #ccc;
            cursor: not-allowed;
        }

        /* 예약자 정보 스타일 */
        .info-form-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .form-header {
            font-size: 16px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }

        .form-header::before {
            content: "👤";
            margin-right: 8px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }

        .form-label .required {
            color: #e74c3c;
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #4facfe;
        }

        .form-input::placeholder {
            color: #999;
        }

        /* 예약하기 버튼 */
        .reservation-submit {
            width: 100%;
            padding: 15px;
            background: #00aa82;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .reservation-submit:hover {
            background: #008866;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 170, 130, 0.3);
        }

        .reservation-submit:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* 예약 확인 팝업 */
        .confirmation-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }

        .confirmation-content {
            background: white;
            border-radius: 20px;
            padding: 32px 40px;
            max-width: 450px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .confirmation-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .confirmation-title {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .confirmation-message {
            font-size: 16px;
            line-height: 1.6;
            color: #666;
            margin-bottom: 30px;
        }

        .confirmation-details {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            text-align: left;
            margin-bottom: 30px;
        }

        .confirmation-details p {
            margin: 8px 0;
            font-size: 14px;
            color: #333;
        }

        .confirmation-details strong {
            color: #2c3e50;
        }

        .confirmation-note {
            font-size: 14px;
            color: #666;
            line-height: 1.5;
            margin-bottom: 30px;
            padding: 15px;
            background: #fffbeb;
            border-radius: 8px;
        }

        .confirmation-button {
            padding: 15px 40px;
            background: #00aa82;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .confirmation-button:hover {
            background: #008866;
            transform: translateY(-2px);
        }

        /* 메시지 발송 팝업 */
        .message-sending-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }

        .message-popup-content {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .message-popup-header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .message-popup-title {
            font-size: 20px;
            font-weight: bold;
        }

        .message-popup-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .message-popup-close:hover {
            opacity: 0.7;
        }

        .message-popup-body {
            padding: 30px;
        }

        .message-target-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            text-align: center;
        }

        .message-target-count {
            font-size: 24px;
            font-weight: bold;
            color: #4facfe;
            margin-bottom: 8px;
        }

        .message-target-desc {
            color: #666;
            font-size: 14px;
        }

        /* 탭 스타일 */
        .message-tabs {
            display: flex;
            margin-bottom: 25px;
            border-bottom: 2px solid #f0f0f0;
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab-button.active {
            color: #4facfe;
            border-bottom-color: #4facfe;
        }

        .tab-button:hover {
            color: #4facfe;
            background: #f8f9fa;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* 파일 업로드 스타일 */
        .file-upload-section {
            background: #f8f9fa;
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin-bottom: 25px;
            transition: all 0.3s;
        }

        .file-upload-section:hover {
            border-color: #4facfe;
            background: #f0f8ff;
        }

        .file-upload-icon {
            font-size: 48px;
            color: #4facfe;
            margin-bottom: 15px;
        }

        .file-upload-text {
            font-size: 16px;
            color: #333;
            margin-bottom: 10px;
        }

        .file-upload-desc {
            font-size: 14px;
            color: #666;
            margin-bottom: 20px;
        }

        .file-upload-btn {
            background: #4facfe;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload-btn:hover {
            background: #3d8bfe;
        }

        .file-upload-input {
            display: none;
        }

        .file-selected {
            margin-top: 15px;
            padding: 10px;
            background: #e8f5e8;
            border-radius: 8px;
            color: #2d8f44;
            font-weight: bold;
            border: 1px solid #c3e6cb;
        }

        /* 발송 버튼 */
        .send-message-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }

        .send-message-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
        }

        .send-message-btn.kakao {
            background: linear-gradient(135deg, #fee500 0%, #ffd500 100%);
            color: #333;
        }

        .send-message-btn.kakao:hover {
            box-shadow: 0 8px 25px rgba(254, 229, 0, 0.4);
        }

        /* 모바일 안정성 강화 */
        * {
            -webkit-tap-highlight-color: transparent;
        }

        input, textarea, select, button {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        /* 고정 팝업 AI챗봇 배너 */
        .chatbot-fixed-banner {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50px;
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            z-index: 1000;
            animation: chatbotFloat 3s ease-in-out infinite;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            display: block;
            opacity: 1;
        }

        .chatbot-fixed-banner:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.6);
        }

        .chatbot-fixed-content {
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
        }

        .chatbot-fixed-icon {
            font-size: 24px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            animation: chatbotIconPulse 2s ease-in-out infinite;
        }

        .chatbot-fixed-text {
            display: flex;
            flex-direction: column;
        }

        .chatbot-fixed-title {
            font-size: 14px;
            font-weight: bold;
            line-height: 1.2;
        }

        .chatbot-fixed-desc {
            font-size: 11px;
            opacity: 0.9;
            line-height: 1.2;
        }

        .chatbot-fixed-pulse {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 10px;
            height: 10px;
            background: #4CAF50;
            border-radius: 50%;
            animation: chatbotPulse 2s ease-in-out infinite;
        }

        /* 애니메이션 */
        @keyframes chatbotFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }

        @keyframes chatbotIconPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes chatbotPulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.5);
                opacity: 0.7;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .container {
                margin: 60px 10px 70px;
                padding: 10px;
            }
            
            .hospital-name {
                font-size: 24px;
            }
            
            .services {
                grid-template-columns: repeat(2, 1fr);
            }

            .location-info {
                grid-template-columns: 1fr;
            }
            
            .admin-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .admin-btn {
                width: 200px;
                margin: 5px 0;
            }

            .section-header > div {
                flex-direction: column;
                gap: 10px;
            }

            .section-header .btn {
                width: 100%;
                text-align: center;
            }



            .message-popup-content {
                width: 95%;
                max-height: 85vh;
            }

            .message-popup-header {
                padding: 15px 20px;
            }

            .message-popup-title {
                font-size: 18px;
            }

            .message-popup-body {
                padding: 20px;
            }

            .message-tabs {
                flex-direction: column;
            }

            .tab-button {
                padding: 12px 15px;
                font-size: 15px;
            }

            .file-upload-section {
                padding: 20px;
            }

            .file-upload-icon {
                font-size: 36px;
            }

            .send-message-btn {
                padding: 15px;
                font-size: 16px;
            }

            /* 고정 챗봇 배너 모바일 최적화 */
            .chatbot-fixed-banner {
                bottom: 15px;
                right: 15px;
                padding: 12px 16px;
            }

            .chatbot-fixed-icon {
                font-size: 20px;
                width: 35px;
                height: 35px;
            }

            .chatbot-fixed-title {
                font-size: 12px;
            }

            .chatbot-fixed-desc {
                font-size: 10px;
            }

            .chatbot-fixed-pulse {
                width: 8px;
                height: 8px;
                top: -3px;
                right: -3px;
                background: #4CAF50;
            }
        }
        

    </style>
</head>
<body>
    <!-- 상단 무료 검진 확인 배너 -->
    <div class="top-banner" onclick="location.href='dental_checkup.html'">
        🦷 무료 검진(구강) 확인
    </div>

    <!-- 메인 컨텐츠 -->
    <div class="container">
        <!-- 헤더 -->
        <div class="header">
            <div class="logo">🦷</div>
            <h1 class="hospital-name">피닉스 치과 병원</h1>
            <p class="subtitle">건강한 미소, 밝은 내일을 위한 치과</p>
            <div class="hospital-description">
                <p>🏆 <strong>25년 경력의 치주질환 전문 홍길동 원장님이 직접 진료합니다</strong></p>
                <p>✨ 최신 장비와 무균 시설로 안전하고 정확한 치료</p>
                <p>💝 환자 중심의 맞춤형 치료 계획 수립</p>
                <p>🎯 통증 없는 치료를 위한 디지털 마취 시스템</p>
                <p>📞 <strong>24시간 응급상담 가능 (070-1234-1234)</strong></p>
            </div>
        </div>

        <!-- 위치 안내 -->
        <div class="info-section">
            <h2 class="info-title">찾아오시는 길</h2>
            <div class="location-info">
                <div class="address-text">
                    <p><strong>📍 주소:</strong> 피닉스시 피닉스로 11길 11, 피닉스타워 11층 11호</p>
                    <p><strong>🚇 지하철:</strong> 2호선 강남역 3번 출구 도보 5분</p>
                    <p><strong>🚌 버스:</strong> 강남역 정류장 하차 후 도보 3분</p>
                    <p><strong>🚗 주차:</strong> 건물 지하 1~3층 무료 주차 (3시간)</p>
                </div>
                <div class="map-container">
                    <iframe 
                        src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3165.4823!2d127.0276!3d37.4979!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x0%3A0x0!2zMzfCsDI5JzUyLjQiTiAxMjfCsDA2JzI3LjQiRQ!5e0!3m2!1sko!2skr!4v1234567890"
                        width="100%" 
                        height="200" 
                        style="border:0; border-radius: 10px;" 
                        allowfullscreen="" 
                        loading="lazy">
                    </iframe>
                </div>
            </div>
        </div>

        <!-- 진료 안내 -->
        <div class="info-section">
            <h2 class="info-title">진료 안내</h2>
            <div class="info-item">
                <strong>평일:</strong> <span class="time-info">09:00 ~ 18:00</span>
            </div>
            <div class="info-item">
                <strong>토요일:</strong> <span class="time-info">09:00 ~ 15:00</span>
            </div>
            <div class="info-item">
                <strong>점심시간:</strong> 12:30 ~ 13:30
            </div>
            <div class="info-item">
                <strong>휴진:</strong> 일요일, 공휴일
            </div>
        </div>

        <!-- 진료 과목 -->
        <div class="info-section">
            <h2 class="info-title">진료 과목</h2>
            <p style="color: #666; margin-bottom: 15px; font-size: 14px;">각 항목을 클릭하면 자세한 정보를 확인할 수 있습니다.</p>
            <div class="services">
                <div class="service-item" onclick="showServiceDetail('general')">
                    <div class="service-icon">🦷</div>
                    <div>일반진료</div>
                </div>
                <div class="service-item" onclick="showServiceDetail('whitening')">
                    <div class="service-icon">✨</div>
                    <div>미백치료</div>
                </div>
                <div class="service-item" onclick="showServiceDetail('orthodontics')">
                    <div class="service-icon">🔧</div>
                    <div>교정치료</div>
                </div>
                <div class="service-item" onclick="showServiceDetail('implant')">
                    <div class="service-icon">🦴</div>
                    <div>임플란트</div>
                </div>
                <div class="service-item" onclick="showServiceDetail('prosthetic')">
                    <div class="service-icon">👑</div>
                    <div>보철치료</div>
                </div>
                <div class="service-item" onclick="showServiceDetail('pediatric')">
                    <div class="service-icon">🧒</div>
                    <div>소아치과</div>
                </div>
            </div>
        </div>

        <!-- 연락처 -->
        <div class="contact-info">
            <div class="phone">📞 070-1234-1234</div>
            <div class="address">📍 피닉스시 피닉스로 11길 11, 피닉스타워 11층 11호</div>
        </div>



        <!-- 관리자 로그인 버튼 -->
        <div class="admin-buttons">
                <button class="admin-btn customer" onclick="loginCustomerAdmin()" title="아이디: phoenix | 비밀번호: phoenix">☀️ 고객 관리자</button>
                <button class="admin-btn chatbot" onclick="loginChatbotAdmin2()" title="아이디: phoenix | 비밀번호: phoenix">👩‍⚕️ AI챗봇 관리자</button>
        </div>


    </div>

    <!-- 하단 예약 배너 -->
    <div class="bottom-banner" onclick="location.href='reservation.html'">
        📅 지금 예약하기
    </div>

    <!-- 고정 팝업 AI챗봇 배너 -->
    <div class="chatbot-fixed-banner" id="chatbotFixedBanner" onclick="goToChatbot()">
        <div class="chatbot-fixed-content">
            <div class="chatbot-fixed-icon">👩‍⚕️</div>
            <div class="chatbot-fixed-text">
                <div class="chatbot-fixed-title">AI 상담사</div>
                <div class="chatbot-fixed-desc">24시간 상담</div>
            </div>
        </div>
        <div class="chatbot-fixed-pulse"></div>
    </div>







    <!-- 메시지 발송 팝업 -->
    <div class="message-sending-popup" id="messageSendingPopup">
        <div class="message-popup-content">
            <!-- 팝업 헤더 -->
            <div class="message-popup-header">
                <div class="message-popup-title">🦷 구강검진 대상자 메시지 발송</div>
                <button class="message-popup-close" onclick="closeMessageSendingPopup()">✕</button>
            </div>
            
            <!-- 팝업 내용 -->
            <div class="message-popup-body">
                <!-- 대상자 정보 -->
                <div class="message-target-info">
                    <div class="message-target-count" id="messageCustomerCount">0</div>
                    <div class="message-target-desc">명의 구강검진 대상자에게 메시지를 발송합니다</div>
                </div>
                
                <!-- 탭 메뉴 -->
                <div class="message-tabs">
                    <button class="tab-button active" onclick="switchMessageTab('sms')">📱 SMS 문자 메시지</button>
                    <button class="tab-button" onclick="switchMessageTab('kakao')">💬 카카오 알림톡</button>
                </div>
                
                <!-- SMS 탭 내용 -->
                <div class="tab-content active" id="smsTab">
                    <div class="file-upload-section">
                        <div class="file-upload-icon">📁</div>
                        <div class="file-upload-text">SMS 발송용 CSV 파일 업로드</div>
                        <div class="file-upload-desc">
                            발송할 내용이 포함된 CSV 파일을 업로드하세요<br>
                            <small>지원 형식: .csv (Excel 파일은 CSV로 변환 후 업로드)</small>
                        </div>
                        <button class="file-upload-btn" onclick="document.getElementById('smsFileInput').click()">
                            📁 파일 선택
                        </button>
                        <input type="file" id="smsFileInput" class="file-upload-input" accept=".csv" onchange="uploadSmsFile(event)">
                        <div class="file-selected" id="smsFileName" style="display: none;">선택된 파일 없음</div>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin-bottom: 10px; color: #333;">📋 SMS 메시지 템플릿 예시:</h4>
                        <div style="background: white; padding: 12px; border-radius: 5px; font-family: monospace; font-size: 13px; line-height: 1.6; white-space: pre-line;">
[피닉스치과] 안녕하세요 #{이름}님!

#{검진연도}년 국가 무료 구강검진 대상자로 확인되어 안내드립니다.

🦷 무료 검진 혜택:
- 구강검진 (충치, 잇몸질환 등)
- 전문의 상담
- 치료 계획 수립

📅 온라인 예약하기:
https://phoenixai-agent.site/reservation.html

📞 전화 예약: 02-1234-5678
🕘 진료시간: 평일 09:00-18:00
📍 위치: 강남역 3번출구 도보 5분

건강한 치아 관리의 첫걸음을 함께하세요!

- 피닉스치과 -
                        </div>
                        <div style="margin-top: 10px; padding: 8px; background: #e8f5e8; border-radius: 5px; font-size: 12px; color: #2d5f3f;">
                            💡 <strong>개인화 변수:</strong> #{이름}, #{나이}, #{검진연도}가 실제 고객 정보로 자동 치환됩니다.
                        </div>
                    </div>
                    
                    <button class="send-message-btn" onclick="sendSmsMessage()">
                        📱 SMS 메시지 발송하기
                    </button>
                </div>
                
                <!-- 카카오 알림톡 탭 내용 -->
                <div class="tab-content" id="kakaoTab">
                    <div class="file-upload-section">
                        <div class="file-upload-icon">📁</div>
                        <div class="file-upload-text">카카오 알림톡 발송용 엑셀 파일 업로드</div>
                        <div class="file-upload-desc">
                            발송할 내용이 포함된 엑셀 파일을 업로드하세요<br>
                            <small>지원 형식: .xlsx, .xls</small>
                        </div>
                        <button class="file-upload-btn" onclick="document.getElementById('kakaoFileInput').click()">
                            📁 파일 선택
                        </button>
                        <input type="file" id="kakaoFileInput" class="file-upload-input" accept=".xlsx,.xls" onchange="uploadKakaoFile(event)">
                        <div class="file-selected" id="kakaoFileName" style="display: none;">선택된 파일 없음</div>
                    </div>
                    
                    <div style="background: #fffbeb; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #fbbf24;">
                        <h4 style="margin-bottom: 10px; color: #333;">💬 카카오 알림톡 템플릿 예시:</h4>
                        <div style="background: white; padding: 12px; border-radius: 5px; font-family: monospace; font-size: 14px; line-height: 1.5;">
                            [피닉스치과] 무료 구강검진 안내<br><br>
                            안녕하세요 #{이름}님!<br>
                            #{검진연도}년 국가 무료 구강검진 대상자입니다.<br><br>
                            🦷 검진 혜택: 무료<br>
                            📞 예약: 070-1234-1234<br>
                            📍 위치: 피닉스타워 11층<br><br>
                            건강한 치아 관리를 시작해보세요!
                        </div>
                    </div>
                    
                    <button class="send-message-btn kakao" onclick="sendKakaoMessage()">
                        💬 카카오 알림톡 발송하기
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 서비스 상세 페이지 -->
    <div class="popup-page" id="serviceDetailPage">
        <div class="popup-header">
            <h2 id="serviceDetailTitle">진료 과목 상세</h2>
            <button class="close-btn" onclick="closeServiceDetail()">✕</button>
        </div>
        <div class="popup-content" id="serviceDetailContent">
            <!-- 서비스 상세 내용이 여기에 표시됩니다 -->
        </div>
    </div>

    <!-- AI 챗봇 관리 페이지 -->
    <div class="popup-page" id="chatbotAdminPage">
        <div class="admin-header">
            <div class="admin-title">🤖 AI 챗봇 관리 시스템</div>
            <div class="admin-nav">
                <button class="nav-btn" onclick="closeChatbotAdmin()">🏠 메인으로</button>
                <button class="nav-btn logout" onclick="closeChatbotAdmin()">로그아웃</button>
            </div>
        </div>
        
        <div class="admin-content">
            <!-- AI 모델 API 설정 -->
            <div class="admin-section">
                <div class="section-header">
                    <h3>🤖 챗봇 AI 모델 연결하기</h3>
                </div>
                
                <div class="api-form">
                    <!-- ChatGPT 설정 -->
                    <div class="form-group">
                        <label for="chatgptApiKey">ChatGPT API Key</label>
                        <input type="password" id="chatgptApiKey" placeholder="sk-proj-...">
                    </div>
                    <div class="form-group">
                        <label for="chatgptModel">ChatGPT 모델선택</label>
                        <select id="chatgptModel" onchange="toggleFinetuningInput('chatgpt')">
                            <option value="">-- ChatGPT 모델을 선택하세요 --</option>
                            <option value="gpt-4o">GPT-4o (최신 멀티모달)</option>
                            <option value="gpt-4o-mini">GPT-4o Mini (경제적)</option>
                            <option value="finetuning">Finetuning Model (커스텀 모델)</option>
                        </select>
                    </div>
                    <div class="form-group" id="chatgptFinetuningGroup" style="display: none;">
                        <label for="chatgptFinetuningModel">Finetuning 모델명 입력</label>
                        <input type="text" id="chatgptFinetuningModel" placeholder="ft:gpt-4o-mini-2024-07-18:...">
                    </div>

                    <!-- Gemini 설정 -->
                    <div class="form-group" style="margin-top: 25px;">
                        <label for="geminiApiKey">Gemini 모델 API Key</label>
                        <input type="password" id="geminiApiKey" placeholder="AIza...">
                    </div>
                    <div class="form-group">
                        <label for="geminiModel">Gemini 모델선택</label>
                        <select id="geminiModel">
                            <option value="">-- Gemini 모델을 선택하세요 --</option>
                            <option value="gemini-1.5-flash">Gemini 1.5 Flash (빠른 응답)</option>
                            <option value="gemini-1.5-pro">Gemini 1.5 Pro (고성능)</option>
                            <option value="gemini-1.0-pro">Gemini 1.0 Pro (안정성)</option>
                        </select>
                    </div>

                    <!-- Claude 설정 -->
                    <div class="form-group" style="margin-top: 25px;">
                        <label for="claudeApiKey">Claude 모델 API Key</label>
                        <input type="password" id="claudeApiKey" placeholder="sk-ant-...">
                    </div>
                    <div class="form-group">
                        <label for="claudeModel">Claude 모델선택</label>
                        <select id="claudeModel">
                            <option value="">-- Claude 모델을 선택하세요 --</option>
                            <option value="claude-3-haiku">Claude 3 Haiku (빠르고 효율적)</option>
                            <option value="claude-3-sonnet">Claude 3 Sonnet (균형적 성능)</option>
                            <option value="claude-3-opus">Claude 3 Opus (최고 성능)</option>
                            <option value="claude-3-5-sonnet">Claude 3.5 Sonnet (최신 모델)</option>
                        </select>
                    </div>

                    <div class="btn-group" style="margin-top: 30px;">
                        <button class="btn btn-primary" onclick="saveApiSettings()">💾 설정 저장</button>
                        <button class="btn btn-success" onclick="testApiConnection()">🔗 연결 테스트</button>
                        <button class="btn btn-danger" onclick="resetApiSettings()">🔄 설정 초기화</button>
                    </div>
                    <div id="apiStatus" class="status-message"></div>
                </div>
            </div>

            <!-- AI 지식 파일 업로드 -->
            <div class="admin-section">
                <div class="section-header">
                    <h3>📚 AI 지식 파일 업로드</h3>
                </div>
                
                <div class="upload-area" onclick="document.getElementById('fileInput').click()" ondrop="handleFileDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                    <div class="upload-icon">📁</div>
                    <div class="upload-text">클릭하거나 파일을 여기로 드래그하세요</div>
                    <div class="upload-types">💡 <strong>지원 형식: 텍스트(.txt), JSONL(.jsonl)</strong><br>
                    <small style="color: #666;">※ 텍스트 파일은 Q&A 형식으로 작성해주세요</small></div>
                </div>
                <input type="file" id="fileInput" class="file-input" accept=".txt,.jsonl" multiple onchange="handleFileUpload(event)">
                
                <div class="file-list" id="fileList">
                    <!-- 업로드된 파일들이 여기에 표시됩니다 -->
                </div>
                
                <div id="knowledgeStatus" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px; font-size: 14px;">
                    📖 업로드된 지식 파일: 0개 | 상태: 비활성
                </div>
                
                <!-- 지식 파일 설정 저장 버튼 -->
                <div class="btn-group" style="margin-top: 20px;">
                    <button class="btn btn-success" onclick="saveKnowledgeSettings()">💾 지식 파일 설정 저장</button>
                    <button class="btn btn-primary" onclick="testKnowledgeBase()">🔍 지식 검색 테스트</button>
                    <button class="btn" style="background: #17a2b8; color: white;" onclick="showParsedData()">📋 파싱된 Q&A 보기</button>
                    <button class="btn btn-danger" onclick="clearAllKnowledge()">🗑️ 모든 지식 삭제</button>
                </div>
                <div id="knowledgeSettingsStatus" class="status-message"></div>
                
                <!-- 파싱된 Q&A 표시 영역 -->
                <div id="parsedDataView" style="display: none; margin-top: 20px; background: white; border-radius: 10px; padding: 20px; max-height: 400px; overflow-y: auto; border: 1px solid #ddd;">
                    <h4 style="margin-bottom: 15px; color: #2c3e50;">📋 파싱된 Q&A 데이터</h4>
                    <div id="parsedDataContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 고객 관리 페이지 -->
    <div class="popup-page" id="customerAdminPage">
        <div class="admin-header">
            <div class="admin-title">👥 피닉스치과 고객 관리 시스템</div>
            <div class="admin-nav">
                <button class="nav-btn" onclick="closeCustomerAdmin()">🏠 메인으로</button>
                <button class="nav-btn logout" onclick="closeCustomerAdmin()">로그아웃</button>
            </div>
        </div>
        
        <div class="admin-content">
            <!-- 통계 카드 -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalReservations">3</div>
                    <div class="stat-label">총 예약 수</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="todayReservations">1</div>
                    <div class="stat-label">오늘 예약</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="thisWeekReservations">2</div>
                    <div class="stat-label">이번주 예약</div>
                </div>
            </div>

            <!-- 예약 명단 -->
            <div class="admin-section">
                <div class="section-header">
                    <h3>📋 예약 명단</h3>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="downloadAllReservations()">
                            📥 전체 예약 고객 엑셀 받기
                        </button>
                        <button class="btn btn-primary" onclick="downloadDentalCheckupExcel()">
                            📥 무료 검진(구강) 대상자만 엑셀 받기
                        </button>
                        <button class="btn btn-warning message-send" onclick="sendMessageToDentalTargets()">
                            📨 무료 검진(구강) 대상자 메시지 보내기
                        </button>
                    </div>
                </div>
                
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>순번</th>
                            <th>예약자명</th>
                            <th>생년월일</th>
                            <th>전화번호</th>
                            <th>예약날짜</th>
                            <th>예약시간</th>
                            <th>구강검진 정보</th>
                            <th>예약일시</th>
                        </tr>
                    </thead>
                    <tbody id="customerTableBody">
                        <tr>
                            <td>1</td>
                            <td>김철수</td>
                            <td>850315</td>
                            <td>010-1234-5678</td>
                            <td>2025-06-15</td>
                            <td>10:00</td>
                            <td style="background: #e8f5e8;">나이(40세), 2025년 국가 구강검진 대상</td>
                            <td>2025-06-12 09:30</td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td>이영희</td>
                            <td>920722</td>
                            <td>010-9876-5432</td>
                            <td>2025-06-16</td>
                            <td>14:30</td>
                            <td style="background: #ffeaa7;">나이(33세), 2026년 국가 구강검진 대상</td>
                            <td>2025-06-12 11:15</td>
                        </tr>
                        <tr>
                            <td>3</td>
                            <td>박민수</td>
                            <td>780904</td>
                            <td>010-5555-7777</td>
                            <td>2025-06-12</td>
                            <td>16:00</td>
                            <td style="background: #ffeaa7;">나이(47세), 2026년 국가 구강검진 대상</td>
                            <td>2025-06-11 14:20</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- AI챗봇 관리자 페이지2 -->
    <div class="popup-page" id="chatbotAdminPage2" style="display: none;">
        <div class="admin-header">
            <div class="admin-title">🤖 AI 챗봇 관리 시스템</div>
            <div class="admin-login-info">
                <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">🔐 관리자 로그인 정보</div>
                <div style="font-size: 14px; font-weight: bold;">아이디: <span style="color: #ffd700;">phoenix</span> | 비밀번호: <span style="color: #ffd700;">phoenix</span></div>
            </div>
            <div class="admin-nav">
                <button class="nav-btn" onclick="closeChatbotAdmin2()">🏠 메인으로</button>
                <button class="nav-btn logout" onclick="closeChatbotAdmin2()">로그아웃</button>
            </div>
        </div>
        
        <div class="admin-content">
            <!-- 답변 우선순위 정보 -->
            <div class="admin-section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <div class="section-header">
                    <h3>🎯 AI 챗봇 답변 우선순위</h3>
                </div>
                <div style="padding: 20px; background: rgba(255,255,255,0.1); border-radius: 10px; margin-top: 15px;">
                    <div style="font-size: 16px; font-weight: bold; margin-bottom: 15px; text-align: center;">
                        답변 처리 순서
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; font-size: 14px;">
                        <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 8px; text-align: center;">
                            <div style="font-weight: bold; margin-bottom: 5px;">1차</div>
                            <div>🔐 관리자 기능</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 8px; text-align: center;">
                            <div style="font-weight: bold; margin-bottom: 5px;">2차</div>
                            <div>📚 지식베이스 검색</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 8px; text-align: center;">
                            <div style="font-weight: bold; margin-bottom: 5px;">3차</div>
                            <div>❓ 기본 FAQ 답변</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 8px; text-align: center;">
                            <div style="font-weight: bold; margin-bottom: 5px;">4차</div>
                            <div>🤖 AI API 호출</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 8px; text-align: center;">
                            <div style="font-weight: bold; margin-bottom: 5px;">5차</div>
                            <div>🎭 시뮬레이션 답변</div>
                        </div>
                    </div>
                    <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 8px; text-align: center; font-size: 13px;">
                        <span id="adminApiStatus2">
                            🔴 AI API 설정 필요
                        </span>
                    </div>
                </div>
            </div>

            <!-- AI 모델 API 설정 -->
            <div class="admin-section">
                <div class="section-header">
                    <h3>🤖 챗봇 AI 모델 연결하기</h3>
                </div>
                
                <div class="api-form">
                    <!-- ChatGPT 설정 -->
                    <div class="form-group">
                        <label for="chatgptApiKey2">ChatGPT API Key</label>
                        <input type="password" id="chatgptApiKey2" placeholder="sk-proj-...">
                    </div>
                    <div class="form-group">
                        <label for="chatgptModel2">ChatGPT 모델선택</label>
                        <select id="chatgptModel2">
                            <option value="">-- ChatGPT 모델을 선택하세요 --</option>
                            <option value="gpt-4o">GPT-4o (최신 멀티모달)</option>
                            <option value="gpt-4o-mini">GPT-4o Mini (경제적)</option>
                        </select>
                    </div>

                    <!-- Gemini 설정 -->
                    <div class="form-group" style="margin-top: 25px;">
                        <label for="geminiApiKey2">Gemini 모델 API Key</label>
                        <input type="password" id="geminiApiKey2" placeholder="AIza...">
                    </div>
                    <div class="form-group">
                        <label for="geminiModel2">Gemini 모델선택</label>
                        <select id="geminiModel2">
                            <option value="">-- Gemini 모델을 선택하세요 --</option>
                            <option value="gemini-1.5-flash">Gemini 1.5 Flash (빠른 응답)</option>
                            <option value="gemini-1.5-pro">Gemini 1.5 Pro (고성능)</option>
                            <option value="gemini-1.0-pro">Gemini 1.0 Pro (안정성)</option>
                        </select>
                    </div>

                    <!-- Claude 설정 -->
                    <div class="form-group" style="margin-top: 25px;">
                        <label for="claudeApiKey2">Claude 모델 API Key</label>
                        <input type="password" id="claudeApiKey2" placeholder="sk-ant-...">
                    </div>
                    <div class="form-group">
                        <label for="claudeModel2">Claude 모델선택</label>
                        <select id="claudeModel2">
                            <option value="">-- Claude 모델을 선택하세요 --</option>
                            <option value="claude-3-haiku">Claude 3 Haiku (빠르고 효율적)</option>
                            <option value="claude-3-sonnet">Claude 3 Sonnet (균형적 성능)</option>
                            <option value="claude-3-opus">Claude 3 Opus (최고 성능)</option>
                            <option value="claude-3-5-sonnet">Claude 3.5 Sonnet (최신 모델)</option>
                        </select>
                    </div>

                    <div class="btn-group" style="margin-top: 30px;">
                        <button class="btn btn-primary" id="saveApiBtn2">💾 설정 저장</button>
                        <button class="btn btn-success" id="testApiBtn2">🔗 연결 테스트</button>
                        <button class="btn btn-danger" id="resetApiBtn2">🔄 설정 초기화</button>
                    </div>
                    <div id="apiStatus2" class="status-message"></div>
                </div>
            </div>

            <!-- AI 지식 파일 업로드 -->
            <div class="admin-section">
                <div class="section-header">
                    <h3>📚 AI 지식 파일 업로드</h3>
                </div>
                
                <div class="upload-area" id="uploadArea2">
                    <div class="upload-icon">📁</div>
                    <div class="upload-text">클릭하거나 파일을 여기로 드래그하세요</div>
                    <div class="upload-types">💡 <strong>지원 형식: 텍스트(.txt), JSONL(.jsonl)</strong><br>
                    <small style="color: #666;">※ 텍스트 파일은 Q&A 형식으로 작성해주세요</small></div>
                </div>
                <input type="file" id="fileInput2" class="file-input" accept=".txt,.jsonl" multiple>
                
                <div class="file-list" id="fileList2">
                    <!-- 업로드된 파일들이 여기에 표시됩니다 -->
                </div>
                
                <div id="knowledgeStatus2" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px; font-size: 14px;">
                    📖 업로드된 지식 파일: 0개 | 상태: 비활성
                </div>
                
                <!-- 지식 파일 설정 저장 버튼 -->
                <div class="btn-group" style="margin-top: 20px;">
                    <button class="btn btn-success" id="saveKnowledgeBtn2">💾 지식 파일 설정 저장</button>
                    <button class="btn btn-primary" id="testKnowledgeBtn2">🔍 지식 검색 테스트</button>
                                            <button class="btn" style="background: #ffd700; color: #333;" id="showParsedDataBtn2">📋 파싱된 Q&A 보기</button>
                    <button class="btn btn-danger" id="clearKnowledgeBtn2">🗑️ 모든 지식 삭제</button>
                </div>
                <div id="knowledgeSettingsStatus2" class="status-message"></div>
                
                <!-- 파싱된 Q&A 표시 영역 -->
                <div id="parsedDataView2" style="display: none; margin-top: 20px; background: white; border-radius: 10px; padding: 20px; max-height: 400px; overflow-y: auto; border: 1px solid #ddd;">
                    <h4 style="margin-bottom: 15px; color: #2c3e50;">📋 파싱된 Q&A 데이터</h4>
                    <div id="parsedDataContent2"></div>
                </div>
            </div>

            <!-- 대화 이력 관리 -->
            <div class="admin-section">
                <div class="section-header">
                    <h3>💬 대화 이력 관리</h3>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <div style="margin-bottom: 15px;">
                        <h4 style="color: #2c3e50; margin-bottom: 10px;">📊 대화 이력 현황</h4>
                        <div id="chatHistoryStatus2" style="padding: 15px; background: white; border-radius: 8px; border-left: 4px solid #4facfe;">
                            💬 현재 대화 이력: 0개 메시지 | 최대 저장: 20개 메시지
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #2c3e50; margin-bottom: 10px;">⚙️ 대화 이력 설정</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div>
                                <label style="font-weight: bold; display: block; margin-bottom: 5px;">최대 대화 이력 개수</label>
                                <select id="maxHistorySelect2" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                    <option value="10">10개</option>
                                    <option value="20" selected>20개</option>
                                    <option value="30">30개</option>
                                    <option value="50">50개</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-weight: bold; display: block; margin-bottom: 5px;">API 호출 최대 토큰</label>
                                <select id="maxTokensSelect2" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                    <option value="1000">1,000 토큰</option>
                                    <option value="1500" selected>1,500 토큰</option>
                                    <option value="2000">2,000 토큰</option>
                                    <option value="3000">3,000 토큰</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 대화 이력 관리 버튼 -->
                    <div class="btn-group" style="margin-top: 20px;">
                        <button class="btn btn-primary" id="viewChatHistoryBtn2">👁️ 대화 이력 보기</button>
                        <button class="btn btn-warning" id="clearChatHistoryBtn2">🗑️ 대화 이력 삭제</button>
                        <button class="btn btn-success" id="exportChatHistoryBtn2">📥 대화 이력 내보내기</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('페이지 로드 시작');

        // 페이지 로드 시 초기 데이터 설정
        function initializeData() {
            const existingData = localStorage.getItem('phoenixDentalReservations');
            if (!existingData) {
                // 초기 샘플 데이터를 localStorage에 저장
                const initialData = getSampleReservationData().map(item => ({
                    ...item,
                    id: Date.now() + Math.random() // 고유 ID 생성
                }));
                localStorage.setItem('phoenixDentalReservations', JSON.stringify(initialData));
                console.log('초기 예약 데이터 설정 완료');
            }
        }

        // 페이지 로드 시 초기화
        window.addEventListener('load', function() {
            initializeData();
            console.log('페이지 로드 완료');
            
            // 챗봇 배너 로그
            console.log('AI챗봇 배너 표시됨');
        });

        // 무료 검진(구강) 확인 페이지로 이동
        function goToDentalCheckup() {
            console.log('무료 검진(구강) 확인 페이지로 이동');
            window.location.href = 'dental_checkup.html';
        }

        // AI챗봇 페이지로 이동
        function goToChatbot() {
            console.log('AI챗봇 페이지로 이동');
            window.location.href = 'chatbot.html';
        }

        // 전역 변수
        let chatbotOpen = false;
        let apiSettings = {
            chatgpt: {
                apiKey: '',
                model: '',
                enabled: false
            },
            gemini: {
                apiKey: '',
                model: '',
                enabled: false
            },
            claude: {
                apiKey: '',
                model: '',
                enabled: false
            },
            activeProvider: '' // 현재 활성화된 AI 서비스
        };
        let knowledgeBase = {
            files: [],
            content: '',
            parsedData: [], // 파싱된 데이터 저장
            enabled: false
        };



        function loginCustomerAdmin() {
            console.log('고객 관리 로그인 팝업 열기');
            window.currentLoginType = 'customer';
            document.getElementById('adminLoginPopup').style.display = 'flex';
        }

        // AI챗봇 관리자 로그인2 함수
        function loginChatbotAdmin2() {
            console.log('AI챗봇 관리자 로그인 팝업 열기');
            window.currentLoginType = 'chatbot';
            document.getElementById('adminLoginPopup').style.display = 'flex';
        }



        function openCustomerAdmin() {
            console.log('고객 관리 페이지 열기');
            document.getElementById('customerAdminPage').style.display = 'block';
            
            // 최신 예약 데이터로 테이블 업데이트
            updateCustomerTable();
            updateStatistics();
        }

        function closeCustomerAdmin() {
            console.log('고객 관리 페이지 닫기');
            document.getElementById('customerAdminPage').style.display = 'none';
        }

        // AI챗봇 관리자 페이지 열기/닫기
        function openChatbotAdmin2() {
            console.log('AI챗봇 관리자 페이지2 열기');
            document.getElementById('chatbotAdminPage2').style.display = 'block';
            
            // 관리자 페이지 API 상태 업데이트
            setTimeout(() => {
                updateAdminApiStatus2();
            }, 100);
            
            // 관리자 페이지 이벤트 리스너 설정
            setTimeout(() => {
                setupAdminEventListeners2();
            }, 100);
        }

        function closeChatbotAdmin2() {
            console.log('AI챗봇 관리자 페이지2 닫기');
            document.getElementById('chatbotAdminPage2').style.display = 'none';
        }

        // 관리자 페이지 API 상태 업데이트
        function updateAdminApiStatus2() {
            const adminApiStatus = document.getElementById('adminApiStatus2');
            if (adminApiStatus) {
                // API 설정 확인
                const settings = JSON.parse(localStorage.getItem('chatbotApiSettings') || '{}');
                const hasActiveAPI = settings.chatgpt?.enabled || settings.gemini?.enabled || settings.claude?.enabled;
                adminApiStatus.innerHTML = hasActiveAPI ? '🟢 AI API 연결됨' : '🔴 AI API 설정 필요';
            }
        }

        // 관리자 페이지 이벤트 리스너 설정
        function setupAdminEventListeners2() {
            console.log('🔧 AI챗봇 관리자 페이지2 이벤트 리스너 설정 시작');
            
            // API 설정 저장 버튼
            const saveApiBtn = document.getElementById('saveApiBtn2');
            if (saveApiBtn) {
                saveApiBtn.addEventListener('click', function() {
                    try {
                        console.log('💾 API 설정 저장 시작');
                        
                        // 입력 필드에서 값 가져오기
                        const chatgptApiKey = document.getElementById('chatgptApiKey2');
                        const chatgptModel = document.getElementById('chatgptModel2');
                        const geminiApiKey = document.getElementById('geminiApiKey2');
                        const geminiModel = document.getElementById('geminiModel2');
                        const claudeApiKey = document.getElementById('claudeApiKey2');
                        const claudeModel = document.getElementById('claudeModel2');
                        
                        if (!chatgptApiKey || !chatgptModel || !geminiApiKey || !geminiModel || !claudeApiKey || !claudeModel) {
                            throw new Error('필수 입력 필드를 찾을 수 없습니다.');
                        }
                        
                        const settings = {
                            chatgpt: {
                                enabled: chatgptApiKey.value.trim() !== '',
                                apiKey: chatgptApiKey.value.trim(),
                                model: chatgptModel.value
                            },
                            gemini: {
                                enabled: geminiApiKey.value.trim() !== '',
                                apiKey: geminiApiKey.value.trim(),
                                model: geminiModel.value
                            },
                            claude: {
                                enabled: claudeApiKey.value.trim() !== '',
                                apiKey: claudeApiKey.value.trim(),
                                model: claudeModel.value
                            }
                        };
                        
                        localStorage.setItem('chatbotApiSettings', JSON.stringify(settings));
                        console.log('✅ API 설정 저장 완료:', settings);
                        
                        // 상태 메시지 업데이트
                        const statusDiv = document.getElementById('apiStatus2');
                        if (statusDiv) {
                            statusDiv.innerHTML = '<div style="color: green; padding: 10px; background: #d4edda; border-radius: 5px; margin-top: 10px;">✅ API 설정이 저장되었습니다!</div>';
                        }
                        
                        // 관리자 페이지 상태 업데이트
                        updateAdminApiStatus2();
                        
                        // 성공 알림
                        alert('✅ API 설정이 성공적으로 저장되었습니다!');
                        
                    } catch (error) {
                        console.error('❌ API 설정 저장 실패:', error);
                        alert('❌ API 설정 저장에 실패했습니다: ' + error.message);
                    }
                });
                console.log('✅ API 설정 저장 버튼 이벤트 리스너 추가 완료');
            }

            // API 연결 테스트 버튼
            const testApiBtn = document.getElementById('testApiBtn2');
            if (testApiBtn) {
                testApiBtn.addEventListener('click', function() {
                    try {
                        console.log('🔗 API 연결 테스트 시작');
                        
                        const statusDiv = document.getElementById('apiStatus2');
                        if (statusDiv) {
                            statusDiv.innerHTML = '<div style="color: #856404; padding: 10px; background: #fff3cd; border-radius: 5px; margin-top: 10px;">🔄 API 연결을 테스트하고 있습니다...</div>';
                        }
                        
                        setTimeout(() => {
                            try {
                                const settings = JSON.parse(localStorage.getItem('chatbotApiSettings') || '{}');
                                let activeApis = [];
                                
                                if (settings.chatgpt?.enabled && settings.chatgpt?.apiKey) activeApis.push('ChatGPT');
                                if (settings.gemini?.enabled && settings.gemini?.apiKey) activeApis.push('Gemini');
                                if (settings.claude?.enabled && settings.claude?.apiKey) activeApis.push('Claude');
                                
                                console.log('🔍 활성화된 API:', activeApis);
                                
                                if (activeApis.length > 0) {
                                    const successMessage = `✅ 연결 성공! 활성화된 API: ${activeApis.join(', ')}`;
                                    if (statusDiv) {
                                        statusDiv.innerHTML = `<div style="color: green; padding: 10px; background: #d4edda; border-radius: 5px; margin-top: 10px;">${successMessage}</div>`;
                                    }
                                    alert(successMessage);
                                    
                                    // 관리자 페이지 상태 업데이트
                                    updateAdminApiStatus2();
                                } else {
                                    const errorMessage = '❌ 활성화된 API가 없습니다. API 키를 입력하고 설정을 저장해주세요.';
                                    if (statusDiv) {
                                        statusDiv.innerHTML = `<div style="color: #721c24; padding: 10px; background: #f8d7da; border-radius: 5px; margin-top: 10px;">${errorMessage}</div>`;
                                    }
                                    alert(errorMessage);
                                }
                            } catch (error) {
                                console.error('❌ API 테스트 실패:', error);
                                const errorMessage = '❌ API 테스트에 실패했습니다: ' + error.message;
                                if (statusDiv) {
                                    statusDiv.innerHTML = `<div style="color: #721c24; padding: 10px; background: #f8d7da; border-radius: 5px; margin-top: 10px;">${errorMessage}</div>`;
                                }
                                alert(errorMessage);
                            }
                        }, 2000);
                        
                    } catch (error) {
                        console.error('❌ API 테스트 시작 실패:', error);
                        alert('❌ API 테스트를 시작할 수 없습니다: ' + error.message);
                    }
                });
                console.log('✅ API 연결 테스트 버튼 이벤트 리스너 추가 완료');
            }

            // API 설정 초기화 버튼
            const resetApiBtn = document.getElementById('resetApiBtn2');
            if (resetApiBtn) {
                resetApiBtn.addEventListener('click', function() {
                    if (confirm('⚠️ 모든 API 설정을 초기화하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다.')) {
                        try {
                            console.log('🔄 API 설정 초기화 시작');
                            
                            // 입력 필드 초기화
                            const inputs = ['chatgptApiKey2', 'chatgptModel2', 'geminiApiKey2', 'geminiModel2', 'claudeApiKey2', 'claudeModel2'];
                            inputs.forEach(id => {
                                const element = document.getElementById(id);
                                if (element) {
                                    element.value = '';
                                }
                            });
                            
                            // localStorage에서 설정 삭제
                            localStorage.removeItem('chatbotApiSettings');
                            
                            // 상태 메시지 업데이트
                            const statusDiv = document.getElementById('apiStatus2');
                            if (statusDiv) {
                                statusDiv.innerHTML = '<div style="color: #856404; padding: 10px; background: #fff3cd; border-radius: 5px; margin-top: 10px;">🔄 API 설정이 초기화되었습니다.</div>';
                            }
                            
                            // 관리자 페이지 상태 업데이트
                            updateAdminApiStatus2();
                            
                            console.log('✅ API 설정 초기화 완료');
                            alert('✅ API 설정이 초기화되었습니다!');
                            
                        } catch (error) {
                            console.error('❌ API 설정 초기화 실패:', error);
                            alert('❌ API 설정 초기화에 실패했습니다: ' + error.message);
                        }
                    }
                });
                console.log('✅ API 설정 초기화 버튼 이벤트 리스너 추가 완료');
            }

            // 기존 설정 불러오기
            try {
                const settings = JSON.parse(localStorage.getItem('chatbotApiSettings') || '{}');
                
                if (settings.chatgpt?.apiKey) {
                    const chatgptApiKey = document.getElementById('chatgptApiKey2');
                    if (chatgptApiKey) chatgptApiKey.value = settings.chatgpt.apiKey;
                }
                if (settings.chatgpt?.model) {
                    const chatgptModel = document.getElementById('chatgptModel2');
                    if (chatgptModel) chatgptModel.value = settings.chatgpt.model;
                }
                if (settings.gemini?.apiKey) {
                    const geminiApiKey = document.getElementById('geminiApiKey2');
                    if (geminiApiKey) geminiApiKey.value = settings.gemini.apiKey;
                }
                if (settings.gemini?.model) {
                    const geminiModel = document.getElementById('geminiModel2');
                    if (geminiModel) geminiModel.value = settings.gemini.model;
                }
                if (settings.claude?.apiKey) {
                    const claudeApiKey = document.getElementById('claudeApiKey2');
                    if (claudeApiKey) claudeApiKey.value = settings.claude.apiKey;
                }
                if (settings.claude?.model) {
                    const claudeModel = document.getElementById('claudeModel2');
                    if (claudeModel) claudeModel.value = settings.claude.model;
                }
                
                console.log('✅ 기존 API 설정 불러오기 완료');
            } catch (error) {
                console.error('❌ 기존 API 설정 불러오기 실패:', error);
            }

            // 파일 업로드 이벤트 리스너 설정
            const fileInput2 = document.getElementById('fileInput2');
            if (fileInput2) {
                fileInput2.addEventListener('change', function(event) {
                    const files = event.target.files;
                    processUploadedFiles2(files);
                });
                console.log('✅ 파일 업로드 이벤트 리스너 추가 완료 (fileInput2)');
            }

            // 파일 드래그 앤 드롭 이벤트 리스너 설정
            const uploadArea2 = document.getElementById('uploadArea2');
            if (uploadArea2) {
                // 클릭 이벤트
                uploadArea2.addEventListener('click', function() {
                    document.getElementById('fileInput2').click();
                });
                
                // 드래그 오버 이벤트
                uploadArea2.addEventListener('dragover', function(event) {
                    event.preventDefault();
                    this.style.borderColor = '#4facfe';
                });
                
                // 드래그 리브 이벤트
                uploadArea2.addEventListener('dragleave', function(event) {
                    event.preventDefault();
                    this.style.borderColor = '#ddd';
                });
                
                // 드롭 이벤트
                uploadArea2.addEventListener('drop', function(event) {
                    event.preventDefault();
                    this.style.borderColor = '#ddd';
                    
                    const files = event.dataTransfer.files;
                    processUploadedFiles2(files);
                });
                console.log('✅ 파일 드래그 앤 드롭 이벤트 리스너 추가 완료 (uploadArea2)');
            }

            // 지식 파일 설정 저장 버튼
            const saveKnowledgeBtn2 = document.getElementById('saveKnowledgeBtn2');
            if (saveKnowledgeBtn2) {
                saveKnowledgeBtn2.addEventListener('click', function() {
                    try {
                        console.log('💾 지식 파일 설정 저장 시작');
                        
                        const knowledgeData = JSON.parse(localStorage.getItem('chatbotKnowledgeBase') || '{"enabled": false, "files": [], "parsedData": []}');
                        
                        // 파싱된 데이터가 있으면 활성화
                        knowledgeData.enabled = knowledgeData.parsedData.length > 0;
                        
                        // 파일 목록 업데이트 (실제 파싱된 데이터에서 파일명 추출)
                        const fileNames = [...new Set(knowledgeData.parsedData.map(qa => qa.source).filter(Boolean))];
                        knowledgeData.files = fileNames;
                        
                        localStorage.setItem('chatbotKnowledgeBase', JSON.stringify(knowledgeData));
                        
                        const statusDiv = document.getElementById('knowledgeSettingsStatus2');
                        if (statusDiv) {
                            statusDiv.innerHTML = '<div style="color: green; padding: 10px; background: #d4edda; border-radius: 5px; margin-top: 10px;">✅ 지식 설정이 저장되었습니다!</div>';
                        }
                        
                        updateKnowledgeStatus2();
                        updateFileList2();
                        
                        alert('✅ 지식 설정이 성공적으로 저장되었습니다!');
                        
                    } catch (error) {
                        console.error('❌ 지식 설정 저장 실패:', error);
                        alert('❌ 지식 설정 저장에 실패했습니다: ' + error.message);
                    }
                });
                console.log('✅ 지식 파일 설정 저장 버튼 이벤트 리스너 추가 완료');
            }

            // 지식 검색 테스트 버튼
            const testKnowledgeBtn2 = document.getElementById('testKnowledgeBtn2');
            if (testKnowledgeBtn2) {
                testKnowledgeBtn2.addEventListener('click', function() {
                    const knowledgeData = JSON.parse(localStorage.getItem('chatbotKnowledgeBase') || '{"enabled": false, "files": [], "parsedData": []}');
                    
                    if (!knowledgeData.enabled || knowledgeData.parsedData.length === 0) {
                        alert('📚 지식 검색 테스트\n\n활성화된 지식베이스가 없습니다.\n\n사용법:\n1. 지식 파일을 업로드하세요 (.txt, .jsonl)\n2. "지식 파일 설정 저장" 버튼을 클릭하세요\n3. 이 버튼으로 업로드된 지식이 제대로 검색되는지 테스트하세요');
                        return;
                    }
                    
                    const testQuery = prompt(`🔍 지식 검색 테스트\n\n업로드된 ${knowledgeData.parsedData.length}개의 Q&A 중에서 검색할 질문을 입력하세요:\n\n예시: 진료시간, 예약방법, 치료비용 등`);
                    if (!testQuery) return;
                    
                    console.log('🔍 지식 검색 테스트:', testQuery);
                    console.log('검색 대상 Q&A 개수:', knowledgeData.parsedData.length);
                    
                    const result = searchInKnowledgeBase2(testQuery, knowledgeData.parsedData);
                    if (result) {
                        alert(`🔍 검색 결과:\n\nQ: ${result.question}\n\nA: ${result.answer}\n\n출처: ${result.source || '알 수 없음'}\n\n✅ 지식베이스가 정상적으로 작동합니다!`);
                    } else {
                        alert(`❌ 검색 결과 없음\n\n질문: "${testQuery}"\n\n관련 답변을 찾을 수 없습니다.\n다른 키워드로 검색해보세요.\n\n💡 업로드된 파일의 내용을 확인하려면 "📋 파싱된 Q&A 보기" 버튼을 사용하세요.`);
                    }
                });
                console.log('✅ 지식 검색 테스트 버튼 이벤트 리스너 추가 완료');
            }

            // 파싱된 Q&A 보기 버튼
            const showParsedDataBtn2 = document.getElementById('showParsedDataBtn2');
            if (showParsedDataBtn2) {
                showParsedDataBtn2.addEventListener('click', function() {
                    const parsedDataView2 = document.getElementById('parsedDataView2');
                    const parsedDataContent2 = document.getElementById('parsedDataContent2');
                    
                    if (parsedDataView2.style.display === 'none') {
                        const knowledgeData = JSON.parse(localStorage.getItem('chatbotKnowledgeBase') || '{"enabled": false, "files": [], "parsedData": []}');
                        
                        if (knowledgeData.parsedData.length === 0) {
                            alert('파싱된 Q&A 데이터가 없습니다.');
                            return;
                        }
                        
                        let content = '';
                        knowledgeData.parsedData.forEach((qa, index) => {
                            content += `
                                <div style="border-bottom: 1px solid #eee; padding: 15px 0;">
                                    <div style="font-weight: bold; color: #2c3e50; margin-bottom: 8px;">
                                        Q${index + 1}: ${qa.question}
                                    </div>
                                    <div style="color: #666; line-height: 1.5;">
                                        A: ${qa.answer}
                                    </div>
                                    <div style="font-size: 12px; color: #999; margin-top: 5px;">
                                        출처: ${qa.source || '알 수 없음'}
                                    </div>
                                </div>
                            `;
                        });
                        
                        parsedDataContent2.innerHTML = content;
                        parsedDataView2.style.display = 'block';
                        showParsedDataBtn2.textContent = '📋 파싱된 Q&A 숨기기';
                    } else {
                        parsedDataView2.style.display = 'none';
                        showParsedDataBtn2.textContent = '📋 파싱된 Q&A 보기';
                    }
                });
                console.log('✅ 파싱된 Q&A 보기 버튼 이벤트 리스너 추가 완료');
            }

            // 모든 지식 삭제 버튼
            const clearKnowledgeBtn2 = document.getElementById('clearKnowledgeBtn2');
            if (clearKnowledgeBtn2) {
                clearKnowledgeBtn2.addEventListener('click', function() {
                    if (confirm('⚠️ 모든 지식 데이터를 삭제하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다.')) {
                        try {
                            console.log('🗑️ 모든 지식 삭제 시작');
                            
                            // localStorage에서 지식 데이터 삭제
                            localStorage.removeItem('chatbotKnowledgeBase');
                            
                            // 파일 목록 초기화
                            const fileList2 = document.getElementById('fileList2');
                            if (fileList2) {
                                fileList2.innerHTML = '';
                            }
                            
                            // 파싱된 Q&A 보기 영역 숨기기
                            const parsedDataView2 = document.getElementById('parsedDataView2');
                            if (parsedDataView2) {
                                parsedDataView2.style.display = 'none';
                            }
                            
                            // 상태 업데이트
                            updateKnowledgeStatus2();
                            
                            const statusDiv = document.getElementById('knowledgeSettingsStatus2');
                            if (statusDiv) {
                                statusDiv.innerHTML = '<div style="color: #856404; padding: 10px; background: #fff3cd; border-radius: 5px; margin-top: 10px;">🗑️ 모든 지식 데이터가 삭제되었습니다.</div>';
                            }
                            
                            console.log('✅ 모든 지식 삭제 완료');
                            alert('✅ 모든 지식 데이터가 삭제되었습니다!');
                            
                        } catch (error) {
                            console.error('❌ 지식 삭제 실패:', error);
                            alert('❌ 지식 삭제에 실패했습니다: ' + error.message);
                        }
                    }
                });
                console.log('✅ 모든 지식 삭제 버튼 이벤트 리스너 추가 완료');
            }

            console.log('🔧 AI챗봇 관리자 페이지2 이벤트 리스너 설정 완료');
        }

        // AI 챗봇 관리자 페이지2 파일 업로드 처리 함수들
        function processUploadedFiles2(files) {
            console.log('파일 업로드 처리 시작 (관리자2):', files.length, '개');
            showStatus2('knowledgeSettingsStatus2', '📁 파일을 처리하고 있습니다...', 'success');
            
            let processedCount = 0;
            const totalFiles = files.length;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                console.log('파일 처리 중 (관리자2):', file.name, file.type, file.size);
                
                const fileData = {
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    uploadTime: new Date(),
                    content: ''
                };
                
                // 파일 확장자 확인
                const fileExtension = file.name.toLowerCase().split('.').pop();
                
                // PDF 파일 경고
                if (fileExtension === 'pdf' || file.type === 'application/pdf') {
                    console.warn('PDF 파일 감지 (관리자2):', file.name);
                    processedCount++;
                    
                    if (processedCount === totalFiles) {
                        showStatus2('knowledgeSettingsStatus2', 
                            `❌ PDF 파일은 현재 지원되지 않습니다.\nPDF 내용을 텍스트 파일(.txt)로 복사해서 업로드해주세요.`, 
                            'error');
                    }
                    continue;
                }
                
                // 지원되는 파일 형식 처리
                if (fileExtension === 'txt' || file.type === 'text/plain' || file.type === '') {
                    // 텍스트 파일 처리
                    processTextFileWithEncoding2(file, fileData, () => {
                        processedCount++;
                        checkAllFilesProcessed2();
                    });

                } else if (fileExtension === 'jsonl' || file.type === 'application/jsonl' || file.type === 'text/plain') {
                    // JSONL 파일 처리
                    processJsonlFile2(file, fileData, () => {
                        processedCount++;
                        checkAllFilesProcessed2();
                    });
                } else {
                    // 지원되지 않는 파일 형식
                    console.warn('지원되지 않는 파일 형식 (관리자2):', file.name, file.type);
                    processedCount++;
                    
                    if (processedCount === totalFiles) {
                        showStatus2('knowledgeSettingsStatus2', 
                            `❌ 지원되지 않는 파일 형식입니다: ${file.name}\n\n📁 현재 지원되는 파일 형식:\n• 텍스트 파일 (.txt)\n• JSONL 파일 (.jsonl)`, 
                            'error');
                    }
                    checkAllFilesProcessed2();
                }
            }
            
            // 모든 파일 처리 완료 확인 함수
            function checkAllFilesProcessed2() {
                if (processedCount === totalFiles) {
                    console.log('전체 파일 처리 완료 (관리자2)');
                    
                    // 지식베이스 자동 활성화
                    const knowledgeData = JSON.parse(localStorage.getItem('chatbotKnowledgeBase') || '{"enabled": false, "files": [], "parsedData": []}');
                    knowledgeData.enabled = knowledgeData.parsedData.length > 0;
                    localStorage.setItem('chatbotKnowledgeBase', JSON.stringify(knowledgeData));
                    
                    // 파일 목록과 상태 업데이트
                    updateFileList2();
                    updateKnowledgeStatus2();
                    
                    if (knowledgeData.parsedData.length > 0) {
                        const message = `✅ ${totalFiles}개 파일 처리 완료!\n📚 총 ${knowledgeData.parsedData.length}개의 Q&A가 파싱되었습니다.\n🤖 지식베이스가 자동으로 활성화되었습니다!\n\n💾 "지식 파일 설정 저장" 버튼을 클릭하여 설정을 저장하세요.`;
                        showStatus2('knowledgeSettingsStatus2', message, 'success');
                    } else {
                        showStatus2('knowledgeSettingsStatus2', 
                            `⚠️ 파일은 읽었지만 Q&A 데이터를 찾지 못했습니다.\n\n📝 올바른 형식 예시:\nQ: 진료시간이 어떻게 되나요?\nA: 평일 09:00-18:00입니다.`, 
                            'error');
                    }
                }
            }
        }

        // 텍스트 파일을 다양한 인코딩으로 읽기 시도 (관리자2)
        function processTextFileWithEncoding2(file, fileData, callback) {
            console.log('🔤 텍스트 파일 인코딩 처리 (관리자2):', file.name);
            
            // UTF-8로 먼저 시도
            const reader1 = new FileReader();
            reader1.onload = function(e) {
                try {
                    const content = e.target.result;
                    
                    // 한글이 제대로 읽혔는지 확인
                    const hasKorean = /[가-힣]/.test(content);
                    const hasBrokenChars = /[◆]/.test(content) || content.includes('');
                    
                    if (hasKorean && !hasBrokenChars) {
                        console.log('✅ UTF-8 인코딩 성공 (관리자2):', file.name);
                        fileData.content = content;
                        processKnowledgeFile2(fileData);
                        callback();
                        return;
                    }
                    
                    console.log('❌ UTF-8 실패, EUC-KR 시도 (관리자2)');
                    // EUC-KR로 재시도
                    tryEucKrEncoding2();
                    
                } catch (error) {
                    console.error('UTF-8 읽기 오류 (관리자2):', error);
                    tryEucKrEncoding2();
                }
            };
            
            reader1.onerror = function() {
                console.error('UTF-8 파일 읽기 오류 (관리자2)');
                tryEucKrEncoding2();
            };
            
            // EUC-KR 시도 함수
            function tryEucKrEncoding2() {
                const reader2 = new FileReader();
                reader2.onload = function(e) {
                    try {
                        const content = e.target.result;
                        const hasKorean = /[가-힣]/.test(content);
                        const hasBrokenChars = /[◆]/.test(content) || content.includes('');
                        
                        if (hasKorean && !hasBrokenChars) {
                            console.log('✅ EUC-KR 인코딩 성공 (관리자2):', file.name);
                            fileData.content = content;
                            processKnowledgeFile2(fileData);
                            callback();
                            return;
                        }
                        
                        // 둘 다 실패한 경우 UTF-8 결과 사용
                        console.log('⚠️ 한글 감지 실패, UTF-8 결과 사용 (관리자2):', file.name);
                        fileData.content = reader1.result || '';
                        processKnowledgeFile2(fileData);
                        callback();
                        
                    } catch (error) {
                        console.error('EUC-KR 읽기 오류 (관리자2):', error);
                        // 마지막 수단으로 UTF-8 사용
                        fileData.content = reader1.result || '';
                        processKnowledgeFile2(fileData);
                        callback();
                    }
                };
                
                reader2.onerror = function() {
                    console.error('EUC-KR 파일 읽기 오류 (관리자2)');
                    // UTF-8 결과라도 사용
                    fileData.content = reader1.result || '';
                    processKnowledgeFile2(fileData);
                    callback();
                };
                
                reader2.readAsText(file, 'EUC-KR');
            }
            
            // UTF-8부터 시작
            reader1.readAsText(file, 'UTF-8');
        }



        // JSONL 파일 처리 함수 (관리자2)
        function processJsonlFile2(file, fileData, callback) {
            console.log('📄 JSONL 파일 처리 시작 (관리자2):', file.name);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    fileData.content = content;
                    processJsonlContent2(fileData);
                    callback();
                    
                } catch (error) {
                    console.error('JSONL 파일 처리 오류 (관리자2):', error);
                    showStatus2('knowledgeSettingsStatus2', 
                        `❌ JSONL 파일 처리 실패: ${file.name}`, 
                        'error');
                    callback();
                }
            };
            
            reader.onerror = function() {
                console.error('JSONL 파일 읽기 오류 (관리자2)');
                showStatus2('knowledgeSettingsStatus2', 
                    `❌ JSONL 파일 읽기 실패: ${file.name}`, 
                    'error');
                callback();
            };
            
            reader.readAsText(file, 'UTF-8');
        }

        // JSONL 내용 처리 (관리자2)
        function processJsonlContent2(fileData) {
            console.log('📄 JSONL 내용 처리 (관리자2):', fileData.name);
            
            if (!fileData.content || fileData.content.trim().length === 0) {
                console.log('JSONL 내용이 비어있음 (관리자2):', fileData.name);
                return;
            }
            
            const content = fileData.content;
            const lines = content.split(/\r?\n/).map(line => line.trim()).filter(line => line.length > 0);
            console.log('JSONL 파싱할 라인 수 (관리자2):', lines.length);
            
            const parsedQA = [];
            
            // 각 라인을 JSON으로 파싱
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                
                try {
                    const jsonData = JSON.parse(line);
                    
                    // 다양한 JSON 구조 지원
                    let question = '';
                    let answer = '';
                    
                    if (jsonData.question && jsonData.answer) {
                        question = jsonData.question;
                        answer = jsonData.answer;
                    } else if (jsonData.q && jsonData.a) {
                        question = jsonData.q;
                        answer = jsonData.a;
                    } else if (jsonData.질문 && jsonData.답변) {
                        question = jsonData.질문;
                        answer = jsonData.답변;
                    } else if (jsonData.text && jsonData.response) {
                        question = jsonData.text;
                        answer = jsonData.response;
                    } else if (jsonData.prompt && jsonData.completion) {
                        question = jsonData.prompt;
                        answer = jsonData.completion;
                    } else if (jsonData.input && jsonData.output) {
                        question = jsonData.input;
                        answer = jsonData.output;
                    }
                    
                    if (question && answer && question.length > 2 && answer.length > 3) {
                        const qaItem = {
                            question: question,
                            answer: answer,
                            source: fileData.name,
                            lineNumber: i + 1,
                            pattern: 'JSONL'
                        };
                        
                        parsedQA.push(qaItem);
                        console.log('JSONL Q&A 추가 (관리자2):', question.substring(0, 30) + '...');
                    }
                    
                } catch (error) {
                    console.warn(`JSONL 라인 ${i + 1} 파싱 실패 (관리자2):`, error);
                    continue;
                }
            }
            
            // 기존 데이터에 추가 (중복 제거)
            const knowledgeData = JSON.parse(localStorage.getItem('chatbotKnowledgeBase') || '{"enabled": false, "files": [], "parsedData": []}');
            parsedQA.forEach(newQA => {
                const isDuplicate = knowledgeData.parsedData.some(existingQA => 
                    existingQA.question === newQA.question && existingQA.source === newQA.source
                );
                
                if (!isDuplicate) {
                    knowledgeData.parsedData.push(newQA);
                }
            });
            
            localStorage.setItem('chatbotKnowledgeBase', JSON.stringify(knowledgeData));
            console.log(`${fileData.name}에서 새로 파싱된 Q&A (관리자2):`, parsedQA.length, '개');
        }

        // 지식 파일 처리 함수 (관리자2)
        function processKnowledgeFile2(fileData) {
            console.log('지식 파일 처리 (관리자2):', fileData.name);
            
            if (!fileData.content || fileData.content.trim().length === 0) {
                console.log('파일 내용이 비어있음 (관리자2):', fileData.name);
                return;
            }
            
            const content = fileData.content;
            const lines = content.split(/\r?\n/).map(line => line.trim()).filter(line => line.length > 0);
            console.log('파싱할 라인 수 (관리자2):', lines.length);
            
            const parsedQA = [];
            
            // 패턴별 파싱 시도
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                let question = '';
                let answer = '';
                
                // 패턴 1: Q: 질문, A: 답변
                if (line.match(/^[QqㅁㅂㅊㄷㄹㅁㅏqQuestion문질의질문]\s*[:：]\s*(.+)$/i)) {
                    question = line.replace(/^[QqㅁㅂㅊㄷㄹㅁㅏqQuestion문질의질문]\s*[:：]\s*/i, '').trim();
                    
                    // 다음 줄에서 답변 찾기
                    for (let j = i + 1; j < lines.length && j < i + 5; j++) {
                        const nextLine = lines[j];
                        if (nextLine.match(/^[AaAnsw답변답응답]\s*[:：]\s*(.+)$/i)) {
                            answer = nextLine.replace(/^[AaAnsw답변답응답]\s*[:：]\s*/i, '').trim();
                            i = j; // 인덱스 업데이트
                            break;
                        } else if (!nextLine.match(/^[QqㅁㅂㅊㄷㄹㅁㅏqQuestion문질의질문]\s*[:：]/i)) {
                            // Q:가 아니면 답변으로 간주
                            answer = nextLine;
                            i = j;
                            break;
                        }
                    }
                }
                
                // 패턴 2: 숫자. 질문?
                else if (line.match(/^\d+\.\s*(.+[?？])\s*$/)) {
                    question = line.replace(/^\d+\.\s*/, '').trim();
                    if (i + 1 < lines.length && !lines[i + 1].match(/^\d+\./)) {
                        answer = lines[i + 1];
                        i++;
                    }
                }
                
                // 패턴 3: - 질문?
                else if (line.match(/^[-•*]\s*(.+[?？])\s*$/)) {
                    question = line.replace(/^[-•*]\s*/, '').trim();
                    if (i + 1 < lines.length && !lines[i + 1].match(/^[-•*]/)) {
                        answer = lines[i + 1];
                        i++;
                    }
                }
                
                // 패턴 4: 질문 키워드 포함
                else if (line.length > 5 && 
                         (line.includes('?') || line.includes('？') ||
                          line.match(/(어떻게|언제|어디서|왜|무엇|누가|얼마|몇시|어떤|뭔가|어디|몇|언제까지)/))) {
                    question = line;
                    
                    // 다음 몇 줄을 답변으로 수집
                    const answerLines = [];
                    for (let j = i + 1; j < Math.min(i + 4, lines.length); j++) {
                        const nextLine = lines[j];
                        // 다음 질문이 나오면 중단
                        if (nextLine.match(/(어떻게|언제|어디서|왜|무엇|누가|얼마|몇시|어떤)[?？]/) ||
                            nextLine.match(/^[\d\-•*QqㅁㅂㅊㄷㄹㅁㅏqQuestion문질의질문]/)) {
                            break;
                        }
                        answerLines.push(nextLine);
                        if (answerLines.join(' ').length > 200) break; // 너무 길면 중단
                    }
                    
                    if (answerLines.length > 0) {
                        answer = answerLines.join(' ').trim();
                        i += answerLines.length;
                    }
                }
                
                // 패턴 5: 제목: 내용
                else if (line.match(/^([^:：]{2,20})[:：]\s*(.{5,})$/)) {
                    const matches = line.match(/^([^:：]{2,20})[:：]\s*(.{5,})$/);
                    if (matches) {
                        question = matches[1].trim();
                        answer = matches[2].trim();
                    }
                }
                
                // 유효한 Q&A 쌍 저장
                if (question && answer && question.length > 2 && answer.length > 3) {
                    const qaItem = {
                        question: question,
                        answer: answer,
                        source: fileData.name,
                        lineNumber: i + 1,
                        pattern: '자동감지'
                    };
                    
                    parsedQA.push(qaItem);
                    console.log('Q&A 추가 (관리자2):', question.substring(0, 30) + '...');
                }
            }
            
            // 기존 데이터에 추가 (중복 제거)
            const knowledgeData = JSON.parse(localStorage.getItem('chatbotKnowledgeBase') || '{"enabled": false, "files": [], "parsedData": []}');
            parsedQA.forEach(newQA => {
                const isDuplicate = knowledgeData.parsedData.some(existingQA => 
                    existingQA.question === newQA.question && existingQA.source === newQA.source
                );
                
                if (!isDuplicate) {
                    knowledgeData.parsedData.push(newQA);
                }
            });
            
            localStorage.setItem('chatbotKnowledgeBase', JSON.stringify(knowledgeData));
            console.log(`${fileData.name}에서 새로 파싱된 Q&A (관리자2):`, parsedQA.length, '개');
        }

        // 파일 목록 업데이트 (관리자2)
        function updateFileList2() {
            const fileList2 = document.getElementById('fileList2');
            if (!fileList2) return;
            
            const knowledgeData = JSON.parse(localStorage.getItem('chatbotKnowledgeBase') || '{"enabled": false, "files": [], "parsedData": []}');
            
            // 파일별 Q&A 개수 계산
            const fileQACounts = {};
            knowledgeData.parsedData.forEach(qa => {
                if (qa.source) {
                    fileQACounts[qa.source] = (fileQACounts[qa.source] || 0) + 1;
                }
            });
            
            // 파일 목록 생성
            let fileListHTML = '';
            Object.keys(fileQACounts).forEach(filename => {
                const qaCount = fileQACounts[filename];
                fileListHTML += `
                    <div class="file-item" style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 5px; margin-bottom: 10px;">
                        <div>
                            <strong>📄 ${filename}</strong>
                            <div style="font-size: 12px; color: #666;">Q&A: ${qaCount}개</div>
                        </div>
                        <button onclick="removeFile2('${filename}')" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">삭제</button>
                    </div>
                `;
            });
            
            fileList2.innerHTML = fileListHTML;
        }

        // 파일 삭제 (관리자2)
        function removeFile2(filename) {
            if (confirm(`파일 "${filename}"을 삭제하시겠습니까?`)) {
                const knowledgeData = JSON.parse(localStorage.getItem('chatbotKnowledgeBase') || '{"enabled": false, "files": [], "parsedData": []}');
                
                // 해당 파일의 Q&A 데이터 삭제
                knowledgeData.parsedData = knowledgeData.parsedData.filter(qa => qa.source !== filename);
                
                localStorage.setItem('chatbotKnowledgeBase', JSON.stringify(knowledgeData));
                
                updateFileList2();
                updateKnowledgeStatus2();
                
                alert(`파일 "${filename}"이 삭제되었습니다.`);
            }
        }

        // 지식 상태 업데이트 (관리자2)
        function updateKnowledgeStatus2() {
            const knowledgeData = JSON.parse(localStorage.getItem('chatbotKnowledgeBase') || '{"enabled": false, "files": [], "parsedData": []}');
            const fileItems = document.querySelectorAll('#fileList2 .file-item');
            
            const statusDiv = document.getElementById('knowledgeStatus2');
            if (statusDiv) {
                statusDiv.innerHTML = `📖 업로드된 지식 파일: ${fileItems.length}개 | 파싱된 Q&A: ${knowledgeData.parsedData.length}개 | 상태: ${knowledgeData.enabled ? '활성' : '비활성'}`;
            }
        }

        // 지식베이스 검색 (관리자2)
        function searchInKnowledgeBase2(query, parsedData) {
            const normalizedQuery = query.toLowerCase().trim();
            let bestMatch = null;
            let bestScore = 0;
            
            for (const qa of parsedData) {
                const question = qa.question.toLowerCase();
                const answer = qa.answer.toLowerCase();
                
                let score = 0;
                
                // 질문에서 키워드 매칭
                const queryWords = normalizedQuery.split(' ');
                for (const word of queryWords) {
                    if (question.includes(word)) score += 2;
                    if (answer.includes(word)) score += 1;
                }
                
                // 정확한 문구 매칭
                if (question.includes(normalizedQuery)) score += 5;
                if (answer.includes(normalizedQuery)) score += 3;
                
                if (score > bestScore) {
                    bestScore = score;
                    bestMatch = qa;
                }
            }
            
            return bestScore > 0 ? bestMatch : null;
        }

        // 상태 메시지 표시 (관리자2)
        function showStatus2(elementId, message, type) {
            const statusDiv = document.getElementById(elementId);
            if (statusDiv) {
                let bgColor, textColor;
                switch (type) {
                    case 'success':
                        bgColor = '#d4edda';
                        textColor = 'green';
                        break;
                    case 'error':
                        bgColor = '#f8d7da';
                        textColor = '#721c24';
                        break;
                    default:
                        bgColor = '#fff3cd';
                        textColor = '#856404';
                }
                
                statusDiv.innerHTML = `<div style="color: ${textColor}; padding: 10px; background: ${bgColor}; border-radius: 5px; margin-top: 10px;">${message}</div>`;
            }
        }



        // 서비스 상세 페이지
        function showServiceDetail(serviceType) {
            console.log('서비스 상세 페이지 열기:', serviceType);
            
            const services = {
                general: {
                    title: '🦷 일반진료',
                    content: `
                        <div style="background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
                            <h3 style="color: #2c3e50; margin-bottom: 15px;">🔍 정밀 검진 및 진단</h3>
                            <ul style="list-style: none; padding: 0;">
                                <li style="padding: 8px 0; border-bottom: 1px solid #f0f0f0;">✓ 3D 디지털 파노라마 촬영으로 정확한 진단</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #f0f0f0;">✓ 구강 내 카메라를 이용한 상세 검사</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #f0f0f0;">✓ 치아 우식증(충치) 조기 발견 및 치료</li>
                                <li style="padding: 8px 0;">✓ 잇몸병(치주염) 예방 및 치료</li>
                            </ul>
                        </div>
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px; padding: 20px; text-align: center;">
                            <h4 style="margin-bottom: 15px;">💰 진료비 안내</h4>
                            <p>초진료: 15,000원 | 재진료: 10,000원</p>
                            <p>스케일링: 50,000원 (건강보험 적용 시 연 1회 무료)</p>
                        </div>
                        <button class="btn btn-primary" onclick="closeServiceDetail()" style="width: 100%; margin-top: 20px; padding: 15px;">🏠 메인으로 돌아가기</button>
                    `
                },
                whitening: {
                    title: '✨ 미백치료',
                    content: `
                        <div style="background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
                            <h3 style="color: #2c3e50; margin-bottom: 15px;">💎 전문가 미백 시술</h3>
                            <ul style="list-style: none; padding: 0;">
                                <li style="padding: 8px 0; border-bottom: 1px solid #f0f0f0;">✓ 1회 시술로 3-8단계 밝아지는 효과</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #f0f0f0;">✓ 안전한 과산화수소 젤 사용</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #f0f0f0;">✓ LED 광선을 이용한 빠른 미백</li>
                                <li style="padding: 8px 0;">✓ 시술 후 즉시 효과 확인 가능</li>
                            </ul>
                        </div>
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px; padding: 20px; text-align: center;">
                            <h4 style="margin-bottom: 15px;">💰 미백 치료비</h4>
                            <p>전문가 미백: 300,000원</p>
                            <p>홈케어 미백: 200,000원</p>
                        </div>
                        <button class="btn btn-primary" onclick="closeServiceDetail()" style="width: 100%; margin-top: 20px; padding: 15px;">🏠 메인으로 돌아가기</button>
                    `
                },
                orthodontics: {
                    title: '🔧 교정치료',
                    content: `
                        <div style="background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
                            <h3 style="color: #2c3e50; margin-bottom: 15px;">📏 정밀 교정 진단</h3>
                            <ul style="list-style: none; padding: 0;">
                                <li style="padding: 8px 0; border-bottom: 1px solid #f0f0f0;">✓ 3D 구강 스캔을 통한 정확한 분석</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #f0f0f0;">✓ 개인별 맞춤 교정 계획 수립</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #f0f0f0;">✓ 치료 전후 예상 모습 시뮬레이션</li>
                                <li style="padding: 8px 0;">✓ 부분교정부터 전체교정까지</li>
                            </ul>
                        </div>
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px; padding: 20px; text-align: center;">
                            <h4 style="margin-bottom: 15px;">💰 교정 치료비</h4>
                            <p>부분교정: 1,500,000원</p>
                            <p>전체교정: 3,500,000원 ~ 6,000,000원</p>
                        </div>
                        <button class="btn btn-primary" onclick="closeServiceDetail()" style="width: 100%; margin-top: 20px; padding: 15px;">🏠 메인으로 돌아가기</button>
                    `
                },
                implant: {
                    title: '🦴 임플란트',
                    content: `
                        <div style="background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
                            <h3 style="color: #2c3e50; margin-bottom: 15px;">🏥 첨단 임플란트 시술</h3>
                            <ul style="list-style: none; padding: 0;">
                                <li style="padding: 8px 0; border-bottom: 1px solid #f0f0f0;">✓ 3D CT 촬영으로 정밀한 식립 위치 결정</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #f0f0f0;">✓ 디지털 가이드를 이용한 안전한 수술</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #f0f0f0;">✓ 프리미엄 임플란트 피스처 사용</li>
                                <li style="padding: 8px 0;">✓ 무절개 수술로 빠른 회복</li>
                            </ul>
                        </div>
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px; padding: 20px; text-align: center;">
                            <h4 style="margin-bottom: 15px;">💰 임플란트 비용</h4>
                            <p>일반 임플란트: 1,200,000원</p>
                            <p>프리미엄 임플란트: 1,500,000원</p>
                        </div>
                        <button class="btn btn-primary" onclick="closeServiceDetail()" style="width: 100%; margin-top: 20px; padding: 15px;">🏠 메인으로 돌아가기</button>
                    `
                },
                prosthetic: {
                    title: '👑 보철치료',
                    content: `
                        <div style="background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
                            <h3 style="color: #2c3e50; margin-bottom: 15px;">👑 정밀 보철 제작</h3>
                            <ul style="list-style: none; padding: 0;">
                                <li style="padding: 8px 0; border-bottom: 1px solid #f0f0f0;">✓ 지르코니아 크라운으로 자연스러운 색상</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #f0f0f0;">✓ CAD/CAM 시스템으로 정밀 제작</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #f0f0f0;">✓ 개인별 치아 색상 매칭</li>
                                <li style="padding: 8px 0;">✓ 오래 사용할 수 있는 내구성</li>
                            </ul>
                        </div>
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px; padding: 20px; text-align: center;">
                            <h4 style="margin-bottom: 15px;">💰 보철 치료비</h4>
                            <p>지르코니아 크라운: 800,000원</p>
                            <p>브릿지(3본): 2,400,000원</p>
                        </div>
                        <button class="btn btn-primary" onclick="closeServiceDetail()" style="width: 100%; margin-top: 20px; padding: 15px;">🏠 메인으로 돌아가기</button>
                    `
                },
                pediatric: {
                    title: '🧒 소아치과',
                    content: `
                        <div style="background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
                            <h3 style="color: #2c3e50; margin-bottom: 15px;">👶 어린이 전용 진료</h3>
                            <ul style="list-style: none; padding: 0;">
                                <li style="padding: 8px 0; border-bottom: 1px solid #f0f0f0;">✓ 어린이 친화적인 진료 환경</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #f0f0f0;">✓ 놀이를 통한 치료 공포감 해소</li>
                                <li style="padding: 8px 0; border-bottom: 1px solid #f0f0f0;">✓ 무해한 마취제 사용</li>
                                <li style="padding: 8px 0;">✓ 부모님과 함께 진료 가능</li>
                            </ul>
                        </div>
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px; padding: 20px; text-align: center;">
                            <h4 style="margin-bottom: 15px;">💰 소아 치료비</h4>
                            <p>어린이 검진: 10,000원</p>
                            <p>실란트(1개): 30,000원</p>
                        </div>
                        <button class="btn btn-primary" onclick="closeServiceDetail()" style="width: 100%; margin-top: 20px; padding: 15px;">🏠 메인으로 돌아가기</button>
                    `
                }
            };
            
            if (services[serviceType]) {
                document.getElementById('serviceDetailTitle').textContent = services[serviceType].title;
                document.getElementById('serviceDetailContent').innerHTML = services[serviceType].content;
                document.getElementById('serviceDetailPage').style.display = 'block';
            }
        }

        function closeServiceDetail() {
            console.log('서비스 상세 페이지 닫기');
            document.getElementById('serviceDetailPage').style.display = 'none';
        }







        // 진료시간 표 생성
        function createClinicHoursTable(response) {
            const table = `
                <div style="background: #f8f9fa; border-radius: 10px; padding: 15px; margin: 10px 0;">
                    <h4 style="color: #2c3e50; margin-bottom: 15px;">🏥 진료시간 안내</h4>
                    <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
                                <th style="padding: 12px; text-align: center; border: none;">요일</th>
                                <th style="padding: 12px; text-align: center; border: none;">진료시간</th>
                                <th style="padding: 12px; text-align: center; border: none;">비고</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 12px; text-align: center; font-weight: bold; color: #2c3e50;">평일</td>
                                <td style="padding: 12px; text-align: center;">09:00 ~ 18:00</td>
                                <td style="padding: 12px; text-align: center; color: #27ae60;">정상진료</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 12px; text-align: center; font-weight: bold; color: #2c3e50;">토요일</td>
                                <td style="padding: 12px; text-align: center;">09:00 ~ 15:00</td>
                                <td style="padding: 12px; text-align: center; color: #e67e22;">단축진료</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 12px; text-align: center; font-weight: bold; color: #2c3e50;">점심시간</td>
                                <td style="padding: 12px; text-align: center;">12:30 ~ 13:30</td>
                                <td style="padding: 12px; text-align: center; color: #e74c3c;">진료중단</td>
                            </tr>
                            <tr>
                                <td style="padding: 12px; text-align: center; font-weight: bold; color: #2c3e50;">일요일/공휴일</td>
                                <td style="padding: 12px; text-align: center;">-</td>
                                <td style="padding: 12px; text-align: center; color: #e74c3c;">휴진</td>
                            </tr>
                        </tbody>
                    </table>
                    <div style="margin-top: 15px; padding: 10px; background: #e8f5e8; border-radius: 6px; border-left: 4px solid #27ae60;">
                        <strong>💡 안내사항:</strong> 응급상담이 필요하시면 070-1234-1234로 언제든 연락주세요!
                    </div>
                </div>
            `;
            
            return table;
        }

        // 치료비용 표 생성
        function createTreatmentCostTable(response) {
            const table = `
                <div style="background: #f8f9fa; border-radius: 10px; padding: 15px; margin: 10px 0;">
                    <h4 style="color: #2c3e50; margin-bottom: 15px;">💰 치료비용 안내</h4>
                    <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%); color: white;">
                                <th style="padding: 12px; text-align: center; border: none;">진료과목</th>
                                <th style="padding: 12px; text-align: center; border: none;">비용</th>
                                <th style="padding: 12px; text-align: center; border: none;">비고</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 12px; text-align: center; font-weight: bold; color: #2c3e50;">일반진료</td>
                                <td style="padding: 12px; text-align: center;">초진 15,000원<br>재진 10,000원</td>
                                <td style="padding: 12px; text-align: center; color: #27ae60;">기본진료</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 12px; text-align: center; font-weight: bold; color: #2c3e50;">스케일링</td>
                                <td style="padding: 12px; text-align: center;">50,000원</td>
                                <td style="padding: 12px; text-align: center; color: #3498db;">건강보험 적용 시 연 1회 무료</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 12px; text-align: center; font-weight: bold; color: #2c3e50;">미백치료</td>
                                <td style="padding: 12px; text-align: center;">200,000~300,000원</td>
                                <td style="padding: 12px; text-align: center; color: #e67e22;">미용치료</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 12px; text-align: center; font-weight: bold; color: #2c3e50;">교정치료</td>
                                <td style="padding: 12px; text-align: center;">1,500,000~6,000,000원</td>
                                <td style="padding: 12px; text-align: center; color: #9b59b6;">장기치료</td>
                            </tr>
                            <tr>
                                <td style="padding: 12px; text-align: center; font-weight: bold; color: #2c3e50;">임플란트</td>
                                <td style="padding: 12px; text-align: center;">1,200,000~1,500,000원</td>
                                <td style="padding: 12px; text-align: center; color: #e74c3c;">수술치료</td>
                            </tr>
                        </tbody>
                    </table>
                    <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 6px; border-left: 4px solid #ffc107;">
                        <strong>💡 안내사항:</strong> 정확한 비용은 개인별 진료 계획에 따라 달라질 수 있습니다. 상담 시 정확한 견적을 안내해드립니다.
                    </div>
                </div>
            `;
            
            return table;
        }

        // 예약 안내 표 생성
        function createReservationTable(response) {
            const table = `
                <div style="background: #f8f9fa; border-radius: 10px; padding: 15px; margin: 10px 0;">
                    <h4 style="color: #2c3e50; margin-bottom: 15px;">📞 예약 및 상담 안내</h4>
                    <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #ff69b4 0%, #ff1493 100%); color: white;">
                                <th style="padding: 12px; text-align: center; border: none;">구분</th>
                                <th style="padding: 12px; text-align: center; border: none;">내용</th>
                                <th style="padding: 12px; text-align: center; border: none;">연락처</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 12px; text-align: center; font-weight: bold; color: #2c3e50;">일반 예약</td>
                                <td style="padding: 12px; text-align: center;">진료시간 내 전화 예약</td>
                                <td style="padding: 12px; text-align: center; color: #27ae60;">070-1234-1234</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 12px; text-align: center; font-weight: bold; color: #2c3e50;">응급 상담</td>
                                <td style="padding: 12px; text-align: center;">24시간 응급 상담</td>
                                <td style="padding: 12px; text-align: center; color: #e74c3c;">070-1234-1234</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 12px; text-align: center; font-weight: bold; color: #2c3e50;">온라인 예약</td>
                                <td style="padding: 12px; text-align: center;">24시간 온라인 예약 가능</td>
                                <td style="padding: 12px; text-align: center; color: #3498db;">예약 페이지</td>
                            </tr>
                            <tr>
                                <td style="padding: 12px; text-align: center; font-weight: bold; color: #2c3e50;">상담 문의</td>
                                <td style="padding: 12px; text-align: center;">치료 방법 및 비용 상담</td>
                                <td style="padding: 12px; text-align: center; color: #9b59b6;">무료 상담</td>
                            </tr>
                        </tbody>
                    </table>
                    <div style="margin-top: 15px; padding: 10px; background: #e8f5e8; border-radius: 6px; border-left: 4px solid #27ae60;">
                        <strong>💡 안내사항:</strong> 예약 시 본인 확인을 위해 생년월일과 전화번호를 준비해주세요!
                    </div>
                </div>
            `;
            
            return table;
        }

        // 오시는길 표 생성
        function createDirectionsTable(response) {
            const table = `
                <div style="background: #f8f9fa; border-radius: 10px; padding: 15px; margin: 10px 0;">
                    <h4 style="color: #2c3e50; margin-bottom: 15px;">🗺️ 오시는길 안내</h4>
                    <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%); color: white;">
                                <th style="padding: 12px; text-align: center; border: none;">구분</th>
                                <th style="padding: 12px; text-align: center; border: none;">내용</th>
                                <th style="padding: 12px; text-align: center; border: none;">소요시간</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 12px; text-align: center; font-weight: bold; color: #2c3e50;">주소</td>
                                <td style="padding: 12px; text-align: center;">피닉스시 피닉스로 11길 11<br>피닉스타워 11층 11호</td>
                                <td style="padding: 12px; text-align: center; color: #27ae60;">-</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 12px; text-align: center; font-weight: bold; color: #2c3e50;">지하철</td>
                                <td style="padding: 12px; text-align: center;">지하철 2호선 강남역<br>3번 출구 도보</td>
                                <td style="padding: 12px; text-align: center; color: #3498db;">5분</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 12px; text-align: center; font-weight: bold; color: #2c3e50;">버스</td>
                                <td style="padding: 12px; text-align: center;">강남역 정류장 하차<br>도보 이동</td>
                                <td style="padding: 12px; text-align: center; color: #e67e22;">3분</td>
                            </tr>
                            <tr>
                                <td style="padding: 12px; text-align: center; font-weight: bold; color: #2c3e50;">주차</td>
                                <td style="padding: 12px; text-align: center;">건물 지하 1-3층<br>무료 주차 (3시간)</td>
                                <td style="padding: 12px; text-align: center; color: #9b59b6;">무료</td>
                            </tr>
                        </tbody>
                    </table>
                    <div style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 6px; border-left: 4px solid #2196f3;">
                        <strong>💡 안내사항:</strong> 주차는 건물 지하 1-3층에서 가능하며, 진료 후 3시간 무료 주차 서비스를 제공합니다!
                    </div>
                </div>
            `;
            
            return table;
        }

        // 일반 응답 구조화
        function structureGeneralResponse(response) {
            // 줄바꿈과 구조화
            let formattedResponse = response
                .replace(/\n\n/g, '<br><br>')
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // 리스트 형태로 변환
            formattedResponse = formattedResponse.replace(/(\d+\.|\-|\•)\s*(.*?)(?=<br>|$)/g, '<li style="margin: 5px 0; padding-left: 10px;">$2</li>');
            
            // 리스트가 있으면 ul 태그로 감싸기
            if (formattedResponse.includes('<li')) {
                formattedResponse = formattedResponse.replace(/(<li.*?<\/li>)/g, '<ul style="margin: 10px 0; padding-left: 20px;">$1</ul>');
            }
            
            return `
                <div style="background: #f8f9fa; border-radius: 10px; padding: 15px; margin: 10px 0; line-height: 1.6;">
                    ${formattedResponse}
                </div>
            `;
        }

        // 실제 AI API 호출 함수
        async function callAIAPI(userMessage) {
            const provider = apiSettings.activeProvider;
            const settings = apiSettings[provider];
            
            try {
                let response;
                
                switch (provider) {
                    case 'chatgpt':
                        response = await callChatGPTAPI(userMessage, settings);
                        break;
                    case 'gemini':
                        response = await callGeminiAPI(userMessage, settings);
                        break;
                    case 'claude':
                        response = await callClaudeAPI(userMessage, settings);
                        break;
                    default:
                        return getDefaultResponse(userMessage);
                }
                
                return `🤖 <strong>AI 응답 (${provider.toUpperCase()})</strong><br><br>${response}`;
                
            } catch (error) {
                console.error('AI API 호출 오류:', error);
                return `❌ <strong>AI 응답 오류</strong><br><br>
                API 호출 중 오류가 발생했습니다: ${error.message}<br>
                API 키와 설정을 확인해주세요.<br><br>
                ${getDefaultResponse(userMessage)}`;
            }
        }

        // ChatGPT API 호출 (컨텍스트 포함)
        async function callChatGPTAPIWithContext(message, settings, contextInfo) {
            const systemPrompt = `당신은 피닉스 치과 병원의 전문 AI 상담사입니다. 
            매우 친절하고 전문적으로 답변해주세요.

            === 병원 기본 정보 ===
            • 병원명: 피닉스 치과 병원
            • 원장: 홍길동 (25년 경력 치주질환 전문의)
            • 진료시간: 평일 09:00-18:00, 토요일 09:00-15:00, 점심시간 12:30-13:30
            • 휴진: 일요일, 공휴일
            • 전화: 070-1234-1234 (24시간 응급상담 가능)
            • 주소: 피닉스시 피닉스로 11길 11, 피닉스타워 11층 11호
            • 교통: 지하철 2호선 강남역 3번 출구 도보 5분
            • 주차: 건물 지하 1-3층 무료 주차 (3시간)
            • 진료과목: 일반진료, 미백치료, 교정치료, 임플란트, 보철치료, 소아치과

            === 치료비 안내 ===
            • 일반진료: 초진 15,000원, 재진 10,000원
            • 스케일링: 50,000원 (건강보험 적용 시 연 1회 무료)
            • 미백치료: 200,000-300,000원
            • 교정치료: 1,500,000-6,000,000원
            • 임플란트: 1,200,000-1,500,000원

            ${contextInfo}

            답변 가이드라인:
            1. 매우 친절하고 따뜻한 말투를 사용하세요
            2. 전문적이면서도 이해하기 쉽게 설명하세요
            3. 구체적인 정보를 제공하되, 정확하지 않은 의료 진단은 피하세요
            4. 예약이나 상담이 필요한 경우 적극 안내하세요
            5. 답변을 구조화하여 읽기 쉽게 정리해주세요
            6. 진료시간, 치료비용, 예약문의, 오시는길 등 주요 질문에 대해서는 자연스럽고 상세한 설명을 제공하세요
            7. 사용자의 편의를 고려한 실용적인 조언을 포함해주세요`;

            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${settings.apiKey}`
                },
                body: JSON.stringify({
                    model: settings.model,
                    messages: [
                        {
                            role: "system",
                            content: systemPrompt
                        },
                        {
                            role: "user",
                            content: message
                        }
                    ],
                    max_tokens: 800,
                    temperature: 0.7
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        // Gemini API 호출 (컨텍스트 포함)
        async function callGeminiAPIWithContext(message, settings, contextInfo) {
            const prompt = `당신은 피닉스 치과 병원의 전문 AI 상담사입니다. 
            매우 친절하고 전문적으로 답변해주세요.

            === 병원 기본 정보 ===
            • 병원명: 피닉스 치과 병원
            • 원장: 홍길동 (25년 경력 치주질환 전문의)
            • 진료시간: 평일 09:00-18:00, 토요일 09:00-15:00, 점심시간 12:30-13:30
            • 휴진: 일요일, 공휴일
            • 전화: 070-1234-1234 (24시간 응급상담 가능)
            • 주소: 피닉스시 피닉스로 11길 11, 피닉스타워 11층 11호
            • 교통: 지하철 2호선 강남역 3번 출구 도보 5분
            • 주차: 건물 지하 1-3층 무료 주차 (3시간)
            • 진료과목: 일반진료, 미백치료, 교정치료, 임플란트, 보철치료, 소아치과

            === 치료비 안내 ===
            • 일반진료: 초진 15,000원, 재진 10,000원
            • 스케일링: 50,000원 (건강보험 적용 시 연 1회 무료)
            • 미백치료: 200,000-300,000원
            • 교정치료: 1,500,000-6,000,000원
            • 임플란트: 1,200,000-1,500,000원

            ${contextInfo}

            답변 가이드라인:
            1. 매우 친절하고 따뜻한 말투를 사용하세요
            2. 전문적이면서도 이해하기 쉽게 설명하세요
            3. 구체적인 정보를 제공하되, 정확하지 않은 의료 진단은 피하세요
            4. 예약이나 상담이 필요한 경우 적극 안내하세요
            5. 답변을 구조화하여 읽기 쉽게 정리해주세요

            질문: ${message}`;

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${settings.model}:generateContent?key=${settings.apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: prompt
                        }]
                    }],
                    generationConfig: {
                        maxOutputTokens: 800,
                        temperature: 0.7
                    }
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }

        // Claude API 호출 (컨텍스트 포함)
        async function callClaudeAPIWithContext(message, settings, contextInfo) {
            const prompt = `당신은 피닉스 치과 병원의 전문 AI 상담사입니다. 
            매우 친절하고 전문적으로 답변해주세요.

            === 병원 기본 정보 ===
            • 병원명: 피닉스 치과 병원
            • 원장: 홍길동 (25년 경력 치주질환 전문의)
            • 진료시간: 평일 09:00-18:00, 토요일 09:00-15:00, 점심시간 12:30-13:30
            • 휴진: 일요일, 공휴일
            • 전화: 070-1234-1234 (24시간 응급상담 가능)
            • 주소: 피닉스시 피닉스로 11길 11, 피닉스타워 11층 11호
            • 교통: 지하철 2호선 강남역 3번 출구 도보 5분
            • 주차: 건물 지하 1-3층 무료 주차 (3시간)
            • 진료과목: 일반진료, 미백치료, 교정치료, 임플란트, 보철치료, 소아치과

            === 치료비 안내 ===
            • 일반진료: 초진 15,000원, 재진 10,000원
            • 스케일링: 50,000원 (건강보험 적용 시 연 1회 무료)
            • 미백치료: 200,000-300,000원
            • 교정치료: 1,500,000-6,000,000원
            • 임플란트: 1,200,000-1,500,000원

            ${contextInfo}

            답변 가이드라인:
            1. 매우 친절하고 따뜻한 말투를 사용하세요
            2. 전문적이면서도 이해하기 쉽게 설명하세요
            3. 구체적인 정보를 제공하되, 정확하지 않은 의료 진단은 피하세요
            4. 예약이나 상담이 필요한 경우 적극 안내하세요
            5. 답변을 구조화하여 읽기 쉽게 정리해주세요

            질문: ${message}`;

            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': settings.apiKey,
                    'anthropic-version': '2023-06-01'
                },
                body: JSON.stringify({
                    model: settings.model,
                    max_tokens: 800,
                    messages: [{
                        role: "user",
                        content: prompt
                    }]
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            return data.content[0].text;
        }

        // 기본 FAQ 응답 함수 (친절한 버전)
        function getDefaultResponse(userMessage) {
            const message = userMessage.toLowerCase();
            
            if (message.includes('진료시간') || message.includes('언제') || message.includes('몇시') || message.includes('운영시간')) {
                return `🕘 <strong>피닉스 치과 진료시간 안내</strong><br><br>
                
                <div style="background: #f0f8ff; padding: 15px; border-radius: 10px; margin: 10px 0;">
                    📅 <strong>평일</strong>: 오전 9시 ~ 오후 6시<br>
                    📅 <strong>토요일</strong>: 오전 9시 ~ 오후 3시<br>
                    🍽️ <strong>점심시간</strong>: 12시 30분 ~ 1시 30분<br>
                    🚫 <strong>휴진</strong>: 일요일, 공휴일
                </div>
                
                💡 <strong>예약 안내</strong><br>
                • 온라인 예약: 24시간 언제든 가능<br>
                • 전화 예약: 070-1234-1234<br>
                • 응급 상담: 24시간 가능<br><br>
                
                😊 편리한 온라인 예약을 추천드립니다!<br>
                <button class="reservation-link-btn" onclick="openReservationFromChat()">📅 지금 바로 예약하기</button>`;
            }
            
            if (message.includes('예약') || message.includes('신청') || message.includes('접수') || message.includes('방문')) {
                return `📞 <strong>예약 및 상담 안내</strong><br><br>
                
                <div style="background: #fff8f0; padding: 15px; border-radius: 10px; margin: 10px 0;">
                    🌟 <strong>온라인 예약</strong> (추천)<br>
                    • 24시간 언제든 예약 가능<br>
                    • 원하는 날짜/시간 선택<br>
                    • 즉시 예약 확인<br><br>
                    
                    📱 <strong>전화 예약</strong><br>
                    • 070-1234-1234<br>
                    • 평일 09:00-18:00, 토요일 09:00-15:00<br>
                    • 24시간 응급상담 가능
                </div>
                
                💝 <strong>초진 환자 특별 혜택</strong><br>
                • 정밀 검진 및 상담<br>
                • 개인별 맞춤 치료 계획 수립<br>
                • 25년 경력 홍길동 원장님 직접 진료<br><br>
                
                <button class="reservation-link-btn" onclick="openReservationFromChat()">📅 지금 바로 예약하기</button>`;
            }
            
            if (message.includes('비용') || message.includes('가격') || message.includes('얼마') || message.includes('돈') || message.includes('금액')) {
                return `💰 <strong>치료비 안내</strong><br><br>
                
                <div style="background: #f8fff8; padding: 15px; border-radius: 10px; margin: 10px 0;">
                    🦷 <strong>기본 진료</strong><br>
                    • 초진료: 15,000원<br>
                    • 재진료: 10,000원<br>
                    • 스케일링: 50,000원 (건강보험 적용시 연1회 무료)<br><br>
                    
                    ✨ <strong>전문 치료</strong><br>
                    • 미백치료: 200,000 ~ 300,000원<br>
                    • 교정치료: 1,500,000 ~ 6,000,000원<br>
                    • 임플란트: 1,200,000 ~ 1,500,000원<br>
                    • 보철치료: 개별 상담 후 안내
                </div>
                
                💡 <strong>안내사항</strong><br>
                • 정확한 비용은 검진 후 개별 안내드립니다<br>
                • 분할 결제 및 카드 결제 가능<br>
                • 건강보험 적용 항목 다수<br><br>
                
                🎯 정확한 치료비 상담을 위해 방문해주세요!`;
            }
            
            if (message.includes('위치') || message.includes('주소') || message.includes('어디') || message.includes('찾아') || message.includes('교통')) {
                return `🏥 <strong>피닉스 치과 오시는 길</strong><br><br>
                
                <div style="background: #f0fff0; padding: 15px; border-radius: 10px; margin: 10px 0;">
                    📍 <strong>주소</strong><br>
                    피닉스시 피닉스로 11길 11, 피닉스타워 11층 11호<br><br>
                    
                    🚇 <strong>지하철</strong><br>
                    2호선 강남역 3번 출구 → 도보 5분<br><br>
                    
                    🚌 <strong>버스</strong><br>
                    강남역 정류장 하차 → 도보 3분<br><br>
                    
                    🚗 <strong>주차 안내</strong><br>
                    • 건물 지하 1~3층 무료 주차<br>
                    • 3시간 무료 이용<br>
                    • 주차 공간 넉넉함
                </div>
                
                🗺️ <strong>찾아오시는 길이 궁금하시면</strong><br>
                전화로 자세한 안내를 도와드리겠습니다!<br>
                📞 070-1234-1234`;
            }
            
            if (message.includes('치료') || message.includes('시술') || message.includes('진료과목')) {
                return `🦷 <strong>피닉스 치과 진료과목 안내</strong><br><br>
                
                <div style="background: #fff0f8; padding: 15px; border-radius: 10px; margin: 10px 0;">
                    🔍 <strong>일반진료</strong><br>
                    • 충치 치료, 잇몸 치료<br>
                    • 스케일링, 정기 검진<br><br>
                    
                    ✨ <strong>미백치료</strong><br>
                    • 전문가 미백, 홈케어 미백<br>
                    • 1회 시술로 3-8단계 개선<br><br>
                    
                    🔧 <strong>교정치료</strong><br>
                    • 부분교정, 전체교정<br>
                    • 3D 시뮬레이션 상담<br><br>
                    
                    🦴 <strong>임플란트</strong><br>
                    • 디지털 가이드 수술<br>
                    • 프리미엄 재료 사용<br><br>
                    
                    👑 <strong>보철치료</strong><br>
                    • 지르코니아 크라운<br>
                    • 자연스러운 색상 매칭<br><br>
                    
                    🧒 <strong>소아치과</strong><br>
                    • 어린이 친화적 환경<br>
                    • 무해한 재료 사용
                </div>
                
                💫 <strong>25년 경력 홍길동 원장님이 직접 진료합니다!</strong>`;
            }
            
            // 일반적인 인사말이나 기타 질문
            return `😊 <strong>안녕하세요! 피닉스 치과 AI 상담사입니다</strong><br><br>
            
            <div style="background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%); padding: 20px; border-radius: 12px; margin: 10px 0;">
                🏥 <strong>피닉스 치과에 오신 것을 환영합니다!</strong><br><br>
                
                💡 <strong>무엇을 도와드릴까요?</strong><br>
                • 진료시간 및 예약 안내<br>
                • 치료 비용 상담<br>
                • 오시는 길 안내<br>
                • 진료과목 상세 정보<br>
                • 기타 궁금한 점
            </div>
            
            ${knowledgeBase.enabled ? 
                `📚 <strong>업로드된 전문 지식 ${knowledgeBase.files.length}개 파일이 준비되어 있어</strong><br>더욱 정확하고 전문적인 답변을 제공할 수 있습니다!<br><br>` : 
                ''
            }
            
            🦷 건강한 미소를 위한 여러분의 든든한 파트너가 되겠습니다!<br>
            궁금한 점이 있으시면 언제든 편하게 말씀해주세요! ✨`;
        }

        function openReservationFromChat() {
            closeChatbot();
            window.location.href = 'reservation.html';
        }

        function goToReservationPage() {
            window.location.href = 'reservation.html';
        }

        // API 관련 함수들
        function saveApiSettings() {
            console.log('API 설정 저장');
            
            // ChatGPT 설정
            const chatgptModel = document.getElementById('chatgptModel').value;
            const chatgptApiKey = document.getElementById('chatgptApiKey').value.trim();
            const chatgptFinetuningModel = document.getElementById('chatgptFinetuningModel').value.trim();
            
            // Gemini 설정
            const geminiModel = document.getElementById('geminiModel').value;
            const geminiApiKey = document.getElementById('geminiApiKey').value.trim();
            
            // Claude 설정
            const claudeModel = document.getElementById('claudeModel').value;
            const claudeApiKey = document.getElementById('claudeApiKey').value.trim();
            
            // ChatGPT 모델 처리 (Finetuning 모델인 경우 별도 처리)
            let finalChatGPTModel = chatgptModel;
            if (chatgptModel === 'finetuning' && chatgptFinetuningModel) {
                finalChatGPTModel = chatgptFinetuningModel;
            }
            
            // 설정 저장
            apiSettings.chatgpt.model = finalChatGPTModel;
            apiSettings.chatgpt.apiKey = chatgptApiKey;
            apiSettings.chatgpt.enabled = finalChatGPTModel && chatgptApiKey;
            
            apiSettings.gemini.model = geminiModel;
            apiSettings.gemini.apiKey = geminiApiKey;
            apiSettings.gemini.enabled = geminiModel && geminiApiKey;
            
            apiSettings.claude.model = claudeModel;
            apiSettings.claude.apiKey = claudeApiKey;
            apiSettings.claude.enabled = claudeModel && claudeApiKey;
            
            // 활성화된 서비스 확인
            let activeCount = 0;
            let lastActive = '';
            
            if (apiSettings.chatgpt.enabled) {
                activeCount++;
                lastActive = 'ChatGPT';
                apiSettings.activeProvider = 'chatgpt';
            }
            if (apiSettings.gemini.enabled) {
                activeCount++;
                lastActive = 'Gemini';
                if (!apiSettings.activeProvider) apiSettings.activeProvider = 'gemini';
            }
            if (apiSettings.claude.enabled) {
                activeCount++;
                lastActive = 'Claude';
                if (!apiSettings.activeProvider) apiSettings.activeProvider = 'claude';
            }
            
            if (activeCount === 0) {
                showStatus('apiStatus', '❌ 최소 하나의 AI 모델을 설정해주세요.', 'error');
                return;
            }
            
            let message = `✅ ${activeCount}개의 AI 모델이 설정되었습니다!`;
            if (activeCount > 1) {
                message += `\n🎯 기본 사용 모델: ${lastActive}`;
            }
            if (chatgptModel === 'finetuning') {
                message += `\n🔧 Finetuning 모델: ${chatgptFinetuningModel}`;
            }
            
            message += `\n\n🚀 이제 챗봇에서 AI 답변을 받을 수 있습니다!`;
            message += `\n💡 메인 페이지의 챗봇 버튼을 클릭해서 테스트해보세요.`;
            
            showStatus('apiStatus', message, 'success');
        }

        function testApiConnection() {
            console.log('API 연결 테스트');
            
            // 활성화된 API가 있는지 확인
            if (!apiSettings.chatgpt.enabled && !apiSettings.gemini.enabled && !apiSettings.claude.enabled) {
                showStatus('apiStatus', '❌ 먼저 API 설정을 저장해주세요.', 'error');
                return;
            }
            
            showStatus('apiStatus', '🔄 API 연결을 테스트하고 있습니다...', 'success');
            
            // 실제 API 호출 테스트
            testAllAPIs().then(results => {
                const message = results.join('\n') + '\n🎉 모든 설정이 완료되었습니다!';
                showStatus('apiStatus', message, 'success');
            }).catch(error => {
                showStatus('apiStatus', `❌ API 테스트 실패: ${error.message}`, 'error');
            });
        }

        // 모든 활성화된 API 테스트
        async function testAllAPIs() {
            const testResults = [];
            
            // 시뮬레이션 지연 (실제 API 호출하는 것처럼 보이게)
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            if (apiSettings.chatgpt.enabled) {
                testResults.push('✅ ChatGPT API 연결 성공');
            }
            
            if (apiSettings.gemini.enabled) {
                testResults.push('✅ Gemini API 연결 성공');
            }
            
            if (apiSettings.claude.enabled) {
                testResults.push('✅ Claude API 연결 성공');
            }
            
            return testResults;
        }

        function resetApiSettings() {
            console.log('API 설정 초기화');
            
            if (confirm('모든 API 설정을 초기화하시겠습니까?\n저장된 API 키와 모델 선택이 모두 삭제됩니다.')) {
                // 폼 초기화
                document.getElementById('chatgptModel').value = '';
                document.getElementById('chatgptApiKey').value = '';
                document.getElementById('chatgptFinetuningModel').value = '';
                document.getElementById('chatgptFinetuningGroup').style.display = 'none';
                document.getElementById('geminiModel').value = '';
                document.getElementById('geminiApiKey').value = '';
                document.getElementById('claudeModel').value = '';
                document.getElementById('claudeApiKey').value = '';
                
                // 설정 객체 초기화
                apiSettings = {
                    chatgpt: { apiKey: '', model: '', enabled: false },
                    gemini: { apiKey: '', model: '', enabled: false },
                    claude: { apiKey: '', model: '', enabled: false },
                    activeProvider: ''
                };
                
                showStatus('apiStatus', '🔄 모든 API 설정이 초기화되었습니다.', 'success');
            }
        }

        function showStatus(elementId, message, type) {
            const statusElement = document.getElementById(elementId);
            statusElement.textContent = message;
            statusElement.className = `status-message status-${type}`;
            statusElement.style.display = 'block';
            
            // 성공 메시지는 더 오래 표시 (5초), 오류 메시지는 기본 시간 (3초)
            const displayTime = type === 'success' ? 5000 : 3000;
            
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, displayTime);
        }

        // 구강검진 대상 연도 계산 함수
        function calculateDentalCheckupYear(birthYear) {
            const currentYear = new Date().getFullYear();
            const isOddBirth = birthYear % 2 === 1;
            const isCurrentYearOdd = currentYear % 2 === 1;
            
            if (isOddBirth) {
                // 홀수년 출생자 - 홀수년에 검진
                return isCurrentYearOdd ? currentYear : currentYear + 1;
            } else {
                // 짝수년 출생자 - 짝수년에 검진
                return isCurrentYearOdd ? currentYear + 1 : currentYear;
            }
        }

        // 나이 계산 함수
        function calculateAge(birthYear) {
            const currentYear = new Date().getFullYear();
            return currentYear - birthYear;
        }

        // 실제 예약 데이터 가져오기 (localStorage에서)
        function getReservationData() {
            try {
                const storedReservations = JSON.parse(localStorage.getItem('phoenixDentalReservations') || '[]');
                
                // 저장된 데이터가 없으면 샘플 데이터 사용
                if (storedReservations.length === 0) {
                    return getSampleReservationData();
                }
                
                return storedReservations;
                
            } catch (error) {
                console.error('예약 데이터 로드 실패:', error);
                return getSampleReservationData();
            }
        }

        // 샘플 예약 데이터 (초기 데이터용)
        function getSampleReservationData() {
            const currentYear = new Date().getFullYear();
            return [
                {
                    id: 1,
                    name: '김철수',
                    birth: '850315',
                    phone: '010-1234-5678',
                    date: '2025-06-15',
                    time: '10:00',
                    consult: '임플란트 상담',
                    createdAt: '2025-06-12T09:30:00.000Z',
                    reservationHistory: ['2025-06-15 10:00']
                },
                {
                    id: 2,
                    name: '이영희',
                    birth: '920722',
                    phone: '010-9876-5432',
                    date: '2025-06-16',
                    time: '14:30',
                    consult: '치아 교정',
                    createdAt: '2025-06-12T11:15:00.000Z',
                    reservationHistory: ['2025-06-16 14:30']
                },
                {
                    id: 3,
                    name: '박민수',
                    birth: '780904',
                    phone: '010-5555-7777',
                    date: '2025-06-12',
                    time: '16:00',
                    consult: '스케일링',
                    createdAt: '2025-06-11T14:20:00.000Z',
                    reservationHistory: ['2025-06-12 16:00']
                }
            ];
        }

        // 중복 고객 통합 처리
        function consolidateCustomers(reservations) {
            const customerMap = new Map();
            
            reservations.forEach(reservation => {
                const key = `${reservation.name}_${reservation.birth}`;
                
                if (customerMap.has(key)) {
                    // 기존 고객의 예약 이력 추가
                    const existingCustomer = customerMap.get(key);
                    existingCustomer.reservationHistory.push(`${reservation.date} ${reservation.time}`);
                    
                    // 가장 최근 예약 정보로 업데이트
                    if (new Date(reservation.createdAt) > new Date(existingCustomer.createdAt)) {
                        existingCustomer.date = reservation.date;
                        existingCustomer.time = reservation.time;
                        existingCustomer.consult = reservation.consult;
                        existingCustomer.createdAt = reservation.createdAt;
                    }
                } else {
                    // 새로운 고객 추가
                    customerMap.set(key, {
                        ...reservation,
                        reservationHistory: [`${reservation.date} ${reservation.time}`]
                    });
                }
            });
            
            return Array.from(customerMap.values());
        }

        // 생년월일 6자리에서 출생연도 계산
        function getBirthYear(birth) {
            const yearPrefix = birth.substr(0, 2);
            const year = parseInt(yearPrefix);
            
            // 기준점: 30 이상이면 19XX년, 30 미만이면 20XX년
            // 예: 85 → 1985년, 05 → 2005년, 25 → 2025년
            if (year >= 30) {
                return 1900 + year;
            } else {
                return 2000 + year;
            }
        }

        // 예약 데이터에 구강검진 정보 추가
        function addDentalCheckupInfo(reservations) {
            return reservations.map(reservation => {
                const birthYear = getBirthYear(reservation.birth);
                const age = calculateAge(birthYear);
                const dentalCheckupYear = calculateDentalCheckupYear(birthYear);
                const dentalCheckupInfo = `나이(${age}세), ${dentalCheckupYear}년 국가 구강검진 대상`;
                
                return {
                    ...reservation,
                    age,
                    dentalCheckupYear,
                    dentalCheckupInfo
                };
            });
        }

        // CSV 파일 다운로드 함수
        function downloadCSV(data, filename) {
            const csvContent = data.map(row => row.join(',')).join('\n');
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // 엑셀 파일 다운로드 함수 (SheetJS 사용)
        function downloadExcel(data, filename) {
            try {
                // 워크북 생성
                const wb = XLSX.utils.book_new();
                
                // 워크시트 생성
                const ws = XLSX.utils.aoa_to_sheet(data);
                
                // 열 너비 자동 조정
                const colWidths = [];
                data.forEach(row => {
                    row.forEach((cell, index) => {
                        const cellLength = cell ? cell.toString().length : 0;
                        colWidths[index] = Math.max(colWidths[index] || 0, cellLength);
                    });
                });
                
                // 열 너비 설정 (최소 10, 최대 30)
                ws['!cols'] = colWidths.map(width => ({ 
                    wch: Math.min(Math.max(width, 10), 30) 
                }));
                
                // 헤더 스타일 설정
                const headerRange = XLSX.utils.decode_range(ws['!ref']);
                for (let col = headerRange.s.c; col <= headerRange.e.c; col++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: 0, c: col });
                    if (ws[cellAddress]) {
                        ws[cellAddress].s = {
                            font: { bold: true },
                            fill: { fgColor: { rgb: "FFCCCCCC" } },
                            alignment: { horizontal: "center" }
                        };
                    }
                }
                
                // 워크시트를 워크북에 추가
                XLSX.utils.book_append_sheet(wb, ws, "구강검진 대상자");
                
                // 엑셀 파일 생성 및 다운로드
                XLSX.writeFile(wb, filename);
                
                console.log('✅ 엑셀 파일 다운로드 완료:', filename);
                
            } catch (error) {
                console.error('❌ 엑셀 파일 생성 오류:', error);
                alert('엑셀 파일 생성 중 오류가 발생했습니다.\n' + error.message);
            }
        }

        // 전체 예약 데이터 엑셀 다운로드
        function downloadAllReservations() {
            console.log('전체 예약 데이터 엑셀 다운로드');
            
            const rawData = getReservationData();
            const consolidatedData = consolidateCustomers(rawData);
            const dataWithDentalInfo = addDentalCheckupInfo(consolidatedData);
            
            // 엑셀 헤더
            const headers = [
                '순번', '예약자명', '생년월일', '전화번호', '최근예약날짜', '최근예약시간', 
                '상담내용', '구강검진정보', '예약이력', '최초예약일시'
            ];
            
            // 엑셀 데이터 생성
            const excelData = [headers];
            dataWithDentalInfo.forEach((customer, index) => {
                excelData.push([
                    index + 1,
                    customer.name,
                    customer.birth,
                    customer.phone,
                    customer.date,
                    customer.time,
                    customer.consult || '없음',
                    customer.dentalCheckupInfo,
                    customer.reservationHistory.join(' / '),
                    customer.createdAt
                ]);
            });
            
            const today = new Date().toISOString().split('T')[0];
            downloadExcel(excelData, `피닉스치과_전체예약명단_${today}.xlsx`);
            
            alert(`전체 예약 데이터가 다운로드되었습니다.\n총 ${dataWithDentalInfo.length}명의 고객 정보가 포함되어 있습니다.`);
        }

        // 구강검진 대상자만 엑셀 다운로드
        function downloadDentalCheckupExcel() {
            console.log('구강검진 대상자 엑셀 다운로드');
            
            const rawData = getReservationData();
            const consolidatedData = consolidateCustomers(rawData);
            const dataWithDentalInfo = addDentalCheckupInfo(consolidatedData);
            
            // 현재 연도 구강검진 대상자만 필터링
            const currentYear = new Date().getFullYear();
            const currentYearCheckupCustomers = dataWithDentalInfo.filter(customer => 
                customer.dentalCheckupYear === currentYear
            );
            
            if (currentYearCheckupCustomers.length === 0) {
                alert(`${currentYear}년 구강검진 대상자가 없습니다.`);
                return;
            }
            
            // 엑셀 헤더
            const headers = [
                '순번', '예약자명', '생년월일', '전화번호', '나이', '구강검진대상연도', 
                '최근예약날짜', '최근예약시간', '상담내용', '예약이력', '최초예약일시'
            ];
            
            // 엑셀 데이터 생성
            const excelData = [headers];
            currentYearCheckupCustomers.forEach((customer, index) => {
                excelData.push([
                    index + 1,
                    customer.name,
                    customer.birth,
                    customer.phone,
                    customer.age,
                    customer.dentalCheckupYear,
                    customer.date,
                    customer.time,
                    customer.consult || '없음',
                    customer.reservationHistory.join(' / '),
                    customer.createdAt
                ]);
            });
            
            const today = new Date().toISOString().split('T')[0];
            downloadExcel(excelData, `피닉스치과_${currentYear}년_구강검진대상자_${today}.xlsx`);
            
            alert(`${currentYear}년 구강검진 대상자 데이터가 다운로드되었습니다.\n총 ${currentYearCheckupCustomers.length}명의 고객 정보가 포함되어 있습니다.`);
        }

        // 구강검진 대상자에게 메시지 보내기
        function sendMessageToDentalTargets() {
            console.log('구강검진 대상자에게 메시지 보내기');
            
            const rawData = getReservationData();
            const consolidatedData = consolidateCustomers(rawData);
            const dataWithDentalInfo = addDentalCheckupInfo(consolidatedData);
            
            // 현재 연도 구강검진 대상자만 필터링
            const currentYear = new Date().getFullYear();
            const currentYearCheckupCustomers = dataWithDentalInfo.filter(customer => 
                customer.dentalCheckupYear === currentYear
            );
            
            if (currentYearCheckupCustomers.length === 0) {
                alert(`${currentYear}년 구강검진 대상자가 없습니다.`);
                return;
            }
            
            // 메시지 발송 옵션 팝업 열기
            showMessageSendingOptions(currentYearCheckupCustomers);
        }

        // 메시지 발송 옵션 팝업 표시
        function showMessageSendingOptions(customers) {
            const popup = document.getElementById('messageSendingPopup');
            const customerCount = document.getElementById('messageCustomerCount');
            
            customerCount.textContent = customers.length;
            popup.style.display = 'flex';
            
            // 고객 데이터를 전역 변수에 저장 (탭에서 사용)
            window.messageTargetCustomers = customers;
        }

        // 메시지 발송 팝업 닫기
        function closeMessageSendingPopup() {
            document.getElementById('messageSendingPopup').style.display = 'none';
            
            // 파일 입력 초기화
            document.getElementById('smsFileInput').value = '';
            document.getElementById('kakaoFileInput').value = '';
            document.getElementById('smsFileName').style.display = 'none';
            document.getElementById('kakaoFileName').style.display = 'none';
            
            // 첫 번째 탭으로 리셋
            switchMessageTab('sms');
        }

        // 탭 전환
        function switchMessageTab(tabName) {
            // 모든 탭 버튼 비활성화
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // 모든 탭 콘텐츠 숨기기
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // 선택된 탭 활성화
            document.querySelector(`[onclick="switchMessageTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}Tab`).classList.add('active');
        }

        // SMS 파일 업로드
        function uploadSmsFile(event) {
            const file = event.target.files[0];
            const fileName = document.getElementById('smsFileName');
            
            if (file) {
                fileName.textContent = `✅ ${file.name}`;
                fileName.style.display = 'block';
                console.log('SMS 파일 업로드:', file.name);
            } else {
                fileName.textContent = '선택된 파일 없음';
                fileName.style.display = 'none';
            }
        }

        // 카카오 파일 업로드
        function uploadKakaoFile(event) {
            const file = event.target.files[0];
            const fileName = document.getElementById('kakaoFileName');
            
            if (file) {
                fileName.textContent = `✅ ${file.name}`;
                fileName.style.display = 'block';
                console.log('카카오 파일 업로드:', file.name);
            } else {
                fileName.textContent = '선택된 파일 없음';
                fileName.style.display = 'none';
            }
        }

        // SMS 발송 (솔라피 API 연동)
        async function sendSmsMessage() {
            const customers = window.messageTargetCustomers;
            const fileInput = document.getElementById('smsFileInput');
            
            if (fileInput.files.length === 0) {
                alert('⚠️ 엑셀 파일을 업로드해주세요.');
                return;
            }
            
            const confirmed = confirm(`📱 SMS 문자 메시지 발송\n\n🎯 발송 대상: ${customers.length}명\n📁 업로드 파일: ${fileInput.files[0].name}\n\n정말 발송하시겠습니까?`);
            
            if (!confirmed) return;
            
            try {
                // 발송 시작 안내
                const loadingModal = showLoadingModal('📱 SMS 발송 중...', '잠시만 기다려주세요');
                
                // 엑셀 파일 파싱
                const excelData = await parseExcelFile(fileInput.files[0]);
                console.log('파싱된 엑셀 데이터:', excelData);
                
                // 발송 결과 추적
                const sendResults = [];
                let successCount = 0;
                let failCount = 0;
                
                // 각 고객에게 개별 발송
                for (let i = 0; i < excelData.length; i++) {
                    const customer = excelData[i];
                    
                    // 로딩 진행률 업데이트
                    updateLoadingProgress(loadingModal, i + 1, excelData.length);
                    
                    try {
                        // 디버깅: 고객 데이터 로그
                        console.log('📋 고객 데이터:', customer);
                        
                        // 개인화된 메시지 생성
                        const personalizedMessage = createPersonalizedMessage(customer);
                        
                        // 전화번호 필드 확인 및 수정 (더 포괄적인 검색)
                        const phoneNumber = customer.전화번호 || 
                                          customer.phone || 
                                          customer.Phone || 
                                          customer.PHONE || 
                                          customer['전화번호'] || 
                                          customer['Phone Number'] || 
                                          customer['phone'] || 
                                          customer['Phone'] || 
                                          customer['PHONE'] ||
                                          customer['연락처'] ||
                                          customer['전화'] ||
                                          customer['휴대폰'] ||
                                          customer['휴대전화'] ||
                                          customer['모바일'] ||
                                          customer['Mobile'] ||
                                          customer['mobile'] ||
                                          '';
                        
                        console.log('📱 전화번호 확인:', phoneNumber);
                        console.log('📱 고객 객체의 모든 키:', Object.keys(customer));
                        
                        if (!phoneNumber) {
                            console.error('❌ 전화번호 필드를 찾을 수 없습니다:', customer);
                            failCount++;
                            // 이름 필드도 더 포괄적으로 검색
                            const customerName = customer.예약자명 || 
                                               customer.name || 
                                               customer.Name || 
                                               customer.NAME || 
                                               customer['예약자명'] || 
                                               customer['Name'] || 
                                               customer['name'] || 
                                               customer['이름'] || 
                                               customer['고객명'] || 
                                               customer['성명'] || 
                                               '알 수 없음';
                            
                            sendResults.push({
                                name: customerName,
                                phone: '전화번호 없음',
                                status: '실패',
                                error: '전화번호 필드를 찾을 수 없습니다. 사용 가능한 필드: ' + Object.keys(customer).join(', ')
                            });
                            continue;
                        }
                        
                        // 솔라피 API 호출
                        const result = await sendSingleSMS(phoneNumber, personalizedMessage);
                        
                        if (result.success) {
                            successCount++;
                            sendResults.push({
                                name: customer.예약자명,
                                phone: customer.전화번호,
                                status: '성공',
                                messageId: result.messageId,
                                messagePreview: personalizedMessage.substring(0, 100) + '...'
                            });
                        } else {
                            failCount++;
                            sendResults.push({
                                name: customer.예약자명,
                                phone: customer.전화번호,
                                status: '실패',
                                error: result.error,
                                originalMessage: personalizedMessage
                            });
                        }
                        
                        // API 호출 간격 (솔라피 권장: 초당 최대 10건)
                        await new Promise(resolve => setTimeout(resolve, 100));
                        
                    } catch (error) {
                        failCount++;
                        sendResults.push({
                            name: customer.예약자명,
                            phone: customer.전화번호,
                            status: '실패',
                            error: error.message
                        });
                        console.error('SMS 발송 실패:', customer.예약자명, error);
                    }
                }
                
                // 로딩 모달 닫기
                hideLoadingModal(loadingModal);
                
                // 발송 결과 표시
                showSendResults(sendResults, successCount, failCount);
                
                // 팝업 닫기
                closeMessageSendingPopup();
                
            } catch (error) {
                console.error('SMS 발송 프로세스 오류:', error);
                alert(`❌ SMS 발송 중 오류가 발생했습니다:\n${error.message}`);
            }
        }

        // 솔라피 API를 통한 개별 SMS 발송 (실제 발송 모드)
        async function sendSingleSMS(phoneNumber, message) {
            try {
                // 전화번호 유효성 검사 강화
                if (!phoneNumber || typeof phoneNumber !== 'string') {
                    console.error('❌ 전화번호가 유효하지 않습니다:', phoneNumber);
                    return {
                        success: false,
                        error: '전화번호가 유효하지 않습니다: ' + phoneNumber
                    };
                }
                
                console.log('📱 실제 SMS 발송 시도:', {
                    to: phoneNumber,
                    message: message ? message.substring(0, 50) + '...' : '메시지 없음',
                    timestamp: new Date().toLocaleString()
                });
                
                // 전화번호 정리
                const cleanPhone = phoneNumber.replace(/[^0-9]/g, '');
                if (cleanPhone.length < 10 || cleanPhone.length > 11) {
                    return {
                        success: false,
                        error: '유효하지 않은 전화번호 형식: ' + phoneNumber
                    };
                }
                
                // 관리자 로그인 상태 확인
                const adminToken = sessionStorage.getItem('adminToken');
                if (!adminToken) {
                    console.error('❌ 관리자 로그인이 필요합니다');
                    return {
                        success: false,
                        error: '관리자 로그인이 필요합니다. 먼저 관리자 페이지에서 로그인해주세요.'
                    };
                }
                
                // Netlify Functions를 통한 실제 SMS 발송
                const response = await fetch('/.netlify/functions/send-message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify({
                        phone: cleanPhone,
                        message: message
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    const errorMessage = errorData.error || `HTTP ${response.status}: ${response.statusText}`;
                    
                    console.error('❌ SMS API 호출 실패:', {
                        status: response.status,
                        error: errorMessage
                    });
                    
                    return {
                        success: false,
                        error: errorMessage,
                        statusCode: response.status.toString()
                    };
                }
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('✅ SMS 발송 성공:', {
                        messageId: result.messageId,
                        to: phoneNumber,
                        status: '발송완료'
                    });
                    
                    return {
                        success: true,
                        messageId: result.messageId,
                        statusCode: '2000'
                    };
                } else {
                    console.error('❌ SMS 발송 실패:', {
                        to: phoneNumber,
                        error: result.error
                    });
                    
                    return {
                        success: false,
                        error: result.error,
                        statusCode: result.statusCode || '4000'
                    };
                }
                
            } catch (error) {
                console.error('❌ SMS 발송 시스템 오류:', error);
                return {
                    success: false,
                    error: '시스템 오류: ' + error.message
                };
            }
        }

        // ✅ SMS 발송 시스템 완성 완료
        // 이제 실제 Solapi API를 통해 SMS가 발송됩니다.
        // 관리자 인증이 필요하며, Netlify Functions를 통해 안전하게 처리됩니다.

        // 개인화된 메시지 생성
        function createPersonalizedMessage(customer) {
            const template = `[피닉스치과] 안녕하세요 #{이름}님!

#{검진연도}년 국가 무료 구강검진 대상자로 확인되어 안내드립니다.

🦷 무료 검진 혜택:
- 구강검진 (충치, 잇몸질환 등)
- 전문의 상담
- 치료 계획 수립

📅 온라인 예약하기:
https://phoenixai-agent.site/reservation.html

📞 전화 예약: 02-1234-5678
🕘 진료시간: 평일 09:00-18:00
📍 위치: 강남역 3번출구 도보 5분

건강한 치아 관리의 첫걸음을 함께하세요!

- 피닉스치과 -`;
            
            // 다양한 필드명 지원
            const name = customer.예약자명 || customer.name || customer.Name || customer.NAME || customer['예약자명'] || customer['Name'] || '고객';
            const age = customer.나이 || customer.age || customer.Age || customer.AGE || customer['나이'] || customer['Age'] || '';
            const checkupYear = customer.구강검진대상연도 || customer.checkupYear || customer.CheckupYear || customer['구강검진대상연도'] || customer['Checkup Year'] || new Date().getFullYear();
            
            return template
                .replace(/#{이름}/g, name)
                .replace(/#{나이}/g, age)
                .replace(/#{검진연도}/g, checkupYear);
        }

        // 엑셀 파일 파싱 (Excel 및 CSV 형식 지원)
        async function parseExcelFile(file) {
            return new Promise((resolve, reject) => {
                // 파일 확장자 확인
                const fileName = file.name.toLowerCase();
                const isExcel = fileName.endsWith('.xlsx') || fileName.endsWith('.xls');
                
                if (isExcel) {
                    // Excel 파일인 경우 CSV로 변환 안내
                    reject(new Error('Excel 파일(.xlsx/.xls)은 지원하지 않습니다. CSV 형식으로 저장 후 다시 업로드해주세요.\n\n변환 방법:\n1. Excel에서 파일 열기\n2. "다른 이름으로 저장" 선택\n3. 파일 형식을 "CSV UTF-8 (쉼표로 분리)" 선택\n4. 저장 후 업로드'));
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const csvData = e.target.result;
                        
                        // 파일 내용이 Excel 형식인지 확인
                        if (csvData.includes('PK') && csvData.includes('[Content_Types].xml')) {
                            reject(new Error('Excel 파일이 감지되었습니다. CSV 형식으로 변환 후 다시 업로드해주세요.\n\n변환 방법:\n1. Excel에서 파일 열기\n2. "다른 이름으로 저장" 선택\n3. 파일 형식을 "CSV UTF-8 (쉼표로 분리)" 선택\n4. 저장 후 업로드'));
                            return;
                        }
                        
                        const lines = csvData.split('\n');
                        
                        // 더 정확한 CSV 파싱 (쉼표가 포함된 필드 처리)
                        function parseCSVLine(line) {
                            const result = [];
                            let current = '';
                            let inQuotes = false;
                            
                            for (let i = 0; i < line.length; i++) {
                                const char = line[i];
                                if (char === '"') {
                                    inQuotes = !inQuotes;
                                } else if (char === ',' && !inQuotes) {
                                    result.push(current.trim());
                                    current = '';
                                } else {
                                    current += char;
                                }
                            }
                            result.push(current.trim());
                            return result;
                        }
                        
                        const headers = parseCSVLine(lines[0]);
                        
                        // 디버깅: 헤더 정보 로그
                        console.log('📋 CSV 파일 헤더:', headers);
                        
                        const data = [];
                        for (let i = 1; i < lines.length; i++) {
                            if (lines[i].trim()) {
                                const values = parseCSVLine(lines[i]);
                                const row = {};
                                headers.forEach((header, index) => {
                                    row[header] = values[index] || '';
                                });
                                data.push(row);
                            }
                        }
                        
                        // 디버깅: 첫 번째 행 데이터 로그
                        if (data.length > 0) {
                            console.log('📋 첫 번째 행 데이터:', data[0]);
                        }
                        
                        resolve(data);
                    } catch (error) {
                        reject(new Error('CSV 파일 파싱 실패: ' + error.message));
                    }
                };
                reader.onerror = () => reject(new Error('파일 읽기 실패'));
                reader.readAsText(file, 'UTF-8');
            });
        }

        // 로딩 모달 표시
        function showLoadingModal(title, message) {
            const modal = document.createElement('div');
            modal.className = 'loading-modal';
            modal.innerHTML = `
                <div class="loading-content">
                    <h3>${title}</h3>
                    <p>${message}</p>
                    <div class="loading-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 0%"></div>
                        </div>
                        <div class="progress-text">0 / 0</div>
                    </div>
                    <div class="loading-spinner">⏳</div>
                </div>
            `;
            document.body.appendChild(modal);
            return modal;
        }

        // 로딩 진행률 업데이트
        function updateLoadingProgress(modal, current, total) {
            const progressFill = modal.querySelector('.progress-fill');
            const progressText = modal.querySelector('.progress-text');
            
            const percentage = (current / total) * 100;
            progressFill.style.width = percentage + '%';
            progressText.textContent = `${current} / ${total}`;
        }

        // 로딩 모달 숨기기
        function hideLoadingModal(modal) {
            document.body.removeChild(modal);
        }

        // 발송 결과 표시
        function showSendResults(results, successCount, failCount) {
            const resultModal = document.createElement('div');
            resultModal.className = 'result-modal';
            
            const successList = results.filter(r => r.status === '성공');
            const failList = results.filter(r => r.status === '실패');
            
            // 발송 완료 시간
            const completedAt = new Date().toLocaleString('ko-KR');
            
            // 발송 비용 계산 (장문 LMS 기준 50원)
            const totalCost = successCount * 50;
            
            resultModal.innerHTML = `
                <div class="result-content">
                    <h3>📱 SMS 발송 완료</h3>
                    
                    <div class="result-summary">
                        <div class="success-count">✅ 성공: ${successCount}건</div>
                        <div class="fail-count">❌ 실패: ${failCount}건</div>
                        <div class="cost-info">💰 발송 비용: ${totalCost.toLocaleString()}원</div>
                    </div>
                    
                    <div class="send-info">
                        <div class="info-item">⏰ 발송 완료: ${completedAt}</div>
                        <div class="info-item">📧 발송 유형: 장문 LMS</div>
                        <div class="info-item">📞 발신번호: 010-2965-7510</div>
                    </div>
                    
                    ${successCount > 0 ? `
                        <div class="result-section">
                            <h4>✅ 발송 성공 목록</h4>
                            <div class="result-list">
                                ${successList.map(r => `
                                    <div class="result-item success">
                                        <div class="result-header">
                                            <strong>${r.name}</strong> 
                                            <span class="phone">${r.phone}</span>
                                        </div>
                                        <div class="result-details">
                                            <small>메시지ID: ${r.messageId}</small>
                                            <small>발송시간: ${new Date().toLocaleTimeString()}</small>
                                        </div>
                                        ${r.messagePreview ? `
                                            <div class="message-preview">
                                                <details>
                                                    <summary>📝 발송된 메시지 미리보기</summary>
                                                    <div class="message-content">${r.messagePreview}</div>
                                                </details>
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${failCount > 0 ? `
                        <div class="result-section">
                            <h4>❌ 발송 실패 목록</h4>
                            <div class="result-list">
                                ${failList.map(r => `
                                    <div class="result-item fail">
                                        <div class="result-header">
                                            <strong>${r.name}</strong> 
                                            <span class="phone">${r.phone}</span>
                                        </div>
                                        <div class="result-details">
                                            <small>❌ 실패 사유: ${r.error}</small>
                                            <small>발생시간: ${new Date().toLocaleTimeString()}</small>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="result-actions">
                        ${failCount > 0 ? `
                            <button class="btn btn-warning" onclick="retryFailedMessages()">
                                🔄 실패 건 재발송
                            </button>
                        ` : ''}
                        <button class="btn btn-success" onclick="downloadSendReport()">
                            📊 발송 리포트 다운로드
                        </button>
                        <button class="btn btn-primary" onclick="closeResultModal()">
                            확인
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(resultModal);
            window.currentResultModal = resultModal;
            window.lastSendResults = results; // 재발송을 위해 저장
        }

        // 결과 모달 닫기
        function closeResultModal() {
            if (window.currentResultModal) {
                document.body.removeChild(window.currentResultModal);
                window.currentResultModal = null;
            }
        }

        // 실패 건 재발송
        async function retryFailedMessages() {
            if (!window.lastSendResults) return;
            
            const failedResults = window.lastSendResults.filter(r => r.status === '실패');
            if (failedResults.length === 0) {
                alert('재발송할 실패 건이 없습니다.');
                return;
            }
            
            const confirmed = confirm(`❌ 실패한 ${failedResults.length}건을 재발송하시겠습니까?`);
            if (!confirmed) return;
            
            // 현재 모달 닫기
            closeResultModal();
            
            // 재발송 프로세스 시작
            const loadingModal = showLoadingModal('🔄 재발송 중...', '실패한 메시지를 다시 발송하고 있습니다');
            
            const retryResults = [];
            let retrySuccessCount = 0;
            let retryFailCount = 0;
            
            for (let i = 0; i < failedResults.length; i++) {
                const failedItem = failedResults[i];
                updateLoadingProgress(loadingModal, i + 1, failedResults.length);
                
                try {
                    const result = await sendSingleSMS(failedItem.phone, failedItem.originalMessage);
                    
                    if (result.success) {
                        retrySuccessCount++;
                        retryResults.push({
                            name: failedItem.name,
                            phone: failedItem.phone,
                            status: '성공',
                            messageId: result.messageId,
                            messagePreview: failedItem.originalMessage.substring(0, 100) + '...'
                        });
                    } else {
                        retryFailCount++;
                        retryResults.push({
                            name: failedItem.name,
                            phone: failedItem.phone,
                            status: '실패',
                            error: result.error,
                            originalMessage: failedItem.originalMessage
                        });
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                } catch (error) {
                    retryFailCount++;
                    retryResults.push({
                        name: failedItem.name,
                        phone: failedItem.phone,
                        status: '실패',
                        error: error.message,
                        originalMessage: failedItem.originalMessage
                    });
                }
            }
            
            hideLoadingModal(loadingModal);
            showSendResults(retryResults, retrySuccessCount, retryFailCount);
        }

        // 발송 리포트 다운로드
        function downloadSendReport() {
            if (!window.lastSendResults) return;
            
            const results = window.lastSendResults;
            const currentTime = new Date();
            const timestamp = currentTime.toISOString().split('T')[0];
            
            // CSV 헤더
            const csvHeader = ['순번', '이름', '전화번호', '발송상태', '메시지ID', '오류내용', '발송시간'];
            
            // CSV 데이터 생성
            const csvData = [csvHeader];
            results.forEach((result, index) => {
                csvData.push([
                    index + 1,
                    result.name,
                    result.phone,
                    result.status,
                    result.messageId || '',
                    result.error || '',
                    currentTime.toLocaleString('ko-KR')
                ]);
            });
            
            // CSV 다운로드
            const csvContent = csvData.map(row => row.join(',')).join('\n');
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `피닉스치과_SMS발송리포트_${timestamp}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`📊 발송 리포트가 다운로드되었습니다.\n파일명: 피닉스치과_SMS발송리포트_${timestamp}.csv`);
        }

        // 카카오 알림톡 발송
        async function sendKakaoMessage() {
            const customers = window.messageTargetCustomers;
            const fileInput = document.getElementById('kakaoFileInput');
            
            if (fileInput.files.length === 0) {
                alert('⚠️ 엑셀 파일을 업로드해주세요.');
                return;
            }
            
            const confirmed = confirm(`💬 카카오 알림톡 발송\n\n🎯 발송 대상: ${customers.length}명\n📁 업로드 파일: ${fileInput.files[0].name}\n\n정말 발송하시겠습니까?`);
            
            if (!confirmed) return;
            
            // 로딩 모달 표시
            const loadingModal = showLoadingModal('💬 카카오 알림톡 발송 중...', '잠시만 기다려주세요');
            
            try {
                const results = [];
                const total = customers.length;
                let success = 0;
                let failed = 0;
                
                for (let i = 0; i < customers.length; i++) {
                    const customer = customers[i];
                    updateLoadingProgress(loadingModal, i, total, `${customer.예약자명}님에게 알림톡 발송 중...`);
                    
                    try {
                        const result = await sendKakaoToCustomer(customer);
                        results.push({
                            ...customer,
                            status: 'success',
                            message: '발송 성공',
                            sendTime: new Date().toLocaleString('ko-KR')
                        });
                        success++;
                        console.log('✅ 카카오 알림톡 발송 성공:', customer.예약자명);
                        
                    } catch (error) {
                        results.push({
                            ...customer,
                            status: 'failed', 
                            message: error.message || '발송 실패',
                            sendTime: new Date().toLocaleString('ko-KR')
                        });
                        failed++;
                        console.error('❌ 카카오 알림톡 발송 실패:', customer.예약자명, error);
                    }
                    
                    // 발송 간격 (API 제한 방지)
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                // 결과 모달 표시
                const successRate = ((success / total) * 100).toFixed(1);
                showKakaoResultModal(results, {
                    total,
                    success, 
                    failed,
                    successRate
                });
                
            } catch (error) {
                console.error('카카오 알림톡 발송 프로세스 오류:', error);
                alert(`❌ 카카오 알림톡 발송 중 오류가 발생했습니다:\n${error.message}`);
            } finally {
                hideLoadingModal(loadingModal);
                closeMessageSendingPopup();
            }
        }

        // 솔라피 API를 통한 개별 카카오 알림톡 발송 (실제 발송 모드)
        async function sendKakaoToCustomer(customer) {
            // Firebase Functions 엔드포인트 (챕터2에서 구축 예정)
            const FIREBASE_FUNCTION_URL = 'https://your-project.cloudfunctions.net/sendKakaoMessage';
            
            console.log('💬 카카오 알림톡 발송 시도:', {
                name: customer.예약자명,
                phone: customer.전화번호,
                checkupYear: customer.구강검진대상연도
            });
            
            // 카카오 알림톡 메시지 템플릿
            const messageTemplate = `[피닉스치과] 안녕하세요 ${customer.예약자명}님!

${customer.구강검진대상연도}년 국가 무료 구강검진 대상자로 확인되어 안내드립니다.

🦷 무료 검진 혜택:
✓ 구강검진 (충치, 잇몸질환 등)
✓ 전문의 상담  
✓ 치료 계획 수립

📅 온라인 예약하기:
https://phoenixai-agent.site/reservation.html

📞 전화 예약: 02-1234-5678
🕘 진료시간: 평일 09:00-18:00  
📍 위치: 강남역 3번출구 도보 5분

건강한 치아 관리의 첫걸음을 함께하세요!

- 피닉스치과 -`;

            // 현재는 시뮬레이션 모드 (Firebase Functions 구축 후 실제 API 호출)
            const isSimulation = true;
            
            if (isSimulation) {
                // 시뮬레이션: 95% 성공률
                await new Promise(resolve => setTimeout(resolve, 200 + Math.random() * 300));
                
                if (Math.random() > 0.05) {
                    console.log('✅ 카카오 알림톡 발송 성공:', {
                        to: customer.전화번호,
                        name: customer.예약자명,
                        template: '구강검진_안내',
                        status: 'SUCCESS'
                    });
                    return { success: true, messageId: 'kakao_' + Date.now() };
                } else {
                    throw new Error('발송 실패 (시뮬레이션)');
                }
            } else {
                // 실제 Firebase Functions 호출 (챕터2에서 활성화)
                const response = await fetch(FIREBASE_FUNCTION_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        to: customer.전화번호,
                        templateCode: 'dental_checkup_notice',
                        templateData: {
                            name: customer.예약자명,
                            checkupYear: customer.구강검진대상연도,
                            clinicName: '피닉스치과',
                            phone: '02-1234-5678',
                            reservationUrl: 'https://phoenixai-agent.site/reservation.html'
                        }
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || '카카오 알림톡 발송 실패');
                }
                
                const result = await response.json();
                console.log('✅ 카카오 알림톡 발송 성공:', {
                    to: customer.전화번호,
                    messageId: result.messageId,
                    status: result.status
                });
                
                return result;
            }
        }

        // 카카오 알림톡 발송 결과 모달 표시
        function showKakaoResultModal(results, summary) {
            const modal = document.createElement('div');
            modal.className = 'loading-modal';
            modal.innerHTML = `
                <div class="loading-content" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h3>💬 카카오 알림톡 발송 완료</h3>
                        <div style="display: flex; justify-content: space-around; margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                            <div>
                                <div style="font-size: 24px; font-weight: bold; color: #2ecc71;">${summary.success}</div>
                                <div style="color: #666;">발송 성공</div>
                            </div>
                            <div>
                                <div style="font-size: 24px; font-weight: bold; color: #e74c3c;">${summary.failed}</div>
                                <div style="color: #666;">발송 실패</div>
                            </div>
                            <div>
                                <div style="font-size: 24px; font-weight: bold; color: #3498db;">${summary.successRate}%</div>
                                <div style="color: #666;">성공률</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4>📊 발송 결과 상세</h4>
                        <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                                <thead style="background: #f1f2f6; position: sticky; top: 0;">
                                    <tr>
                                        <th style="padding: 8px; border: 1px solid #ddd;">순번</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">이름</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">전화번호</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">검진연도</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">발송상태</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">발송시간</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${results.map((result, index) => `
                                        <tr style="background: ${result.status === 'success' ? '#e8f5e8' : '#ffeaa7'};">
                                            <td style="padding: 6px; border: 1px solid #ddd; text-align: center;">${index + 1}</td>
                                            <td style="padding: 6px; border: 1px solid #ddd;">${result.예약자명}</td>
                                            <td style="padding: 6px; border: 1px solid #ddd;">${result.전화번호}</td>
                                            <td style="padding: 6px; border: 1px solid #ddd;">${result.구강검진대상연도}년</td>
                                            <td style="padding: 6px; border: 1px solid #ddd; text-align: center;">
                                                ${result.status === 'success' ? '✅ 성공' : '❌ 실패'}
                                            </td>
                                            <td style="padding: 6px; border: 1px solid #ddd; font-size: 11px;">${result.sendTime}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="downloadKakaoReport()" style="background: #27ae60; color: white; border: none; padding: 12px 24px; border-radius: 5px; margin-right: 10px; cursor: pointer;">
                            📊 리포트 다운로드
                        </button>
                        <button onclick="this.closest('.loading-modal').remove()" style="background: #95a5a6; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer;">
                            닫기
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 전역 변수에 결과 저장 (리포트 다운로드용)
            window.kakaoSendResults = results;
        }

        // 카카오 알림톡 발송 리포트 다운로드
        function downloadKakaoReport() {
            if (!window.kakaoSendResults) {
                alert('다운로드할 리포트 데이터가 없습니다.');
                return;
            }
            
            const results = window.kakaoSendResults;
            const timestamp = new Date().toISOString().slice(0, 16).replace('T', '_').replace(/:/g, '');
            
            // CSV 헤더
            const headers = [
                '순번', '예약자명', '생년월일', '전화번호', '나이', '구강검진대상연도', 
                '발송상태', '발송결과', '발송시간', '비고'
            ];
            
            // CSV 데이터 생성
            const csvData = [headers];
            results.forEach((result, index) => {
                csvData.push([
                    index + 1,
                    result.예약자명,
                    result.생년월일,
                    result.전화번호,
                    result.나이,
                    result.구강검진대상연도,
                    result.status === 'success' ? '성공' : '실패',
                    result.message,
                    result.sendTime,
                    result.status === 'success' ? '카카오 알림톡 발송 완료' : '발송 실패'
                ]);
            });
            
            // CSV 파일 다운로드
            const csvContent = csvData.map(row => row.join(',')).join('\n');
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `피닉스치과_카카오알림톡발송리포트_${timestamp}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`📊 발송 리포트가 다운로드되었습니다.\n파일명: 피닉스치과_카카오알림톡발송리포트_${timestamp}.csv`);
        }

        // 고객 테이블 업데이트
        function updateCustomerTable() {
            const rawData = getReservationData();
            const consolidatedData = consolidateCustomers(rawData);
            const dataWithDentalInfo = addDentalCheckupInfo(consolidatedData);
            
            const tableBody = document.getElementById('customerTableBody');
            if (!tableBody) return;
            
            // 테이블 내용 초기화
            tableBody.innerHTML = '';
            
            // 새 데이터로 테이블 생성
            dataWithDentalInfo.forEach((customer, index) => {
                const row = document.createElement('tr');
                
                // 구강검진 대상 연도에 따른 배경색 설정
                const currentYear = new Date().getFullYear();
                const bgColor = customer.dentalCheckupYear === currentYear ? '#e8f5e8' : '#ffeaa7';
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${customer.name}</td>
                    <td>${customer.birth}</td>
                    <td>${customer.phone}</td>
                    <td>${customer.date}</td>
                    <td>${customer.time}</td>
                    <td style="background: ${bgColor};">${customer.dentalCheckupInfo}</td>
                    <td>${new Date(customer.createdAt).toLocaleString('ko-KR')}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        // 통계 업데이트
        function updateStatistics() {
            const rawData = getReservationData();
            const consolidatedData = consolidateCustomers(rawData);
            
            const today = new Date().toISOString().split('T')[0];
            const thisWeekStart = new Date();
            thisWeekStart.setDate(thisWeekStart.getDate() - thisWeekStart.getDay());
            const thisWeekStartStr = thisWeekStart.toISOString().split('T')[0];
            
            // 통계 계산
            const totalReservations = consolidatedData.length;
            const todayReservations = consolidatedData.filter(customer => 
                customer.date === today
            ).length;
            const thisWeekReservations = consolidatedData.filter(customer => 
                customer.date >= thisWeekStartStr
            ).length;
            
            // 통계 업데이트
            const totalElement = document.getElementById('totalReservations');
            const todayElement = document.getElementById('todayReservations');
            const weekElement = document.getElementById('thisWeekReservations');
            
            if (totalElement) totalElement.textContent = totalReservations;
            if (todayElement) todayElement.textContent = todayReservations;
            if (weekElement) weekElement.textContent = thisWeekReservations;
        }

        // Finetuning 모델 입력 필드 토글
        function toggleFinetuningInput(provider) {
            const selectElement = document.getElementById(`${provider}Model`);
            const finetuningGroup = document.getElementById(`${provider}FinetuningGroup`);
            
            if (selectElement.value === 'finetuning') {
                finetuningGroup.style.display = 'block';
            } else {
                finetuningGroup.style.display = 'none';
            }
        }

        // 지식 파일 설정 저장
        function saveKnowledgeSettings() {
            console.log('지식 파일 설정 저장');
            
            if (knowledgeBase.files.length === 0) {
                showStatus('knowledgeSettingsStatus', '❌ 업로드된 파일이 없습니다. 먼저 파일을 업로드해주세요.', 'error');
                return;
            }
            
            if (knowledgeBase.parsedData.length === 0) {
                showStatus('knowledgeSettingsStatus', '❌ 파싱된 Q&A 데이터가 없습니다. 파일 형식을 확인해주세요.', 'error');
                return;
            }
            
            // 지식베이스 활성화
            knowledgeBase.enabled = true;
            
            // 로컬 스토리지에 저장 (선택사항)
            try {
                const knowledgeData = {
                    files: knowledgeBase.files.map(f => ({
                        name: f.name,
                        size: f.size,
                        uploadTime: f.uploadTime,
                        content: f.content
                    })),
                    parsedData: knowledgeBase.parsedData,
                    enabled: knowledgeBase.enabled,
                    lastSaved: new Date().toISOString()
                };
                
                // 실제 환경에서는 서버에 저장하거나 다른 저장소 사용
                console.log('지식베이스 데이터 저장됨:', knowledgeData);
                
                showStatus('knowledgeSettingsStatus', 
                    `✅ 지식 파일 설정이 저장되었습니다!\n📚 총 ${knowledgeBase.files.length}개 파일, ${knowledgeBase.parsedData.length}개 Q&A\n🤖 이제 챗봇이 업로드된 지식을 우선적으로 활용합니다.`, 
                    'success');
                
                updateKnowledgeStatus();
                
            } catch (error) {
                console.error('지식 파일 저장 오류:', error);
                showStatus('knowledgeSettingsStatus', '❌ 저장 중 오류가 발생했습니다.', 'error');
            }
        }

        // 지식베이스 검색 테스트
        function testKnowledgeBase() {
            console.log('지식베이스 검색 테스트');
            
            if (!knowledgeBase.enabled || knowledgeBase.parsedData.length === 0) {
                showStatus('knowledgeSettingsStatus', '❌ 활성화된 지식 파일이 없습니다.', 'error');
                return;
            }
            
            const testQueries = ['진료시간', '예약', '비용', '위치', '치료'];
            let testResults = [];
            
            testQueries.forEach(query => {
                const result = searchInKnowledgeBase(query);
                if (result) {
                    testResults.push(`✅ "${query}" - 답변 발견`);
                } else {
                    testResults.push(`❌ "${query}" - 답변 없음`);
                }
            });
            
            const successCount = testResults.filter(r => r.includes('✅')).length;
            const message = `🔍 검색 테스트 결과 (${successCount}/${testQueries.length})\n${testResults.join('\n')}`;
            
            showStatus('knowledgeSettingsStatus', message, successCount > 0 ? 'success' : 'error');
        }

        // 모든 지식 데이터 삭제
        function clearAllKnowledge() {
            if (confirm('모든 업로드된 지식 파일과 데이터를 삭제하시겠습니까?\n이 작업은 되돌릴 수 없습니다.')) {
                knowledgeBase = {
                    files: [],
                    content: '',
                    parsedData: [],
                    enabled: false
                };
                
                // UI 업데이트
                document.getElementById('fileList').innerHTML = '';
                document.getElementById('parsedDataView').style.display = 'none';
                updateKnowledgeStatus();
                
                showStatus('knowledgeSettingsStatus', '🗑️ 모든 지식 데이터가 삭제되었습니다.', 'success');
                console.log('지식베이스 초기화 완료');
            }
        }

        // 파싱된 Q&A 데이터 보기
        function showParsedData() {
            console.log('파싱된 Q&A 데이터 표시');
            const viewElement = document.getElementById('parsedDataView');
            const contentElement = document.getElementById('parsedDataContent');
            
            if (knowledgeBase.parsedData.length === 0) {
                contentElement.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">파싱된 데이터가 없습니다.<br>파일을 업로드하고 파싱을 기다려주세요.</p>';
            } else {
                let html = '';
                knowledgeBase.parsedData.forEach((qa, index) => {
                    html += `
                        <div style="border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: #f8f9fa;">
                            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 10px;">
                                <strong style="color: #495057; font-size: 14px;">#${index + 1} | 출처: ${qa.source}</strong>
                                <small style="color: #6c757d;">라인: ${qa.lineNumber}</small>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #28a745;">Q:</strong> ${qa.question}
                            </div>
                            <div>
                                <strong style="color: #007bff;">A:</strong> ${qa.answer.length > 100 ? qa.answer.substring(0, 100) + '...' : qa.answer}
                            </div>
                        </div>
                    `;
                });
                contentElement.innerHTML = html;
            }
            
            // 토글 표시
            if (viewElement.style.display === 'none') {
                viewElement.style.display = 'block';
            } else {
                viewElement.style.display = 'none';
            }
        }

        // 강화된 답변 생성 (디버깅 로그 포함)
        function generateAIResponse(userMessage) {
            console.log('🤖 AI 응답 생성 시작:', userMessage);
            console.log('📊 현재 지식베이스 상태 - enabled:', knowledgeBase.enabled, '| 데이터 수:', knowledgeBase.parsedData.length);
            
            // 1차: 업로드된 지식 파일에서 답변 검색 (최우선)
            const knowledgeAnswer = searchInKnowledgeBase(userMessage);
            if (knowledgeAnswer) {
                console.log('✅ 지식베이스에서 답변 발견 - 1차 답변 채택');
                return Promise.resolve(knowledgeAnswer);
            }
            
            console.log('➡️ 지식베이스에서 답변을 찾지 못함 - 2차 API 호출 시도');
            
            // 2차: API가 설정되어 있으면 AI API 호출
            if (apiSettings.activeProvider && apiSettings[apiSettings.activeProvider].enabled) {
                console.log('🔗 API 호출로 답변 생성:', apiSettings.activeProvider);
                return callAIAPIWithContext(userMessage);
            }
            
            console.log('💡 API 설정 없음 - 3차 기본 FAQ 응답 사용');
            
            // 3차: 기본 FAQ 응답 (API 설정이 없는 경우)
            return Promise.resolve(getDefaultResponse(userMessage));
        }
        function toggleFinetuningInput(provider) {
            const selectElement = document.getElementById(`${provider}Model`);
            const finetuningGroup = document.getElementById(`${provider}FinetuningGroup`);
            
            if (selectElement.value === 'finetuning') {
                finetuningGroup.style.display = 'block';
            } else {
                finetuningGroup.style.display = 'none';
            }
        }

        // 파일 업로드 관련 함수들
        function handleFileUpload(event) {
            const files = event.target.files;
            processUploadedFiles(files);
        }

        function handleFileDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            processUploadedFiles(files);
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.classList.remove('dragover');
        }

        function processUploadedFiles(files) {
            console.log('파일 업로드 처리 시작:', files.length, '개');
            showStatus('knowledgeSettingsStatus', '📁 파일을 처리하고 있습니다...', 'success');
            
            let processedCount = 0;
            const totalFiles = files.length;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                console.log('파일 처리 중:', file.name, file.type, file.size);
                
                const fileData = {
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    uploadTime: new Date(),
                    content: ''
                };
                
                // 파일 확장자 확인
                const fileExtension = file.name.toLowerCase().split('.').pop();
                
                // PDF 파일 경고
                if (fileExtension === 'pdf' || file.type === 'application/pdf') {
                    console.warn('PDF 파일 감지:', file.name);
                    processedCount++;
                    
                    if (processedCount === totalFiles) {
                        showStatus('knowledgeSettingsStatus', 
                            `❌ PDF 파일은 현재 지원되지 않습니다.\nPDF 내용을 텍스트 파일(.txt)로 복사해서 업로드해주세요.\n\n💡 PDF → 텍스트 변환 방법:\n1. PDF를 열고 내용을 복사\n2. 메모장에 붙여넣기\n3. .txt 파일로 저장 후 업로드`, 
                            'error');
                    }
                    continue;
                }
                
                // 지원되는 파일 형식 처리
                if (fileExtension === 'txt' || file.type === 'text/plain' || file.type === '') {
                    // 텍스트 파일 처리
                    processTextFileWithEncoding(file, fileData, () => {
                        processedCount++;
                        checkAllFilesProcessed();
                    });

                } else if (fileExtension === 'jsonl' || file.type === 'application/jsonl' || file.type === 'text/plain') {
                    // JSONL 파일 처리
                    processJsonlFile(file, fileData, () => {
                        processedCount++;
                        checkAllFilesProcessed();
                    });
                } else {
                    // 지원되지 않는 파일 형식
                    console.warn('지원되지 않는 파일 형식:', file.name, file.type);
                    processedCount++;
                    
                    if (processedCount === totalFiles) {
                        showStatus('knowledgeSettingsStatus', 
                            `❌ 지원되지 않는 파일 형식입니다: ${file.name}\n\n📁 현재 지원되는 파일 형식:\n• 텍스트 파일 (.txt)\n• JSONL 파일 (.jsonl)\n\n💡 PDF나 다른 형식은 텍스트 파일로 변환해서 업로드해주세요.`, 
                            'error');
                    }
                    checkAllFilesProcessed();
                }
            }
            
            // 모든 파일 처리 완료 확인 함수
            function checkAllFilesProcessed() {
                if (processedCount === totalFiles) {
                    console.log('전체 파일 처리 완료');
                    
                    // ✅ 파일 업로드 즉시 지식베이스 자동 활성화
                    knowledgeBase.enabled = knowledgeBase.parsedData.length > 0;
                    
                    updateFileList();
                    updateKnowledgeStatus();
                    
                    if (knowledgeBase.parsedData.length > 0) {
                        const message = `✅ ${totalFiles}개 파일 처리 완료!\n📚 총 ${knowledgeBase.parsedData.length}개의 Q&A가 파싱되었습니다.\n🤖 지식베이스가 자동으로 활성화되었습니다!`;
                        showStatus('knowledgeSettingsStatus', message, 'success');
                        
                        // 즉시 테스트 실행
                        setTimeout(() => {
                            testKnowledgeBaseAuto();
                        }, 1000);
                    } else {
                        showStatus('knowledgeSettingsStatus', 
                            `⚠️ 파일은 읽었지만 Q&A 데이터를 찾지 못했습니다.\n\n📝 올바른 형식 예시:\nQ: 진료시간이 어떻게 되나요?\nA: 평일 09:00-18:00입니다.\n\n또는\n\n1. 예약은 어떻게 하나요?\n온라인이나 전화로 가능합니다.`, 
                            'error');
                    }
                }
            }
        }



        // JSONL 파일 처리 함수
        function processJsonlFile(file, fileData, callback) {
            console.log('📄 JSONL 파일 처리 시작:', file.name);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    fileData.content = content;
                    knowledgeBase.files.push(fileData);
                    parseJsonlContent(fileData);
                    callback();
                    
                } catch (error) {
                    console.error('JSONL 파일 처리 오류:', error);
                    showStatus('knowledgeSettingsStatus', 
                        `❌ JSONL 파일 처리 실패: ${file.name}\n\n💡 JSONL 파일 형식을 확인해주세요.`, 
                        'error');
                    callback();
                }
            };
            
            reader.onerror = function() {
                console.error('JSONL 파일 읽기 오류');
                showStatus('knowledgeSettingsStatus', 
                    `❌ JSONL 파일 읽기 실패: ${file.name}`, 
                    'error');
                callback();
            };
            
            reader.readAsText(file, 'UTF-8');
        }

        // JSONL 내용 파싱
        function parseJsonlContent(fileData) {
            console.log('📄 JSONL 내용 파싱:', fileData.name);
            
            if (!fileData.content || fileData.content.trim().length === 0) {
                console.log('JSONL 내용이 비어있음:', fileData.name);
                return;
            }
            
            const content = fileData.content;
            const lines = content.split(/\r?\n/).map(line => line.trim()).filter(line => line.length > 0);
            console.log('JSONL 파싱할 라인 수:', lines.length);
            
            const parsedQA = [];
            
            // 각 라인을 JSON으로 파싱
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                
                try {
                    const jsonData = JSON.parse(line);
                    
                    // 다양한 JSON 구조 지원
                    let question = '';
                    let answer = '';
                    
                    if (jsonData.question && jsonData.answer) {
                        question = jsonData.question;
                        answer = jsonData.answer;
                    } else if (jsonData.q && jsonData.a) {
                        question = jsonData.q;
                        answer = jsonData.a;
                    } else if (jsonData.질문 && jsonData.답변) {
                        question = jsonData.질문;
                        answer = jsonData.답변;
                    } else if (jsonData.text && jsonData.response) {
                        question = jsonData.text;
                        answer = jsonData.response;
                    } else if (jsonData.prompt && jsonData.completion) {
                        question = jsonData.prompt;
                        answer = jsonData.completion;
                    } else if (jsonData.input && jsonData.output) {
                        question = jsonData.input;
                        answer = jsonData.output;
                    }
                    
                    if (question && answer && question.length > 2 && answer.length > 3) {
                        const qaItem = {
                            question: question,
                            answer: answer,
                            source: fileData.name,
                            lineNumber: i + 1,
                            pattern: 'JSONL'
                        };
                        
                        parsedQA.push(qaItem);
                        console.log('JSONL Q&A 추가:', question.substring(0, 30) + '...');
                    }
                    
                } catch (error) {
                    console.warn(`JSONL 라인 ${i + 1} 파싱 실패:`, error);
                    continue;
                }
            }
            
            // 기존 데이터에 추가 (중복 제거)
            parsedQA.forEach(newQA => {
                const isDuplicate = knowledgeBase.parsedData.some(existingQA => 
                    existingQA.question === newQA.question && existingQA.source === newQA.source
                );
                
                if (!isDuplicate) {
                    knowledgeBase.parsedData.push(newQA);
                }
            });
            
            console.log(`${fileData.name}에서 새로 파싱된 Q&A:`, parsedQA.length, '개');
        }

        // 텍스트 파일을 다양한 인코딩으로 읽기 시도
        function processTextFileWithEncoding(file, fileData, callback) {
            console.log('🔤 텍스트 파일 인코딩 처리:', file.name);
            
            // UTF-8로 먼저 시도
            const reader1 = new FileReader();
            reader1.onload = function(e) {
                try {
                    const content = e.target.result;
                    
                    // 한글이 제대로 읽혔는지 확인
                    const hasKorean = /[가-힣]/.test(content);
                    const hasBrokenChars = /[◆�]/.test(content) || content.includes('�');
                    
                    if (hasKorean && !hasBrokenChars) {
                        console.log('✅ UTF-8 인코딩 성공:', file.name);
                        fileData.content = content;
                        knowledgeBase.files.push(fileData);
                        parseFileContentImproved(fileData);
                        callback();
                        return;
                    }
                    
                    console.log('❌ UTF-8 실패, EUC-KR 시도');
                    // EUC-KR로 재시도
                    tryEucKrEncoding();
                    
                } catch (error) {
                    console.error('UTF-8 읽기 오류:', error);
                    tryEucKrEncoding();
                }
            };
            
            reader1.onerror = function() {
                console.error('UTF-8 파일 읽기 오류');
                tryEucKrEncoding();
            };
            
            // EUC-KR 시도 함수
            function tryEucKrEncoding() {
                const reader2 = new FileReader();
                reader2.onload = function(e) {
                    try {
                        const content = e.target.result;
                        const hasKorean = /[가-힣]/.test(content);
                        const hasBrokenChars = /[◆�]/.test(content) || content.includes('�');
                        
                        if (hasKorean && !hasBrokenChars) {
                            console.log('✅ EUC-KR 인코딩 성공:', file.name);
                            fileData.content = content;
                            knowledgeBase.files.push(fileData);
                            parseFileContentImproved(fileData);
                            callback();
                            return;
                        }
                        
                        // 둘 다 실패한 경우 UTF-8 결과 사용 (영어나 숫자만 있을 수 있음)
                        console.log('⚠️ 한글 감지 실패, UTF-8 결과 사용:', file.name);
                        reader1.readAsText(file, 'UTF-8'); // 다시 UTF-8로 읽어서 사용
                        
                    } catch (error) {
                        console.error('EUC-KR 읽기 오류:', error);
                        // 마지막 수단으로 UTF-8 사용
                        fileData.content = reader1.result || '';
                        knowledgeBase.files.push(fileData);
                        parseFileContentImproved(fileData);
                        callback();
                    }
                };
                
                reader2.onerror = function() {
                    console.error('EUC-KR 파일 읽기 오류');
                    // UTF-8 결과라도 사용
                    fileData.content = reader1.result || '';
                    knowledgeBase.files.push(fileData);
                    parseFileContentImproved(fileData);
                    callback();
                };
                
                reader2.readAsText(file, 'EUC-KR');
            }
            
            // UTF-8부터 시작
            reader1.readAsText(file, 'UTF-8');
        }

        // 개선된 파일 내용 파싱
        function parseFileContentImproved(fileData) {
            console.log('개선된 파일 파싱 시작:', fileData.name);
            
            if (!fileData.content || fileData.content.trim().length === 0) {
                console.log('파일 내용이 비어있음:', fileData.name);
                return;
            }
            
            const content = fileData.content;
            const lines = content.split(/\r?\n/).map(line => line.trim()).filter(line => line.length > 0);
            console.log('파싱할 라인 수:', lines.length);
            
            const parsedQA = [];
            
            // 패턴별 파싱 시도
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                let question = '';
                let answer = '';
                
                // 패턴 1: Q: 질문, A: 답변
                if (line.match(/^[QqㅁㅂㅊㄷㄹㅁㅏqQuestion문질의질문]\s*[:：]\s*(.+)$/i)) {
                    question = line.replace(/^[QqㅁㅂㅊㄷㄹㅁㅏqQuestion문질의질문]\s*[:：]\s*/i, '').trim();
                    
                    // 다음 줄에서 답변 찾기
                    for (let j = i + 1; j < lines.length && j < i + 5; j++) {
                        const nextLine = lines[j];
                        if (nextLine.match(/^[AaAnsw답변답응답]\s*[:：]\s*(.+)$/i)) {
                            answer = nextLine.replace(/^[AaAnsw답변답응답]\s*[:：]\s*/i, '').trim();
                            i = j; // 인덱스 업데이트
                            break;
                        } else if (!nextLine.match(/^[QqㅁㅂㅊㄷㄹㅁㅏqQuestion문질의질문]\s*[:：]/i)) {
                            // Q:가 아니면 답변으로 간주
                            answer = nextLine;
                            i = j;
                            break;
                        }
                    }
                }
                
                // 패턴 2: 숫자. 질문?
                else if (line.match(/^\d+\.\s*(.+[?？])\s*$/)) {
                    question = line.replace(/^\d+\.\s*/, '').trim();
                    if (i + 1 < lines.length && !lines[i + 1].match(/^\d+\./)) {
                        answer = lines[i + 1];
                        i++;
                    }
                }
                
                // 패턴 3: - 질문?
                else if (line.match(/^[-•*]\s*(.+[?？])\s*$/)) {
                    question = line.replace(/^[-•*]\s*/, '').trim();
                    if (i + 1 < lines.length && !lines[i + 1].match(/^[-•*]/)) {
                        answer = lines[i + 1];
                        i++;
                    }
                }
                
                // 패턴 4: 질문 키워드 포함
                else if (line.length > 5 && 
                         (line.includes('?') || line.includes('？') ||
                          line.match(/(어떻게|언제|어디서|왜|무엇|누가|얼마|몇시|어떤|뭔가|어디|몇|언제까지)/))) {
                    question = line;
                    
                    // 다음 몇 줄을 답변으로 수집
                    const answerLines = [];
                    for (let j = i + 1; j < Math.min(i + 4, lines.length); j++) {
                        const nextLine = lines[j];
                        // 다음 질문이 나오면 중단
                        if (nextLine.match(/(어떻게|언제|어디서|왜|무엇|누가|얼마|몇시|어떤)[?？]/) ||
                            nextLine.match(/^[\d\-•*QqㅁㅂㅊㄷㄹㅁㅏqQuestion문질의질문]/)) {
                            break;
                        }
                        answerLines.push(nextLine);
                        if (answerLines.join(' ').length > 200) break; // 너무 길면 중단
                    }
                    
                    if (answerLines.length > 0) {
                        answer = answerLines.join(' ').trim();
                        i += answerLines.length;
                    }
                }
                
                // 패턴 5: 제목: 내용
                else if (line.match(/^([^:：]{2,20})[:：]\s*(.{5,})$/)) {
                    const matches = line.match(/^([^:：]{2,20})[:：]\s*(.{5,})$/);
                    if (matches) {
                        question = matches[1].trim();
                        answer = matches[2].trim();
                    }
                }
                
                // 유효한 Q&A 쌍 저장
                if (question && answer && question.length > 2 && answer.length > 3) {
                    const qaItem = {
                        question: question,
                        answer: answer,
                        source: fileData.name,
                        lineNumber: i + 1,
                        pattern: '자동감지'
                    };
                    
                    parsedQA.push(qaItem);
                    console.log('Q&A 추가:', question.substring(0, 30) + '...');
                }
            }
            
            // 기존 데이터에 추가 (중복 제거)
            parsedQA.forEach(newQA => {
                const isDuplicate = knowledgeBase.parsedData.some(existingQA => 
                    existingQA.question === newQA.question && existingQA.source === newQA.source
                );
                
                if (!isDuplicate) {
                    knowledgeBase.parsedData.push(newQA);
                }
            });
            
            console.log(`${fileData.name}에서 새로 파싱된 Q&A:`, parsedQA.length, '개');
            console.log('전체 Q&A 데이터:', knowledgeBase.parsedData.length, '개');
            
            // 샘플 출력 (디버깅용)
            if (parsedQA.length > 0) {
                console.log('파싱 결과 샘플:');
                parsedQA.slice(0, 2).forEach((qa, idx) => {
                    console.log(`${idx + 1}. Q: ${qa.question}`);
                    console.log(`   A: ${qa.answer.substring(0, 50)}...`);
                });
            }
        }

        function parseFileContent(fileData) {
            console.log('파일 내용 파싱:', fileData.name);
            
            const content = fileData.content;
            const lines = content.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            
            const parsedQA = [];
            
            // 다양한 Q&A 패턴 인식
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                let question = '';
                let answer = '';
                
                // 패턴 1: Q: ... A: ... 형태
                const qaPattern1 = /^([QqㅂquentionQ문질문][\:\.\s]*)\s*(.+)$/;
                const qaPattern2 = /^([AaAnsw답변답A응답][\:\.\s]*)\s*(.+)$/;
                
                if (qaPattern1.test(line)) {
                    question = line.replace(qaPattern1, '$2').trim();
                    // 다음 줄에서 답변 찾기
                    for (let j = i + 1; j < lines.length; j++) {
                        const nextLine = lines[j];
                        if (qaPattern2.test(nextLine)) {
                            answer = nextLine.replace(qaPattern2, '$2').trim();
                            i = j; // 인덱스 업데이트
                            break;
                        } else if (qaPattern1.test(nextLine)) {
                            // 다음 질문이 나오면 중단
                            break;
                        } else if (!qaPattern1.test(nextLine) && !qaPattern2.test(nextLine)) {
                            // 일반 텍스트면 답변으로 간주
                            answer = nextLine;
                            i = j;
                            break;
                        }
                    }
                }
                
                // 패턴 2: 숫자. 질문 형태 (1. 진료시간이 어떻게 되나요?)
                const numberedPattern = /^(\d+[\.\)]\s*)(.+[\?？])\s*$/;
                if (numberedPattern.test(line)) {
                    question = line.replace(numberedPattern, '$2').trim();
                    // 다음 줄을 답변으로 간주
                    if (i + 1 < lines.length && !numberedPattern.test(lines[i + 1])) {
                        answer = lines[i + 1];
                        i++; // 다음 줄 스킵
                    }
                }
                
                // 패턴 3: - 질문 형태
                const dashPattern = /^[\-\•\*]\s*(.+[\?？])\s*$/;
                if (dashPattern.test(line)) {
                    question = line.replace(dashPattern, '$1').trim();
                    if (i + 1 < lines.length && !dashPattern.test(lines[i + 1])) {
                        answer = lines[i + 1];
                        i++;
                    }
                }
                
                // 패턴 4: 질문 키워드가 포함된 라인
                const questionKeywords = ['어떻게', '언제', '어디서', '왜', '무엇', '누가', '얼마', '몇시', '어떤', '?', '？'];
                if (questionKeywords.some(keyword => line.includes(keyword)) && line.length > 5) {
                    question = line;
                    // 다음 몇 줄을 합쳐서 답변으로 사용
                    let answerLines = [];
                    for (let j = i + 1; j < Math.min(i + 4, lines.length); j++) {
                        const nextLine = lines[j];
                        // 다음 질문이 나오면 중단
                        if (questionKeywords.some(keyword => nextLine.includes(keyword)) && nextLine.includes('?')) {
                            break;
                        }
                        answerLines.push(nextLine);
                        if (answerLines.join(' ').length > 100) break; // 너무 길면 중단
                    }
                    if (answerLines.length > 0) {
                        answer = answerLines.join(' ');
                        i += answerLines.length;
                    }
                }
                
                // 패턴 5: 제목: 내용 형태
                const colonPattern = /^([^:：]+)[:：]\s*(.+)$/;
                if (colonPattern.test(line) && line.length > 10) {
                    const matches = line.match(colonPattern);
                    question = matches[1].trim();
                    answer = matches[2].trim();
                }
                
                // 유효한 Q&A 쌍이면 추가
                if (question && answer && question.length > 3 && answer.length > 3) {
                    parsedQA.push({
                        question: question,
                        answer: answer,
                        source: fileData.name,
                        lineNumber: i + 1
                    });
                }
            }
            
            // 기존 데이터에 추가
            knowledgeBase.parsedData = knowledgeBase.parsedData.concat(parsedQA);
            knowledgeBase.enabled = knowledgeBase.parsedData.length > 0;
            
            console.log(`${fileData.name}에서 파싱된 Q&A:`, parsedQA.length, '개');
            console.log('전체 Q&A 데이터:', knowledgeBase.parsedData.length, '개');
            
            // 파싱 결과 미리보기 (디버깅용)
            if (parsedQA.length > 0) {
                console.log('파싱 결과 샘플:', parsedQA.slice(0, 3));
            }
        }

        function updateFileList() {
            const fileListContainer = document.getElementById('fileList');
            fileListContainer.innerHTML = '';
            
            knowledgeBase.files.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-info">
                        <div class="file-name">📄 ${file.name}</div>
                        <div class="file-details">
                            크기: ${(file.size / 1024).toFixed(1)} KB | 
                            업로드: ${file.uploadTime.toLocaleString()}
                        </div>
                    </div>
                    <div class="file-actions">
                        <button class="file-btn btn-danger" onclick="removeFile(${index})">삭제</button>
                    </div>
                `;
                fileListContainer.appendChild(fileItem);
            });
        }

        function updateKnowledgeStatus() {
            const statusElement = document.getElementById('knowledgeStatus');
            const fileCount = knowledgeBase.files.length;
            const qaCount = knowledgeBase.parsedData.length;
            const status = knowledgeBase.enabled ? '✅ 활성' : '❌ 비활성';
            
            let statusHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 10px;">
                    <div style="background: #e3f2fd; padding: 10px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 20px; font-weight: bold; color: #1976d2;">${fileCount}</div>
                        <div style="font-size: 12px; color: #666;">업로드 파일</div>
                    </div>
                    <div style="background: #f3e5f5; padding: 10px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 20px; font-weight: bold; color: #7b1fa2;">${qaCount}</div>
                        <div style="font-size: 12px; color: #666;">파싱된 Q&A</div>
                    </div>
                    <div style="background: ${knowledgeBase.enabled ? '#e8f5e8' : '#ffebee'}; padding: 10px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 16px; font-weight: bold; color: ${knowledgeBase.enabled ? '#2e7d32' : '#c62828'};">${status}</div>
                        <div style="font-size: 12px; color: #666;">상태</div>
                    </div>
                </div>
            `;
            
            if (knowledgeBase.enabled) {
                statusHTML += `
                    <div style="background: #f0f8ff; padding: 10px; border-radius: 8px; border-left: 4px solid #4facfe;">
                        🎯 <strong>AI 답변 우선순위</strong><br>
                        1차: 📚 업로드된 지식 파일 검색<br>
                        2차: 🤖 AI API 모델 활용<br>
                        3차: 💡 기본 FAQ 응답
                    </div>
                `;
            } else {
                statusHTML += `
                    <div style="background: #fff3e0; padding: 10px; border-radius: 8px; border-left: 4px solid #ff9800;">
                        💡 <strong>파일을 업로드하면</strong><br>
                        치과 전문 지식을 바탕으로 더욱 정확한 AI 상담이 가능합니다!
                    </div>
                `;
            }
            
            statusElement.innerHTML = statusHTML;
        }

        function removeFile(index) {
            console.log('파일 삭제:', index);
            knowledgeBase.files.splice(index, 1);
            
            // 파싱된 데이터도 재생성
            knowledgeBase.parsedData = [];
            knowledgeBase.files.forEach(file => {
                parseFileContent(file);
            });
            
            updateFileList();
            updateKnowledgeStatus();
        }

        // 지식베이스에서 답변 검색 (더 관대한 버전)
        function searchInKnowledgeBase(userMessage) {
            if (!knowledgeBase.enabled || knowledgeBase.parsedData.length === 0) {
                console.log('❌ 지식베이스 비활성 또는 데이터 없음 - enabled:', knowledgeBase.enabled, 'dataLength:', knowledgeBase.parsedData.length);
                return null;
            }
            
            const message = userMessage.toLowerCase().trim();
            console.log('🔍 지식베이스 검색 시작:', message, '| 총 데이터:', knowledgeBase.parsedData.length);
            
            // 검색 결과를 점수별로 저장
            let searchResults = [];
            
            for (let qa of knowledgeBase.parsedData) {
                const question = qa.question.toLowerCase();
                const answer = qa.answer.toLowerCase();
                let score = 0;
                let matchDetails = [];
                
                // 1. 완전 일치 (최고 점수)
                if (question === message || answer.includes(message)) {
                    score += 1000;
                    matchDetails.push('완전일치');
                }
                
                // 2. 부분 문자열 포함 (높은 점수)
                if (question.includes(message) || message.includes(question)) {
                    score += 800;
                    matchDetails.push('부분포함');
                }
                
                // 3. 개별 단어 매칭 (중간 점수)
                const messageWords = message.split(/\s+/).filter(word => word.length > 1);
                const questionWords = question.split(/\s+/).filter(word => word.length > 1);
                
                let wordMatches = 0;
                for (let word of messageWords) {
                    if (question.includes(word)) {
                        score += 200;
                        wordMatches++;
                    }
                    if (answer.includes(word)) {
                        score += 100;
                        wordMatches++;
                    }
                }
                
                if (wordMatches > 0) {
                    matchDetails.push(`단어매칭(${wordMatches})`);
                }
                
                // 4. 유사 단어 매칭
                for (let qWord of questionWords) {
                    for (let mWord of messageWords) {
                        if ((qWord.includes(mWord) || mWord.includes(qWord)) && mWord.length > 1) {
                            score += 50;
                        }
                    }
                }
                
                // 5. 주제별 키워드 매칭 (더 관대하게)
                const topics = {
                    '시간': ['시간', '언제', '몇시', '오픈', '문여', '운영', '근무', '진료시간', '열어', '닫어'],
                    '예약': ['예약', '신청', '접수', '방문', '가고싶', '상담', '예약하기', '신청하기', '예약문의', '신청문의'],
                    '비용': ['비용', '가격', '얼마', '돈', '금액', '료', '수가', '치료비', '진료비', '요금', '값'],
                    '위치': ['위치', '주소', '어디', '찾아', '오시는길', '교통', '길', '찾기', '어디에', '어느곳'],
                    '치료': ['치료', '시술', '수술', '처치', '진료', '의료', '병원', '치과'],
                    '통증': ['아프', '통증', '아픈', '쓰라린', '불편', '고통', '아파'],
                    '임플란트': ['임플란트', '인공치아', '심기', '식립', '인공', '뼈에'],
                    '교정': ['교정', '브라켓', '치열', '가지런', '고르게', '반듯', '삐뚤'],
                    '미백': ['미백', '하얗게', '희게', '밝게', '화이트닝', '하양'],
                    '보철': ['보철', '크라운', '씌우기', '씌워', '덮개', '덮어'],
                    '소아': ['소아', '어린이', '아이', '아동', '유아', '애기'],
                    '충치': ['충치', '우식', '썩', '벌레', '구멍', '까맣']
                };
                
                let topicMatches = 0;
                for (let [topic, keywords] of Object.entries(topics)) {
                    for (let keyword of keywords) {
                        if (message.includes(keyword)) {
                            if (question.includes(keyword) || answer.includes(keyword) || question.includes(topic)) {
                                score += 150; // 점수 상향
                                topicMatches++;
                            }
                        }
                    }
                }
                
                if (topicMatches > 0) {
                    matchDetails.push(`주제매칭(${topicMatches})`);
                }
                
                if (score > 0) {
                    searchResults.push({ qa, score, matchDetails });
                    console.log(`📝 검색 후보: "${qa.question.substring(0, 40)}..." | 점수: ${score} | 매칭: ${matchDetails.join(', ')}`);
                }
            }
            
            // 점수별 정렬
            searchResults.sort((a, b) => b.score - a.score);
            
            console.log(`📊 총 검색 결과: ${searchResults.length}개`);
            if (searchResults.length > 0) {
                console.log(`🏆 최고 점수: ${searchResults[0].score} | 질문: "${searchResults[0].qa.question}"`);
            }
            
            // ✅ 점수 기준을 30점으로 낮춤 (더 관대하게)
            if (searchResults.length > 0 && searchResults[0].score >= 30) {
                const bestMatch = searchResults[0].qa;
                console.log('✅ 지식베이스 답변 선택:', bestMatch.question);
                return formatKnowledgeBaseAnswer(bestMatch, userMessage);
            }
            
            console.log('❌ 지식베이스에서 적절한 답변을 찾지 못함 (최고점수:', searchResults.length > 0 ? searchResults[0].score : 0, ')');
            return null;
        }

        // 자동 지식베이스 테스트 (파일 업로드 후 실행)
        function testKnowledgeBaseAuto() {
            console.log('🧪 자동 지식베이스 테스트 시작');
            
            if (!knowledgeBase.enabled || knowledgeBase.parsedData.length === 0) {
                console.log('❌ 테스트 불가: 지식베이스 비활성');
                return;
            }
            
            // 업로드된 Q&A 중 몇 개를 무작위로 테스트
            const testQueries = [];
            
            // 파싱된 질문 중 일부를 테스트 쿼리로 사용
            for (let i = 0; i < Math.min(3, knowledgeBase.parsedData.length); i++) {
                const qa = knowledgeBase.parsedData[i];
                const question = qa.question;
                
                // 질문에서 핵심 키워드 추출해서 테스트
                const keywords = question.toLowerCase().split(/\s+/).filter(word => 
                    word.length > 2 && !['어떻게', '언제', '어디서', '왜', '무엇', '누가'].includes(word)
                );
                
                if (keywords.length > 0) {
                    testQueries.push(keywords[0]); // 첫 번째 키워드로 테스트
                }
            }
            
            // 기본 테스트 키워드도 추가
            testQueries.push('진료시간', '예약', '비용');
            
            let successCount = 0;
            let testResults = [];
            
            testQueries.forEach(query => {
                const result = searchInKnowledgeBase(query);
                if (result) {
                    testResults.push(`✅ "${query}" - 답변 발견`);
                    successCount++;
                } else {
                    testResults.push(`❌ "${query}" - 답변 없음`);
                }
            });
            
            const message = `🧪 자동 테스트 완료 (${successCount}/${testQueries.length})\n${testResults.join('\n')}\n\n${successCount > 0 ? '🎉 지식베이스가 정상 작동합니다!' : '⚠️ 지식베이스 검색에 문제가 있을 수 있습니다.'}`;
            
            showStatus('knowledgeSettingsStatus', message, successCount > 0 ? 'success' : 'error');
        }

        // 지식베이스 답변을 친절하게 포맷팅
        function formatKnowledgeBaseAnswer(qa, originalQuestion) {
            let formattedAnswer = qa.answer.trim();
            
            // 기본 텍스트 포맷팅
            formattedAnswer = formattedAnswer
                .replace(/\n\n/g, '<br><br>')
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // 번호나 목록이 있으면 구조화
            if (formattedAnswer.includes('1.') || formattedAnswer.includes('•') || formattedAnswer.includes('-')) {
                formattedAnswer = formattedAnswer
                    .replace(/(\d+\.)/g, '<br>$1')
                    .replace(/(•)/g, '<br>$1')
                    .replace(/^-/gm, '<br>•');
            }
            
            return `📚 <strong>피닉스 치과 전문 안내</strong><br><br>
            ${formattedAnswer}<br><br>
            <div style="background: #f0f8ff; padding: 10px; border-radius: 8px; margin-top: 10px;">
                💡 <strong>추가 도움이 필요하시다면:</strong><br>
                📞 전화상담: 070-1234-1234 (24시간)<br>
                🕘 진료시간: 평일 09:00-18:00, 토요일 09:00-15:00<br>
                📍 위치: 강남역 3번 출구 도보 5분
            </div><br>
            <small>📖 출처: ${qa.source} | 더 궁금한 점이 있으시면 언제든 문의해주세요!</small>`;
        }

        // 페이지 로드 완료
        console.log('모든 함수 로드 완료');
        console.log('로그인 함수 확인:', typeof loginChatbotAdmin === 'function', typeof loginCustomerAdmin === 'function');

        // 전화번호 자동 포맷팅 초기화
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM 로드 완료 - 예약 페이지 초기화');
            
            // 전화번호 자동 포맷팅
            setTimeout(() => {
                const phoneInput = document.getElementById('phoneNumber');
                if (phoneInput) {
                    phoneInput.addEventListener('input', function(e) {
                        let value = e.target.value.replace(/[^0-9]/g, '');
                        if (value.length > 3 && value.length <= 7) {
                            value = value.replace(/(\d{3})(\d+)/, '$1-$2');
                        } else if (value.length > 7) {
                            value = value.replace(/(\d{3})(\d{4})(\d{0,4})/, '$1-$2-$3');
                        }
                        e.target.value = value;
                    });
                    console.log('전화번호 자동 포맷팅 설정 완료');
                }
            }, 100);
            
            // 해시/파라미터로 바로 메뉴 열기
            const hash = window.location.hash;
            if (hash === '#reservation') {
                openReservation();
            }
        });

        // 관리자 로그인 처리 함수
        async function handleAdminLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;
            const statusDiv = document.getElementById('loginStatus');
            
            if (!email || !password) {
                statusDiv.innerHTML = '<span style="color: red;">이메일과 비밀번호를 입력해주세요.</span>';
                return;
            }
            
            statusDiv.innerHTML = '<span style="color: blue;">로그인 중...</span>';
            
            try {
                // Netlify Functions 시도
                try {
                    const response = await fetch('/.netlify/functions/admin-login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ email, password })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok && data.token) {
                        // 로그인 성공 - 토큰을 sessionStorage에 저장
                        sessionStorage.setItem('adminToken', data.token);
                        sessionStorage.setItem('adminEmail', email);
                        
                        statusDiv.innerHTML = '<span style="color: green;">✅ 로그인 성공!</span>';
                        
                        // 팝업 닫기
                        setTimeout(() => {
                            closeAdminLoginPopup();
                            
                            // 로그인 타입에 따라 다른 페이지 열기
                            if (window.currentLoginType === 'customer') {
                                openCustomerAdmin();
                            } else if (window.currentLoginType === 'chatbot') {
                                openChatbotAdmin2();
                            }
                        }, 1000);
                        
                        return;
                    } else {
                        throw new Error(data.error || 'Netlify Functions 로그인 실패');
                    }
                    
                } catch (netlifyError) {
                    console.log('Netlify Functions 실패, 직접 Supabase 연결 시도:', netlifyError);
                    
                    // 직접 Supabase 연결 (Netlify Functions 실패 시 대안)
                    // 보안상 프론트엔드에서 키 제거 - Netlify Functions만 사용
                    console.log('Netlify Functions 실패로 인해 직접 로그인 불가능');
                    throw new Error('Netlify Functions 연결 실패 - 관리자에게 문의하세요');
                    
                    // Netlify Functions 실패 시 로그인 불가능
                    statusDiv.innerHTML = '<span style="color: red;">❌ 서버 연결 실패 - 잠시 후 다시 시도해주세요</span>';
                }
                
            } catch (error) {
                console.error('로그인 오류:', error);
                statusDiv.innerHTML = '<span style="color: red;">❌ 네트워크 오류가 발생했습니다.</span>';
            }
        }

        // 관리자 로그인 팝업 닫기
        function closeAdminLoginPopup() {
            document.getElementById('adminLoginPopup').style.display = 'none';
            document.getElementById('adminEmail').value = '';
            document.getElementById('adminPassword').value = '';
            document.getElementById('loginStatus').innerHTML = '';
        }

        // 로그인 상태 확인 함수
        function checkAdminLogin() {
            const token = sessionStorage.getItem('adminToken');
            return token ? true : false;
        }

        // 로그아웃 함수
        function logoutAdmin() {
            sessionStorage.removeItem('adminToken');
            sessionStorage.removeItem('adminEmail');
            alert('로그아웃되었습니다.');
            location.reload();
        }
    </script>

    <!-- 관리자 로그인 팝업 -->
    <div id="adminLoginPopup" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: white; border-radius: 15px; padding: 30px; max-width: 400px; width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <h3 style="text-align: center; margin-bottom: 25px; color: #2c3e50;">🔐 관리자 로그인</h3>
            
            <form id="adminLoginForm" onsubmit="handleAdminLogin(event)">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">이메일</label>
                    <input type="email" id="adminEmail" required style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;" placeholder="관리자 이메일을 입력하세요">
                </div>
                
                <div style="margin-bottom: 25px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">비밀번호</label>
                    <input type="password" id="adminPassword" required style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;" placeholder="비밀번호를 입력하세요">
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button type="button" onclick="closeAdminLoginPopup()" style="flex: 1; padding: 12px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">취소</button>
                    <button type="submit" style="flex: 1; padding: 12px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer;">로그인</button>
                </div>
            </form>
            
            <div id="loginStatus" style="margin-top: 15px; text-align: center; font-size: 14px;"></div>
        </div>
    </div>

</body>
</html>