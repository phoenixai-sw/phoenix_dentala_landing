<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>피닉스 치과 AI 상담사</title>
    
    <!-- 카카오톡 인앱 브라우저 캐시 방지 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="format-detection" content="telephone=no">
    <meta name="format-detection" content="address=no">
    <meta name="format-detection" content="email=no">
    
    <!-- 모바일 최적화 메타 태그 -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-touch-fullscreen" content="yes">
    <meta name="theme-color" content="#4facfe">
    
    <!-- iOS 13+ 동적 뷰포트 높이 지원 -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- 안드로이드 크롬 브라우저 최적화 -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="피닉스 치과 AI챗봇">
    
    <!-- 카카오톡 브라우저 최적화 -->
    <meta name="kakao-link-color" content="#4facfe">
    <meta name="kakao-link-bgcolor" content="#ffffff">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* iOS Safari 뷰포트 높이 문제 해결 */
        :root {
            --vh: 1vh;
            --safe-area-inset-top: env(safe-area-inset-top);
            --safe-area-inset-right: env(safe-area-inset-right);
            --safe-area-inset-bottom: env(safe-area-inset-bottom);
            --safe-area-inset-left: env(safe-area-inset-left);
        }

        /* 터치 스크롤 최적화 */
        html, body {
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            touch-action: manipulation;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f2f5;
            height: 100vh;
            height: calc(var(--vh, 1vh) * 100);
            overflow: hidden;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            -webkit-overflow-scrolling: touch;
        }

        .chatbot-main {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: white;
            position: relative;
        }

        /* 헤더 */
        .chatbot-header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 18px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
            flex-shrink: 0;
            order: 1;
        }

        .chatbot-title {
            font-size: 22px;
            font-weight: bold;
            margin: 0;
        }

        .back-link {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            width: 68px;
            height: 75px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            transition: all 0.3s ease;
            padding: 4px;
            text-decoration: none;
            z-index: 1000;
        }

        .back-link:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-50%) scale(1.1);
        }

        .home-icon {
            font-size: 27px;
            line-height: 1;
        }

        .home-arrow {
            font-size: 17px;
            line-height: 1;
            margin-top: 3px;
        }

        /* 우측 상단 언어 선택 드롭다운 */
        .header-language-dropdown {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 2000;
        }

        .language-dropdown {
            position: relative;
            display: inline-block;
        }

        .language-current {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            border: 2px solid #ffbf00;
            color: black !important;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 120px;
            justify-content: center;
            box-shadow: 0 3px 10px rgba(255, 215, 0, 0.4);
        }

        .language-current:hover {
            background: linear-gradient(135deg, #ffbf00 0%, #ffd700 100%);
            color: black !important;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(255, 215, 0, 0.6);
        }

        .language-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 3000;
            display: none;
            min-width: 140px;
            margin-top: 5px;
        }

        .language-menu.show {
            display: block;
        }

        .language-option {
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 1px solid #eee;
            font-size: 14px;
            color: black !important;
        }

        .language-option:last-child {
            border-bottom: none;
        }

        .language-option:hover {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: black !important;
        }

        .language-option.active {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: black !important;
        }

        /* 메시지 영역 */
        .chatbot-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
            -webkit-overflow-scrolling: touch;
            order: 2;
            margin-bottom: 80px; /* 입력창 공간 확보 */
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .message.bot .message-avatar {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .message.user .message-avatar {
            background: #e9ecef;
            color: #495057;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.4;
            font-size: 14px;
        }

        .message.bot .message-content {
            background: white;
            color: #333;
            border-bottom-left-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .message.user .message-content {
            background: #4facfe;
            color: white;
            border-bottom-right-radius: 6px;
        }

        /* 빠른 버튼 */
        .quick-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .quick-button {
            background: #f0f8ff;
            color: #4facfe;
            border: 1px solid #4facfe;
            border-radius: 15px;
            padding: 8px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            touch-action: manipulation;
        }

        .quick-button:hover {
            background: #4facfe;
            color: white;
        }

        /* 입력 영역 - 화면 하단 고정 */
        .chatbot-input {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #ddd;
            padding: 15px;
            display: flex;
            gap: 10px;
            align-items: flex-end;
            z-index: 1000;
            order: 3;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .chatbot-input textarea {
            flex: 1;
            border: 2px solid #4facfe;
            border-radius: 20px;
            padding: 12px 16px;
            font-size: 16px;
            resize: none;
            outline: none;
            min-height: 45px;
            max-height: 120px;
            line-height: 1.4;
            -webkit-user-select: text;
            user-select: text;
            touch-action: manipulation;
        }

        .chatbot-input textarea:focus {
            border-color: #00f2fe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.2);
        }

        .chatbot-send {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 108px;
            height: 45px;
            touch-action: manipulation;
        }

        .chatbot-send:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
        }

        .chatbot-send:active {
            transform: translateY(0);
        }

        /* 반응형 디자인 - 모바일 최적화 */
        @media (max-width: 768px) {
            .chatbot-header {
                padding: 15px 8px;
            }
            
            .chatbot-title {
                font-size: 18px;
                margin: 0 120px; /* 좌우 버튼 공간 확보 */
            }
            
            .back-link {
                width: 52px;
                height: 58px;
                left: 8px;
            }
            
            .home-icon {
                font-size: 22px;
            }
            
            .home-arrow {
                font-size: 14px;
            }
            
            .header-language-dropdown {
                right: 8px;
            }
            
            .language-current {
                padding: 8px 12px;
                font-size: 12px;
                min-width: 100px;
                color: black !important;
            }
            
            .language-option {
                color: black !important;
            }
            
            .chatbot-messages {
                padding: 15px;
                margin-bottom: 75px;
            }
            
            /* 환영 메시지 일반 모바일 최적화 */
            .message.bot .message-content div[style*="font-size: 18px"] {
                font-size: 17px !important;
            }
            
            .message.bot .message-content div[style*="font-size: 14px"] {
                font-size: 13px !important;
                line-height: 1.5 !important;
                padding: 0 5px !important;
            }
            
            .quick-buttons {
                gap: 8px !important;
                justify-content: center !important;
            }
            
            .quick-button {
                font-size: 12px !important;
                padding: 8px 12px !important;
                border-radius: 12px !important;
            }
            
            .chatbot-input {
                padding: 10px;
            }
            
            .chatbot-send {
                min-width: 80px;
                padding: 10px 20px;
                font-size: 14px;
            }
        }

        @media (max-width: 480px) {
            .chatbot-header {
                padding: 12px 5px;
            }
            
            .chatbot-title {
                font-size: 16px;
                margin: 0 100px;
            }
            
            .back-link {
                width: 45px;
                height: 50px;
                left: 5px;
            }
            
            .home-icon {
                font-size: 20px;
            }
            
            .home-arrow {
                font-size: 12px;
            }
            
            .header-language-dropdown {
                right: 5px;
            }
            
            .language-current {
                padding: 6px 10px;
                font-size: 11px;
                min-width: 85px;
                color: black !important;
            }
            
            .language-option {
                color: black !important;
            }
            
            .chatbot-messages {
                padding: 10px;
                margin-bottom: 70px;
            }
            
            /* 환영 메시지 480px 이하 모바일 최적화 */
            .message.bot .message-content div[style*="font-size: 18px"] {
                font-size: 16px !important;
            }
            
            .message.bot .message-content div[style*="font-size: 14px"] {
                font-size: 12px !important;
                line-height: 1.4 !important;
                padding: 0 3px !important;
            }
            
            .quick-buttons {
                gap: 6px !important;
                justify-content: center !important;
            }
            
            .quick-button {
                font-size: 11px !important;
                padding: 6px 10px !important;
                border-radius: 10px !important;
            }
            
            .chatbot-input {
                padding: 8px;
            }
            
            .chatbot-send {
                min-width: 70px;
                padding: 8px 16px;
                font-size: 13px;
            }
        }

        /* Galaxy XCover 5 특별 최적화 */
        @media screen and (max-width: 432px) and (max-height: 900px) {
            .chatbot-header {
                padding: 10px 5px;
            }
            
            .chatbot-title {
                font-size: 15px;
                margin: 0 90px;
            }
            
            .back-link {
                width: 40px;
                height: 45px;
                left: 5px;
            }
            
            .home-icon {
                font-size: 18px;
            }
            
            .home-arrow {
                font-size: 10px;
            }
            
            .header-language-dropdown {
                right: 5px;
            }
            
            .language-current {
                padding: 5px 8px;
                font-size: 10px;
                min-width: 75px;
            }
            
            .chatbot-messages {
                padding: 8px;
                margin-bottom: 65px;
            }
            
            .chatbot-input {
                padding: 6px;
            }
            
            .chatbot-input textarea {
                font-size: 14px;
                padding: 10px 12px;
            }
            
            .chatbot-send {
                min-width: 60px;
                padding: 6px 12px;
                font-size: 12px;
            }
        }

        /* 아이폰 미니 특별 최적화 */
        @media screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) {
            .chatbot-header {
                padding: 12px 5px;
            }
            
            .chatbot-title {
                font-size: 16px;
                margin: 0 95px;
            }
            
            .header-language-dropdown {
                right: 5px;
            }
            
            .language-current {
                padding: 6px 10px;
                font-size: 11px;
                min-width: 80px;
            }
            
            .chatbot-messages {
                margin-bottom: 70px;
            }
        }

        /* 카카오톡 브라우저 특별 최적화 */
        .kakao-optimized {
            -webkit-overflow-scrolling: touch;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }

        /* iOS Safari 특별 최적화 */
        @supports (-webkit-touch-callout: none) {
            .chatbot-main {
                height: 100vh;
                height: -webkit-fill-available;
            }
            
            .chatbot-input {
                padding-bottom: env(safe-area-inset-bottom, 15px);
            }
            
            .chatbot-messages {
                padding-bottom: calc(80px + env(safe-area-inset-bottom, 0px));
            }
        }

        /* 아이폰11 특별 최적화 (414×896) */
        @media screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) {
            .chatbot-header {
                padding: 15px 8px;
            }
            
            .chatbot-title {
                font-size: 18px;
                margin: 0 130px;
            }
            
            .header-language-dropdown {
                right: 8px;
            }
            
            .language-current {
                padding: 8px 12px;
                font-size: 13px;
                min-width: 110px;
                color: black !important;
            }
            
            .language-option {
                color: black !important;
            }
            
            .chatbot-messages {
                margin-bottom: 85px;
            }
            
            /* 환영 메시지 아이폰11 최적화 */
            .message.bot .message-content div[style*="font-size: 18px"] {
                font-size: 18px !important;
            }
            
            .message.bot .message-content div[style*="font-size: 14px"] {
                font-size: 14px !important;
                line-height: 1.5 !important;
            }
            
            .quick-buttons {
                gap: 10px !important;
            }
            
            .quick-button {
                font-size: 13px !important;
                padding: 8px 14px !important;
            }
        }

        /* 아이폰 미니 추가 최적화 (375×812) */
        @media screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) {
            .chatbot-header {
                padding: 12px 5px;
                position: sticky;
                top: 0;
                z-index: 100;
            }
            
            .chatbot-title {
                font-size: 16px;
                margin: 0 100px;
                line-height: 1.2;
            }
            
            .header-language-dropdown {
                right: 5px;
            }
            
            .language-current {
                padding: 6px 10px;
                font-size: 11px;
                min-width: 85px;
                color: black !important;
            }
            
            .language-option {
                color: black !important;
            }
            
            .chatbot-messages {
                margin-bottom: 75px;
                padding: 10px;
            }
            
            /* 환영 메시지 아이폰 미니 최적화 */
            .message.bot .message-content div[style*="font-size: 18px"] {
                font-size: 17px !important;
            }
            
            .message.bot .message-content div[style*="font-size: 14px"] {
                font-size: 13px !important;
                line-height: 1.5 !important;
            }
            
            .quick-buttons {
                gap: 8px !important;
            }
            
            .quick-button {
                font-size: 12px !important;
                padding: 7px 12px !important;
            }
            
            .chatbot-input {
                padding: 8px;
            }
            
            .chatbot-input textarea {
                font-size: 16px; /* iOS zoom 방지 */
                padding: 10px 14px;
            }
        }

        /* Galaxy XCover 5 및 유사 안드로이드 기기 최적화 */
        @media screen and (max-width: 432px) and (max-height: 900px) and (orientation: portrait) {
            body {
                font-size: 14px;
            }
            
            .chatbot-header {
                padding: 10px 5px;
                position: sticky;
                top: 0;
                z-index: 100;
            }
            
            .chatbot-title {
                font-size: 15px;
                margin: 0 95px;
                line-height: 1.2;
            }
            
            .back-link {
                width: 42px;
                height: 47px;
                left: 5px;
            }
            
            .home-icon {
                font-size: 18px;
            }
            
            .home-arrow {
                font-size: 10px;
            }
            
            .header-language-dropdown {
                right: 5px;
            }
            
            .language-current {
                padding: 5px 8px;
                font-size: 10px;
                min-width: 80px;
                color: black !important;
            }
            
            .language-menu {
                min-width: 120px;
                font-size: 12px;
            }
            
            .language-option {
                padding: 10px 16px;
                font-size: 12px;
                color: black !important;
            }
            
            .chatbot-messages {
                padding: 8px;
                margin-bottom: 70px;
            }
            
            .message-content {
                max-width: 85%;
                font-size: 13px;
                padding: 10px 14px;
            }
            
            /* 환영 메시지 Galaxy XCover 5 최적화 */
            .message.bot .message-content div[style*="font-size: 18px"] {
                font-size: 16px !important;
            }
            
            .message.bot .message-content div[style*="font-size: 14px"] {
                font-size: 12px !important;
                line-height: 1.5 !important;
            }
            
            .quick-buttons {
                gap: 6px !important;
            }
            
            .quick-button {
                font-size: 11px !important;
                padding: 6px 10px !important;
            }
            
            .chatbot-input {
                padding: 6px;
            }
            
            .chatbot-input textarea {
                font-size: 16px; /* 안드로이드 zoom 방지 */
                padding: 10px 12px;
                min-height: 42px;
            }
            
            .chatbot-send {
                min-width: 65px;
                padding: 6px 14px;
                font-size: 12px;
                height: 42px;
            }
        }

        /* 극소형 모바일 (320px 이하) 최적화 */
        @media screen and (max-width: 320px) {
            .chatbot-title {
                font-size: 14px;
                margin: 0 80px;
            }
            
            .back-link {
                width: 35px;
                height: 40px;
                left: 3px;
            }
            
            .home-icon {
                font-size: 16px;
            }
            
            .home-arrow {
                font-size: 9px;
            }
            
            .header-language-dropdown {
                right: 3px;
            }
            
            .language-current {
                padding: 4px 6px;
                font-size: 9px;
                min-width: 70px;
                color: black !important;
            }
            
            .language-option {
                color: black !important;
            }
            
            .chatbot-messages {
                padding: 6px;
                margin-bottom: 65px;
            }
            
            .message-content {
                max-width: 90%;
                font-size: 12px;
                padding: 8px 12px;
            }
            
            /* 환영 메시지 모바일 최적화 */
            .message.bot .message-content div[style*="font-size: 18px"] {
                font-size: 16px !important;
            }
            
            .message.bot .message-content div[style*="font-size: 14px"] {
                font-size: 13px !important;
                line-height: 1.4 !important;
            }
            
            .chatbot-input textarea {
                font-size: 16px;
                padding: 8px 10px;
                min-height: 38px;
            }
            
            .chatbot-send {
                min-width: 55px;
                padding: 5px 10px;
                font-size: 11px;
                height: 38px;
            }
        }

        /* 가로 모드 최적화 */
        @media screen and (orientation: landscape) and (max-height: 500px) {
            .chatbot-header {
                padding: 8px;
            }
            
            .chatbot-title {
                font-size: 16px;
            }
            
            .back-link {
                width: 45px;
                height: 50px;
            }
            
            .language-current {
                padding: 6px 10px;
                font-size: 12px;
            }
            
            .chatbot-messages {
                margin-bottom: 60px;
                padding: 10px;
            }
            
            .chatbot-input {
                padding: 8px;
            }
        }

        /* 모바일 기기 터치 이벤트 최적화 */
        .quick-button {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            touch-action: manipulation;
            position: relative;
            overflow: hidden;
        }

        .quick-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .quick-button:active {
            transform: translateY(0);
        }

        /* 진료시간 버튼 호버 효과 */
        .clinic-hours-btn:hover {
            background: linear-gradient(135deg, #ffed4e 0%, #ffd700 100%) !important;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.4) !important;
        }

        /* 치료비용 버튼 호버 효과 */
        .treatment-cost-btn:hover {
            background: linear-gradient(135deg, #42a5f5 0%, #1e88e5 100%) !important;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(30, 136, 229, 0.4) !important;
        }

        /* 예약문의 버튼 호버 효과 */
        .reservation-btn:hover {
            background: linear-gradient(135deg, #ff1493 0%, #ff69b4 100%) !important;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 105, 180, 0.4) !important;
        }

        /* 오시는길 버튼 호버 효과 */
        .directions-btn:hover {
            background: linear-gradient(135deg, #8bc34a 0%, #4caf50 100%) !important;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.4) !important;
        }

        /* 카카오톡 브라우저 최적화 */
        .kakao-optimized .quick-button {
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            touch-action: manipulation;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            border: none;
            outline: none;
        }

        /* 아이폰 11 최적화 (414×896) */
        @media screen and (device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) {
            .quick-buttons {
                gap: 8px !important;
                padding: 5px !important;
            }
            
            .quick-button {
                padding: 10px 6px !important;
                font-size: 12px !important;
                font-weight: bold !important;
                border-radius: 18px !important;
                min-height: 36px !important;
            }
        }

        /* 아이폰 미니 최적화 (375×812) */
        @media screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) {
            .quick-buttons {
                gap: 6px !important;
                padding: 3px !important;
            }
            
            .quick-button {
                padding: 8px 5px !important;
                font-size: 11px !important;
                font-weight: bold !important;
                border-radius: 16px !important;
                min-height: 34px !important;
            }
        }

        /* Galaxy XCover 5 최적화 */
        @media screen and (max-width: 432px) and (max-height: 900px) and (orientation: portrait) {
            .quick-buttons {
                gap: 6px !important;
                padding: 3px !important;
                max-width: 280px !important;
            }
            
            .quick-button {
                padding: 8px 4px !important;
                font-size: 10px !important;
                font-weight: bold !important;
                border-radius: 15px !important;
                min-height: 32px !important;
            }
        }

        /* 극도로 작은 화면 최적화 */
        @media (max-width: 320px) {
            .quick-buttons {
                gap: 4px !important;
                padding: 2px !important;
                max-width: 260px !important;
            }
            
            .quick-button {
                padding: 6px 3px !important;
                font-size: 9px !important;
                font-weight: bold !important;
                border-radius: 12px !important;
                min-height: 28px !important;
            }
        }

        /* 터치 이벤트 강화 */
        .quick-button {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform, box-shadow;
        }

        .quick-button:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.3);
        }

        /* 카카오톡 브라우저 캐시 방지 */
        .kakao-optimized * {
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
        }

        /* 메시지 영역 터치 최적화 */
        .chatbot-messages {
            -webkit-overflow-scrolling: touch;
            overflow-scrolling: touch;
            scroll-behavior: smooth;
        }

        /* 입력 영역 터치 최적화 */
        .chatbot-input textarea {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            border-radius: 20px;
            outline: none;
        }

        .chatbot-send {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
            outline: none;
            border: none;
            cursor: pointer;
        }

        /* 드롭다운 메뉴 터치 최적화 */
        .language-dropdown {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }

        .language-current {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
            cursor: pointer;
            outline: none;
            border: none;
        }

        .language-option {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
            cursor: pointer;
        }

        .language-option:hover {
            background: rgba(79, 172, 254, 0.1);
        }

        .language-option:active {
            background: rgba(79, 172, 254, 0.2);
        }

        /* 백 버튼 터치 최적화 */
        .back-link {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
            outline: none;
            border: none;
            cursor: pointer;
        }

        .back-link:active {
            transform: translateY(-50%) scale(0.95);
        }

        /* 특정 모바일 기기 최적화 */
        @media screen and (max-width: 600px) {
            .chatbot-main {
                font-size: 14px;
            }
            
            .quick-button {
                font-size: 12px;
                padding: 10px 8px;
            }
            
            .chatbot-messages {
                padding: 15px;
            }
        }

        /* 추가 모바일 기기 최적화 */
        @media screen and (max-width: 480px) {
            .quick-button {
                font-size: 11px;
                padding: 8px 6px;
                min-height: 32px;
            }
            
            .quick-buttons {
                gap: 6px;
                max-width: 280px;
            }
        }

        /* 뷰포트 높이 설정 */
        @media screen and (max-height: 600px) {
            .chatbot-messages {
                max-height: 350px;
            }
        }

        /* 뷰포트 폰트 크기 조정 */
        @media screen and (max-width: 360px) {
            .quick-button {
                font-size: 10px;
                padding: 6px 4px;
                min-height: 28px;
            }
            
            .quick-buttons {
                gap: 4px;
                max-width: 250px;
            }
        }

        /* 로딩 애니메이션 최적화 */
        .quick-button {
            animation: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .quick-button:hover {
            animation: none;
        }

        /* 성능 최적화 */
        .quick-button {
            will-change: transform, box-shadow;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
        }

        /* 터치 디바이스 감지 */
        @media (hover: none) and (pointer: coarse) {
            .quick-button:hover {
                transform: none;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            }
        }

        /* 추가 터치 이벤트 처리 */
        .quick-button {
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }

        /* 카카오톡 브라우저 특별 처리 */
        @media screen and (max-width: 500px) {
            .kakao-optimized .quick-button {
                position: relative;
                z-index: 1;
                pointer-events: auto;
            }
        }

        .language-current, .language-option {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }

        .chatbot-send {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }

        .chatbot-send:active {
            transform: scale(0.95);
        }

        /* 카카오톡 브라우저 특별 최적화 */
        @supports (-webkit-touch-callout: none) {
            .quick-buttons {
                gap: 12px !important;
            }
            
            .quick-button {
                min-height: 44px !important;
                padding: 12px 16px !important;
            }
        }

        /* 키보드 열림 상태 최적화 */
        .keyboard-open .chatbot-messages {
            padding-bottom: 20px;
        }

        .keyboard-open .chatbot-input {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        /* PC 웹브라우저 최적화 */
        @media (min-width: 1024px) {
            .chatbot-main {
                max-width: 800px !important;
                margin: 0 auto !important;
                height: 90vh !important;
                border-radius: 20px !important;
                box-shadow: 0 20px 60px rgba(0,0,0,0.1) !important;
                margin-top: 5vh !important;
            }
            
            .chatbot-header {
                border-radius: 20px 20px 0 0 !important;
            }
            
            .chatbot-messages {
                max-height: 60vh !important;
            }
            
            .chatbot-input {
                border-radius: 0 0 20px 20px !important;
            }
            
            /* PC에서 API 상태 표시 위치 조정 */
            #apiStatus {
                right: 140px !important;
                top: 12px !important;
                font-size: 12px !important;
                padding: 6px 10px !important;
            }
            
            /* PC에서 언어 선택 드롭다운 위치 조정 */
            .header-language-dropdown {
                right: 20px !important;
            }
            
            .language-current {
                min-width: 140px !important;
                font-size: 16px !important;
                padding: 12px 18px !important;
            }
        }

        /* 모바일 기기별 특화 최적화 */
        
        /* 아이폰11 최적화 (414×896) */
        .device-iphone11 .chatbot-main {
            max-width: 414px !important;
            margin: 0 auto !important;
        }
        
        .device-iphone11 .chatbot-header {
            padding: 20px 18px !important;
            font-size: 20px !important;
        }
        
        .device-iphone11 .back-link {
            left: 12px !important;
            top: 50% !important;
            transform: translateY(-50%) !important;
            width: 60px !important;
            height: 66px !important;
        }
        
        .device-iphone11 .home-icon {
            font-size: 24px !important;
        }
        
        .device-iphone11 .home-arrow {
            font-size: 15px !important;
        }
        
        .device-iphone11 .chatbot-input {
            padding: 15px 18px !important;
        }
        
        /* 아이폰 미니 최적화 (375×812) */
        .device-iphone-mini .chatbot-main {
            max-width: 375px !important;
            margin: 0 auto !important;
        }
        
        .device-iphone-mini .chatbot-header {
            padding: 18px 16px !important;
            font-size: 19px !important;
        }
        
        .device-iphone-mini .back-link {
            left: 10px !important;
            top: 50% !important;
            transform: translateY(-50%) !important;
            width: 55px !important;
            height: 60px !important;
        }
        
        .device-iphone-mini .home-icon {
            font-size: 22px !important;
        }
        
        .device-iphone-mini .home-arrow {
            font-size: 14px !important;
        }
        
        .device-iphone-mini .chatbot-input {
            padding: 12px 16px !important;
        }
        
        /* Galaxy XCover 5 최적화 (432×900) */
        .device-galaxy-xcover5 .chatbot-main {
            max-width: 432px !important;
            margin: 0 auto !important;
        }
        
        .device-galaxy-xcover5 .chatbot-header {
            padding: 22px 20px !important;
            font-size: 21px !important;
        }
        
        .device-galaxy-xcover5 .back-link {
            left: 14px !important;
            top: 50% !important;
            transform: translateY(-50%) !important;
            width: 62px !important;
            height: 68px !important;
        }
        
        .device-galaxy-xcover5 .home-icon {
            font-size: 25px !important;
        }
        
        .device-galaxy-xcover5 .home-arrow {
            font-size: 16px !important;
        }
        
        .device-galaxy-xcover5 .chatbot-input {
            padding: 18px 20px !important;
        }
        
        /* 카카오톡 브라우저 최적화 */
        .kakao-browser button {
            -webkit-tap-highlight-color: transparent !important;
            touch-action: manipulation !important;
            -webkit-touch-callout: none !important;
            -webkit-user-select: none !important;
            user-select: none !important;
        }
        
        .kakao-browser .back-link {
            -webkit-tap-highlight-color: transparent !important;
            touch-action: manipulation !important;
            top: 50% !important;
            transform: translateY(-50%) !important;
        }
        
        .kakao-browser .chatbot-input textarea {
            min-height: 50px !important;
            font-size: 16px !important;
        }
        
        .kakao-browser .chatbot-send {
            min-width: 50px !important;
            min-height: 50px !important;
        }
        
        /* 모든 아이폰 기기 공통 최적화 */
        .device-iphone .chatbot-main {
            min-height: calc(100vh - var(--safe-area-inset-top) - var(--safe-area-inset-bottom)) !important;
        }
        
        .device-iphone .back-link {
            top: 50% !important;
            transform: translateY(-50%) !important;
        }
        
        .device-iphone .chatbot-input textarea:focus {
            transform: none !important;
            zoom: 1 !important;
        }
        
        /* 카카오톡 브라우저에서 입력 필드 줌 방지 */
        .kakao-browser textarea {
            font-size: 16px !important;
        }
        
        .kakao-browser .chatbot-input textarea {
            font-size: 16px !important;
        }
        
        /* iOS Safe Area 지원 */
        .device-ios body {
            padding-top: var(--safe-area-inset-top);
            padding-bottom: var(--safe-area-inset-bottom);
            padding-left: var(--safe-area-inset-left);
            padding-right: var(--safe-area-inset-right);
        }
        
        /* iOS 기기에서 헤더 내 요소들 정확한 중앙 정렬 */
        .device-ios .chatbot-header {
            position: relative !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }
        
        .device-ios .back-link {
            position: absolute !important;
            left: 15px !important;
            top: 50% !important;
            transform: translateY(-50%) !important;
            z-index: 1000 !important;
        }
        
        /* 안드로이드 키보드 열림 상태 최적화 */
        .keyboard-open .chatbot-messages {
            max-height: 60vh !important;
            overflow-y: auto !important;
        }
        
        .keyboard-open .chatbot-input {
            position: fixed !important;
            bottom: 0 !important;
            width: 100% !important;
            z-index: 1000 !important;
        }
        
        /* 터치 성능 개선 */
        .device-ios *, .device-android * {
            -webkit-transform: translate3d(0, 0, 0);
            transform: translate3d(0, 0, 0);
        }
        
        /* 모바일 기기에서 헤더 요소들 정확한 위치 조정 */
        .device-ios .chatbot-header,
        .device-android .chatbot-header {
            position: relative !important;
            min-height: 60px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }
        
        .device-ios .chatbot-title,
        .device-android .chatbot-title {
            position: relative !important;
            z-index: 1 !important;
        }
        
        /* 스크롤 바운스 효과 제거 (iOS) */
        .device-ios .chatbot-messages {
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }
        
        /* 안드로이드 스크롤 최적화 */
        .device-android .chatbot-messages {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .device-android .chatbot-messages::-webkit-scrollbar {
            display: none;
        }
        
        /* 안드로이드 기기 공통 최적화 */
        .device-android .back-link {
            top: 50% !important;
            transform: translateY(-50%) !important;
        }
        
        /* 예약하기 버튼 스타일 */
        .reservation-button {
            background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%) !important;
            color: white !important;
            border: none !important;
            padding: 12px 24px !important;
            border-radius: 25px !important;
            font-size: 14px !important;
            font-weight: bold !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
            text-decoration: none !important;
            display: inline-block !important;
            margin: 10px 0 !important;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3) !important;
        }
        
        .reservation-button:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.5) !important;
        }
        
        .reservation-button:active {
            transform: translateY(0) !important;
        }
        
        /* 예약 문의 메시지 스타일 */
        .reservation-message {
            margin-top: 15px !important;
            padding: 15px !important;
            background: #f8f9fa !important;
            border-radius: 10px !important;
            border-left: 4px solid #4facfe !important;
            text-align: center !important;
        }
        
        .reservation-message-text {
            font-size: 14px !important;
            color: #666 !important;
            margin-bottom: 10px !important;
        }
    </style>
</head>
<body>
    <div class="chatbot-main">
        <!-- 헤더 -->
        <div class="chatbot-header">
            <a href="index.html" class="back-link">
                <span class="home-icon">🏠</span>
                <span class="home-arrow">←</span>
            </a>
            <h1 class="chatbot-title">피닉스 치과 AI 상담사👩‍⚕️</h1>
            
            <!-- API 설정 상태 표시 -->
            <div id="apiStatus" style="position: absolute; top: 10px; right: 120px; font-size: 11px; padding: 4px 8px; border-radius: 12px; background: #f8f9fa; color: #6c757d; border: 1px solid #dee2e6; font-weight: bold; z-index: 1001;">
                ❌ AI API 설정 안됨
            </div>
            
            <!-- 우측 상단 언어 선택 드롭다운 -->
            <div class="header-language-dropdown">
                <div class="language-dropdown">
                    <button class="language-current">
                        <span id="currentLanguageText" style="color: black;">🇰🇷 KR</span>
                        <span style="color: black;">▼</span>
                    </button>
                    <div class="language-menu" id="languageMenu">
                        <div class="language-option active" data-lang="ko" style="color: black;">🇰🇷 KR</div>
                        <div class="language-option" data-lang="en" style="color: black;">🇺🇸 US</div>
                        <div class="language-option" data-lang="ru" style="color: black;">🇷🇺 RU</div>
                        <div class="language-option" data-lang="ja" style="color: black;">🇯🇵 JP</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 메시지 영역 -->
        <div class="chatbot-messages" id="chatbotMessages">
            <!-- 메시지들이 여기에 추가됩니다 -->
        </div>

        <!-- 입력 영역 -->
        <div class="chatbot-input">
            <textarea id="chatbotInput" placeholder="메시지를 입력하세요... (Shift+Enter: 전송)" rows="1"></textarea>
            <button class="chatbot-send" onclick="sendMessage()">전송</button>
        </div>
    </div>

    <script>
        console.log('🚀 별도창 AI챗봇 페이지 로드 시작');

        // 전역 변수
        let currentLanguage = 'ko';
        let apiSettings = {
            chatgpt: { apiKey: '', model: '', enabled: false },
            gemini: { apiKey: '', model: '', enabled: false },
            claude: { apiKey: '', model: '', enabled: false },
            activeProvider: ''
        };
        
        // 지식베이스 설정 (랜딩페이지와 동일한 구조)
        let knowledgeBase = {
            enabled: false,
            files: [],
            parsedData: []
        };

        // 언어별 텍스트
        const translations = {
            ko: {
                title: '피닉스 치과 AI 상담사👩‍⚕️',
                placeholder: '메시지를 입력하세요... (Shift+Enter: 전송)',
                sendButton: '전송',
                currentLanguage: '🇰🇷 KR',
                welcomeMessage: '피닉스 치과 AI상담사 입니다!',
                welcomeSubMessage: '우측 상단 메뉴, AI의 언어 변경 가능',
                clinicHours: `🕘 <strong>피닉스 치과 진료시간 안내</strong><br><br>
                    📅 <strong>평일:</strong> 09:00 ~ 18:00<br>
                    📅 <strong>토요일:</strong> 09:00 ~ 15:00<br>
                    🍽️ <strong>점심시간:</strong> 12:30 ~ 13:30<br>
                    🚫 <strong>휴진:</strong> 일요일, 공휴일<br><br>
                    📞 <strong>예약 문의:</strong> 070-1234-1234<br><br>
                    <div class="reservation-message">
                        <div class="reservation-message-text">자세한 문의는 방문 상담 해주세요</div>
                        <button class="reservation-button" onclick="window.open('reservation.html', '_blank')">📅 예약하기</button>
                    </div>`,
                treatmentCost: `💰 <strong>피닉스 치과 치료비용 안내</strong><br><br>
                    🦷 <strong>일반 진료:</strong> 상담 후 안내<br>
                    🦷 <strong>스케일링:</strong> 30,000원 ~ 50,000원<br>
                    🦷 <strong>임플란트:</strong> 상담 후 개별 견적<br>
                    🦷 <strong>교정:</strong> 상담 후 개별 견적<br><br>
                    💡 <strong>정확한 비용은 진료 후 안내드립니다!</strong><br><br>
                    <div class="reservation-message">
                        <div class="reservation-message-text">자세한 문의는 방문 상담 해주세요</div>
                        <button class="reservation-button" onclick="window.open('reservation.html', '_blank')">📅 예약하기</button>
                    </div>`,
                reservationInquiry: `📞 <strong>피닉스 치과 예약 문의</strong><br><br>
                    🏥 <strong>병원명:</strong> 피닉스 치과<br>
                    📞 <strong>전화번호:</strong> 070-1234-1234<br>
                    💬 <strong>카카오톡:</strong> 피닉스치과<br>
                    🌐 <strong>온라인 예약:</strong> 홈페이지 예약 시스템 이용<br><br>
                    ⏰ <strong>전화 상담 시간:</strong><br>
                    • 평일: 09:00 ~ 17:30<br>
                    • 토요일: 09:00 ~ 14:30<br>
                    • 일요일/공휴일: 휴무<br><br>
                    💡 <strong>온라인 예약이 가장 편리합니다!</strong><br><br>
                    <div class="reservation-message">
                        <div class="reservation-message-text">자세한 문의는 방문 상담 해주세요</div>
                        <button class="reservation-button" onclick="window.open('reservation.html', '_blank')">📅 예약하기</button>
                    </div>`,
                directions: `🗺️ <strong>피닉스 치과 오시는길</strong><br><br>
                    📍 <strong>주소:</strong> 서울특별시 강남구 테헤란로 123<br>
                    🚇 <strong>지하철:</strong> 2호선 강남역 3번 출구 도보 5분<br>
                    🚌 <strong>버스:</strong> 강남역 정류장 하차<br>
                    🚗 <strong>주차:</strong> 건물 지하 1층 (2시간 무료)<br><br>
                    🏢 <strong>건물 안내:</strong><br>
                    • 피닉스 빌딩 3층<br>
                    • 엘리베이터 이용<br>
                    • 1층 안내데스크에서 문의 가능<br><br>
                    📞 <strong>길찾기 문의:</strong> 070-1234-1234<br><br>
                    <div class="reservation-message">
                        <div class="reservation-message-text">자세한 문의는 방문 상담 해주세요</div>
                        <button class="reservation-button" onclick="window.open('reservation.html', '_blank')">📅 예약하기</button>
                    </div>`
            },
            en: {
                title: 'Phoenix Dental AI Consultant👩‍⚕️',
                placeholder: 'Enter your message... (Shift+Enter: Send)',
                sendButton: 'Send',
                currentLanguage: '🇺🇸 US',
                welcomeMessage: 'I am Phoenix Dental AI consultant!',
                welcomeSubMessage: 'Top right menu, AI language change available',
                clinicHours: `🕘 <strong>Phoenix Dental Clinic Hours</strong><br><br>
                    📅 <strong>Weekdays:</strong> 09:00 ~ 18:00<br>
                    📅 <strong>Saturday:</strong> 09:00 ~ 15:00<br>
                    🍽️ <strong>Lunch Break:</strong> 12:30 ~ 13:30<br>
                    🚫 <strong>Closed:</strong> Sunday, Holidays<br><br>
                    📞 <strong>Reservation:</strong> 070-1234-1234<br><br>
                    <div class="reservation-message">
                        <div class="reservation-message-text">For detailed consultation, please visit us for consultation</div>
                        <button class="reservation-button" onclick="window.open('reservation.html', '_blank')">📅 Make Reservation</button>
                    </div>`,
                treatmentCost: `💰 <strong>Phoenix Dental Treatment Costs</strong><br><br>
                    🦷 <strong>General Treatment:</strong> Consultation required<br>
                    🦷 <strong>Scaling:</strong> 30,000 ~ 50,000 KRW<br>
                    🦷 <strong>Implant:</strong> Individual estimate after consultation<br>
                    🦷 <strong>Orthodontics:</strong> Individual estimate after consultation<br><br>
                    💡 <strong>Exact costs will be provided after examination!</strong><br><br>
                    <div class="reservation-message">
                        <div class="reservation-message-text">For detailed consultation, please visit us for consultation</div>
                        <button class="reservation-button" onclick="window.open('reservation.html', '_blank')">📅 Make Reservation</button>
                    </div>`,
                reservationInquiry: `📞 <strong>Phoenix Dental Reservation Inquiry</strong><br><br>
                    🏥 <strong>Clinic Name:</strong> Phoenix Dental<br>
                    📞 <strong>Phone:</strong> 070-1234-1234<br>
                    💬 <strong>KakaoTalk:</strong> Phoenix Dental<br>
                    🌐 <strong>Online Booking:</strong> Use website reservation system<br><br>
                    ⏰ <strong>Phone Consultation Hours:</strong><br>
                    • Weekdays: 09:00 ~ 17:30<br>
                    • Saturday: 09:00 ~ 14:30<br>
                    • Sunday/Holidays: Closed<br><br>
                    💡 <strong>Online booking is most convenient!</strong><br><br>
                    <div class="reservation-message">
                        <div class="reservation-message-text">For detailed consultation, please visit us for consultation</div>
                        <button class="reservation-button" onclick="window.open('reservation.html', '_blank')">📅 Make Reservation</button>
                    </div>`,
                directions: `🗺️ <strong>Directions to Phoenix Dental</strong><br><br>
                    📍 <strong>Address:</strong> 123 Teheran-ro, Gangnam-gu, Seoul<br>
                    🚇 <strong>Subway:</strong> Line 2 Gangnam Station Exit 3, 5 min walk<br>
                    🚌 <strong>Bus:</strong> Get off at Gangnam Station<br>
                    🚗 <strong>Parking:</strong> Building B1 (2 hours free)<br><br>
                    🏢 <strong>Building Guide:</strong><br>
                    • Phoenix Building 3rd Floor<br>
                    • Use elevator<br>
                    • Information desk available on 1st floor<br><br>
                    📞 <strong>Direction Inquiry:</strong> 070-1234-1234<br><br>
                    <div class="reservation-message">
                        <div class="reservation-message-text">For detailed consultation, please visit us for consultation</div>
                        <button class="reservation-button" onclick="window.open('reservation.html', '_blank')">📅 Make Reservation</button>
                    </div>`
            },
            ru: {
                title: 'Консультант ИИ стоматологии Phoenix👩‍⚕️',
                placeholder: 'Введите ваше сообщение... (Shift+Enter: Отправить)',
                sendButton: 'Отправить',
                currentLanguage: '🇷🇺 RU',
                welcomeMessage: 'Я консультант ИИ стоматологии Phoenix!',
                welcomeSubMessage: 'Меню в правом верхнем углу, изменение языка ИИ доступно',
                clinicHours: `🕘 <strong>Часы работы стоматологии Phoenix</strong><br><br>
                    📅 <strong>Будни:</strong> 09:00 ~ 18:00<br>
                    📅 <strong>Суббота:</strong> 09:00 ~ 15:00<br>
                    🍽️ <strong>Обед:</strong> 12:30 ~ 13:30<br>
                    🚫 <strong>Выходные:</strong> Воскресенье, праздники<br><br>
                    📞 <strong>Запись:</strong> 070-1234-1234<br><br>
                    <div class="reservation-message">
                        <div class="reservation-message-text">Для подробной консультации, пожалуйста, посетите нас для консультации</div>
                        <button class="reservation-button" onclick="window.open('reservation.html', '_blank')">📅 Записаться на прием</button>
                    </div>`,
                treatmentCost: `💰 <strong>Стоимость лечения в стоматологии Phoenix</strong><br><br>
                    🦷 <strong>Общее лечение:</strong> Требуется консультация<br>
                    🦷 <strong>Чистка:</strong> 30,000 ~ 50,000 вон<br>
                    🦷 <strong>Имплант:</strong> Индивидуальная оценка после консультации<br>
                    🦷 <strong>Ортодонтия:</strong> Индивидуальная оценка после консультации<br><br>
                    💡 <strong>Точная стоимость будет предоставлена после обследования!</strong><br><br>
                    <div class="reservation-message">
                        <div class="reservation-message-text">Для подробной консультации, пожалуйста, посетите нас для консультации</div>
                        <button class="reservation-button" onclick="window.open('reservation.html', '_blank')">📅 Записаться на прием</button>
                    </div>`,
                reservationInquiry: `📞 <strong>Запись в стоматологию Phoenix</strong><br><br>
                    🏥 <strong>Название клиники:</strong> Phoenix Dental<br>
                    📞 <strong>Телефон:</strong> 070-1234-1234<br>
                    💬 <strong>KakaoTalk:</strong> Phoenix Dental<br>
                    🌐 <strong>Онлайн запись:</strong> Используйте систему записи на сайте<br><br>
                    ⏰ <strong>Часы телефонных консультаций:</strong><br>
                    • Будни: 09:00 ~ 17:30<br>
                    • Суббота: 09:00 ~ 14:30<br>
                    • Воскресенье/праздники: Закрыто<br><br>
                    💡 <strong>Онлайн запись наиболее удобна!</strong><br><br>
                    <div class="reservation-message">
                        <div class="reservation-message-text">Для подробной консультации, пожалуйста, посетите нас для консультации</div>
                        <button class="reservation-button" onclick="window.open('reservation.html', '_blank')">📅 Записаться на прием</button>
                    </div>`,
                directions: `🗺️ <strong>Как добраться до стоматологии Phoenix</strong><br><br>
                    📍 <strong>Адрес:</strong> Сеул, Каннам-гу, Техеран-ро 123<br>
                    🚇 <strong>Метро:</strong> Линия 2, станция Каннам, выход 3, 5 мин пешком<br>
                    🚌 <strong>Автобус:</strong> Остановка станция Каннам<br>
                    🚗 <strong>Парковка:</strong> Подземный этаж здания (2 часа бесплатно)<br><br>
                    🏢 <strong>Описание здания:</strong><br>
                    • Здание Phoenix, 3-й этаж<br>
                    • Используйте лифт<br>
                    • Информационная стойка на 1-м этаже<br><br>
                    📞 <strong>Справки о маршруте:</strong> 070-1234-1234<br><br>
                    <div class="reservation-message">
                        <div class="reservation-message-text">Для подробной консультации, пожалуйста, посетите нас для консультации</div>
                        <button class="reservation-button" onclick="window.open('reservation.html', '_blank')">📅 Записаться на прием</button>
                    </div>`
            },
            ja: {
                title: 'フェニックス歯科AIコンサルタント👩‍⚕️',
                placeholder: 'メッセージを入力してください... (Shift+Enter: 送信)',
                sendButton: '送信',
                currentLanguage: '🇯🇵 JP',
                welcomeMessage: 'フェニックス歯科AIコンサルタントです！',
                welcomeSubMessage: '右上メニュー、AI言語変更可能',
                clinicHours: `🕘 <strong>フェニックス歯科診療時間案内</strong><br><br>
                    📅 <strong>平日:</strong> 09:00 ~ 18:00<br>
                    📅 <strong>土曜日:</strong> 09:00 ~ 15:00<br>
                    🍽️ <strong>昼休み:</strong> 12:30 ~ 13:30<br>
                    🚫 <strong>休診:</strong> 日曜日、祝日<br><br>
                    📞 <strong>予約問い合わせ:</strong> 070-1234-1234<br><br>
                    <div class="reservation-message">
                        <div class="reservation-message-text">詳しいご相談は来院相談をお願いします</div>
                        <button class="reservation-button" onclick="window.open('reservation.html', '_blank')">📅 予約する</button>
                    </div>`,
                treatmentCost: `💰 <strong>フェニックス歯科治療費案内</strong><br><br>
                    🦷 <strong>一般診療:</strong> 相談後ご案内<br>
                    🦷 <strong>スケーリング:</strong> 30,000円 ~ 50,000円<br>
                    🦷 <strong>インプラント:</strong> 相談後個別見積もり<br>
                    🦷 <strong>矯正:</strong> 相談後個別見積もり<br><br>
                    💡 <strong>正確な費用は診療後にご案内いたします！</strong><br><br>
                    <div class="reservation-message">
                        <div class="reservation-message-text">詳しいご相談は来院相談をお願いします</div>
                        <button class="reservation-button" onclick="window.open('reservation.html', '_blank')">📅 予約する</button>
                    </div>`,
                reservationInquiry: `📞 <strong>フェニックス歯科予約問い合わせ</strong><br><br>
                    🏥 <strong>病院名:</strong> フェニックス歯科<br>
                    📞 <strong>電話番号:</strong> 070-1234-1234<br>
                    💬 <strong>カカオトーク:</strong> フェニックス歯科<br>
                    🌐 <strong>オンライン予約:</strong> ホームページ予約システム利用<br><br>
                    ⏰ <strong>電話相談時間:</strong><br>
                    • 平日: 09:00 ~ 17:30<br>
                    • 土曜日: 09:00 ~ 14:30<br>
                    • 日曜일/祝日: 休業<br><br>
                    💡 <strong>オンライン予約が最も便利です！</strong><br><br>
                    <div class="reservation-message">
                        <div class="reservation-message-text">詳しいご相談は来院相談をお願いします</div>
                        <button class="reservation-button" onclick="window.open('reservation.html', '_blank')">📅 予約する</button>
                    </div>`,
                directions: `🗺️ <strong>フェニックス歯科へのアクセス</strong><br><br>
                    📍 <strong>住所:</strong> ソウル特別市江南区テヘラン路123<br>
                    🚇 <strong>地下鉄:</strong> 2号線江南駅3番出口徒歩5分<br>
                    🚌 <strong>バス:</strong> 江南駅停留所下車<br>
                    🚗 <strong>駐車場:</strong> 建物地下1階（2時間無料）<br><br>
                    🏢 <strong>建物案内:</strong><br>
                    • フェニックスビル3階<br>
                    • エレベーター利用<br>
                    • 1階案内デスクでお問い合わせ可能<br><br>
                    📞 <strong>道案内問い合わせ:</strong> 070-1234-1234<br><br>
                    <div class="reservation-message">
                        <div class="reservation-message-text">詳しいご相談は来院相談をお願いします</div>
                        <button class="reservation-button" onclick="window.open('reservation.html', '_blank')">📅 予約する</button>
                    </div>`
            }
        };

        // iOS Safari 뷰포트 높이 계산 함수
        function setViewportHeight() {
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }

        // 안드로이드 키보드 감지 함수
        function handleAndroidKeyboard() {
            const initialHeight = window.innerHeight;
            
            window.addEventListener('resize', function() {
                const currentHeight = window.innerHeight;
                const heightDiff = initialHeight - currentHeight;
                
                // 키보드가 올라왔을 때 (높이가 150px 이상 감소)
                if (heightDiff > 150) {
                    document.body.classList.add('keyboard-open');
                    console.log('안드로이드 키보드 열림 감지');
                } else {
                    document.body.classList.remove('keyboard-open');
                    console.log('안드로이드 키보드 닫힘 감지');
                }
            });
        }

        // 모바일 기기별 특화 최적화 (아이폰11, 아이폰 미니, Galaxy XCover 5)
        function applyMobileDeviceOptimizations() {
            const userAgent = navigator.userAgent;
            const isKakaoTalk = userAgent.includes('KAKAO');
            const screenWidth = screen.width;
            const screenHeight = screen.height;
            const isIOS = /iPad|iPhone|iPod/.test(userAgent) && !window.MSStream;
            const isAndroid = userAgent.includes('Android');
            
            console.log('기기 정보:', {
                userAgent: userAgent,
                isKakaoTalk: isKakaoTalk,
                screenWidth: screenWidth,
                screenHeight: screenHeight,
                isIOS: isIOS,
                isAndroid: isAndroid
            });
            
            // iOS 기기일 때 뷰포트 높이 설정
            if (isIOS) {
                setViewportHeight();
                window.addEventListener('resize', setViewportHeight);
                window.addEventListener('orientationchange', () => {
                    setTimeout(setViewportHeight, 100);
                });
                document.body.classList.add('device-ios');
                document.body.classList.add('device-iphone');
            }
            
            // 안드로이드 기기일 때 키보드 감지
            if (isAndroid) {
                handleAndroidKeyboard();
                document.body.classList.add('device-android');
            }
            
            // 기기별 최적화 적용
            if (userAgent.includes('iPhone')) {
                // 아이폰11 (414×896)
                if (screenWidth === 414 && screenHeight === 896) {
                    document.body.classList.add('device-iphone11');
                    console.log('아이폰11 최적화 적용');
                }
                // 아이폰 미니 (375×812)
                else if (screenWidth === 375 && screenHeight === 812) {
                    document.body.classList.add('device-iphone-mini');
                    console.log('아이폰 미니 최적화 적용');
                }
            }
            
            // Galaxy XCover 5 (432×900)
            if (userAgent.includes('Android') && screenWidth === 432 && screenHeight === 900) {
                document.body.classList.add('device-galaxy-xcover5');
                console.log('Galaxy XCover 5 최적화 적용');
            }
            
            // 카카오톡 브라우저 특별 최적화
            if (isKakaoTalk) {
                document.body.classList.add('kakao-browser');
                
                // 카카오톡 브라우저에서 터치 이벤트 최적화
                const allButtons = document.querySelectorAll('button, .back-link, .reservation-button');
                allButtons.forEach(button => {
                    button.style.setProperty('-webkit-tap-highlight-color', 'transparent', 'important');
                    button.style.setProperty('touch-action', 'manipulation', 'important');
                    
                    // 터치 이벤트 추가
                    button.addEventListener('touchstart', function(e) {
                        this.style.transform = 'scale(0.95)';
                        this.style.transition = 'all 0.1s';
                    }, { passive: true });
                    
                    button.addEventListener('touchend', function(e) {
                        this.style.transform = '';
                        this.style.transition = 'all 0.3s';
                    }, { passive: true });
                });
                
                console.log('카카오톡 브라우저 최적화 적용');
            }
        }

        // 초기화
        window.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 별도창 AI챗봇 페이지 로드 시작');
            
            // 모바일 기기별 최적화 적용
            applyMobileDeviceOptimizations();
            
            // 카카오톡 브라우저 감지
            const isKakaoTalk = navigator.userAgent.includes('KAKAO');
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (isKakaoTalk || isMobile) {
                console.log('카카오톡 브라우저 또는 모바일 기기 감지됨');
                document.body.classList.add('kakao-optimized');
            }
            
            // 뷰포트 높이 설정
            setViewportHeight();
            window.addEventListener('resize', setViewportHeight);
            
            // 드롭다운 메뉴 이벤트 리스너
            const languageBtn = document.querySelector('.language-current');
            const languageMenu = document.getElementById('languageMenu');
            
            if (languageBtn) {
                languageBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleLanguageMenu();
                });
                
                // 터치 이벤트 추가 (모바일 기기용)
                languageBtn.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleLanguageMenu();
                });
            }
            
            // 언어 옵션 클릭 이벤트
            const languageOptions = document.querySelectorAll('.language-option');
            languageOptions.forEach(option => {
                option.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const lang = this.getAttribute('data-lang');
                    selectLanguage(lang);
                });
                
                // 터치 이벤트 추가 (모바일 기기용)
                option.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const lang = this.getAttribute('data-lang');
                    selectLanguage(lang);
                });
            });
            
            // 외부 클릭 시 드롭다운 닫기
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.language-dropdown')) {
                    const menu = document.getElementById('languageMenu');
                    if (menu) {
                        menu.style.display = 'none';
                        menu.classList.remove('show');
                    }
                }
            });
            
            // 터치 이벤트로도 드롭다운 닫기
            document.addEventListener('touchstart', function(e) {
                if (!e.target.closest('.language-dropdown')) {
                    const menu = document.getElementById('languageMenu');
                    if (menu) {
                        menu.style.display = 'none';
                        menu.classList.remove('show');
                    }
                }
            });
            
            // 입력창 이벤트 리스너
            const chatInput = document.getElementById('chatbotInput');
            if (chatInput) {
                chatInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
                
                // 자동 높이 조절
                chatInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 100) + 'px';
                });
            }
            
            // 환영 메시지 추가
            setTimeout(() => {
                addWelcomeMessage();
            }, 500);
            
            // 초기 UI 업데이트
            updateLanguageUI(currentLanguage);
        });

        // 모바일 기기 최적화 함수
        function optimizeForMobile() {
            const isKakaoTalk = navigator.userAgent.includes('KAKAO');
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (isKakaoTalk || isMobile) {
                console.log('모바일 기기 최적화 적용');
                
                // 모든 버튼에 터치 이벤트 추가
                function addMobileTouchEvents() {
                    const quickButtons = document.querySelectorAll('.quick-button');
                    quickButtons.forEach(button => {
                        // 터치 시작
                        button.addEventListener('touchstart', function(e) {
                            e.preventDefault();
                            this.style.transform = 'scale(0.95)';
                            this.style.transition = 'all 0.1s';
                        }, { passive: false });
                        
                        // 터치 종료
                        button.addEventListener('touchend', function(e) {
                            this.style.transform = '';
                            this.style.transition = 'all 0.3s';
                            
                            // 카카오톡 브라우저에서 메뉴 버튼 터치 강화
                            const onclick = this.getAttribute('onclick');
                            const isKakaoTalk = navigator.userAgent.includes('KAKAO');
                            
                            if (onclick && onclick.includes('handleQuickMessage') && isKakaoTalk) {
                                e.preventDefault();
                                e.stopPropagation();
                                const match = onclick.match(/handleQuickMessage\('([^']+)'\)/);
                                if (match) {
                                    console.log('카카오톡 터치 강제 실행:', match[1]);
                                    setTimeout(() => {
                                        handleQuickMessage(match[1]);
                                    }, 100);
                                }
                            } else if (onclick && onclick.includes('handleQuickMessage')) {
                                // 일반 브라우저에서는 onclick 이벤트가 자동으로 실행되도록 함
                                console.log('터치 이벤트 완료 - onclick 이벤트 대기');
                            }
                        }, { passive: false });
                        
                        // 터치 취소
                        button.addEventListener('touchcancel', function(e) {
                            e.preventDefault();
                            this.style.transform = '';
                            this.style.transition = 'all 0.3s';
                        }, { passive: false });
                    });
                }
                
                // 초기 적용
                addMobileTouchEvents();
                
                // 새로운 버튼이 추가될 때마다 이벤트 재적용
                const chatMessagesContainer = document.getElementById('chatbotMessages');
                if (chatMessagesContainer) {
                    const observer = new MutationObserver(function(mutations) {
                        mutations.forEach(function(mutation) {
                            if (mutation.type === 'childList') {
                                addMobileTouchEvents();
                            }
                        });
                    });
                    
                    observer.observe(chatMessagesContainer, { 
                        childList: true, 
                        subtree: true 
                    });
                }
                
                // 키보드 높이 감지 및 조정
                let initialViewportHeight = window.innerHeight;
                
                window.addEventListener('resize', function() {
                    const currentHeight = window.innerHeight;
                    const isKeyboardOpen = currentHeight < initialViewportHeight * 0.75;
                    
                    if (isKeyboardOpen) {
                        document.body.classList.add('keyboard-open');
                        const messagesEl = document.querySelector('.chatbot-messages');
                        if (messagesEl) {
                            messagesEl.style.maxHeight = (currentHeight - 200) + 'px';
                        }
                    } else {
                        document.body.classList.remove('keyboard-open');
                        const messagesEl = document.querySelector('.chatbot-messages');
                        if (messagesEl) {
                            messagesEl.style.maxHeight = '';
                        }
                    }
                });
                
                // iOS 뷰포트 높이 문제 해결
                if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
                    function setViewportHeight() {
                        const vh = window.innerHeight * 0.01;
                        document.documentElement.style.setProperty('--vh', `${vh}px`);
                    }
                    
                    setViewportHeight();
                    window.addEventListener('resize', setViewportHeight);
                    window.addEventListener('orientationchange', setViewportHeight);
                }
                
                // 안드로이드 키보드 감지
                if (/Android/.test(navigator.userAgent)) {
                    let lastViewportHeight = window.innerHeight;
                    
                    window.addEventListener('resize', function() {
                        const currentHeight = window.innerHeight;
                        const heightDifference = lastViewportHeight - currentHeight;
                        
                        if (heightDifference > 150) {
                            // 키보드가 열림
                            document.body.classList.add('android-keyboard-open');
                        } else if (heightDifference < -150) {
                            // 키보드가 닫힘
                            document.body.classList.remove('android-keyboard-open');
                        }
                        
                        lastViewportHeight = currentHeight;
                    });
                }
                
                // 터치 스크롤 개선
                const touchMessagesContainer = document.querySelector('.chatbot-messages');
                if (touchMessagesContainer) {
                    touchMessagesContainer.addEventListener('touchmove', function(e) {
                        e.stopPropagation();
                    }, { passive: true });
                }
                
                // 더블 탭 확대 방지
                document.addEventListener('touchstart', function(e) {
                    if (e.touches.length > 1) {
                        e.preventDefault();
                    }
                }, { passive: false });
                
                let lastTouchEnd = 0;
                document.addEventListener('touchend', function(e) {
                    const now = (new Date()).getTime();
                    if (now - lastTouchEnd <= 300) {
                        e.preventDefault();
                    }
                    lastTouchEnd = now;
                }, { passive: false });
                
                // 카카오톡 브라우저 특별 처리
                if (isKakaoTalk) {
                    console.log('카카오톡 브라우저 최적화 적용');
                    
                    // 페이지 로드 완료 후 스타일 강제 재적용
                    setTimeout(() => {
                        const buttons = document.querySelectorAll('.quick-button');
                        buttons.forEach(button => {
                            button.style.pointerEvents = 'auto';
                            button.style.touchAction = 'manipulation';
                            button.style.webkitTapHighlightColor = 'transparent';
                            button.style.cursor = 'pointer';
                        });
                        
                        // 모든 클릭 가능한 요소에 터치 이벤트 추가
                        const clickableElements = document.querySelectorAll('button, .language-current, .language-option, .back-link');
                        clickableElements.forEach(element => {
                            element.style.touchAction = 'manipulation';
                            element.style.webkitTapHighlightColor = 'transparent';
                        });
                        
                        console.log('카카오톡 브라우저 버튼 스타일 강제 재적용 완료');
                    }, 1000);
                    
                    // 페이지 새로고침 시에도 재적용
                    document.addEventListener('visibilitychange', function() {
                        if (!document.hidden) {
                            setTimeout(() => {
                                const buttons = document.querySelectorAll('.quick-button');
                                buttons.forEach(button => {
                                    button.style.pointerEvents = 'auto';
                                    button.style.touchAction = 'manipulation';
                                });
                                addMobileTouchEvents();
                            }, 500);
                        }
                    });
                    
                    // 카카오톡 브라우저에서 캐시 방지
                    const timestamp = new Date().getTime();
                    if (window.history && window.history.replaceState) {
                        window.history.replaceState({}, '', window.location.pathname + '?t=' + timestamp);
                    }
                }
                
                // 화면 회전 감지
                window.addEventListener('orientationchange', function() {
                    setTimeout(() => {
                        addMobileTouchEvents();
                        // 뷰포트 재계산
                        const vh = window.innerHeight * 0.01;
                        document.documentElement.style.setProperty('--vh', `${vh}px`);
                    }, 100);
                });
                
                // 특정 기기별 최적화 강화
                function applyDeviceSpecificOptimizations() {
                    const userAgent = navigator.userAgent;
                    const isKakaoTalk = userAgent.includes('KAKAO');
                    
                    // 아이폰11 (414x896)
                    if (userAgent.includes('iPhone') && 
                        screen.width === 414 && screen.height === 896) {
                        console.log('아이폰11 최적화 적용');
                        document.body.classList.add('device-iphone11');
                    }
                    
                    // 아이폰 미니 (375x812)
                    if (userAgent.includes('iPhone') && 
                        screen.width === 375 && screen.height === 812) {
                        console.log('아이폰 미니 최적화 적용');
                        document.body.classList.add('device-iphone-mini');
                    }
                    
                    // Galaxy XCover 5 (432x900)
                    if (userAgent.includes('Android') && 
                        screen.width <= 432 && screen.height <= 900) {
                        console.log('Galaxy XCover 5 최적화 적용');
                        document.body.classList.add('device-galaxy-xcover5');
                    }
                    
                    // 카카오톡 브라우저 강화 최적화
                    if (isKakaoTalk) {
                        console.log('카카오톡 브라우저 강화 최적화 적용');
                        document.body.classList.add('kakao-browser-enhanced');
                        
                        // 터치 이벤트 완전 재구성
                        const allButtons = document.querySelectorAll('button, .language-current, .language-option, .back-link');
                        allButtons.forEach(element => {
                            element.style.setProperty('-webkit-tap-highlight-color', 'transparent', 'important');
                            element.style.setProperty('touch-action', 'manipulation', 'important');
                            element.style.setProperty('-webkit-user-select', 'none', 'important');
                            element.style.setProperty('user-select', 'none', 'important');
                            element.style.setProperty('cursor', 'pointer', 'important');
                            element.style.setProperty('pointer-events', 'auto', 'important');
                        });
                    }
                }
                
                // 기기별 최적화 적용
                applyDeviceSpecificOptimizations();
                
                        // 카카오톡 브라우저 특별 최적화
        function setupKakaoTalkOptimization() {
            const isKakaoTalk = navigator.userAgent.includes('KAKAO');
            if (!isKakaoTalk) return;
            
            console.log('카카오톡 브라우저 감지 - 특별 최적화 적용');
            
            // 모든 메뉴 버튼에 추가 이벤트 리스너 설정
            function addKakaoTalkEvents() {
                const menuButtons = document.querySelectorAll('.quick-button');
                
                menuButtons.forEach(button => {
                    // 기존 이벤트 리스너 제거 후 새로 추가
                    const newButton = button.cloneNode(true);
                    button.parentNode.replaceChild(newButton, button);
                    
                    // 카카오톡 전용 클릭 이벤트
                    newButton.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const onclick = this.getAttribute('onclick');
                        if (onclick && onclick.includes('handleQuickMessage')) {
                            const match = onclick.match(/handleQuickMessage\('([^']+)'\)/);
                            if (match) {
                                console.log('카카오톡 클릭 이벤트 실행:', match[1]);
                                handleQuickMessage(match[1]);
                            }
                        }
                    }, { passive: false });
                    
                    // 터치 이벤트 추가
                    newButton.addEventListener('touchstart', function(e) {
                        console.log('카카오톡 터치 시작:', this.textContent);
                        this.style.transform = 'scale(0.95)';
                        this.style.transition = 'all 0.1s';
                    }, { passive: true });
                    
                    newButton.addEventListener('touchend', function(e) {
                        console.log('카카오톡 터치 종료:', this.textContent);
                        this.style.transform = '';
                        this.style.transition = 'all 0.3s';
                        
                        const onclick = this.getAttribute('onclick');
                        if (onclick && onclick.includes('handleQuickMessage')) {
                            e.preventDefault();
                            e.stopPropagation();
                            const match = onclick.match(/handleQuickMessage\('([^']+)'\)/);
                            if (match) {
                                console.log('카카오톡 터치 메시지 전송:', match[1]);
                                setTimeout(() => {
                                    handleQuickMessage(match[1]);
                                }, 50);
                            }
                        }
                    }, { passive: false });
                    
                    console.log('카카오톡 이벤트 추가 완료:', newButton.textContent);
                });
            }
            
            // 초기 설정
            setTimeout(addKakaoTalkEvents, 500);
            
            // DOM 변경 감지하여 새 버튼에도 적용
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                        mutation.addedNodes.forEach(function(node) {
                            if (node.nodeType === 1 && (node.classList.contains('quick-button') || node.querySelector('.quick-button'))) {
                                console.log('새 메뉴 버튼 감지 - 카카오톡 이벤트 추가');
                                setTimeout(addKakaoTalkEvents, 100);
                            }
                        });
                    }
                });
            });
            
            const messagesContainer = document.getElementById('messages');
            if (messagesContainer) {
                observer.observe(messagesContainer, {
                    childList: true,
                    subtree: true
                });
            }
        }
        
        // 페이지 포커스 복귀 시 이벤트 재적용
        window.addEventListener('pageshow', function(e) {
                    if (e.persisted) {
                        setTimeout(() => {
                            addMobileTouchEvents();
                        }, 100);
                    }
                });
            }
        }

        // 강제 터치 이벤트 초기화 (카카오톡 브라우저용)
        function forceInitializeTouchEvents() {
            setTimeout(() => {
                const allButtons = document.querySelectorAll('button, .clickable');
                allButtons.forEach(button => {
                    button.style.touchAction = 'manipulation';
                    button.style.webkitTapHighlightColor = 'transparent';
                    button.style.outline = 'none';
                    button.style.border = 'none';
                    button.addEventListener('touchstart', function(e) {
                        e.stopPropagation();
                    }, { passive: true });
                });
                console.log('강제 터치 이벤트 초기화 완료');
            }, 500);
        }

        // 페이지 로드 시 모바일 최적화 적용
        document.addEventListener('DOMContentLoaded', function() {
            optimizeForMobile();
            forceInitializeTouchEvents();
        });

        // 윈도우 로드 시에도 한 번 더 적용
        window.addEventListener('load', function() {
            setTimeout(() => {
                optimizeForMobile();
                forceInitializeTouchEvents();
                
                // 지식베이스 설정 불러오기
                loadKnowledgeBaseSettings();
                
                // API 설정 확인
                checkApiSettings();
            }, 1000);
        });
        
        // API 설정 확인 함수
        function checkApiSettings() {
            try {
                const savedSettings = localStorage.getItem('chatbotApiSettings');
                if (savedSettings) {
                    const apiSettings = JSON.parse(savedSettings);
                    console.log('🔍 페이지 로드 시 API 설정 확인:');
                    console.log('- ChatGPT:', apiSettings.chatgpt?.enabled && apiSettings.chatgpt?.apiKey ? '활성' : '비활성');
                    console.log('- Gemini:', apiSettings.gemini?.enabled && apiSettings.gemini?.apiKey ? '활성' : '비활성');
                    console.log('- Claude:', apiSettings.claude?.enabled && apiSettings.claude?.apiKey ? '활성' : '비활성');
                    console.log('- 활성 제공자:', apiSettings.activeProvider);
                    
                    // 활성화된 API가 있는지 확인
                    const hasActiveAPI = (
                        (apiSettings.chatgpt?.enabled && apiSettings.chatgpt?.apiKey) ||
                        (apiSettings.gemini?.enabled && apiSettings.gemini?.apiKey) ||
                        (apiSettings.claude?.enabled && apiSettings.claude?.apiKey)
                    );
                    
                    if (hasActiveAPI) {
                        console.log('✅ 활성화된 AI API가 있습니다. AI 답변이 가능합니다.');
                    } else {
                        console.log('❌ 활성화된 AI API가 없습니다. 시뮬레이션된 답변을 사용합니다.');
                    }
                } else {
                    console.log('❌ 저장된 API 설정이 없습니다.');
                }
            } catch (error) {
                console.error('❌ API 설정 확인 실패:', error);
            }
        }

        // 지식베이스 설정 불러오기
        function loadKnowledgeBaseSettings() {
            try {
                const savedKnowledgeBase = localStorage.getItem('chatbotKnowledgeBase');
                if (savedKnowledgeBase) {
                    const parsed = JSON.parse(savedKnowledgeBase);
                    knowledgeBase.enabled = parsed.enabled || false;
                    knowledgeBase.parsedData = parsed.parsedData || [];
                    
                    // 파일 정보 복원 (실제 파일 객체는 복원할 수 없으므로 메타데이터만)
                    if (parsed.files) {
                        knowledgeBase.files = parsed.files.map(fileInfo => ({
                            name: fileInfo.name,
                            size: fileInfo.size,
                            type: fileInfo.type
                        }));
                    }
                    
                    console.log('📚 지식베이스 설정 불러옴:', knowledgeBase.parsedData.length, '개 Q&A,', knowledgeBase.files.length, '개 파일');
                    
                    // 파일 목록 UI 업데이트
                    updateFileList2();
                    updateKnowledgeStatus2();
                }
            } catch (error) {
                console.error('지식베이스 설정 불러오기 실패:', error);
            }
        }

        // 지식베이스 설정 저장
        function saveKnowledgeBaseSettings() {
            try {
                const dataToSave = {
                    enabled: knowledgeBase.enabled,
                    parsedData: knowledgeBase.parsedData,
                    files: knowledgeBase.files.map(file => ({
                        name: file.name,
                        size: file.size,
                        type: file.type
                    }))
                };
                localStorage.setItem('chatbotKnowledgeBase', JSON.stringify(dataToSave));
                console.log('📚 지식베이스 설정 저장됨:', knowledgeBase.parsedData.length, '개 Q&A');
            } catch (error) {
                console.error('지식베이스 설정 저장 실패:', error);
            }
        }

        console.log('별도창 AI챗봇 모바일 최적화 스크립트 로드 완료');

        // 드롭다운 메뉴 토글
        function toggleLanguageMenu() {
            const menu = document.getElementById('languageMenu');
            if (menu) {
                if (menu.style.display === 'block' || menu.classList.contains('show')) {
                    menu.style.display = 'none';
                    menu.classList.remove('show');
                } else {
                    menu.style.display = 'block';
                    menu.classList.add('show');
                }
            }
        }

        // 언어 선택
        function selectLanguage(language) {
            console.log('언어 선택:', language);
            
            currentLanguage = language;
            
            // UI 업데이트
            updateLanguageUI(language);
            
            // 드롭다운 메뉴 닫기
            const menu = document.getElementById('languageMenu');
            if (menu) {
                menu.style.display = 'none';
                menu.classList.remove('show');
            }
            
            // 언어 변경 알림
            const changeMessages = {
                ko: '🇰🇷 한국어로 언어가 변경되었습니다!',
                en: '🇺🇸 Language changed to English!',
                ru: '🇷🇺 Язык изменен на русский!',
                ja: '🇯🇵 言語が日本語に変更されました！'
            };
            
            addBotMessage(changeMessages[language] || changeMessages['ko']);
            
            // 모바일 기기에서 기본 답변 재생성 (카카오톡 브라우저 문제 해결)
            const isKakaoTalk = navigator.userAgent.includes('KAKAO');
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (isKakaoTalk || isMobile) {
                console.log('모바일 기기 감지 - 기본 답변 재생성');
                
                // 기본 답변 재생성을 위한 강제 업데이트
                setTimeout(() => {
                    regenerateQuickButtons();
                }, 1000);
            }
        }

        // 기본 답변 버튼 재생성 (모바일 기기용)
        function regenerateQuickButtons() {
            const t = translations[currentLanguage] || translations['ko'];
            
            // 기존 환영 메시지 찾기
            const messages = document.querySelectorAll('.message.bot');
            let lastWelcomeMessage = null;
            
            messages.forEach(msg => {
                if (msg.innerHTML.includes('quick-buttons')) {
                    lastWelcomeMessage = msg;
                }
            });
            
            // 새로운 환영 메시지 추가
            if (lastWelcomeMessage) {
                const newWelcomeMessage = `
                    <div style="text-align: center; color: #333;">
                        <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px; color: #2c3e50;">
                            ${t.welcomeMessage}
                        </div>
                        <div style="font-size: 14px; color: #666; line-height: 1.5; margin-bottom: 20px;">
                            ${t.welcomeSubMessage}
                        </div>
                        <div class="quick-buttons" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-width: 300px; margin-left: auto; margin-right: auto;">
                            <button class="quick-button clinic-hours-btn" onclick="handleQuickMessage('진료시간 알려주세요')" ontouchstart="handleKakaoTouch('진료시간 알려주세요')" style="background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); color: #333; border: none; padding: 12px 8px; border-radius: 20px; font-size: 13px; font-weight: bold; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3); -webkit-tap-highlight-color: transparent;">🕘 진료시간</button>
                            <button class="quick-button treatment-cost-btn" onclick="handleQuickMessage('치료비용 궁금해요')" ontouchstart="handleKakaoTouch('치료비용 궁금해요')" style="background: linear-gradient(135deg, #1e88e5 0%, #42a5f5 100%); color: white; border: none; padding: 12px 8px; border-radius: 20px; font-size: 13px; font-weight: bold; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(30, 136, 229, 0.3); -webkit-tap-highlight-color: transparent;">💰 치료비용</button>
                            <button class="quick-button reservation-btn" onclick="handleQuickMessage('예약문의 하고싶어요')" ontouchstart="handleKakaoTouch('예약문의 하고싶어요')" style="background: linear-gradient(135deg, #ff69b4 0%, #ff1493 100%); color: white; border: none; padding: 12px 8px; border-radius: 20px; font-size: 13px; font-weight: bold; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(255, 105, 180, 0.3); -webkit-tap-highlight-color: transparent;">📞 예약문의</button>
                            <button class="quick-button directions-btn" onclick="handleQuickMessage('오시는길 알려주세요')" ontouchstart="handleKakaoTouch('오시는길 알려주세요')" style="background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%); color: white; border: none; padding: 12px 8px; border-radius: 20px; font-size: 13px; font-weight: bold; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3); -webkit-tap-highlight-color: transparent;">🗺️ 오시는길</button>
                        </div>
                    </div>
                `;
                
                const messageContent = lastWelcomeMessage.querySelector('.message-content');
                if (messageContent) {
                    messageContent.innerHTML = newWelcomeMessage;
                }
            }
        }

        // 언어 UI 업데이트
        function updateLanguageUI(language) {
            const t = translations[language] || translations['ko'];
            
            // 헤더 제목
            const title = document.querySelector('.chatbot-title');
            if (title) title.textContent = t.title;
            
            // 입력창 플레이스홀더
            const input = document.getElementById('chatbotInput');
            if (input) input.placeholder = t.placeholder;
            
            // 전송 버튼 텍스트
            const sendBtn = document.querySelector('.chatbot-send');
            if (sendBtn) sendBtn.textContent = t.sendButton;
            
            // 현재 언어 표시
            const currentLangText = document.getElementById('currentLanguageText');
            if (currentLangText) {
                currentLangText.textContent = t.currentLanguage;
                currentLangText.style.color = 'black';
            }
            
            // 드롭다운 옵션 업데이트
            const options = document.querySelectorAll('.language-option');
            options.forEach(option => {
                option.classList.remove('active');
                if (option.getAttribute('data-lang') === language) {
                    option.classList.add('active');
                }
            });
        }

        // 중복 실행 방지를 위한 플래그
        let isProcessingMessage = false;
        let lastMessageTime = 0;
        let lastMessage = '';

        // 빠른 메시지 전송 (카카오톡 브라우저 완벽 지원)
        function handleQuickMessage(message) {
            console.log('빠른 메시지 전송:', message, '카카오톡:', navigator.userAgent.includes('KAKAO'));
            
            // 중복 실행 방지 (1초 내 동일 메시지 차단)
            const currentTime = Date.now();
            if (isProcessingMessage || (currentTime - lastMessageTime < 1000 && lastMessage === message)) {
                console.log('중복 메시지 차단:', message);
                return;
            }
            
            isProcessingMessage = true;
            lastMessageTime = currentTime;
            lastMessage = message;
            
            // 이벤트 전파 방지
            if (typeof event !== 'undefined' && event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            // 사용자 메시지 추가
            addUserMessage(message);
            
            // AI 답변 생성
            setTimeout(() => {
                generateResponse(message);
                // 플래그 해제
                setTimeout(() => {
                    isProcessingMessage = false;
                }, 500);
            }, 300);
        }

        // 카카오톡 브라우저 전용 터치 핸들러
        function handleKakaoTouch(message) {
            console.log('카카오톡 터치 이벤트:', message);
            
            // 약간의 지연을 두고 메시지 전송 (카카오톡 브라우저 최적화)
            setTimeout(() => {
                handleQuickMessage(message);
            }, 100);
        }

        // 빠른 메시지 전송 (호환성 유지)
        function sendQuickMessage(message) {
            handleQuickMessage(message);
        }

        // 메시지 전송
        function sendMessage() {
            const input = document.getElementById('chatbotInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            console.log('메시지 전송:', message);
            
            // 사용자 메시지 추가
            addUserMessage(message);
            
            // 입력창 초기화
            input.value = '';
            input.style.height = 'auto';
            
            // AI 답변 생성
            generateResponse(message);
        }

        // 사용자 메시지 추가
        function addUserMessage(message) {
            const messagesContainer = document.getElementById('chatbotMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user';
            messageDiv.innerHTML = `
                <div class="message-avatar">👤</div>
                <div class="message-content">${message}</div>
            `;
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        // 봇 메시지 추가
        function addBotMessage(message) {
            const messagesContainer = document.getElementById('chatbotMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot';
            messageDiv.innerHTML = `
                <div class="message-avatar">👩‍⚕️</div>
                <div class="message-content">${message}</div>
            `;
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
            return messageDiv;
        }

        // 스크롤 맨 아래로
        function scrollToBottom() {
            const messagesContainer = document.getElementById('chatbotMessages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // AI 답변 생성 (개선된 우선순위 적용)
        function generateResponse(message) {
            const t = translations[currentLanguage] || translations['ko'];

            // 1. 관리자 기능
            if (message.includes('AI관리자') || message.includes('AI 관리자') || message.includes('관리자')) {
                // ... 기존 관리자 코드 ...
                const adminLink = `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px; padding: 20px; margin: 15px 0; text-align: center;">
                        <h4 style="margin-bottom: 15px;">🤖 AI챗봇 관리 로그인</h4>
                        <p style="margin-bottom: 10px;">관리자 페이지에 접속하려면 아래 버튼을 클릭하세요.</p>
                        <p style="margin-bottom: 20px; font-size: 14px; opacity: 0.9;">💡 아이디: <strong>phoenix</strong> | 비밀번호: <strong>phoenix</strong></p>
                        <button id="adminLoginBtn" style="background: white; color: #667eea; border: none; padding: 12px 25px; border-radius: 25px; font-weight: bold; cursor: pointer; font-size: 16px; transition: all 0.3s; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
                            🔐 관리자 페이지 열기
                        </button>
                    </div>
                `;
                addBotMessage(adminLink);
                setTimeout(() => {
                    const adminButton = document.getElementById('adminLoginBtn');
                    if (adminButton) {
                        adminButton.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            openChatbotAdmin2();
                        });
                        adminButton.addEventListener('touchstart', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            openChatbotAdmin2();
                        });
                    }
                }, 100);
                return;
            }

            // 2. 지식베이스
            const knowledgeAnswer = searchInKnowledgeBase(message);
            if (knowledgeAnswer) {
                addBotMessage(knowledgeAnswer);
                return;
            }

            // 3. FAQ (치료비용 포함)
            const isClinicHours = message.includes('진료시간') || message.includes('clinic hours') || message.includes('hours') ||
                                  message.includes('часы работы') || message.includes('診療時間');
            const isTreatmentCost = message.includes('치료비용') || message.includes('가격') || message.includes('비용') ||
                                    message.includes('cost') || message.includes('price') || message.includes('treatment') ||
                                    message.includes('стоимость') || message.includes('цена') ||
                                    message.includes('料金') || message.includes('費用');
            const isReservationInquiry = message.includes('예약') || message.includes('예약문의') ||
                                        message.includes('reservation') || message.includes('booking') || message.includes('inquiry') ||
                                        message.includes('запись') || message.includes('бронирование') ||
                                        message.includes('予約') || message.includes('問い合わせ');
            const isDirections = message.includes('오시는길') || message.includes('주소') || message.includes('위치') ||
                                  message.includes('directions') || message.includes('location') || message.includes('address') ||
                                  message.includes('адрес') || message.includes('местоположение') ||
                                  message.includes('場所') || message.includes('住所') || message.includes('アクセス');

            if (isClinicHours) {
                addBotMessage(t.clinicHours);
                return;
            } else if (isTreatmentCost) {
                addBotMessage(t.treatmentCost);
                return;
            } else if (isReservationInquiry) {
                addBotMessage(t.reservationInquiry);
                return;
            } else if (isDirections) {
                addBotMessage(t.directions);
                return;
            }

            // 4. FAQ에 해당하지 않는 질문은 AI API로!
            let apiSettings = null;
            try {
                const savedSettings = localStorage.getItem('chatbotApiSettings');
                if (savedSettings) {
                    apiSettings = JSON.parse(savedSettings);
                }
            } catch (error) {
                console.error('❌ API 설정 불러오기 실패:', error);
            }

            const hasActiveAPI = apiSettings && (
                (apiSettings.chatgpt?.enabled && apiSettings.chatgpt?.apiKey) ||
                (apiSettings.gemini?.enabled && apiSettings.gemini?.apiKey) ||
                (apiSettings.claude?.enabled && apiSettings.claude?.apiKey)
            );

            if (hasActiveAPI) {
                generateAIResponse(message, apiSettings);
                return;
            } else {
                setTimeout(() => {
                    const aiResponse = generateSimulatedAIResponse(message, 'chatgpt');
                    addBotMessage(aiResponse);
                }, 1000);
                return;
            }
        }

        // AI API를 사용한 답변 생성 (개선된 버전)
        function generateAIResponse(message, apiSettings) {
            console.log('🤖 AI API 답변 생성 시작:', message);
            console.log('📋 API 설정:', apiSettings);
            
            // 로딩 메시지 표시
            const loadingMessage = addBotMessage('🤖 AI가 답변을 생성하고 있습니다...');
            
            // 활성화된 API 선택 (API 키가 있는 것만)
            let activeProvider = apiSettings.activeProvider;
            if (!activeProvider || !apiSettings[activeProvider]?.apiKey) {
                if (apiSettings.chatgpt?.enabled && apiSettings.chatgpt?.apiKey) {
                    activeProvider = 'chatgpt';
                } else if (apiSettings.gemini?.enabled && apiSettings.gemini?.apiKey) {
                    activeProvider = 'gemini';
                } else if (apiSettings.claude?.enabled && apiSettings.claude?.apiKey) {
                    activeProvider = 'claude';
                }
            }
            
            console.log('🎯 선택된 AI 제공자:', activeProvider);
            console.log('🔑 API 키 상태:', {
                chatgpt: apiSettings.chatgpt?.apiKey ? '있음' : '없음',
                gemini: apiSettings.gemini?.apiKey ? '있음' : '없음',
                claude: apiSettings.claude?.apiKey ? '있음' : '없음'
            });
            
            // 지식베이스 컨텍스트 추가
            let contextInfo = getContextFromKnowledgeBase();
            
            // 치과 관련 기본 컨텍스트
            const dentalContext = `
당신은 피닉스치과의 AI 상담사입니다. 
다음 정보를 바탕으로 친절하고 정확한 답변을 제공해주세요:

🏥 피닉스치과 정보:
- 진료시간: 평일 09:00~18:00, 토요일 09:00~15:00, 점심시간 12:30~13:30
- 휴진: 일요일, 공휴일
- 위치: 서울시 강남구
- 연락처: 070-1234-1234

💡 답변 스타일:
- 친절하고 이해하기 쉽게
- 구체적인 정보 제공
- 필요시 예약 안내
- 한국어로 답변

${contextInfo}

사용자 질문: ${message}
`;

            // 실제 API 호출 시도 (개선된 버전)
            let apiCallMade = false;
            
            if (activeProvider === 'chatgpt' && apiSettings.chatgpt?.enabled && apiSettings.chatgpt?.apiKey) {
                console.log('🚀 ChatGPT API 호출 시도');
                apiCallMade = true;
                callChatGPTAPI(message, apiSettings.chatgpt, loadingMessage, contextInfo);
            } else if (activeProvider === 'gemini' && apiSettings.gemini?.enabled && apiSettings.gemini?.apiKey) {
                console.log('🚀 Gemini API 호출 시도');
                apiCallMade = true;
                callGeminiAPI(message, apiSettings.gemini, loadingMessage, contextInfo);
            } else if (activeProvider === 'claude' && apiSettings.claude?.enabled && apiSettings.claude?.apiKey) {
                console.log('🚀 Claude API 호출 시도');
                apiCallMade = true;
                callClaudeAPI(message, apiSettings.claude, loadingMessage, contextInfo);
            }
            
            // API 호출이 실패하거나 활성화된 API가 없는 경우 시뮬레이션된 답변 사용
            if (!apiCallMade) {
                console.log('❌ API 호출 실패 또는 활성화된 API 없음 - 시뮬레이션된 답변 사용');
                console.log('🔍 API 호출 실패 원인 분석:');
                console.log('- activeProvider:', activeProvider);
                console.log('- ChatGPT 상태:', apiSettings.chatgpt?.enabled && apiSettings.chatgpt?.apiKey ? '사용 가능' : '사용 불가');
                console.log('- Gemini 상태:', apiSettings.gemini?.enabled && apiSettings.gemini?.apiKey ? '사용 가능' : '사용 불가');
                console.log('- Claude 상태:', apiSettings.claude?.enabled && apiSettings.claude?.apiKey ? '사용 가능' : '사용 불가');
                
                setTimeout(() => {
                    const aiResponse = generateSimulatedAIResponse(message, activeProvider || 'chatgpt');
                    
                    // 로딩 메시지 제거하고 AI 답변 표시
                    if (loadingMessage && loadingMessage.parentNode) {
                        loadingMessage.parentNode.removeChild(loadingMessage);
                    }
                    
                    addBotMessage(aiResponse);
                }, 1000); // 더 빠른 응답
            }
        }

        // 지식베이스에서 컨텍스트 정보 추출
        function getContextFromKnowledgeBase() {
            if (!knowledgeBase.enabled || knowledgeBase.parsedData.length === 0) {
                console.log('❌ 지식베이스 컨텍스트 추출 실패: 비활성 또는 데이터 없음');
                return '';
            }
            
            // 모든 Q&A를 컨텍스트로 정리
            let context = '\n\n=== 병원 전문 지식 정보 ===\n';
            knowledgeBase.parsedData.forEach((qa, index) => {
                context += `${index + 1}. Q: ${qa.question}\n   A: ${qa.answer}\n`;
            });
            
            console.log('✅ 지식베이스 컨텍스트 추출 완료:', knowledgeBase.parsedData.length, '개 Q&A');
            return context;
        }

        // ChatGPT API 호출 (개선된 버전)
        function callChatGPTAPI(message, settings, loadingMessage, contextInfo = '') {
            const apiKey = settings.apiKey;
            const model = settings.model || 'gpt-4o-mini';
            
            console.log('🔑 ChatGPT API 호출 시작');
            console.log('- API 키:', apiKey ? '있음' : '없음');
            console.log('- 모델:', model);
            console.log('- 메시지:', message);
            
            const systemPrompt = `당신은 피닉스 치과 병원의 전문 AI 상담사입니다. 
            매우 친절하고 전문적으로 답변해주세요.

            === 병원 기본 정보 ===
            • 병원명: 피닉스 치과 병원
            • 원장: 홍길동 (25년 경력 치주질환 전문의)
            • 진료시간: 평일 09:00-18:00, 토요일 09:00-15:00, 점심시간 12:30-13:30
            • 휴진: 일요일, 공휴일
            • 전화: 070-1234-1234 (24시간 응급상담 가능)
            • 주소: 피닉스시 피닉스로 11길 11, 피닉스타워 11층 11호
            • 교통: 지하철 2호선 강남역 3번 출구 도보 5분
            • 주차: 건물 지하 1-3층 무료 주차 (3시간)
            • 진료과목: 일반진료, 미백치료, 교정치료, 임플란트, 보철치료, 소아치과

            === 치료비 안내 ===
            • 일반진료: 초진 15,000원, 재진 10,000원
            • 스케일링: 50,000원 (건강보험 적용 시 연 1회 무료)
            • 미백치료: 200,000-300,000원
            • 교정치료: 1,500,000-6,000,000원
            • 임플란트: 1,200,000-1,500,000원

            ${contextInfo}

            답변 가이드라인:
            1. 매우 친절하고 따뜻한 말투를 사용하세요
            2. 전문적이면서도 이해하기 쉽게 설명하세요
            3. 구체적인 정보를 제공하되, 정확하지 않은 의료 진단은 피하세요
            4. 예약이나 상담이 필요한 경우 적극 안내하세요
            5. 답변을 구조화하여 읽기 쉽게 정리해주세요`;
            
            const requestBody = {
                model: model,
                messages: [
                    {
                        role: "system",
                        content: systemPrompt
                    },
                    {
                        role: "user",
                        content: message
                    }
                ],
                max_tokens: 1000,
                temperature: 0.7
            };

            fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify(requestBody)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('✅ ChatGPT API 호출 성공');
                console.log('- 응답 데이터:', data);
                
                // 로딩 메시지 제거
                if (loadingMessage && loadingMessage.parentNode) {
                    loadingMessage.parentNode.removeChild(loadingMessage);
                }
                
                const aiResponse = data.choices[0].message.content;
                console.log('- AI 응답:', aiResponse);
                addBotMessage(formatAIResponse(aiResponse, 'chatgpt'));
            })
            .catch(error => {
                console.error('❌ ChatGPT API 호출 실패:', error);
                console.log('🔍 실패 원인:', error.message);
                
                // 로딩 메시지 제거
                if (loadingMessage && loadingMessage.parentNode) {
                    loadingMessage.parentNode.removeChild(loadingMessage);
                }
                
                // 시뮬레이션된 답변으로 자연스럽게 대체
                console.log('🔄 ChatGPT API 실패 - 시뮬레이션된 답변으로 대체');
                const aiResponse = generateSimulatedAIResponse(message, 'chatgpt');
                addBotMessage(aiResponse);
            });
        }

        // Gemini API 호출
        function callGeminiAPI(message, settings, loadingMessage, contextInfo = '') {
            const apiKey = settings.apiKey;
            const model = settings.model || 'gemini-1.5-flash';
            
            const prompt = `당신은 피닉스 치과 병원의 전문 AI 상담사입니다. 
            매우 친절하고 전문적으로 답변해주세요.

            === 병원 기본 정보 ===
            • 병원명: 피닉스 치과 병원
            • 원장: 홍길동 (25년 경력 치주질환 전문의)
            • 진료시간: 평일 09:00-18:00, 토요일 09:00-15:00, 점심시간 12:30-13:30
            • 휴진: 일요일, 공휴일
            • 전화: 070-1234-1234 (24시간 응급상담 가능)
            • 주소: 피닉스시 피닉스로 11길 11, 피닉스타워 11층 11호
            • 교통: 지하철 2호선 강남역 3번 출구 도보 5분
            • 주차: 건물 지하 1-3층 무료 주차 (3시간)
            • 진료과목: 일반진료, 미백치료, 교정치료, 임플란트, 보철치료, 소아치과

            === 치료비 안내 ===
            • 일반진료: 초진 15,000원, 재진 10,000원
            • 스케일링: 50,000원 (건강보험 적용 시 연 1회 무료)
            • 미백치료: 200,000-300,000원
            • 교정치료: 1,500,000-6,000,000원
            • 임플란트: 1,200,000-1,500,000원

            ${contextInfo}

            답변 가이드라인:
            1. 매우 친절하고 따뜻한 말투를 사용하세요
            2. 전문적이면서도 이해하기 쉽게 설명하세요
            3. 구체적인 정보를 제공하되, 정확하지 않은 의료 진단은 피하세요
            4. 예약이나 상담이 필요한 경우 적극 안내하세요
            5. 답변을 구조화하여 읽기 쉽게 정리해주세요

            사용자 질문: ${message}`;
            
            const requestBody = {
                contents: [
                    {
                        parts: [
                            {
                                text: prompt
                            }
                        ]
                    }
                ],
                generationConfig: {
                    temperature: 0.7,
                    maxOutputTokens: 1000
                }
            };

            fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // 로딩 메시지 제거
                if (loadingMessage && loadingMessage.parentNode) {
                    loadingMessage.parentNode.removeChild(loadingMessage);
                }
                
                const aiResponse = data.candidates[0].content.parts[0].text;
                addBotMessage(formatAIResponse(aiResponse, 'gemini'));
            })
            .catch(error => {
                console.error('Gemini API 호출 실패:', error);
                
                // 로딩 메시지 제거
                if (loadingMessage && loadingMessage.parentNode) {
                    loadingMessage.parentNode.removeChild(loadingMessage);
                }
                
                // 시뮬레이션된 답변으로 자연스럽게 대체
                console.log('Gemini API 실패 - 시뮬레이션된 답변으로 대체');
                const aiResponse = generateSimulatedAIResponse(message, 'gemini');
                addBotMessage(aiResponse);
            });
        }

        // Claude API 호출
        function callClaudeAPI(message, settings, loadingMessage, contextInfo = '') {
            const apiKey = settings.apiKey;
            const model = settings.model || 'claude-3-haiku-20240307';
            
            const prompt = `당신은 피닉스 치과 병원의 전문 AI 상담사입니다. 
            매우 친절하고 전문적으로 답변해주세요.

            === 병원 기본 정보 ===
            • 병원명: 피닉스 치과 병원
            • 원장: 홍길동 (25년 경력 치주질환 전문의)
            • 진료시간: 평일 09:00-18:00, 토요일 09:00-15:00, 점심시간 12:30-13:30
            • 휴진: 일요일, 공휴일
            • 전화: 070-1234-1234 (24시간 응급상담 가능)
            • 주소: 피닉스시 피닉스로 11길 11, 피닉스타워 11층 11호
            • 교통: 지하철 2호선 강남역 3번 출구 도보 5분
            • 주차: 건물 지하 1-3층 무료 주차 (3시간)
            • 진료과목: 일반진료, 미백치료, 교정치료, 임플란트, 보철치료, 소아치과

            === 치료비 안내 ===
            • 일반진료: 초진 15,000원, 재진 10,000원
            • 스케일링: 50,000원 (건강보험 적용 시 연 1회 무료)
            • 미백치료: 200,000-300,000원
            • 교정치료: 1,500,000-6,000,000원
            • 임플란트: 1,200,000-1,500,000원

            ${contextInfo}

            답변 가이드라인:
            1. 매우 친절하고 따뜻한 말투를 사용하세요
            2. 전문적이면서도 이해하기 쉽게 설명하세요
            3. 구체적인 정보를 제공하되, 정확하지 않은 의료 진단은 피하세요
            4. 예약이나 상담이 필요한 경우 적극 안내하세요
            5. 답변을 구조화하여 읽기 쉽게 정리해주세요
            6. 진료시간, 치료비용, 예약문의, 오시는길 등 주요 질문에 대해서는 자연스럽고 상세한 설명을 제공하세요
            7. 사용자의 편의를 고려한 실용적인 조언을 포함해주세요

            사용자 질문: ${message}`;
            
            const requestBody = {
                model: model,
                max_tokens: 1000,
                messages: [
                    {
                        role: "user",
                        content: prompt
                    }
                ]
            };

            fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': apiKey,
                    'anthropic-version': '2023-06-01'
                },
                body: JSON.stringify(requestBody)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // 로딩 메시지 제거
                if (loadingMessage && loadingMessage.parentNode) {
                    loadingMessage.parentNode.removeChild(loadingMessage);
                }
                
                const aiResponse = data.content[0].text;
                addBotMessage(formatAIResponse(aiResponse, 'claude'));
            })
            .catch(error => {
                console.error('Claude API 호출 실패:', error);
                
                // 로딩 메시지 제거
                if (loadingMessage && loadingMessage.parentNode) {
                    loadingMessage.parentNode.removeChild(loadingMessage);
                }
                
                // 시뮬레이션된 답변으로 자연스럽게 대체
                console.log('Claude API 실패 - 시뮬레이션된 답변으로 대체');
                const aiResponse = generateSimulatedAIResponse(message, 'claude');
                addBotMessage(aiResponse);
            });
        }

        // 지식베이스에서 답변 검색 (랜딩페이지와 동일한 로직)
        function searchInKnowledgeBase(userMessage) {
            if (!knowledgeBase.enabled || knowledgeBase.parsedData.length === 0) {
                console.log('❌ 지식베이스 비활성 또는 데이터 없음 (활성:', knowledgeBase.enabled, ', 데이터:', knowledgeBase.parsedData.length, '개)');
                return null;
            }
            
            const message = userMessage.toLowerCase().trim();
            console.log('🔍 지식베이스 검색 시작:', message, '| 총 데이터:', knowledgeBase.parsedData.length);
            
            // 검색 결과를 점수별로 저장
            let searchResults = [];
            
            for (let qa of knowledgeBase.parsedData) {
                const question = qa.question.toLowerCase();
                const answer = qa.answer.toLowerCase();
                let score = 0;
                let matchDetails = [];
                
                // 1. 완전 일치 (최고 점수)
                if (question === message || answer.includes(message)) {
                    score += 1000;
                    matchDetails.push('완전일치');
                }
                
                // 2. 부분 문자열 포함 (높은 점수)
                if (question.includes(message) || message.includes(question)) {
                    score += 800;
                    matchDetails.push('부분포함');
                }
                
                // 3. 개별 단어 매칭 (중간 점수)
                const messageWords = message.split(/\s+/).filter(word => word.length > 1);
                const questionWords = question.split(/\s+/).filter(word => word.length > 1);
                
                let wordMatches = 0;
                for (let word of messageWords) {
                    if (question.includes(word)) {
                        score += 200;
                        wordMatches++;
                    }
                    if (answer.includes(word)) {
                        score += 100;
                        wordMatches++;
                    }
                }
                
                if (wordMatches > 0) {
                    matchDetails.push(`단어매칭(${wordMatches})`);
                }
                
                // 4. 유사 단어 매칭
                for (let qWord of questionWords) {
                    for (let mWord of messageWords) {
                        if ((qWord.includes(mWord) || mWord.includes(qWord)) && mWord.length > 1) {
                            score += 50;
                        }
                    }
                }
                
                // 5. 주제별 키워드 매칭
                const topics = {
                    '시간': ['시간', '언제', '몇시', '오픈', '문여', '운영', '근무', '진료시간', '열어', '닫어'],
                    '예약': ['예약', '신청', '접수', '방문', '가고싶', '상담', '예약하기', '신청하기', '예약문의', '신청문의'],
                    '비용': ['비용', '가격', '얼마', '돈', '금액', '료', '수가', '치료비', '진료비', '요금', '값'],
                    '위치': ['위치', '주소', '어디', '찾아', '오시는길', '교통', '길', '찾기', '어디에', '어느곳'],
                    '치료': ['치료', '시술', '수술', '처치', '진료', '의료', '병원', '치과'],
                    '통증': ['아프', '통증', '아픈', '쓰라린', '불편', '고통', '아파'],
                    '임플란트': ['임플란트', '인공치아', '심기', '식립', '인공', '뼈에'],
                    '교정': ['교정', '브라켓', '치열', '가지런', '고르게', '반듯', '삐뚤'],
                    '미백': ['미백', '하얗게', '희게', '밝게', '화이트닝', '하양'],
                    '보철': ['보철', '크라운', '씌우기', '씌워', '덮개', '덮어'],
                    '소아': ['소아', '어린이', '아이', '아동', '유아', '애기'],
                    '충치': ['충치', '우식', '썩', '벌레', '구멍', '까맣']
                };
                
                let topicMatches = 0;
                for (let [topic, keywords] of Object.entries(topics)) {
                    for (let keyword of keywords) {
                        if (message.includes(keyword)) {
                            if (question.includes(keyword) || answer.includes(keyword) || question.includes(topic)) {
                                score += 150;
                                topicMatches++;
                            }
                        }
                    }
                }
                
                if (topicMatches > 0) {
                    matchDetails.push(`주제매칭(${topicMatches})`);
                }
                
                if (score > 0) {
                    searchResults.push({ qa, score, matchDetails });
                    console.log(`📝 검색 후보: "${qa.question.substring(0, 40)}..." | 점수: ${score} | 매칭: ${matchDetails.join(', ')}`);
                }
            }
            
            // 점수별 정렬
            searchResults.sort((a, b) => b.score - a.score);
            
            console.log(`📊 총 검색 결과: ${searchResults.length}개`);
            if (searchResults.length > 0) {
                console.log(`🏆 최고 점수: ${searchResults[0].score} | 질문: "${searchResults[0].qa.question}"`);
            }
            
            // 점수 기준을 30점으로 설정 (랜딩페이지와 동일)
            if (searchResults.length > 0 && searchResults[0].score >= 30) {
                const bestMatch = searchResults[0].qa;
                console.log('✅ 지식베이스 답변 선택:', bestMatch.question);
                return formatKnowledgeBaseAnswer(bestMatch, userMessage);
            }
            
            console.log('❌ 지식베이스에서 적절한 답변을 찾지 못함');
            return null;
        }

        // 지식베이스 답변 포맷팅
        function formatKnowledgeBaseAnswer(qa, userMessage) {
            return `📚 <strong>피닉스 치과 전문 지식 답변</strong><br><br>
            <strong>질문:</strong> ${qa.question}<br><br>
            <strong>답변:</strong><br>${qa.answer}<br><br>
            <small>💡 이 답변은 피닉스 치과의 전문 지식 데이터베이스에서 제공됩니다.</small>`;
        }

        // AI 응답 포맷팅 (표와 구조화된 형태로 개선)
        function formatAIResponse(response, provider) {
            // AI 모델 표시와 함께 친절한 헤더 추가
            const providerIcon = {
                'chatgpt': '🧠',
                'gemini': '💎', 
                'claude': '🤖'
            };
            
            const providerName = {
                'chatgpt': 'ChatGPT',
                'gemini': 'Gemini',
                'claude': 'Claude'
            };
            
            // 응답 내용을 구조화하여 표로 변환
            const structuredResponse = structureResponseToTable(response);
            
            return `${providerIcon[provider]} <strong>피닉스 치과 AI 상담사 (${providerName[provider]})</strong><br><br>
            ${structuredResponse}<br><br>
            <small>💡 추가 궁금한 점이 있으시면 언제든 문의해주세요!</small>`;
        }

        // 응답을 표 형태로 구조화
        function structureResponseToTable(response) {
            // 진료시간 관련 정보를 표로 변환
            if (response.includes('진료시간') || response.includes('운영시간') || response.includes('09:00') || response.includes('18:00')) {
                return createClinicHoursTable(response);
            }
            
            // 치료비용 관련 정보를 표로 변환
            if (response.includes('치료비') || response.includes('가격') || response.includes('비용') || response.includes('원')) {
                return createTreatmentCostTable(response);
            }
            
            // 예약 관련 정보를 표로 변환
            if (response.includes('예약') || response.includes('상담') || response.includes('방문')) {
                return createReservationTable(response);
            }
            
            // 오시는길 관련 정보를 표로 변환
            if (response.includes('주소') || response.includes('위치') || response.includes('오시는길') || response.includes('교통')) {
                return createDirectionsTable(response);
            }
            
            // 일반적인 응답은 구조화된 형태로 변환
            return structureGeneralResponse(response);
        }

        // 진료시간 표 생성
        function createClinicHoursTable(response) {
            const table = `
                <div style="background: #f8f9fa; border-radius: 10px; padding: 15px; margin: 10px 0;">
                    <h4 style="color: #2c3e50; margin-bottom: 15px;">🏥 진료시간 안내</h4>
                    <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
                                <th style="padding: 12px; text-align: center; border: none;">요일</th>
                                <th style="padding: 12px; text-align: center; border: none;">진료시간</th>
                                <th style="padding: 12px; text-align: center; border: none;">비고</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 12px; text-align: center; font-weight: bold; color: #2c3e50;">평일</td>
                                <td style="padding: 12px; text-align: center;">09:00 ~ 18:00</td>
                                <td style="padding: 12px; text-align: center; color: #27ae60;">정상진료</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 12px; text-align: center; font-weight: bold; color: #2c3e50;">토요일</td>
                                <td style="padding: 12px; text-align: center;">09:00 ~ 15:00</td>
                                <td style="padding: 12px; text-align: center; color: #e67e22;">단축진료</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 12px; text-align: center; font-weight: bold; color: #2c3e50;">점심시간</td>
                                <td style="padding: 12px; text-align: center;">12:30 ~ 13:30</td>
                                <td style="padding: 12px; text-align: center; color: #e74c3c;">진료중단</td>
                            </tr>
                            <tr>
                                <td style="padding: 12px; text-align: center; font-weight: bold; color: #2c3e50;">일요일/공휴일</td>
                                <td style="padding: 12px; text-align: center;">-</td>
                                <td style="padding: 12px; text-align: center; color: #e74c3c;">휴진</td>
                            </tr>
                        </tbody>
                    </table>
                    <div style="margin-top: 15px; padding: 10px; background: #e8f5e8; border-radius: 6px; border-left: 4px solid #27ae60;">
                        <strong>💡 안내사항:</strong> 응급상담이 필요하시면 070-1234-1234로 언제든 연락주세요!
                    </div>
                </div>
            `;
            
            return table;
        }

        // 치료비용 표 생성
        function createTreatmentCostTable(response) {
            const table = `
                <div style="background: #f8f9fa; border-radius: 10px; padding: 15px; margin: 10px 0;">
                    <h4 style="color: #2c3e50; margin-bottom: 15px;">💰 치료비용 안내</h4>
                    <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%); color: white;">
                                <th style="padding: 12px; text-align: center; border: none;">진료과목</th>
                                <th style="padding: 12px; text-align: center; border: none;">비용</th>
                                <th style="padding: 12px; text-align: center; border: none;">비고</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 12px; text-align: center; font-weight: bold; color: #2c3e50;">일반진료</td>
                                <td style="padding: 12px; text-align: center;">초진 15,000원<br>재진 10,000원</td>
                                <td style="padding: 12px; text-align: center; color: #27ae60;">기본진료</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 12px; text-align: center; font-weight: bold; color: #2c3e50;">스케일링</td>
                                <td style="padding: 12px; text-align: center;">50,000원</td>
                                <td style="padding: 12px; text-align: center; color: #3498db;">건강보험 적용 시 연 1회 무료</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 12px; text-align: center; font-weight: bold; color: #2c3e50;">미백치료</td>
                                <td style="padding: 12px; text-align: center;">200,000~300,000원</td>
                                <td style="padding: 12px; text-align: center; color: #e67e22;">미용치료</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 12px; text-align: center; font-weight: bold; color: #2c3e50;">교정치료</td>
                                <td style="padding: 12px; text-align: center;">1,500,000~6,000,000원</td>
                                <td style="padding: 12px; text-align: center; color: #9b59b6;">장기치료</td>
                            </tr>
                            <tr>
                                <td style="padding: 12px; text-align: center; font-weight: bold; color: #2c3e50;">임플란트</td>
                                <td style="padding: 12px; text-align: center;">1,200,000~1,500,000원</td>
                                <td style="padding: 12px; text-align: center; color: #e74c3c;">수술치료</td>
                            </tr>
                        </tbody>
                    </table>
                    <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 6px; border-left: 4px solid #ffc107;">
                        <strong>💡 안내사항:</strong> 정확한 비용은 개인별 진료 계획에 따라 달라질 수 있습니다. 상담 시 정확한 견적을 안내해드립니다.
                    </div>
                </div>
            `;
            
            return table;
        }

        // 예약 안내 표 생성
        function createReservationTable(response) {
            const table = `
                <div style="background: #f8f9fa; border-radius: 10px; padding: 15px; margin: 10px 0;">
                    <h4 style="color: #2c3e50; margin-bottom: 15px;">📞 예약 및 상담 안내</h4>
                    <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #ff69b4 0%, #ff1493 100%); color: white;">
                                <th style="padding: 12px; text-align: center; border: none;">구분</th>
                                <th style="padding: 12px; text-align: center; border: none;">내용</th>
                                <th style="padding: 12px; text-align: center; border: none;">연락처</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 12px; text-align: center; font-weight: bold; color: #2c3e50;">일반 예약</td>
                                <td style="padding: 12px; text-align: center;">진료시간 내 전화 예약</td>
                                <td style="padding: 12px; text-align: center; color: #27ae60;">070-1234-1234</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 12px; text-align: center; font-weight: bold; color: #2c3e50;">응급 상담</td>
                                <td style="padding: 12px; text-align: center;">24시간 응급 상담</td>
                                <td style="padding: 12px; text-align: center; color: #e74c3c;">070-1234-1234</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 12px; text-align: center; font-weight: bold; color: #2c3e50;">온라인 예약</td>
                                <td style="padding: 12px; text-align: center;">24시간 온라인 예약 가능</td>
                                <td style="padding: 12px; text-align: center; color: #3498db;">예약 페이지</td>
                            </tr>
                            <tr>
                                <td style="padding: 12px; text-align: center; font-weight: bold; color: #2c3e50;">상담 문의</td>
                                <td style="padding: 12px; text-align: center;">치료 방법 및 비용 상담</td>
                                <td style="padding: 12px; text-align: center; color: #9b59b6;">무료 상담</td>
                            </tr>
                        </tbody>
                    </table>
                    <div style="margin-top: 15px; padding: 10px; background: #e8f5e8; border-radius: 6px; border-left: 4px solid #27ae60;">
                        <strong>💡 안내사항:</strong> 예약 시 본인 확인을 위해 생년월일과 전화번호를 준비해주세요!
                    </div>
                </div>
            `;
            
            return table;
        }

        // 오시는길 표 생성
        function createDirectionsTable(response) {
            const table = `
                <div style="background: #f8f9fa; border-radius: 10px; padding: 15px; margin: 10px 0;">
                    <h4 style="color: #2c3e50; margin-bottom: 15px;">🗺️ 오시는길 안내</h4>
                    <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%); color: white;">
                                <th style="padding: 12px; text-align: center; border: none;">구분</th>
                                <th style="padding: 12px; text-align: center; border: none;">내용</th>
                                <th style="padding: 12px; text-align: center; border: none;">소요시간</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 12px; text-align: center; font-weight: bold; color: #2c3e50;">주소</td>
                                <td style="padding: 12px; text-align: center;">피닉스시 피닉스로 11길 11<br>피닉스타워 11층 11호</td>
                                <td style="padding: 12px; text-align: center; color: #27ae60;">-</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 12px; text-align: center; font-weight: bold; color: #2c3e50;">지하철</td>
                                <td style="padding: 12px; text-align: center;">지하철 2호선 강남역<br>3번 출구 도보</td>
                                <td style="padding: 12px; text-align: center; color: #3498db;">5분</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 12px; text-align: center; font-weight: bold; color: #2c3e50;">버스</td>
                                <td style="padding: 12px; text-align: center;">강남역 정류장 하차<br>도보 이동</td>
                                <td style="padding: 12px; text-align: center; color: #e67e22;">3분</td>
                            </tr>
                            <tr>
                                <td style="padding: 12px; text-align: center; font-weight: bold; color: #2c3e50;">주차</td>
                                <td style="padding: 12px; text-align: center;">건물 지하 1-3층<br>무료 주차 (3시간)</td>
                                <td style="padding: 12px; text-align: center; color: #9b59b6;">무료</td>
                            </tr>
                        </tbody>
                    </table>
                    <div style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 6px; border-left: 4px solid #2196f3;">
                        <strong>💡 안내사항:</strong> 주차는 건물 지하 1-3층에서 가능하며, 진료 후 3시간 무료 주차 서비스를 제공합니다!
                    </div>
                </div>
            `;
            
            return table;
        }

        // 일반 응답 구조화
        function structureGeneralResponse(response) {
            // 줄바꿈과 구조화
            let formattedResponse = response
                .replace(/\n\n/g, '<br><br>')
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // 리스트 형태로 변환
            formattedResponse = formattedResponse.replace(/(\d+\.|\-|\•)\s*(.*?)(?=<br>|$)/g, '<li style="margin: 5px 0; padding-left: 10px;">$2</li>');
            
            // 리스트가 있으면 ul 태그로 감싸기
            if (formattedResponse.includes('<li')) {
                formattedResponse = formattedResponse.replace(/(<li.*?<\/li>)/g, '<ul style="margin: 10px 0; padding-left: 20px;">$1</ul>');
            }
            
            return `
                <div style="background: #f8f9fa; border-radius: 10px; padding: 15px; margin: 10px 0; line-height: 1.6;">
                    ${formattedResponse}
                </div>
            `;
        }

        // 시뮬레이션된 AI 답변 생성 (개선된 버전)
        function generateSimulatedAIResponse(message, provider) {
            // FAQ 표 반환 로직 없이 자연스러운 텍스트 답변만!
            let response = '';
            if (message.includes('안녕하세요') || message.toLowerCase().includes('hello')) {
                response = '안녕하세요! 피닉스치과 AI 상담사입니다. 궁금한 점이 있으시면 언제든 말씀해 주세요 😊';
            } else {
                response = `피닉스치과 AI 상담사입니다. "${message}"에 대한 답변을 준비 중입니다. 진료, 예약, 비용, 위치 등 궁금한 점이 있으시면 언제든 문의주세요!`;
            }
            return response;
        }

        // 환영 메시지 추가 (초기 로드 시)
        function addWelcomeMessage() {
            const t = translations[currentLanguage] || translations['ko'];
            
            const welcomeMessage = `
                <div style="text-align: center; color: #333;">
                    <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px; color: #2c3e50;">
                        ${t.welcomeMessage}
                    </div>
                    <div style="font-size: 14px; color: #666; line-height: 1.5; margin-bottom: 20px;">
                        ${t.welcomeSubMessage}
                    </div>
                    <div class="quick-buttons" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-width: 300px; margin-left: auto; margin-right: auto;">
                        <button class="quick-button clinic-hours-btn" onclick="handleQuickMessage('진료시간 알려주세요')" ontouchstart="handleKakaoTouch('진료시간 알려주세요')" style="background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); color: #333; border: none; padding: 12px 8px; border-radius: 20px; font-size: 13px; font-weight: bold; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3); -webkit-tap-highlight-color: transparent;">🕘 진료시간</button>
                        <button class="quick-button treatment-cost-btn" onclick="handleQuickMessage('치료비용 궁금해요')" ontouchstart="handleKakaoTouch('치료비용 궁금해요')" style="background: linear-gradient(135deg, #1e88e5 0%, #42a5f5 100%); color: white; border: none; padding: 12px 8px; border-radius: 20px; font-size: 13px; font-weight: bold; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(30, 136, 229, 0.3); -webkit-tap-highlight-color: transparent;">💰 치료비용</button>
                        <button class="quick-button reservation-btn" onclick="handleQuickMessage('예약문의 하고싶어요')" ontouchstart="handleKakaoTouch('예약문의 하고싶어요')" style="background: linear-gradient(135deg, #ff69b4 0%, #ff1493 100%); color: white; border: none; padding: 12px 8px; border-radius: 20px; font-size: 13px; font-weight: bold; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(255, 105, 180, 0.3); -webkit-tap-highlight-color: transparent;">📞 예약문의</button>
                        <button class="quick-button directions-btn" onclick="handleQuickMessage('오시는길 알려주세요')" ontouchstart="handleKakaoTouch('오시는길 알려주세요')" style="background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%); color: white; border: none; padding: 12px 8px; border-radius: 20px; font-size: 13px; font-weight: bold; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3); -webkit-tap-highlight-color: transparent;">🗺️ 오시는길</button>
                    </div>
                </div>
            `;
            
            addBotMessage(welcomeMessage);
        }

        // 예약 페이지로 이동
        function goToReservationPage() {
            window.location.href = 'reservation.html';
        }

        // AI챗봇 관리자 페이지 열기 함수 (개선된 버전)
        function openChatbotAdmin2() {
            // 중복 실행 방지
            if (window.isLoggingIn) {
                console.log('로그인 진행 중 - 중복 실행 방지');
                return;
            }
            
            window.isLoggingIn = true;
            console.log('관리자 페이지 열기 함수 호출됨');
            
            try {
                // 아이디 입력
                const username = prompt("🔐 AI 챗봇 관리자 로그인\n\n아이디를 입력하세요:");
                
                // 취소 버튼 클릭 시
                if (username === null) {
                    console.log('로그인 취소됨');
                    window.isLoggingIn = false; // 취소 시 플래그 리셋
                    return;
                }
                
                // 아이디 검증
                if (username.trim() === "phoenix") {
                    // 비밀번호 입력
                    const password = prompt("비밀번호를 입력하세요:");
                    
                    // 취소 버튼 클릭 시
                    if (password === null) {
                        console.log('비밀번호 입력 취소됨');
                        window.isLoggingIn = false; // 취소 시 플래그 리셋
                        return;
                    }
                    
                    // 비밀번호 검증
                    if (password.trim() === "phoenix") {
                        console.log('✅ 로그인 성공 - 관리자 페이지 표시');
                        alert('✅ 로그인 성공!\n\nAI 챗봇 관리 페이지로 이동합니다.');
                        showChatbotAdmin2();
                        window.isLoggingIn = false; // 로그인 완료 후 플래그 리셋
                    } else {
                        console.log('❌ 비밀번호 오류:', password);
                        alert("❌ 비밀번호가 틀렸습니다.\n\n아이디: phoenix\n비밀번호: phoenix");
                        window.isLoggingIn = false; // 로그인 실패 후 플래그 리셋
                    }
                } else {
                    console.log('❌ 아이디 오류:', username);
                    alert("❌ 아이디가 틀렸습니다.\n\n아이디: phoenix\n비밀번호: phoenix");
                    window.isLoggingIn = false; // 로그인 실패 후 플래그 리셋
                }
            } catch (error) {
                console.error('관리자 페이지 열기 오류:', error);
                alert('❌ 관리자 페이지 열기에 실패했습니다.\n\n다시 시도해주세요.');
                window.isLoggingIn = false; // 오류 발생 후 플래그 리셋
            }
        }

        // AI챗봇 관리자 페이지 표시
        function showChatbotAdmin2() {
            console.log('관리자 페이지 표시 함수 호출됨');
            
            // 기존 관리자 페이지가 있으면 제거
            const existingAdmin = document.querySelector('div[style*="position: fixed"][style*="z-index: 10000"]');
            if (existingAdmin) {
                existingAdmin.remove();
            }
            
            const adminPage = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; justify-content: center; align-items: center;">
                    <div style="background: white; border-radius: 20px; width: 95%; max-width: 800px; max-height: 90vh; overflow-y: auto; padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px;">
                            <h2 style="color: #2c3e50; margin: 0;">🤖 AI 챗봇 관리 시스템</h2>
                            <button onclick="closeChatbotAdmin2()" style="background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: bold;">🏠 메인으로</button>
                        </div>
                        
                        <div id="chatbotAdmin2Content">
                            <!-- AI 모델 API 설정 -->
                            <div style="background: #f8f9fa; border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                                <h3 style="color: #2c3e50; margin-bottom: 15px;">🤖 챗봇 AI 모델 연결하기</h3>
                                
                                <!-- ChatGPT 설정 -->
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">ChatGPT API Key</label>
                                    <input type="password" id="chatgptApiKey2" placeholder="sk-proj-..." style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                                </div>
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">ChatGPT 모델선택</label>
                                    <select id="chatgptModel2" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                                        <option value="">-- ChatGPT 모델을 선택하세요 --</option>
                                        <option value="gpt-4o">GPT-4o (최신 멀티모달)</option>
                                        <option value="gpt-4o-mini">GPT-4o Mini (경제적)</option>
                                        <option value="finetuning">Finetuning Model (커스텀 모델)</option>
                                    </select>
                                </div>
                                <div id="chatgptFinetuningGroup2" style="display: none; margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">Finetuning 모델명 입력</label>
                                    <input type="text" id="chatgptFinetuningModel2" placeholder="ft:gpt-4o-mini-2024-07-18:..." style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                                </div>

                                <!-- Gemini 설정 -->
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">Gemini 모델 API Key</label>
                                    <input type="password" id="geminiApiKey2" placeholder="AIza..." style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                                </div>
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">Gemini 모델선택</label>
                                    <select id="geminiModel2" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                                        <option value="">-- Gemini 모델을 선택하세요 --</option>
                                        <option value="gemini-1.5-flash">Gemini 1.5 Flash (빠른 응답)</option>
                                        <option value="gemini-1.5-pro">Gemini 1.5 Pro (고성능)</option>
                                        <option value="gemini-1.0-pro">Gemini 1.0 Pro (안정성)</option>
                                    </select>
                                </div>

                                <!-- Claude 설정 -->
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">Claude 모델 API Key</label>
                                    <input type="password" id="claudeApiKey2" placeholder="sk-ant-..." style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                                </div>
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: bold;">Claude 모델선택</label>
                                    <select id="claudeModel2" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                                        <option value="">-- Claude 모델을 선택하세요 --</option>
                                        <option value="claude-3-haiku">Claude 3 Haiku (빠르고 효율적)</option>
                                        <option value="claude-3-sonnet">Claude 3 Sonnet (균형적 성능)</option>
                                        <option value="claude-3-opus">Claude 3 Opus (최고 성능)</option>
                                        <option value="claude-3-5-sonnet">Claude 3.5 Sonnet (최신 모델)</option>
                                    </select>
                                </div>

                                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px;">
                                    <button onclick="saveApiSettings2()" style="background: #28a745; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: bold;">💾 설정 저장</button>
                                    <button onclick="testApiConnection2()" style="background: #17a2b8; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: bold;">🔗 연결 테스트</button>
                                    <button onclick="resetApiSettings2()" style="background: #dc3545; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: bold;">🔄 설정 초기화</button>
                                </div>
                                <div id="apiStatus2" style="margin-top: 15px; padding: 10px; border-radius: 8px; display: none;"></div>
                            </div>

                            <!-- AI 지식 파일 업로드 -->
                            <div style="background: #f8f9fa; border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                                <h3 style="color: #2c3e50; margin-bottom: 15px;">📚 AI 지식 파일 업로드</h3>
                                
                                <div onclick="document.getElementById('fileInput2').click()" style="border: 2px dashed #ddd; border-radius: 10px; padding: 30px; text-align: center; cursor: pointer; background: white;">
                                    <div style="font-size: 48px; margin-bottom: 10px;">📁</div>
                                    <div style="font-weight: bold; margin-bottom: 5px;">클릭하거나 파일을 여기로 드래그하세요</div>
                                    <div style="color: #666; font-size: 14px;">💡 <strong>지원 형식: 텍스트 파일(.txt)</strong></div>
                                </div>
                                <input type="file" id="fileInput2" style="display: none;" accept=".txt" multiple>
                                
                                <div id="fileList2" style="margin-top: 15px;">
                                    <!-- 업로드된 파일들이 여기에 표시됩니다 -->
                                </div>
                                
                                <div id="knowledgeStatus2" style="margin-top: 15px; padding: 10px; background: #e9ecef; border-radius: 8px; font-size: 14px;">
                                    📖 업로드된 지식 파일: 0개 | 상태: 비활성
                                </div>
                                
                                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px;">
                                    <button onclick="saveKnowledgeSettings2()" style="background: #28a745; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: bold;">💾 지식 파일 설정 저장</button>
                                    <button onclick="testKnowledgeBase2()" style="background: #17a2b8; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: bold;">🔍 지식 검색 테스트</button>
                                    <button onclick="clearAllKnowledge2()" style="background: #dc3545; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: bold;">🗑️ 모든 지식 삭제</button>
                                </div>
                                <div id="knowledgeSettingsStatus2" style="margin-top: 10px; padding: 10px; border-radius: 8px; display: none;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', adminPage);
            
            // 저장된 API 설정 불러와서 입력 필드에 채우기
            setTimeout(() => {
                loadApiSettingsToForm();
                console.log('관리자 페이지 표시 완료');
            }, 100);
        }

        // 저장된 API 설정을 관리자 폼에 불러오기
        function loadApiSettingsToForm() {
            try {
                const savedSettings = localStorage.getItem('chatbotApiSettings');
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);
                    console.log('관리자 폼에 API 설정 불러오기:', settings);
                    
                    // ChatGPT 설정 불러오기
                    if (settings.chatgpt) {
                        const chatgptKeyInput = document.getElementById('chatgptApiKey2');
                        const chatgptModelSelect = document.getElementById('chatgptModel2');
                        
                        if (chatgptKeyInput && settings.chatgpt.apiKey) {
                            chatgptKeyInput.value = settings.chatgpt.apiKey;
                        }
                        if (chatgptModelSelect && settings.chatgpt.model) {
                            chatgptModelSelect.value = settings.chatgpt.model;
                        }
                    }
                    
                    // Gemini 설정 불러오기
                    if (settings.gemini) {
                        const geminiKeyInput = document.getElementById('geminiApiKey2');
                        const geminiModelSelect = document.getElementById('geminiModel2');
                        
                        if (geminiKeyInput && settings.gemini.apiKey) {
                            geminiKeyInput.value = settings.gemini.apiKey;
                        }
                        if (geminiModelSelect && settings.gemini.model) {
                            geminiModelSelect.value = settings.gemini.model;
                        }
                    }
                    
                    // Claude 설정 불러오기
                    if (settings.claude) {
                        const claudeKeyInput = document.getElementById('claudeApiKey2');
                        const claudeModelSelect = document.getElementById('claudeModel2');
                        
                        if (claudeKeyInput && settings.claude.apiKey) {
                            claudeKeyInput.value = settings.claude.apiKey;
                        }
                        if (claudeModelSelect && settings.claude.model) {
                            claudeModelSelect.value = settings.claude.model;
                        }
                    }
                    
                    console.log('API 설정이 관리자 폼에 성공적으로 로드되었습니다.');
                } else {
                    console.log('저장된 API 설정이 없습니다.');
                }
            } catch (error) {
                console.error('API 설정을 관리자 폼에 불러오기 실패:', error);
            }
        }

        // AI챗봇 관리자 페이지 닫기
        function closeChatbotAdmin2() {
            console.log('관리자 페이지 닫기 함수 호출됨');
            const adminPage = document.querySelector('div[style*="position: fixed"][style*="z-index: 10000"]');
            if (adminPage) {
                adminPage.remove();
                console.log('관리자 페이지 닫기 완료');
            } else {
                console.log('닫을 관리자 페이지를 찾을 수 없음');
            }
        }

        // API 설정 저장 (새로운 버전)
        function saveApiSettings2() {
            const chatgptKey = document.getElementById('chatgptApiKey2').value.trim();
            const chatgptModel = document.getElementById('chatgptModel2').value;
            const geminiKey = document.getElementById('geminiApiKey2').value.trim();
            const geminiModel = document.getElementById('geminiModel2').value;
            const claudeKey = document.getElementById('claudeApiKey2').value.trim();
            const claudeModel = document.getElementById('claudeModel2').value;
            
            if (!chatgptKey && !geminiKey && !claudeKey) {
                showStatus2('apiStatus2', '❌ 최소 하나의 API 키를 입력해주세요.', 'error');
                return;
            }
            
            // 설정 저장 (chatbotApiSettings 키로 저장하여 챗봇에서 사용할 수 있도록)
            const settings = {
                chatgpt: { apiKey: chatgptKey, model: chatgptModel, enabled: !!chatgptKey },
                gemini: { apiKey: geminiKey, model: geminiModel, enabled: !!geminiKey },
                claude: { apiKey: claudeKey, model: claudeModel, enabled: !!claudeKey },
                activeProvider: chatgptKey ? 'chatgpt' : (geminiKey ? 'gemini' : 'claude')
            };
            
            // 챗봇에서 사용할 수 있도록 chatbotApiSettings 키로 저장
            localStorage.setItem('chatbotApiSettings', JSON.stringify(settings));
            // 호환성을 위해 chatbotApiSettings2 키로도 저장
            localStorage.setItem('chatbotApiSettings2', JSON.stringify(settings));
            
            // 전역 변수에 설정 저장
            window.chatbotApiSettings = settings;
            
            console.log('💾 API 설정 저장 완료:');
            console.log('- 저장된 설정:', settings);
            console.log('- 활성화된 API:', {
                chatgpt: settings.chatgpt.enabled && settings.chatgpt.apiKey ? '활성' : '비활성',
                gemini: settings.gemini.enabled && settings.gemini.apiKey ? '활성' : '비활성',
                claude: settings.claude.enabled && settings.claude.apiKey ? '활성' : '비활성'
            });
            console.log('- 활성 제공자:', settings.activeProvider);
            
            // API 상태 표시 업데이트
            updateApiStatusDisplay(settings);
            
            showStatus2('apiStatus2', '✅ API 설정이 저장되었습니다! 이제 AI 챗봇을 사용할 수 있습니다.', 'success');
        }

        // API 연결 테스트 (새로운 버전)
        function testApiConnection2() {
            showStatus2('apiStatus2', '🔄 API 연결을 테스트하고 있습니다...', 'info');
            
            // 저장된 설정 가져오기
            const chatgptKey = document.getElementById('chatgptApiKey2').value.trim();
            const chatgptModel = document.getElementById('chatgptModel2').value;
            const geminiKey = document.getElementById('geminiApiKey2').value.trim();
            const geminiModel = document.getElementById('geminiModel2').value;
            const claudeKey = document.getElementById('claudeApiKey2').value.trim();
            const claudeModel = document.getElementById('claudeModel2').value;
            
            let testResults = [];
            let completedTests = 0;
            const totalTests = [chatgptKey, geminiKey, claudeKey].filter(key => key).length;
            
            if (totalTests === 0) {
                showStatus2('apiStatus2', '❌ 테스트할 API 키가 없습니다. API 키를 입력해주세요.', 'error');
                return;
            }
            
            // ChatGPT 테스트
            if (chatgptKey) {
                testChatGPTConnection(chatgptKey, chatgptModel || 'gpt-4o-mini')
                    .then(result => {
                        testResults.push(`ChatGPT: ${result}`);
                        completedTests++;
                        checkAllTestsComplete();
                    })
                    .catch(error => {
                        testResults.push(`ChatGPT: ❌ 실패 - ${error.message}`);
                        completedTests++;
                        checkAllTestsComplete();
                    });
            }
            
            // Gemini 테스트
            if (geminiKey) {
                testGeminiConnection(geminiKey, geminiModel || 'gemini-1.5-flash')
                    .then(result => {
                        testResults.push(`Gemini: ${result}`);
                        completedTests++;
                        checkAllTestsComplete();
                    })
                    .catch(error => {
                        testResults.push(`Gemini: ❌ 실패 - ${error.message}`);
                        completedTests++;
                        checkAllTestsComplete();
                    });
            }
            
            // Claude 테스트
            if (claudeKey) {
                testClaudeConnection(claudeKey, claudeModel || 'claude-3-haiku-20240307')
                    .then(result => {
                        testResults.push(`Claude: ${result}`);
                        completedTests++;
                        checkAllTestsComplete();
                    })
                    .catch(error => {
                        testResults.push(`Claude: ❌ 실패 - ${error.message}`);
                        completedTests++;
                        checkAllTestsComplete();
                    });
            }
            
            function checkAllTestsComplete() {
                if (completedTests === totalTests) {
                    const successCount = testResults.filter(result => result.includes('✅')).length;
                    const statusMessage = testResults.join('\n');
                    
                    if (successCount === totalTests) {
                        showStatus2('apiStatus2', `✅ 모든 API 연결 테스트 완료!\n\n${statusMessage}`, 'success');
                    } else if (successCount > 0) {
                        showStatus2('apiStatus2', `⚠️ 일부 API 연결 테스트 완료\n\n${statusMessage}`, 'info');
                    } else {
                        showStatus2('apiStatus2', `❌ 모든 API 연결 테스트 실패\n\n${statusMessage}`, 'error');
                    }
                }
            }
        }

        // ChatGPT 연결 테스트
        function testChatGPTConnection(apiKey, model) {
            return new Promise((resolve, reject) => {
                const requestBody = {
                    model: model,
                    messages: [
                        {
                            role: "user",
                            content: "안녕하세요. 연결 테스트입니다."
                        }
                    ],
                    max_tokens: 50
                };

                fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify(requestBody)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    resolve('✅ 연결 성공');
                })
                .catch(error => {
                    reject(error);
                });
            });
        }

        // Gemini 연결 테스트
        function testGeminiConnection(apiKey, model) {
            return new Promise((resolve, reject) => {
                const requestBody = {
                    contents: [
                        {
                            parts: [
                                {
                                    text: "안녕하세요. 연결 테스트입니다."
                                }
                            ]
                        }
                    ],
                    generationConfig: {
                        maxOutputTokens: 50
                    }
                };

                fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    resolve('✅ 연결 성공');
                })
                .catch(error => {
                    reject(error);
                });
            });
        }

        // Claude 연결 테스트
        function testClaudeConnection(apiKey, model) {
            return new Promise((resolve, reject) => {
                const requestBody = {
                    model: model,
                    max_tokens: 50,
                    messages: [
                        {
                            role: "user",
                            content: "안녕하세요. 연결 테스트입니다."
                        }
                    ]
                };

                fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify(requestBody)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    resolve('✅ 연결 성공');
                })
                .catch(error => {
                    reject(error);
                });
            });
        }

        // API 설정 초기화 (새로운 버전)
        function resetApiSettings2() {
            if (confirm('모든 API 설정을 초기화하시겠습니까?')) {
                document.getElementById('chatgptApiKey2').value = '';
                document.getElementById('chatgptModel2').value = '';
                document.getElementById('geminiApiKey2').value = '';
                document.getElementById('geminiModel2').value = '';
                document.getElementById('claudeApiKey2').value = '';
                document.getElementById('claudeModel2').value = '';
                
                // 챗봇에서 사용하는 설정도 함께 삭제
                localStorage.removeItem('chatbotApiSettings');
                localStorage.removeItem('chatbotApiSettings2');
                
                // 전역 변수도 초기화
                window.chatbotApiSettings = null;
                
                // API 상태 표시 업데이트
                updateApiStatusDisplay(null);
                
                showStatus2('apiStatus2', '🔄 모든 API 설정이 초기화되었습니다.', 'success');
            }
        }

        // 지식 파일 설정 저장 (새로운 버전)
        function saveKnowledgeSettings2() {
            // 파일 업로드 이벤트 리스너 설정
            const fileInput = document.getElementById('fileInput2');
            if (fileInput) {
                fileInput.addEventListener('change', handleFileUpload2);
            }
            
            // 드래그 앤 드롭 이벤트 설정
            const dropZone = document.querySelector('div[onclick="document.getElementById(\'fileInput2\').click()"]');
            if (dropZone) {
                dropZone.addEventListener('dragover', handleDragOver2);
                dropZone.addEventListener('drop', handleDrop2);
            }
            
            showStatus2('knowledgeSettingsStatus2', '✅ 지식 파일 설정이 저장되었습니다!', 'success');
        }

        // 파일 업로드 처리
        function handleFileUpload2(event) {
            const files = event.target.files;
            processFiles2(files);
        }

        // 드래그 앤 드롭 처리
        function handleDragOver2(event) {
            event.preventDefault();
            event.currentTarget.style.borderColor = '#4facfe';
            event.currentTarget.style.background = '#f0f8ff';
        }

        function handleDrop2(event) {
            event.preventDefault();
            event.currentTarget.style.borderColor = '#ddd';
            event.currentTarget.style.background = 'white';
            
            const files = event.dataTransfer.files;
            processFiles2(files);
        }

        // 파일 처리
        function processFiles2(files) {
            knowledgeBase.files = [];
            knowledgeBase.parsedData = [];
            
            Array.from(files).forEach(file => {
                if (file.type === 'text/plain' || file.name.endsWith('.txt')) {
                    knowledgeBase.files.push(file);
                    parseFileContent2(file);
                }
            });
            
            updateFileList2();
            updateKnowledgeStatus2();
        }

        // 파일 내용 파싱
        function parseFileContent2(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const lines = content.split('\n').filter(line => line.trim());
                
                for (let i = 0; i < lines.length - 1; i += 2) {
                    const question = lines[i].trim();
                    const answer = lines[i + 1].trim();
                    
                    if (question && answer) {
                        knowledgeBase.parsedData.push({
                            question: question,
                            answer: answer
                        });
                    }
                }
                
                console.log(`📚 파일 "${file.name}" 파싱 완료: ${knowledgeBase.parsedData.length}개 Q&A`);
                updateKnowledgeStatus2();
                
                // 지식베이스 설정 저장
                saveKnowledgeBaseSettings();
            };
            reader.readAsText(file);
        }

        // 파일 목록 업데이트
        function updateFileList2() {
            const fileList = document.getElementById('fileList2');
            if (!fileList) return;
            
            fileList.innerHTML = '';
            
            knowledgeBase.files.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.style.cssText = 'background: #f8f9fa; padding: 10px; margin: 5px 0; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;';
                
                // 파일 크기 계산 (실제 파일 객체가 없는 경우 size 속성 사용)
                const fileSize = file.size ? (file.size / 1024).toFixed(1) : 'N/A';
                
                fileItem.innerHTML = `
                    <span>📄 ${file.name} (${fileSize}KB)</span>
                    <button onclick="removeFile2(${index})" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">삭제</button>
                `;
                fileList.appendChild(fileItem);
            });
        }

        // 파일 삭제
        function removeFile2(index) {
            knowledgeBase.files.splice(index, 1);
            knowledgeBase.parsedData = [];
            
            // 남은 파일들 재파싱
            knowledgeBase.files.forEach(file => {
                parseFileContent2(file);
            });
            
            updateFileList2();
            updateKnowledgeStatus2();
            
            // 지식베이스 설정 저장
            saveKnowledgeBaseSettings();
        }

        // 지식베이스 상태 업데이트
        function updateKnowledgeStatus2() {
            const statusElement = document.getElementById('knowledgeStatus2');
            if (!statusElement) return;
            
            if (knowledgeBase.files.length > 0 && knowledgeBase.parsedData.length > 0) {
                knowledgeBase.enabled = true;
                statusElement.innerHTML = `📖 업로드된 지식 파일: ${knowledgeBase.files.length}개 | 상태: 활성 | Q&A: ${knowledgeBase.parsedData.length}개`;
                statusElement.style.background = '#d4edda';
                statusElement.style.color = '#155724';
                statusElement.style.border = '1px solid #c3e6cb';
            } else {
                knowledgeBase.enabled = false;
                statusElement.innerHTML = '📖 업로드된 지식 파일: 0개 | 상태: 비활성';
                statusElement.style.background = '#e9ecef';
                statusElement.style.color = '#6c757d';
                statusElement.style.border = '1px solid #dee2e6';
            }
            
            // 지식베이스 설정 저장
            saveKnowledgeBaseSettings();
        }

        // 지식 검색 테스트 (새로운 버전)
        function testKnowledgeBase2() {
            if (!knowledgeBase.enabled || knowledgeBase.parsedData.length === 0) {
                showStatus2('knowledgeSettingsStatus2', '❌ 테스트할 지식 파일이 없습니다.', 'error');
                return;
            }
            
            showStatus2('knowledgeSettingsStatus2', '🔍 지식 검색 테스트를 실행하고 있습니다...', 'info');
            
            // 테스트 쿼리들
            const testQueries = ['진료시간', '예약', '비용', '위치'];
            let successCount = 0;
            let testResults = [];
            
            testQueries.forEach(query => {
                const result = searchInKnowledgeBase(query);
                if (result) {
                    testResults.push(`✅ "${query}" - 답변 발견`);
                    successCount++;
                } else {
                    testResults.push(`❌ "${query}" - 답변 없음`);
                }
            });
            
            setTimeout(() => {
                const message = testResults.join('\n') + `\n\n📊 테스트 결과: ${successCount}/${testQueries.length} 성공`;
                showStatus2('knowledgeSettingsStatus2', message, successCount > 0 ? 'success' : 'error');
            }, 1500);
        }

        // 모든 지식 삭제 (새로운 버전)
        function clearAllKnowledge2() {
            if (confirm('모든 지식 파일을 삭제하시겠습니까?')) {
                knowledgeBase.files = [];
                knowledgeBase.parsedData = [];
                knowledgeBase.enabled = false;
                
                updateFileList2();
                updateKnowledgeStatus2();
                
                // 지식베이스 설정 저장
                saveKnowledgeBaseSettings();
                
                showStatus2('knowledgeSettingsStatus2', '🗑️ 모든 지식 파일이 삭제되었습니다.', 'success');
            }
        }

        // 상태 메시지 표시 (새로운 버전)
        function showStatus2(elementId, message, type) {
            const statusElement = document.getElementById(elementId);
            statusElement.textContent = message;
            statusElement.style.display = 'block';
            
            // 타입에 따른 색상 설정
            if (type === 'success') {
                statusElement.style.background = '#d4edda';
                statusElement.style.color = '#155724';
                statusElement.style.border = '1px solid #c3e6cb';
            } else if (type === 'error') {
                statusElement.style.background = '#f8d7da';
                statusElement.style.color = '#721c24';
                statusElement.style.border = '1px solid #f5c6cb';
            } else if (type === 'info') {
                statusElement.style.background = '#d1ecf1';
                statusElement.style.color = '#0c5460';
                statusElement.style.border = '1px solid #bee5eb';
            }
            
            // 3초 후 자동 숨김
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 3000);
        }

        // 채팅 기록 삭제
        function clearChatHistory() {
            if (confirm('모든 채팅 기록을 삭제하시겠습니까?')) {
                const messagesContainer = document.getElementById('chatbotMessages');
                messagesContainer.innerHTML = '';
                
                // 환영 메시지 다시 추가
                setTimeout(() => {
                    addWelcomeMessage();
                }, 500);
                
                addBotMessage('🗑️ 채팅 기록이 삭제되었습니다.');
            }
        }

        // 챗봇 재시작
        function reloadChatbot() {
            if (confirm('챗봇을 재시작하시겠습니까?')) {
                location.reload();
            }
        }

        // 언어 설정 함수 (호환성)
        function setLanguage(language) {
            selectLanguage(language);
        }

        // 추가 모바일 기기 호환성 강화
        function enhanceMobileCompatibility() {
            // 아이폰11, 아이폰 미니, Galaxy XCover 5 특별 최적화
            const userAgent = navigator.userAgent;
            const isKakaoTalk = userAgent.includes('KAKAO');
            
            // 터치 이벤트 완전 재구성 (모든 기기)
            function setupEnhancedTouchEvents() {
                const allButtons = document.querySelectorAll('button, .language-current, .language-option, .back-link');
                
                allButtons.forEach(element => {
                    // 기본 터치 설정
                    element.style.setProperty('-webkit-tap-highlight-color', 'transparent', 'important');
                    element.style.setProperty('touch-action', 'manipulation', 'important');
                    element.style.setProperty('-webkit-user-select', 'none', 'important');
                    element.style.setProperty('user-select', 'none', 'important');
                    element.style.setProperty('cursor', 'pointer', 'important');
                    
                    // 터치 이벤트 강화
                    element.addEventListener('touchstart', function(e) {
                        this.style.opacity = '0.8';
                        this.style.transform = 'scale(0.98)';
                    }, { passive: true });
                    
                    element.addEventListener('touchend', function(e) {
                        this.style.opacity = '';
                        this.style.transform = '';
                    }, { passive: true });
                    
                    element.addEventListener('touchcancel', function(e) {
                        this.style.opacity = '';
                        this.style.transform = '';
                    }, { passive: true });
                });
            }
            
            // 카카오톡 브라우저 특별 처리
            if (isKakaoTalk) {
                console.log('카카오톡 브라우저 완전 최적화 적용');
                
                // 페이지 로드 후 다중 적용
                setTimeout(() => {
                    setupEnhancedTouchEvents();
                }, 500);
                
                setTimeout(() => {
                    setupEnhancedTouchEvents();
                }, 1500);
                
                setTimeout(() => {
                    setupEnhancedTouchEvents();
                }, 3000);
                
                // 페이지 포커스 시 재적용
                window.addEventListener('focus', function() {
                    setTimeout(setupEnhancedTouchEvents, 200);
                });
                
                window.addEventListener('pageshow', function() {
                    setTimeout(setupEnhancedTouchEvents, 200);
                });
            }
            
            // 기기별 특화 최적화
            if (userAgent.includes('iPhone')) {
                console.log('아이폰 특화 최적화 적용');
                document.body.classList.add('device-iphone');
                
                // iOS 뷰포트 문제 해결
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
                
                window.addEventListener('resize', function() {
                    const vh = window.innerHeight * 0.01;
                    document.documentElement.style.setProperty('--vh', `${vh}px`);
                });
            }
            
            if (userAgent.includes('Android')) {
                console.log('안드로이드 특화 최적화 적용');
                document.body.classList.add('device-android');
            }
            
            // 일반 모바일 기기 최적화
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent);
            if (isMobile) {
                document.body.classList.add('mobile-device');
                setupEnhancedTouchEvents();
            }
        }

        // API 설정 불러오기 함수
        function loadApiSettings() {
            try {
                const savedSettings = localStorage.getItem('chatbotApiSettings');
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);
                    window.chatbotApiSettings = settings;
                    console.log('API 설정 로드 완료:', settings);
                    
                    // API 설정 상태 표시
                    updateApiStatusDisplay(settings);
                } else {
                    console.log('저장된 API 설정이 없습니다.');
                    updateApiStatusDisplay(null);
                }
            } catch (error) {
                console.error('API 설정 로드 실패:', error);
                updateApiStatusDisplay(null);
            }
        }

        // API 상태 표시 업데이트
        function updateApiStatusDisplay(settings) {
            const apiStatus = document.getElementById('apiStatus');
            if (!apiStatus) return;
            
            if (settings && (settings.chatgpt?.enabled || settings.gemini?.enabled || settings.claude?.enabled)) {
                // 활성화된 API 개수 계산
                const activeApis = [
                    settings.chatgpt?.enabled ? 'ChatGPT' : null,
                    settings.gemini?.enabled ? 'Gemini' : null,
                    settings.claude?.enabled ? 'Claude' : null
                ].filter(Boolean);
                
                apiStatus.textContent = `✅ AI API (${activeApis.join(', ')})`;
                apiStatus.style.background = '#d4edda';
                apiStatus.style.color = '#155724';
                apiStatus.style.border = '1px solid #c3e6cb';
                apiStatus.title = `활성화된 AI 모델: ${activeApis.join(', ')}`;
            } else {
                apiStatus.textContent = '❌ AI API 설정 안됨';
                apiStatus.style.background = '#f8f9fa';
                apiStatus.style.color = '#6c757d';
                apiStatus.style.border = '1px solid #dee2e6';
                apiStatus.title = 'AI 관리자에서 API 키를 설정해주세요';
            }
        }

        // 페이지 로드 완료 후 추가 최적화 적용
        window.addEventListener('DOMContentLoaded', function() {
            enhanceMobileCompatibility();
            loadApiSettings(); // API 설정 불러오기
        });

        window.addEventListener('load', function() {
            enhanceMobileCompatibility();
            loadApiSettings(); // API 설정 불러오기
        });

        setupKakaoTalkOptimization();
        
        console.log('별도창 AI챗봇 초기화 완료 - 카카오톡 브라우저 메뉴 클릭 문제 해결, 모든 모바일 기기 완벽 지원');
        // 페이지 포커스 복귀 시 최적화 재적용 (카카오톡 브라우저 대응)
        window.addEventListener('pageshow', function(e) {
            if (e.persisted) {
                setTimeout(() => {
                    applyMobileDeviceOptimizations();
                }, 100);
            }
        });

        // 뷰포트 변경 감지 (모바일 브라우저 대응)
        window.addEventListener('orientationchange', function() {
            setTimeout(() => {
                setViewportHeight();
                applyMobileDeviceOptimizations();
            }, 300);
        });

        console.log('🚀 별도창 AI챗봇 페이지 로드 완료 - 모든 모바일 기기 및 카카오톡 브라우저 완벽 지원');
    </script>
</body>
</html> 