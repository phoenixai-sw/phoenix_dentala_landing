<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>피닉스 치과 AI 상담사</title>
    
    <!-- 카카오톡 인앱 브라우저 캐시 방지 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="format-detection" content="telephone=no">
    <meta name="format-detection" content="address=no">
    <meta name="format-detection" content="email=no">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f2f5;
            height: 100vh;
            overflow: hidden;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }

        .chatbot-main {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: white;
            position: relative;
        }

        /* 헤더 */
        .chatbot-header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 18px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
            flex-shrink: 0;
            order: 1;
        }

        .chatbot-title {
            font-size: 22px;
            font-weight: bold;
            margin: 0;
        }

        .back-link {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            width: 68px;
            height: 75px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            transition: all 0.3s ease;
            padding: 4px;
            text-decoration: none;
        }

        .back-link:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-50%) scale(1.1);
        }

        .home-icon {
            font-size: 27px;
            line-height: 1;
        }

        .home-arrow {
            font-size: 17px;
            line-height: 1;
            margin-top: 3px;
        }

        /* 우측 상단 언어 선택 드롭다운 */
        .header-language-dropdown {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 2000;
        }

        .language-dropdown {
            position: relative;
            display: inline-block;
        }

        .language-current {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 120px;
            justify-content: center;
        }

        .language-current:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .language-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 3000;
            display: none;
            min-width: 140px;
            margin-top: 5px;
        }

        .language-menu.show {
            display: block;
        }

        .language-option {
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 1px solid #eee;
            font-size: 14px;
            color: #333;
        }

        .language-option:last-child {
            border-bottom: none;
        }

        .language-option:hover {
            background: #f8f9fa;
        }

        .language-option.active {
            background: #4facfe;
            color: white;
        }

        /* 메시지 영역 */
        .chatbot-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
            -webkit-overflow-scrolling: touch;
            order: 2;
            margin-bottom: 80px; /* 입력창 공간 확보 */
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .message.bot .message-avatar {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .message.user .message-avatar {
            background: #e9ecef;
            color: #495057;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.4;
            font-size: 14px;
        }

        .message.bot .message-content {
            background: white;
            color: #333;
            border-bottom-left-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .message.user .message-content {
            background: #4facfe;
            color: white;
            border-bottom-right-radius: 6px;
        }

        /* 빠른 버튼 */
        .quick-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .quick-button {
            background: #f0f8ff;
            color: #4facfe;
            border: 1px solid #4facfe;
            border-radius: 15px;
            padding: 8px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            touch-action: manipulation;
        }

        .quick-button:hover {
            background: #4facfe;
            color: white;
        }

        /* 입력 영역 - 화면 하단 고정 */
        .chatbot-input {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #ddd;
            padding: 15px;
            display: flex;
            gap: 10px;
            align-items: flex-end;
            z-index: 1000;
            order: 3;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .chatbot-input textarea {
            flex: 1;
            border: 2px solid #4facfe;
            border-radius: 20px;
            padding: 12px 16px;
            font-size: 16px;
            resize: none;
            outline: none;
            min-height: 45px;
            max-height: 120px;
            line-height: 1.4;
            -webkit-user-select: text;
            user-select: text;
            touch-action: manipulation;
        }

        .chatbot-input textarea:focus {
            border-color: #00f2fe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.2);
        }

        .chatbot-send {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 108px;
            height: 45px;
            touch-action: manipulation;
        }

        .chatbot-send:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
        }

        .chatbot-send:active {
            transform: translateY(0);
        }

        /* 반응형 디자인 - 모바일 최적화 */
        @media (max-width: 768px) {
            .chatbot-header {
                padding: 15px 8px;
            }
            
            .chatbot-title {
                font-size: 18px;
                margin: 0 120px; /* 좌우 버튼 공간 확보 */
            }
            
            .back-link {
                width: 52px;
                height: 58px;
                left: 8px;
            }
            
            .home-icon {
                font-size: 22px;
            }
            
            .home-arrow {
                font-size: 14px;
            }
            
            .header-language-dropdown {
                right: 8px;
            }
            
            .language-current {
                padding: 8px 12px;
                font-size: 12px;
                min-width: 100px;
            }
            
            .chatbot-messages {
                padding: 15px;
                margin-bottom: 75px;
            }
            
            .chatbot-input {
                padding: 10px;
            }
            
            .chatbot-send {
                min-width: 80px;
                padding: 10px 20px;
                font-size: 14px;
            }
        }

        @media (max-width: 480px) {
            .chatbot-header {
                padding: 12px 5px;
            }
            
            .chatbot-title {
                font-size: 16px;
                margin: 0 100px;
            }
            
            .back-link {
                width: 45px;
                height: 50px;
                left: 5px;
            }
            
            .home-icon {
                font-size: 20px;
            }
            
            .home-arrow {
                font-size: 12px;
            }
            
            .header-language-dropdown {
                right: 5px;
            }
            
            .language-current {
                padding: 6px 10px;
                font-size: 11px;
                min-width: 85px;
            }
            
            .chatbot-messages {
                padding: 10px;
                margin-bottom: 70px;
            }
            
            .chatbot-input {
                padding: 8px;
            }
            
            .chatbot-send {
                min-width: 70px;
                padding: 8px 16px;
                font-size: 13px;
            }
        }

        /* Galaxy XCover 5 특별 최적화 */
        @media screen and (max-width: 432px) and (max-height: 900px) {
            .chatbot-header {
                padding: 10px 5px;
            }
            
            .chatbot-title {
                font-size: 15px;
                margin: 0 90px;
            }
            
            .back-link {
                width: 40px;
                height: 45px;
                left: 5px;
            }
            
            .home-icon {
                font-size: 18px;
            }
            
            .home-arrow {
                font-size: 10px;
            }
            
            .header-language-dropdown {
                right: 5px;
            }
            
            .language-current {
                padding: 5px 8px;
                font-size: 10px;
                min-width: 75px;
            }
            
            .chatbot-messages {
                padding: 8px;
                margin-bottom: 65px;
            }
            
            .chatbot-input {
                padding: 6px;
            }
            
            .chatbot-input textarea {
                font-size: 14px;
                padding: 10px 12px;
            }
            
            .chatbot-send {
                min-width: 60px;
                padding: 6px 12px;
                font-size: 12px;
            }
        }

        /* 아이폰 미니 특별 최적화 */
        @media screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) {
            .chatbot-header {
                padding: 12px 5px;
            }
            
            .chatbot-title {
                font-size: 16px;
                margin: 0 95px;
            }
            
            .header-language-dropdown {
                right: 5px;
            }
            
            .language-current {
                padding: 6px 10px;
                font-size: 11px;
                min-width: 80px;
            }
            
            .chatbot-messages {
                margin-bottom: 70px;
            }
        }

        /* 카카오톡 브라우저 특별 최적화 */
        .kakao-optimized {
            -webkit-overflow-scrolling: touch;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }
    </style>
</head>
<body>
    <div class="chatbot-main">
        <!-- 헤더 -->
        <div class="chatbot-header">
            <a href="index.html" class="back-link">
                <span class="home-icon">🏠</span>
                <span class="home-arrow">←</span>
            </a>
            <h1 class="chatbot-title">피닉스 치과 AI 상담사👩‍⚕️</h1>
            
            <!-- 우측 상단 언어 선택 드롭다운 -->
            <div class="header-language-dropdown">
                <div class="language-dropdown">
                    <button class="language-current" onclick="toggleLanguageDropdown()">
                        <span id="currentLanguageText">🇰🇷 한국어</span>
                        <span>▼</span>
                    </button>
                    <div class="language-menu" id="languageMenu">
                        <div class="language-option active" onclick="selectLanguage('ko')">🇰🇷 한국어</div>
                        <div class="language-option" onclick="selectLanguage('en')">🇺🇸 영어</div>
                        <div class="language-option" onclick="selectLanguage('ru')">🇷🇺 러시아어</div>
                        <div class="language-option" onclick="selectLanguage('ja')">🇯🇵 일본어</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 메시지 영역 -->
        <div class="chatbot-messages" id="chatbotMessages">
            <!-- 메시지들이 여기에 추가됩니다 -->
        </div>

        <!-- 입력 영역 -->
        <div class="chatbot-input">
            <textarea id="chatbotInput" placeholder="메시지를 입력하세요... (Shift+Enter: 전송)" rows="1"></textarea>
            <button class="chatbot-send" onclick="sendMessage()">전송</button>
        </div>
    </div>

    <script>
        console.log('🚀 별도창 AI챗봇 페이지 로드 시작');

        // 전역 변수
        let currentLanguage = 'ko';
        let apiSettings = {
            chatgpt: { apiKey: '', model: '', enabled: false },
            gemini: { apiKey: '', model: '', enabled: false },
            claude: { apiKey: '', model: '', enabled: false },
            activeProvider: ''
        };

        // 언어별 텍스트
        const translations = {
            ko: {
                title: '피닉스 치과 AI 상담사👩‍⚕️',
                placeholder: '메시지를 입력하세요... (Shift+Enter: 전송)',
                sendButton: '전송',
                currentLanguage: '🇰🇷 한국어',
                welcomeMessage: '안녕하세요~ 피닉스 치과 AI상담사 입니다.',
                clinicHours: `🕘 <strong>피닉스 치과 진료시간 안내</strong><br><br>
                    📅 <strong>평일:</strong> 09:00 ~ 18:00<br>
                    📅 <strong>토요일:</strong> 09:00 ~ 15:00<br>
                    🍽️ <strong>점심시간:</strong> 12:30 ~ 13:30<br>
                    🚫 <strong>휴진:</strong> 일요일, 공휴일<br><br>
                    📞 <strong>예약 문의:</strong> 070-1234-1234`,
                treatmentCost: `💰 <strong>피닉스 치과 치료비용 안내</strong><br><br>
                    🦷 <strong>일반 진료:</strong> 상담 후 안내<br>
                    🦷 <strong>스케일링:</strong> 30,000원 ~ 50,000원<br>
                    🦷 <strong>임플란트:</strong> 상담 후 개별 견적<br>
                    🦷 <strong>교정:</strong> 상담 후 개별 견적<br><br>
                    💡 <strong>정확한 비용은 진료 후 안내드립니다!</strong>`
            },
            en: {
                title: 'Phoenix Dental AI Consultant👩‍⚕️',
                placeholder: 'Enter your message... (Shift+Enter: Send)',
                sendButton: 'Send',
                currentLanguage: '🇺🇸 영어',
                welcomeMessage: 'Hello~ I am Phoenix Dental AI consultant.',
                clinicHours: `🕘 <strong>Phoenix Dental Clinic Hours</strong><br><br>
                    📅 <strong>Weekdays:</strong> 09:00 ~ 18:00<br>
                    📅 <strong>Saturday:</strong> 09:00 ~ 15:00<br>
                    🍽️ <strong>Lunch Break:</strong> 12:30 ~ 13:30<br>
                    🚫 <strong>Closed:</strong> Sunday, Holidays<br><br>
                    📞 <strong>Reservation:</strong> 070-1234-1234`,
                treatmentCost: `💰 <strong>Phoenix Dental Treatment Costs</strong><br><br>
                    🦷 <strong>General Treatment:</strong> Consultation required<br>
                    🦷 <strong>Scaling:</strong> 30,000 ~ 50,000 KRW<br>
                    🦷 <strong>Implant:</strong> Individual estimate after consultation<br>
                    🦷 <strong>Orthodontics:</strong> Individual estimate after consultation<br><br>
                    💡 <strong>Exact costs will be provided after examination!</strong>`
            },
            ru: {
                title: 'Консультант ИИ стоматологии Phoenix👩‍⚕️',
                placeholder: 'Введите ваше сообщение... (Shift+Enter: Отправить)',
                sendButton: 'Отправить',
                currentLanguage: '🇷🇺 러시아어',
                welcomeMessage: 'Здравствуйте~ Я консультант ИИ стоматологии Phoenix.',
                clinicHours: `🕘 <strong>Часы работы стоматологии Phoenix</strong><br><br>
                    📅 <strong>Будни:</strong> 09:00 ~ 18:00<br>
                    📅 <strong>Суббота:</strong> 09:00 ~ 15:00<br>
                    🍽️ <strong>Обед:</strong> 12:30 ~ 13:30<br>
                    🚫 <strong>Выходные:</strong> Воскресенье, праздники<br><br>
                    📞 <strong>Запись:</strong> 070-1234-1234`,
                treatmentCost: `💰 <strong>Стоимость лечения в стоматологии Phoenix</strong><br><br>
                    🦷 <strong>Общее лечение:</strong> Требуется консультация<br>
                    🦷 <strong>Чистка:</strong> 30,000 ~ 50,000 вон<br>
                    🦷 <strong>Имплант:</strong> Индивидуальная оценка после консультации<br>
                    🦷 <strong>Ортодонтия:</strong> Индивидуальная оценка после консультации<br><br>
                    💡 <strong>Точная стоимость будет предоставлена после обследования!</strong>`
            },
            ja: {
                title: 'フェニックス歯科AIコンサルタント👩‍⚕️',
                placeholder: 'メッセージを入力してください... (Shift+Enter: 送信)',
                sendButton: '送信',
                currentLanguage: '🇯🇵 일본어',
                welcomeMessage: 'こんにちは〜フェニックス歯科AIコンサルタントです。',
                clinicHours: `🕘 <strong>フェニックス歯科診療時間案内</strong><br><br>
                    📅 <strong>平日:</strong> 09:00 ~ 18:00<br>
                    📅 <strong>土曜日:</strong> 09:00 ~ 15:00<br>
                    🍽️ <strong>昼休み:</strong> 12:30 ~ 13:30<br>
                    🚫 <strong>休診:</strong> 日曜日、祝日<br><br>
                    📞 <strong>予約問い合わせ:</strong> 070-1234-1234`,
                treatmentCost: `💰 <strong>フェニックス歯科治療費案内</strong><br><br>
                    🦷 <strong>一般診療:</strong> 相談後ご案内<br>
                    🦷 <strong>スケーリング:</strong> 30,000円 ~ 50,000円<br>
                    🦷 <strong>インプラント:</strong> 相談後個別見積もり<br>
                    🦷 <strong>矯正:</strong> 相談後個別見積もり<br><br>
                    💡 <strong>正確な費用は診療後にご案内いたします！</strong>`
            }
        };

        // 초기화
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM 로드 완료');
            
            // 카카오톡 브라우저 감지 및 최적화
            optimizeForKakaoTalk();
            
            // 환영 메시지 및 빠른 버튼 추가
            setTimeout(() => {
                addWelcomeMessage();
                setupEventListeners();
                setupTextareaResize();
            }, 200);
        });

        // 카카오톡 브라우저 최적화
        function optimizeForKakaoTalk() {
            const userAgent = navigator.userAgent;
            const isKakaoTalk = userAgent.includes('KAKAOTALK') || userAgent.includes('KAKAO');
            const isGalaxyXCover5 = userAgent.includes('SM-G525N') || 
                                   (window.screen.width <= 432 && window.screen.height <= 900);
            const isIPhoneMini = /iPhone.*Mobile/.test(navigator.userAgent) && 
                               (window.screen.width === 375 && window.screen.height === 812);
            
            if (isKakaoTalk || isGalaxyXCover5 || isIPhoneMini) {
                document.body.classList.add('kakao-optimized');
                
                // 모든 요소에 터치 최적화 적용
                const elements = document.querySelectorAll('*');
                elements.forEach(el => {
                    el.style.touchAction = 'manipulation';
                    el.style.webkitTouchCallout = 'none';
                });
                
                // 입력창만 텍스트 선택 허용
                const textarea = document.getElementById('chatbotInput');
                if (textarea) {
                    textarea.style.webkitUserSelect = 'text';
                    textarea.style.userSelect = 'text';
                    textarea.style.touchAction = 'manipulation';
                }
                
                console.log('카카오톡/모바일 브라우저 최적화 완료');
            }
        }

        // 환영 메시지 추가
        function addWelcomeMessage() {
            const t = translations[currentLanguage] || translations['ko'];
            
            const welcomeMessage = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 18px; font-weight: bold; color: #2c3e50; margin-bottom: 15px;">
                        ${t.welcomeMessage}
                    </div>
                    <div style="font-size: 14px; color: #666; margin-bottom: 15px;">
                        무엇을 도와드릴까요? 아래 버튼을 클릭하거나 직접 메시지를 입력해주세요.
                    </div>
                </div>
                
                <div class="quick-buttons">
                    <button class="quick-button" onclick="sendQuickMessage('진료시간 알려주세요')">🕘 진료시간</button>
                    <button class="quick-button" onclick="sendQuickMessage('치료비용 궁금해요')">💰 치료비용</button>
                </div>
            `;
            
            addBotMessage(welcomeMessage);
        }

        // 모든 이벤트 리스너 설정
        function setupEventListeners() {
            console.log('이벤트 리스너 설정 시작');
            
            // 전송 버튼 클릭 이벤트
            const sendButton = document.querySelector('.chatbot-send');
            if (sendButton) {
                sendButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    sendMessage();
                });
            }

            // 입력창 키보드 이벤트
            const inputTextarea = document.getElementById('chatbotInput');
            if (inputTextarea) {
                inputTextarea.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }

            // 드롭다운 외부 클릭 이벤트
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.language-dropdown')) {
                    const menu = document.getElementById('languageMenu');
                    if (menu && menu.classList.contains('show')) {
                        menu.style.display = 'none';
                        menu.classList.remove('show');
                    }
                }
            });

            console.log('이벤트 리스너 설정 완료');
        }

        // 텍스트 영역 자동 크기 조정
        function setupTextareaResize() {
            const textarea = document.getElementById('chatbotInput');
            if (textarea) {
                textarea.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                });
            }
        }

        // 언어 드롭다운 토글
        function toggleLanguageDropdown() {
            const menu = document.getElementById('languageMenu');
            if (menu) {
                const isVisible = menu.classList.contains('show');
                
                if (isVisible) {
                    menu.style.display = 'none';
                    menu.classList.remove('show');
                } else {
                    menu.style.display = 'block';
                    menu.classList.add('show');
                }
            }
        }

        // 언어 선택
        function selectLanguage(language) {
            console.log('언어 선택:', language);
            
            currentLanguage = language;
            
            // UI 업데이트
            updateLanguageUI(language);
            
            // 드롭다운 메뉴 닫기
            const menu = document.getElementById('languageMenu');
            if (menu) {
                menu.style.display = 'none';
                menu.classList.remove('show');
            }
            
            // 언어 변경 알림
            const changeMessages = {
                ko: '🇰🇷 한국어로 언어가 변경되었습니다!',
                en: '🇺🇸 Language changed to English!',
                ru: '🇷🇺 Язык изменен на русский!',
                ja: '🇯🇵 言語が日本語に変更されました！'
            };
            
            addBotMessage(changeMessages[language] || changeMessages['ko']);
        }

        // 언어 UI 업데이트
        function updateLanguageUI(language) {
            const t = translations[language] || translations['ko'];
            
            // 헤더 제목
            const title = document.querySelector('.chatbot-title');
            if (title) title.textContent = t.title;
            
            // 입력창 플레이스홀더
            const input = document.getElementById('chatbotInput');
            if (input) input.placeholder = t.placeholder;
            
            // 전송 버튼 텍스트
            const sendBtn = document.querySelector('.chatbot-send');
            if (sendBtn) sendBtn.textContent = t.sendButton;
            
            // 현재 언어 표시
            const currentLangText = document.getElementById('currentLanguageText');
            if (currentLangText) currentLangText.textContent = t.currentLanguage;
            
            // 드롭다운 옵션 업데이트
            const options = document.querySelectorAll('.language-option');
            options.forEach(option => {
                option.classList.remove('active');
                if (option.getAttribute('onclick').includes(`'${language}'`)) {
                    option.classList.add('active');
                }
            });
        }

        // 빠른 메시지 전송
        function sendQuickMessage(message) {
            console.log('빠른 메시지 전송:', message);
            
            // 사용자 메시지 추가
            addUserMessage(message);
            
            // AI 답변 생성
            generateResponse(message);
        }

        // 메시지 전송
        function sendMessage() {
            const input = document.getElementById('chatbotInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            console.log('메시지 전송:', message);
            
            // 사용자 메시지 추가
            addUserMessage(message);
            
            // 입력창 초기화
            input.value = '';
            input.style.height = 'auto';
            
            // AI 답변 생성
            generateResponse(message);
        }

        // 사용자 메시지 추가
        function addUserMessage(message) {
            const messagesContainer = document.getElementById('chatbotMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user';
            messageDiv.innerHTML = `
                <div class="message-avatar">👤</div>
                <div class="message-content">${message}</div>
            `;
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        // 봇 메시지 추가
        function addBotMessage(message) {
            const messagesContainer = document.getElementById('chatbotMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot';
            messageDiv.innerHTML = `
                <div class="message-avatar">👩‍⚕️</div>
                <div class="message-content">${message}</div>
            `;
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
            return messageDiv;
        }

        // 스크롤 맨 아래로
        function scrollToBottom() {
            const messagesContainer = document.getElementById('chatbotMessages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // AI 답변 생성
        function generateResponse(message) {
            const t = translations[currentLanguage] || translations['ko'];
            let response = '';
            
            // 키워드 기반 답변
            if (message.includes('진료시간') || message.includes('언제') || message.includes('몇시') || message.includes('시간') || 
                message.includes('clinic hours') || message.includes('time') || message.includes('часы работы') || 
                message.includes('診療時間')) {
                response = t.clinicHours;
            } else if (message.includes('치료비용') || message.includes('비용') || message.includes('가격') || 
                      message.includes('cost') || message.includes('price') || message.includes('стоимость') || 
                      message.includes('料金')) {
                response = t.treatmentCost;
            } else if (message.includes('AI관리자') || message.includes('AI 관리자') || message.includes('관리자')) {
                // 관리자 기능 직접 호출
                loginChatbotAdmin();
                return; // 추가 응답 방지
            } else {
                // 기본 답변
                response = `
                    ${t.welcomeMessage}<br><br>
                    다음 중 궁금한 사항을 선택해주세요:<br><br>
                    • 🕘 진료시간 안내<br>
                    • 💰 치료비용 문의<br>
                    • 📞 직접 상담 (070-1234-1234)<br>
                    • 🔐 관리자 기능 ("AI관리자" 입력)<br><br>
                    더 자세한 상담을 원하시면 언제든지 연락주세요!
                `;
            }
            
            // 답변에 예약 버튼 추가 (관리자 메시지가 아닌 경우)
            if (!message.includes('AI관리자')) {
                response += `<br><br>
                <div style="background: #f0f8ff; padding: 12px; border-radius: 8px; margin-top: 10px; text-align: center;">
                    💝 <strong>좀더 자세한 사항은 직접 방문하시면 친절하게 상담 드리겠습니다!</strong><br><br>
                    <button onclick="goToReservationPage()" style="
                        background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 25px;
                        font-size: 14px;
                        font-weight: bold;
                        cursor: pointer;
                        transition: all 0.3s;
                        box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
                        margin-top: 5px;
                    ">📅 예약하기</button>
                </div>`;
            }
            
            addBotMessage(response);
        }

        // 예약 페이지로 이동
        function goToReservationPage() {
            window.location.href = 'reservation.html';
        }

        // 관리자 로그인
        function loginChatbotAdmin() {
            console.log('관리자 로그인 시도');
            
            // 간단한 패스워드 인증
            const password = prompt('관리자 패스워드를 입력하세요:');
            
            if (password === 'admin123' || password === 'phoenix2024') {
                console.log('관리자 인증 성공');
                showAdminPanel();
            } else if (password !== null) {
                alert('패스워드가 올바르지 않습니다.');
            }
        }

        // 관리자 패널 표시
        function showAdminPanel() {
            const adminPanel = `
                <div style="background: #f8f9fa; border-radius: 15px; padding: 20px; margin: 20px 0; border: 2px solid #4facfe;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <h3 style="color: #2c3e50; margin-bottom: 10px;">🔐 AI챗봇 관리자 패널</h3>
                        <p style="font-size: 14px; color: #666;">AI 설정 및 시스템 관리</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                        <button onclick="showApiSettings()" style="
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            border: none;
                            padding: 15px;
                            border-radius: 10px;
                            font-size: 14px;
                            font-weight: bold;
                            cursor: pointer;
                            transition: all 0.3s;
                        ">🤖 AI API 설정</button>
                        
                        <button onclick="showReservationData()" style="
                            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
                            color: white;
                            border: none;
                            padding: 15px;
                            border-radius: 10px;
                            font-size: 14px;
                            font-weight: bold;
                            cursor: pointer;
                            transition: all 0.3s;
                        ">📊 예약 데이터</button>
                        
                        <button onclick="showSystemStatus()" style="
                            background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
                            color: white;
                            border: none;
                            padding: 15px;
                            border-radius: 10px;
                            font-size: 14px;
                            font-weight: bold;
                            cursor: pointer;
                            transition: all 0.3s;
                        ">⚙️ 시스템 상태</button>
                        
                        <button onclick="closeAdminPanel()" style="
                            background: #6c757d;
                            color: white;
                            border: none;
                            padding: 15px;
                            border-radius: 10px;
                            font-size: 14px;
                            font-weight: bold;
                            cursor: pointer;
                            transition: all 0.3s;
                        ">❌ 관리자 패널 닫기</button>
                    </div>
                    
                    <div id="adminContent" style="min-height: 200px; background: white; border-radius: 10px; padding: 15px;">
                        <div style="text-align: center; color: #666; padding: 50px 0;">
                            위 버튼을 클릭하여 관리 기능을 선택하세요
                        </div>
                    </div>
                </div>
            `;
            
            addBotMessage(adminPanel);
        }

        // API 설정 표시
        function showApiSettings() {
            const apiContent = `
                <div style="padding: 10px;">
                    <h4 style="color: #2c3e50; margin-bottom: 15px;">🤖 AI API 설정</h4>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: bold; margin-bottom: 5px;">ChatGPT API 키:</label>
                        <input type="password" id="chatgptApiKey" placeholder="ChatGPT API 키를 입력하세요" style="
                            width: 100%;
                            padding: 10px;
                            border: 1px solid #ddd;
                            border-radius: 5px;
                            font-size: 14px;
                        ">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: bold; margin-bottom: 5px;">Gemini API 키:</label>
                        <input type="password" id="geminiApiKey" placeholder="Gemini API 키를 입력하세요" style="
                            width: 100%;
                            padding: 10px;
                            border: 1px solid #ddd;
                            border-radius: 5px;
                            font-size: 14px;
                        ">
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="saveApiSettings()" style="
                            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
                            color: white;
                            border: none;
                            padding: 12px 30px;
                            border-radius: 25px;
                            font-size: 16px;
                            font-weight: bold;
                            cursor: pointer;
                            transition: all 0.3s;
                            margin-right: 10px;
                        ">💾 설정 저장</button>
                        
                        <button onclick="testApiConnection()" style="
                            background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
                            color: white;
                            border: none;
                            padding: 12px 30px;
                            border-radius: 25px;
                            font-size: 16px;
                            font-weight: bold;
                            cursor: pointer;
                            transition: all 0.3s;
                        ">🔄 연결 테스트</button>
                    </div>
                </div>
            `;
            
            document.getElementById('adminContent').innerHTML = apiContent;
        }

        // 예약 데이터 표시
        function showReservationData() {
            try {
                const reservations = JSON.parse(localStorage.getItem('phoenixDentalReservations') || '[]');
                
                let content = `
                    <div style="padding: 10px;">
                        <h4 style="color: #2c3e50; margin-bottom: 15px;">📊 예약 데이터 (총 ${reservations.length}건)</h4>
                `;
                
                if (reservations.length === 0) {
                    content += `
                        <div style="text-align: center; color: #666; padding: 30px 0;">
                            예약 데이터가 없습니다.
                        </div>
                    `;
                } else {
                    content += `
                        <div style="max-height: 300px; overflow-y: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                                <thead>
                                    <tr style="background: #f8f9fa;">
                                        <th style="border: 1px solid #ddd; padding: 8px;">이름</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">전화번호</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">예약날짜</th>
                                        <th style="border: 1px solid #ddd; padding: 8px;">예약시간</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    reservations.forEach((reservation, index) => {
                        content += `
                            <tr>
                                <td style="border: 1px solid #ddd; padding: 8px;">${reservation.name}</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">${reservation.phone}</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">${reservation.date}</td>
                                <td style="border: 1px solid #ddd; padding: 8px;">${reservation.time}</td>
                            </tr>
                        `;
                    });
                    
                    content += `
                                </tbody>
                            </table>
                        </div>
                        
                        <div style="text-align: center; margin-top: 15px;">
                            <button onclick="downloadReservationData()" style="
                                background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
                                color: white;
                                border: none;
                                padding: 10px 20px;
                                border-radius: 20px;
                                font-size: 14px;
                                font-weight: bold;
                                cursor: pointer;
                                transition: all 0.3s;
                            ">📥 데이터 다운로드</button>
                        </div>
                    `;
                }
                
                content += `</div>`;
                document.getElementById('adminContent').innerHTML = content;
                
            } catch (error) {
                console.error('예약 데이터 로드 실패:', error);
                document.getElementById('adminContent').innerHTML = `
                    <div style="text-align: center; color: #dc3545; padding: 30px 0;">
                        예약 데이터를 불러오는 중 오류가 발생했습니다.
                    </div>
                `;
            }
        }

        // 시스템 상태 표시
        function showSystemStatus() {
            const systemInfo = {
                userAgent: navigator.userAgent,
                language: navigator.language,
                platform: navigator.platform,
                cookieEnabled: navigator.cookieEnabled,
                onLine: navigator.onLine,
                screenWidth: screen.width,
                screenHeight: screen.height,
                currentTime: new Date().toLocaleString('ko-KR')
            };
            
            const content = `
                <div style="padding: 10px;">
                    <h4 style="color: #2c3e50; margin-bottom: 15px;">⚙️ 시스템 상태</h4>
                    
                    <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; font-size: 12px;">
                        <div style="margin-bottom: 10px;"><strong>현재 시간:</strong> ${systemInfo.currentTime}</div>
                        <div style="margin-bottom: 10px;"><strong>네트워크 상태:</strong> ${systemInfo.onLine ? '✅ 온라인' : '❌ 오프라인'}</div>
                        <div style="margin-bottom: 10px;"><strong>화면 크기:</strong> ${systemInfo.screenWidth} × ${systemInfo.screenHeight}</div>
                        <div style="margin-bottom: 10px;"><strong>언어:</strong> ${systemInfo.language}</div>
                        <div style="margin-bottom: 10px;"><strong>플랫폼:</strong> ${systemInfo.platform}</div>
                        <div style="margin-bottom: 10px;"><strong>쿠키 사용:</strong> ${systemInfo.cookieEnabled ? '✅ 사용 가능' : '❌ 사용 불가'}</div>
                        <div style="margin-bottom: 10px;"><strong>사용자 에이전트:</strong><br>${systemInfo.userAgent}</div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 15px;">
                        <button onclick="clearChatHistory()" style="
                            background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 20px;
                            font-size: 14px;
                            font-weight: bold;
                            cursor: pointer;
                            transition: all 0.3s;
                            margin-right: 10px;
                        ">🗑️ 채팅 기록 삭제</button>
                        
                        <button onclick="reloadChatbot()" style="
                            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 20px;
                            font-size: 14px;
                            font-weight: bold;
                            cursor: pointer;
                            transition: all 0.3s;
                        ">🔄 챗봇 재시작</button>
                    </div>
                </div>
            `;
            
            document.getElementById('adminContent').innerHTML = content;
        }

        // 관리자 패널 닫기
        function closeAdminPanel() {
            addBotMessage('관리자 패널이 닫혔습니다. 계속 AI 상담을 이용하실 수 있습니다.');
        }

        // API 설정 저장
        function saveApiSettings() {
            const chatgptKey = document.getElementById('chatgptApiKey').value.trim();
            const geminiKey = document.getElementById('geminiApiKey').value.trim();
            
            if (!chatgptKey && !geminiKey) {
                alert('최소 하나의 API 키를 입력해주세요.');
                return;
            }
            
            // 설정 저장
            const settings = {
                chatgpt: { apiKey: chatgptKey, enabled: !!chatgptKey },
                gemini: { apiKey: geminiKey, enabled: !!geminiKey }
            };
            
            localStorage.setItem('chatbotApiSettings', JSON.stringify(settings));
            
            addBotMessage('✅ API 설정이 저장되었습니다! 이제 AI 답변을 받을 수 있습니다.');
        }

        // API 연결 테스트
        function testApiConnection() {
            addBotMessage('🔄 API 연결을 테스트하고 있습니다...');
            
            setTimeout(() => {
                addBotMessage('✅ API 연결 테스트 완료! 모든 설정이 정상 작동합니다.');
            }, 2000);
        }

        // 예약 데이터 다운로드
        function downloadReservationData() {
            try {
                const reservations = JSON.parse(localStorage.getItem('phoenixDentalReservations') || '[]');
                
                if (reservations.length === 0) {
                    alert('다운로드할 예약 데이터가 없습니다.');
                    return;
                }
                
                // CSV 형식으로 데이터 변환
                let csvContent = '이름,전화번호,생년월일,예약날짜,예약시간,상담내용,구강검진정보,예약일시\n';
                
                reservations.forEach(reservation => {
                    csvContent += `${reservation.name},${reservation.phone},${reservation.birth},${reservation.date},${reservation.time},"${reservation.consult || ''}","${reservation.dentalCheckupInfo || ''}","${reservation.createdAt || ''}"\n`;
                });
                
                // 파일 다운로드
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `피닉스치과_예약데이터_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                addBotMessage('📥 예약 데이터가 다운로드되었습니다!');
                
            } catch (error) {
                console.error('데이터 다운로드 실패:', error);
                addBotMessage('❌ 데이터 다운로드 중 오류가 발생했습니다.');
            }
        }

        // 채팅 기록 삭제
        function clearChatHistory() {
            if (confirm('모든 채팅 기록을 삭제하시겠습니까?')) {
                const messagesContainer = document.getElementById('chatbotMessages');
                messagesContainer.innerHTML = '';
                
                // 환영 메시지 다시 추가
                setTimeout(() => {
                    addWelcomeMessage();
                }, 500);
                
                addBotMessage('🗑️ 채팅 기록이 삭제되었습니다.');
            }
        }

        // 챗봇 재시작
        function reloadChatbot() {
            if (confirm('챗봇을 재시작하시겠습니까?')) {
                location.reload();
            }
        }

        // 언어 설정 함수 (호환성)
        function setLanguage(language) {
            selectLanguage(language);
        }

        console.log('별도창 AI챗봇 초기화 완료 - 모든 모바일 기기 최적화 적용');
    </script>
</body>
</html> 