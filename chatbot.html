<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>피닉스 치과 AI 상담사</title>
    
    <!-- 캐시 방지 및 모바일 최적화 메타 태그 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="format-detection" content="telephone=no">
    <meta name="format-detection" content="address=no">
    <meta name="format-detection" content="email=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4facfe">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --vh: 1vh;
            --primary-color: #4facfe;
            --secondary-color: #00f2fe;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --safe-area-inset-top: env(safe-area-inset-top);
            --safe-area-inset-bottom: env(safe-area-inset-bottom);
        }

        html, body {
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            touch-action: manipulation;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f2f5;
            height: 100vh;
            height: calc(var(--vh, 1vh) * 100);
            overflow: hidden;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .chatbot-main {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: white;
            position: relative;
        }

        /* 헤더 */
        .chatbot-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 18px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chatbot-title {
            font-size: 20px;
            font-weight: bold;
            margin: 0;
            flex: 1;
        }

        .back-link {
            position: absolute;
            left: 15px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            width: 60px;
            height: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            transition: all 0.3s ease;
            text-decoration: none;
            z-index: 1000;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .back-link:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .home-icon {
            font-size: 24px;
            line-height: 1;
        }

        .home-arrow {
            font-size: 14px;
            line-height: 1;
            margin-top: 2px;
        }

        /* API 상태 표시 */
        #apiStatus {
            position: absolute;
            top: 10px;
            right: 140px;
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 12px;
            background: #f8f9fa;
            color: #6c757d;
            border: 1px solid #dee2e6;
            font-weight: bold;
            z-index: 1001;
        }

        /* 언어 선택 드롭다운 */
        .header-language-dropdown {
            position: absolute;
            right: 15px;
            z-index: 2000;
        }

        .language-dropdown {
            position: relative;
            display: inline-block;
        }

        .language-current {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            border: 2px solid #ffbf00;
            color: black !important;
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 100px;
            justify-content: center;
            box-shadow: 0 3px 10px rgba(255, 215, 0, 0.4);
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .language-current:hover {
            background: linear-gradient(135deg, #ffbf00 0%, #ffd700 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(255, 215, 0, 0.6);
        }

        .language-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 3000;
            display: none;
            min-width: 120px;
            margin-top: 5px;
        }

        .language-menu.show {
            display: block;
        }

        .language-option {
            padding: 10px 15px;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 1px solid #eee;
            font-size: 12px;
            color: black !important;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .language-option:last-child {
            border-bottom: none;
        }

        .language-option:hover {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
        }

        .language-option.active {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white !important;
        }

        /* 메시지 영역 */
        .chatbot-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 80px;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            animation: fadeInUp 0.3s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .message.bot .message-avatar {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
        }

        .message.user .message-avatar {
            background: #e9ecef;
            color: #495057;
        }

        .message-content {
            max-width: 75%;
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.5;
            font-size: 14px;
            word-wrap: break-word;
        }

        .message.bot .message-content {
            background: white;
            color: #333;
            border-bottom-left-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .message.user .message-content {
            background: var(--primary-color);
            color: white;
            border-bottom-right-radius: 6px;
        }

        /* 빠른 버튼 최적화 */
        .quick-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 15px;
            max-width: 300px;
            margin-left: auto;
            margin-right: auto;
        }

        .quick-button {
            background: #f0f8ff;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            border-radius: 15px;
            padding: 10px 8px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            will-change: transform, box-shadow;
            text-align: center;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quick-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .quick-button:active {
            transform: translateY(0);
        }

        /* 특별 버튼 스타일 */
        .clinic-hours-btn {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%) !important;
            color: #333 !important;
            border: none !important;
        }

        .treatment-cost-btn {
            background: linear-gradient(135deg, #1e88e5 0%, #42a5f5 100%) !important;
            color: white !important;
            border: none !important;
        }

        .reservation-btn {
            background: linear-gradient(135deg, #ff69b4 0%, #ff1493 100%) !important;
            color: white !important;
            border: none !important;
        }

        .directions-btn {
            background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%) !important;
            color: white !important;
            border: none !important;
        }

        /* 입력 영역 */
        .chatbot-input {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #ddd;
            padding: 15px;
            display: flex;
            gap: 10px;
            align-items: flex-end;
            z-index: 1000;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .chatbot-input textarea {
            flex: 1;
            border: 2px solid var(--primary-color);
            border-radius: 20px;
            padding: 12px 16px;
            font-size: 16px;
            resize: none;
            outline: none;
            min-height: 45px;
            max-height: 120px;
            line-height: 1.4;
            -webkit-user-select: text;
            user-select: text;
            touch-action: manipulation;
            font-family: inherit;
        }

        .chatbot-input textarea:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.2);
        }

        .chatbot-send {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 90px;
            height: 45px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .chatbot-send:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
        }

        .chatbot-send:active {
            transform: scale(0.95);
        }

        /* 로딩 애니메이션 */
        .loading-dots {
            display: inline-block;
        }

        .loading-dots::after {
            content: '';
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 80% { content: '...'; }
            100% { content: ''; }
        }

        /* 예약 버튼 스타일 */
        .reservation-button {
            background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%) !important;
            color: white !important;
            border: none !important;
            padding: 12px 24px !important;
            border-radius: 25px !important;
            font-size: 14px !important;
            font-weight: bold !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
            text-decoration: none !important;
            display: inline-block !important;
            margin: 10px 0 !important;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3) !important;
            touch-action: manipulation !important;
            -webkit-tap-highlight-color: transparent !important;
        }

        .reservation-button:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.5) !important;
        }

        .reservation-message {
            margin-top: 15px !important;
            padding: 15px !important;
            background: #f8f9fa !important;
            border-radius: 10px !important;
            border-left: 4px solid var(--primary-color) !important;
            text-align: center !important;
        }

        .reservation-message-text {
            font-size: 14px !important;
            color: #666 !important;
            margin-bottom: 10px !important;
        }

        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .chatbot-header {
                padding: 12px 8px;
            }
            
            .chatbot-title {
                font-size: 16px;
                margin: 0 80px;
            }
            
            .back-link {
                width: 50px;
                height: 50px;
                left: 8px;
            }
            
            .home-icon {
                font-size: 20px;
            }
            
            .home-arrow {
                font-size: 12px;
            }
            
            #apiStatus {
                right: 90px;
                font-size: 10px;
                padding: 3px 6px;
            }
            
            .header-language-dropdown {
                right: 8px;
            }
            
            .language-current {
                padding: 6px 10px;
                font-size: 11px;
                min-width: 80px;
            }
            
            .chatbot-messages {
                padding: 12px;
                margin-bottom: 75px;
            }
            
            .message-content {
                max-width: 85%;
                font-size: 13px;
            }
            
            .quick-buttons {
                gap: 6px;
                max-width: 280px;
            }
            
            .quick-button {
                font-size: 11px;
                padding: 8px 6px;
                min-height: 40px;
            }
            
            .chatbot-input {
                padding: 10px;
            }
            
            .chatbot-send {
                min-width: 70px;
                padding: 10px 16px;
                font-size: 14px;
            }
        }

        @media (max-width: 480px) {
            .chatbot-title {
                font-size: 14px;
                margin: 0 70px;
            }
            
            .back-link {
                width: 45px;
                height: 45px;
                left: 5px;
            }
            
            .home-icon {
                font-size: 18px;
            }
            
            .home-arrow {
                font-size: 10px;
            }
            
            #apiStatus {
                right: 75px;
                font-size: 9px;
                padding: 2px 4px;
            }
            
            .header-language-dropdown {
                right: 5px;
            }
            
            .language-current {
                padding: 5px 8px;
                font-size: 10px;
                min-width: 70px;
            }
            
            .chatbot-messages {
                padding: 8px;
                margin-bottom: 70px;
            }
            
            .quick-buttons {
                gap: 4px;
                max-width: 250px;
            }
            
            .quick-button {
                font-size: 10px;
                padding: 6px 4px;
                min-height: 36px;
            }
            
            .chatbot-input {
                padding: 8px;
            }
            
            .chatbot-send {
                min-width: 60px;
                padding: 8px 12px;
                font-size: 12px;
            }
        }

        /* iOS Safari 최적화 */
        @supports (-webkit-touch-callout: none) {
            .chatbot-main {
                height: 100vh;
                height: -webkit-fill-available;
            }
            
            .chatbot-input {
                padding-bottom: env(safe-area-inset-bottom, 15px);
            }
        }

        /* 키보드 열림 상태 최적화 */
        .keyboard-open .chatbot-messages {
            padding-bottom: 20px;
        }

        /* PC 최적화 */
        @media (min-width: 1024px) {
            .chatbot-main {
                max-width: 800px;
                margin: 0 auto;
                height: 90vh;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.1);
                margin-top: 5vh;
            }
            
            .chatbot-header {
                border-radius: 20px 20px 0 0;
            }
            
            .chatbot-input {
                border-radius: 0 0 20px 20px;
            }
            
            #apiStatus {
                right: 160px;
                font-size: 12px;
                padding: 6px 10px;
            }
            
            .language-current {
                min-width: 120px;
                font-size: 14px;
                padding: 10px 15px;
            }
        }
    </style>
</head>
<body>
    <div class="chatbot-main">
        <!-- 헤더 -->
        <div class="chatbot-header">
            <a href="index.html" class="back-link" onclick="handleBackNavigation(event)">
                <span class="home-icon">🏠</span>
                <span class="home-arrow">←</span>
            </a>
            <h1 class="chatbot-title">피닉스 치과 AI 상담사👩‍⚕️</h1>
            
            <!-- API 설정 상태 표시 -->
            <div id="apiStatus">❌ AI API 설정 안됨</div>
            
            <!-- 언어 선택 드롭다운 -->
            <div class="header-language-dropdown">
                <div class="language-dropdown">
                    <button class="language-current" onclick="toggleLanguageMenu()" ontouchstart="toggleLanguageMenu()">
                        <span id="currentLanguageText">🇰🇷 KR</span>
                        <span>▼</span>
                    </button>
                    <div class="language-menu" id="languageMenu">
                        <div class="language-option active" data-lang="ko" onclick="selectLanguage('ko')" ontouchstart="selectLanguage('ko')">🇰🇷 KR</div>
                        <div class="language-option" data-lang="en" onclick="selectLanguage('en')" ontouchstart="selectLanguage('en')">🇺🇸 US</div>
                        <div class="language-option" data-lang="ru" onclick="selectLanguage('ru')" ontouchstart="selectLanguage('ru')">🇷🇺 RU</div>
                        <div class="language-option" data-lang="ja" onclick="selectLanguage('ja')" ontouchstart="selectLanguage('ja')">🇯🇵 JP</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 메시지 영역 -->
        <div class="chatbot-messages" id="chatbotMessages">
            <!-- 메시지들이 여기에 추가됩니다 -->
        </div>

        <!-- 입력 영역 -->
        <div class="chatbot-input">
            <textarea id="chatbotInput" placeholder="메시지를 입력하세요... (Shift+Enter: 전송)" rows="1" oninput="adjustTextareaHeight(this)" onkeydown="handleInputKeyDown(event)"></textarea>
            <button class="chatbot-send" onclick="sendMessage()">전송</button>
        </div>
    </div>

    <script>
        console.log('🚀 피닉스 치과 AI 챗봇 시작 (최적화 버전)');

        // 🎯 챗봇 핵심 클래스 (단일 책임 원칙 적용)
        class PhoenixChatbot {
            constructor() {
                this.currentLanguage = 'ko';
                this.apiSettings = null;
                this.knowledgeBase = { enabled: false, files: [], parsedData: [] };
                this.isProcessingMessage = false;
                this.lastMessageTime = 0;
                this.lastMessage = '';
                
                this.initializeTranslations();
                this.init();
            }
            
            // 번역 데이터 초기화
            initializeTranslations() {
                this.translations = {
                    ko: {
                        title: '피닉스 치과 AI 상담사👩‍⚕️',
                        placeholder: '메시지를 입력하세요... (Shift+Enter: 전송)',
                        sendButton: '전송',
                        currentLanguage: '🇰🇷 KR',
                        welcomeMessage: '피닉스 치과 AI상담사 입니다!',
                        welcomeSubMessage: '우측 상단에서 언어 변경 가능합니다',
                        clinicHours: this.createClinicHoursContent('ko'),
                        treatmentCost: this.createTreatmentCostContent('ko'),
                        reservationInquiry: this.createReservationContent('ko'),
                        directions: this.createDirectionsContent('ko')
                    },
                    en: {
                        title: 'Phoenix Dental AI Consultant👩‍⚕️',
                        placeholder: 'Enter your message... (Shift+Enter: Send)',
                        sendButton: 'Send',
                        currentLanguage: '🇺🇸 US',
                        welcomeMessage: 'I am Phoenix Dental AI consultant!',
                        welcomeSubMessage: 'Language change available in top right menu',
                        clinicHours: this.createClinicHoursContent('en'),
                        treatmentCost: this.createTreatmentCostContent('en'),
                        reservationInquiry: this.createReservationContent('en'),
                        directions: this.createDirectionsContent('en')
                    },
                    ru: {
                        title: 'Консультант ИИ стоматологии Phoenix👩‍⚕️',
                        placeholder: 'Введите ваше сообщение... (Shift+Enter: Отправить)',
                        sendButton: 'Отправить',
                        currentLanguage: '🇷🇺 RU',
                        welcomeMessage: 'Я консультант ИИ стоматологии Phoenix!',
                        welcomeSubMessage: 'Изменение языка доступно в меню справа вверху',
                        clinicHours: this.createClinicHoursContent('ru'),
                        treatmentCost: this.createTreatmentCostContent('ru'),
                        reservationInquiry: this.createReservationContent('ru'),
                        directions: this.createDirectionsContent('ru')
                    },
                    ja: {
                        title: 'フェニックス歯科AIコンサルタント👩‍⚕️',
                        placeholder: 'メッセージを入力してください... (Shift+Enter: 送信)',
                        sendButton: '送信',
                        currentLanguage: '🇯🇵 JP',
                        welcomeMessage: 'フェニックス歯科AIコンサルタントです！',
                        welcomeSubMessage: '右上メニューで言語変更が可能です',
                        clinicHours: this.createClinicHoursContent('ja'),
                        treatmentCost: this.createTreatmentCostContent('ja'),
                        reservationInquiry: this.createReservationContent('ja'),
                        directions: this.createDirectionsContent('ja')
                    }
                };
            }
            
            // 초기화
            init() {
                this.loadSettings();
                this.setupEventListeners();
                this.setupMobileOptimization();
                setTimeout(() => this.addWelcomeMessage(), 500);
                this.updateLanguageUI();
            }
            
            // 설정 로딩
            loadSettings() {
                this.loadApiSettings();
                this.loadKnowledgeBaseSettings();
                this.updateApiStatusDisplay();
            }
            
            // 🎯 핵심 메시지 처리 함수 (개선된 우선순위)
            async processMessage(message) {
                console.log('🎯 메시지 처리 시작:', message);
                
                // 중복 실행 방지
                if (this.isDuplicateMessage(message)) {
                    console.log('⚠️ 중복 메시지 차단');
                    return;
                }
                
                this.setProcessingFlag(true);
                
                try {
                    // ✅ 1차: 관리자 기능 (최우선)
                    if (this.isAdminCommand(message)) {
                        console.log('🔐 1차: 관리자 기능 처리');
                        this.handleAdminCommand();
                        return;
                    }
                    
                    // ✅ 1.5차: 인사/감사 처리 (빠른 응답)
                    if (this.isGreetingOrThanks(message)) {
                        console.log('😊 1.5차: 인사/감사 처리');
                        const response = this.generateGreetingResponse(message);
                        this.addBotMessage(response);
                        return;
                    }
                    
                    // ✅ 2차: 지식베이스 검색
                    console.log('📚 2차: 지식베이스 검색');
                    const knowledgeAnswer = this.searchInKnowledgeBase(message);
                    if (knowledgeAnswer) {
                        console.log('✅ 지식베이스에서 답변 발견');
                        this.addBotMessage(knowledgeAnswer);
                        return;
                    }
                    
                    // ✅ 3차: 기본 FAQ 답변 (키워드 기반)
                    console.log('❓ 3차: 기본 FAQ 검색');
                    const faqAnswer = this.getFAQAnswer(message);
                    if (faqAnswer) {
                        console.log('✅ FAQ 답변 발견:', faqAnswer.type);
                        this.addBotMessage(faqAnswer.content);
                        return;
                    }
                    
                    // ✅ 4차: AI API 호출
                    console.log('🤖 4차: AI API 호출 시도');
                    if (this.hasActiveAPI()) {
                        console.log('✅ 활성화된 AI API 발견');
                        await this.generateAIResponse(message);
                        return;
                    }
                    
                    // ✅ 5차: 시뮬레이션된 답변 (최후 수단)
                    console.log('🎭 5차: 시뮬레이션된 답변 사용');
                    setTimeout(() => {
                        const response = this.generateSimulatedResponse(message);
                        this.addBotMessage(response);
                    }, 800);
                    
                } catch (error) {
                    console.error('❌ 메시지 처리 오류:', error);
                    this.addBotMessage('죄송합니다. 일시적인 오류가 발생했습니다. 다시 시도해주세요.');
                } finally {
                    this.setProcessingFlag(false);
                }
            }
            
            // 중복 메시지 확인 (개선됨)
            isDuplicateMessage(message) {
                const currentTime = Date.now();
                const isDuplicate = this.isProcessingMessage || 
                                   (currentTime - this.lastMessageTime < 1000 && this.lastMessage === message);
                
                this.lastMessageTime = currentTime;
                this.lastMessage = message;
                return isDuplicate;
            }
            
            // 처리 플래그 설정
            setProcessingFlag(processing) {
                this.isProcessingMessage = processing;
                if (processing) {
                    setTimeout(() => { this.isProcessingMessage = false; }, 5000);
                }
            }
            
            // 관리자 명령어 확인
            isAdminCommand(message) {
                const adminKeywords = ['AI관리자', 'AI 관리자', '관리자', 'admin'];
                return adminKeywords.some(keyword => 
                    message.toLowerCase().includes(keyword.toLowerCase())
                );
            }
            
            // 인사/감사 확인
            isGreetingOrThanks(message) {
                const greetings = ['안녕', 'hello', 'hi', '하이', '반가워', '안녕하세요'];
                const thanks = ['감사', '고마워', 'thanks', 'thank you', '땡큐'];
                const meaningless = /^(떼|데|테|때|뗘|뗴|데데|떼떼){1,}$/i;
                
                const lower = message.toLowerCase();
                return greetings.some(g => lower.includes(g)) || 
                       thanks.some(t => lower.includes(t)) || 
                       meaningless.test(lower);
            }
            
            // 인사/감사 응답 생성
            generateGreetingResponse(message) {
                const lower = message.toLowerCase();
                
                if (lower.includes('감사') || lower.includes('고마워') || lower.includes('thank')) {
                    return '천만에요! 피닉스치과를 이용해주셔서 감사합니다. 더 궁금한 점이 있으시면 언제든 문의해주세요 😊';
                }
                
                return '안녕하세요! 피닉스치과 AI 상담사입니다. 궁금한 점이 있으시면 언제든 말씀해 주세요 😊';
            }
            
            // FAQ 답변 처리 (개선된 키워드 매칭)
            getFAQAnswer(message) {
                const keywordGroups = this.getKeywordGroups();
                const normalized = message.toLowerCase().trim();
                
                for (const [groupName, group] of Object.entries(keywordGroups)) {
                    if (this.matchesKeywords(normalized, group.keywords)) {
                        const translations = this.translations[this.currentLanguage];
                        return {
                            type: group.type,
                            content: translations[group.type]
                        };
                    }
                }
                
                return null;
            }
            
            // 키워드 그룹 정의 (더 정확한 매칭)
            getKeywordGroups() {
                return {
                    clinicHours: {
                        keywords: ['진료시간', '운영시간', '문여는', '열어', 'clinic hours', 'hours', 'часы работы', '診療時間'],
                        type: 'clinicHours'
                    },
                    treatmentCost: {
                        keywords: ['치료비용', '진료비', '비용', '가격', '얼마', 'cost', 'price', 'стоимость', '料金', '스케일링', '임플란트', '교정', '미백'],
                        type: 'treatmentCost'
                    },
                    reservation: {
                        keywords: ['예약', '예약문의', '신청', 'reservation', 'booking', 'запись', '予約', '접수'],
                        type: 'reservationInquiry'
                    },
                    directions: {
                        keywords: ['오시는길', '주소', '위치', '어디', 'directions', 'location', 'address', 'адрес', '場所', '찾아'],
                        type: 'directions'
                    }
                };
            }
            
            // 키워드 매칭 (더 정확한 알고리즘)
            matchesKeywords(message, keywords) {
                return keywords.some(keyword => {
                    // 정확한 단어 경계 매칭 또는 부분 문자열 매칭
                    const wordBoundary = new RegExp(`\\b${keyword.toLowerCase()}\\b`);
                    return wordBoundary.test(message) || message.includes(keyword.toLowerCase());
                });
            }
            
            // API 활성 상태 확인
            hasActiveAPI() {
                return this.apiSettings && (
                    (this.apiSettings.chatgpt?.enabled && this.apiSettings.chatgpt?.apiKey) ||
                    (this.apiSettings.gemini?.enabled && this.apiSettings.gemini?.apiKey) ||
                    (this.apiSettings.claude?.enabled && this.apiSettings.claude?.apiKey)
                );
            }
            
            // 활성화된 API 제공자 가져오기
            getActiveProvider() {
                if (this.apiSettings?.chatgpt?.enabled && this.apiSettings.chatgpt?.apiKey) {
                    return 'chatgpt';
                } else if (this.apiSettings?.gemini?.enabled && this.apiSettings.gemini?.apiKey) {
                    return 'gemini';
                } else if (this.apiSettings?.claude?.enabled && this.apiSettings.claude?.apiKey) {
                    return 'claude';
                }
                return null;
            }
            
            // 지식베이스에서 컨텍스트 정보 추출
            getContextFromKnowledgeBase() {
                if (!this.knowledgeBase.enabled || this.knowledgeBase.parsedData.length === 0) {
                    return '';
                }
                
                // 모든 Q&A를 컨텍스트로 정리
                let context = '\n\n=== 병원 전문 지식 정보 ===\n';
                this.knowledgeBase.parsedData.forEach((qa, index) => {
                    context += `${index + 1}. Q: ${qa.question}\n   A: ${qa.answer}\n`;
                });
                
                return context;
            }
            
            // API 호출 함수
            async callAPI(provider, message, contextInfo) {
                const settings = this.apiSettings[provider];
                
                switch (provider) {
                    case 'chatgpt':
                        return await this.callChatGPTAPI(message, settings, contextInfo);
                    case 'gemini':
                        return await this.callGeminiAPI(message, settings, contextInfo);
                    case 'claude':
                        return await this.callClaudeAPI(message, settings, contextInfo);
                    default:
                        throw new Error('지원하지 않는 API 제공자입니다.');
                }
            }
            
            // ChatGPT API 호출
            async callChatGPTAPI(message, settings, contextInfo) {
                const systemPrompt = `당신은 피닉스 치과 병원의 전문 AI 상담사입니다. 
                매우 친절하고 전문적으로 답변해주세요.

                === 병원 기본 정보 ===
                • 병원명: 피닉스 치과 병원
                • 원장: 홍길동 (25년 경력 치주질환 전문의)
                • 진료시간: 평일 09:00-18:00, 토요일 09:00-15:00, 점심시간 12:30-13:30
                • 휴진: 일요일, 공휴일
                • 전화: 070-1234-1234 (24시간 응급상담 가능)
                • 주소: 피닉스시 피닉스로 11길 11, 피닉스타워 11층 11호
                • 교통: 지하철 2호선 강남역 3번 출구 도보 5분
                • 주차: 건물 지하 1-3층 무료 주차 (3시간)
                • 진료과목: 일반진료, 미백치료, 교정치료, 임플란트, 보철치료, 소아치과

                === 치료비 안내 ===
                • 일반진료: 초진 15,000원, 재진 10,000원
                • 스케일링: 50,000원 (건강보험 적용 시 연 1회 무료)
                • 미백치료: 200,000-300,000원
                • 교정치료: 1,500,000-6,000,000원
                • 임플란트: 1,200,000-1,500,000원

                ${contextInfo}

                답변 가이드라인:
                1. 매우 친절하고 따뜻한 말투를 사용하세요
                2. 전문적이면서도 이해하기 쉽게 설명하세요
                3. 구체적인 정보를 제공하되, 정확하지 않은 의료 진단은 피하세요
                4. 예약이나 상담이 필요한 경우 적극 안내하세요
                5. 답변을 구조화하여 읽기 쉽게 정리해주세요
                6. 진료시간, 치료비용, 예약문의, 오시는길 등 주요 질문에 대해서는 자연스럽고 상세한 설명을 제공하세요
                7. 사용자의 편의를 고려한 실용적인 조언을 포함해주세요`;

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${settings.apiKey}`
                    },
                    body: JSON.stringify({
                        model: settings.model,
                        messages: [
                            {
                                role: "system",
                                content: systemPrompt
                            },
                            {
                                role: "user",
                                content: message
                            }
                        ],
                        max_tokens: 800,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                return data.choices[0].message.content;
            }
            
            // Gemini API 호출
            async callGeminiAPI(message, settings, contextInfo) {
                const prompt = `당신은 피닉스 치과 병원의 전문 AI 상담사입니다. 
                매우 친절하고 전문적으로 답변해주세요.

                === 병원 기본 정보 ===
                • 병원명: 피닉스 치과 병원
                • 원장: 홍길동 (25년 경력 치주질환 전문의)
                • 진료시간: 평일 09:00-18:00, 토요일 09:00-15:00, 점심시간 12:30-13:30
                • 휴진: 일요일, 공휴일
                • 전화: 070-1234-1234 (24시간 응급상담 가능)
                • 주소: 피닉스시 피닉스로 11길 11, 피닉스타워 11층 11호
                • 교통: 지하철 2호선 강남역 3번 출구 도보 5분
                • 주차: 건물 지하 1-3층 무료 주차 (3시간)
                • 진료과목: 일반진료, 미백치료, 교정치료, 임플란트, 보철치료, 소아치과

                === 치료비 안내 ===
                • 일반진료: 초진 15,000원, 재진 10,000원
                • 스케일링: 50,000원 (건강보험 적용 시 연 1회 무료)
                • 미백치료: 200,000-300,000원
                • 교정치료: 1,500,000-6,000,000원
                • 임플란트: 1,200,000-1,500,000원

                ${contextInfo}

                답변 가이드라인:
                1. 매우 친절하고 따뜻한 말투를 사용하세요
                2. 전문적이면서도 이해하기 쉽게 설명하세요
                3. 구체적인 정보를 제공하되, 정확하지 않은 의료 진단은 피하세요
                4. 예약이나 상담이 필요한 경우 적극 안내하세요
                5. 답변을 구조화하여 읽기 쉽게 정리해주세요

                질문: ${message}`;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${settings.model}:generateContent?key=${settings.apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }],
                        generationConfig: {
                            maxOutputTokens: 800,
                            temperature: 0.7
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            }
            
            // Claude API 호출
            async callClaudeAPI(message, settings, contextInfo) {
                const prompt = `당신은 피닉스 치과 병원의 전문 AI 상담사입니다. 
                매우 친절하고 전문적으로 답변해주세요.

                === 병원 기본 정보 ===
                • 병원명: 피닉스 치과 병원
                • 원장: 홍길동 (25년 경력 치주질환 전문의)
                • 진료시간: 평일 09:00-18:00, 토요일 09:00-15:00, 점심시간 12:30-13:30
                • 휴진: 일요일, 공휴일
                • 전화: 070-1234-1234 (24시간 응급상담 가능)
                • 주소: 피닉스시 피닉스로 11길 11, 피닉스타워 11층 11호
                • 교통: 지하철 2호선 강남역 3번 출구 도보 5분
                • 주차: 건물 지하 1-3층 무료 주차 (3시간)
                • 진료과목: 일반진료, 미백치료, 교정치료, 임플란트, 보철치료, 소아치과

                === 치료비 안내 ===
                • 일반진료: 초진 15,000원, 재진 10,000원
                • 스케일링: 50,000원 (건강보험 적용 시 연 1회 무료)
                • 미백치료: 200,000-300,000원
                • 교정치료: 1,500,000-6,000,000원
                • 임플란트: 1,200,000-1,500,000원

                ${contextInfo}

                답변 가이드라인:
                1. 매우 친절하고 따뜻한 말투를 사용하세요
                2. 전문적이면서도 이해하기 쉽게 설명하세요
                3. 구체적인 정보를 제공하되, 정확하지 않은 의료 진단은 피하세요
                4. 예약이나 상담이 필요한 경우 적극 안내하세요
                5. 답변을 구조화하여 읽기 쉽게 정리해주세요

                질문: ${message}`;

                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': settings.apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: settings.model,
                        max_tokens: 800,
                        messages: [{
                            role: "user",
                            content: prompt
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                return data.content[0].text;
            }
            
            // AI 응답 포맷팅
            formatAIResponse(response, provider) {
                const providerIcon = {
                    'chatgpt': '🧠',
                    'gemini': '💎', 
                    'claude': '🤖'
                };
                
                const providerName = {
                    'chatgpt': 'ChatGPT',
                    'gemini': 'Gemini',
                    'claude': 'Claude'
                };
                
                return `${providerIcon[provider]} <strong>피닉스 치과 AI 상담사 (${providerName[provider]})</strong><br><br>
                ${response}<br><br>
                <small>💡 추가 궁금한 점이 있으시면 언제든 문의해주세요!</small>`;
            }
            
            // AI 응답 생성
            async generateAIResponse(message) {
                const loadingMessage = this.addBotMessage('🤖 AI가 답변을 생성하고 있습니다<span class="loading-dots"></span>');
                
                try {
                    // API 호출 로직
                    const activeProvider = this.getActiveProvider();
                    const contextInfo = this.getContextFromKnowledgeBase();
                    
                    const response = await this.callAPI(activeProvider, message, contextInfo);
                    this.removeMessage(loadingMessage);
                    this.addBotMessage(this.formatAIResponse(response, activeProvider));
                } catch (error) {
                    console.error('AI API 호출 실패:', error);
                    this.removeMessage(loadingMessage);
                    const fallbackResponse = this.generateSimulatedResponse(message);
                    this.addBotMessage(fallbackResponse);
                }
            }
            
            // 시뮬레이션된 응답 생성 (더 자연스럽게)
            generateSimulatedResponse(message) {
                const responses = [
                    `안녕하세요! "${message}"에 대한 답변을 도와드리겠습니다.`,
                    '피닉스치과 AI 상담사입니다. 더 자세한 상담이 필요하시면 언제든 연락주세요!',
                    '궁금한 점이 있으시면 진료시간, 치료비용, 예약, 오시는길 등을 입력해보세요.'
                ];
                
                const apiStatus = this.hasActiveAPI() ? 
                    '🤖 AI API가 연결되어 있어 더 정확한 답변을 제공할 수 있습니다.' : 
                    '❌ AI API가 설정되지 않아 기본 답변을 제공합니다. (관리자 메뉴에서 AI API 설정 가능)';
                
                return responses[Math.floor(Math.random() * responses.length)] + `
                
💡 **빠른 문의 메뉴:**
• "진료시간" - 병원 운영시간 안내
• "치료비용" - 치료비 정보
• "예약" - 예약 및 상담 문의  
• "오시는길" - 병원 위치 안내

${apiStatus}

📞 **직접 문의:** 070-1234-1234`;
            }
            
            // 사용자 메시지 추가
            addUserMessage(message) {
                const messagesContainer = document.getElementById('chatbotMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message user';
                messageDiv.innerHTML = `
                    <div class="message-avatar">👤</div>
                    <div class="message-content">${this.escapeHtml(message)}</div>
                `;
                messagesContainer.appendChild(messageDiv);
                this.scrollToBottom();
            }
            
            // 봇 메시지 추가
            addBotMessage(message) {
                const messagesContainer = document.getElementById('chatbotMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message bot';
                messageDiv.innerHTML = `
                    <div class="message-avatar">👩‍⚕️</div>
                    <div class="message-content">${message}</div>
                `;
                messagesContainer.appendChild(messageDiv);
                this.scrollToBottom();
                return messageDiv;
            }
            
            // HTML 이스케이프
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            // 메시지 제거
            removeMessage(messageElement) {
                if (messageElement && messageElement.parentNode) {
                    messageElement.parentNode.removeChild(messageElement);
                }
            }
            
            // 스크롤 하단 이동
            scrollToBottom() {
                const messagesContainer = document.getElementById('chatbotMessages');
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
            
            // 환영 메시지 추가
            addWelcomeMessage() {
                const t = this.translations[this.currentLanguage];
                
                const welcomeMessage = `
                    <div style="text-align: center; color: #333;">
                        <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px; color: #2c3e50;">
                            ${t.welcomeMessage}
                        </div>
                        <div style="font-size: 14px; color: #666; line-height: 1.5; margin-bottom: 15px;">
                            ${t.welcomeSubMessage}
                        </div>
                        <div style="font-size: 11px; color: #888; margin-bottom: 15px; padding: 8px; background: #f0f8ff; border-radius: 6px;">
                            🎯 <strong>답변 우선순위:</strong> 1차 관리자 → 2차 지식베이스 → 3차 FAQ → 4차 AI API → 5차 시뮬레이션<br>
                            ${this.hasActiveAPI() ? '🤖 AI API 연결됨' : '❌ AI API 설정 필요 (관리자 메뉴에서 설정)'}
                        </div>
                        <div class="quick-buttons">
                            <button class="quick-button clinic-hours-btn" onclick="chatbot.handleQuickMessage('진료시간 알려주세요')">
                                🕘 진료시간
                            </button>
                            <button class="quick-button treatment-cost-btn" onclick="chatbot.handleQuickMessage('치료비용 궁금해요')">
                                💰 치료비용
                            </button>
                            <button class="quick-button reservation-btn" onclick="chatbot.handleQuickMessage('예약문의 하고싶어요')">
                                📞 예약문의
                            </button>
                            <button class="quick-button directions-btn" onclick="chatbot.handleQuickMessage('오시는길 알려주세요')">
                                🗺️ 오시는길
                            </button>
                        </div>
                    </div>
                `;
                
                this.addBotMessage(welcomeMessage);
            }
            
            // 빠른 메시지 처리
            handleQuickMessage(message) {
                console.log('⚡ 빠른 메시지:', message);
                this.addUserMessage(message);
                this.processMessage(message);
            }
            
            // 언어 UI 업데이트
            updateLanguageUI() {
                const t = this.translations[this.currentLanguage];
                
                document.querySelector('.chatbot-title').textContent = t.title;
                document.getElementById('chatbotInput').placeholder = t.placeholder;
                document.querySelector('.chatbot-send').textContent = t.sendButton;
                document.getElementById('currentLanguageText').textContent = t.currentLanguage;
                
                // 드롭다운 옵션 업데이트
                document.querySelectorAll('.language-option').forEach(option => {
                    option.classList.remove('active');
                    if (option.getAttribute('data-lang') === this.currentLanguage) {
                        option.classList.add('active');
                    }
                });
            }
            
            // 이벤트 리스너 설정
            setupEventListeners() {
                // 외부 클릭 시 드롭다운 닫기
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.language-dropdown')) {
                        document.getElementById('languageMenu').classList.remove('show');
                    }
                });
            }
            
            // 모바일 최적화 설정
            setupMobileOptimization() {
                this.setViewportHeight();
                window.addEventListener('resize', () => this.setViewportHeight());
                window.addEventListener('orientationchange', () => {
                    setTimeout(() => this.setViewportHeight(), 100);
                });
                
                // 키보드 감지
                this.setupKeyboardDetection();
            }
            
            // 뷰포트 높이 설정
            setViewportHeight() {
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
            }
            
            // 키보드 감지 설정
            setupKeyboardDetection() {
                const initialHeight = window.innerHeight;
                
                window.addEventListener('resize', () => {
                    const currentHeight = window.innerHeight;
                    const heightDiff = initialHeight - currentHeight;
                    
                    if (heightDiff > 150) {
                        document.body.classList.add('keyboard-open');
                    } else {
                        document.body.classList.remove('keyboard-open');
                    }
                });
            }
            
            // API 설정 로딩
            loadApiSettings() {
                try {
                    const saved = localStorage.getItem('chatbotApiSettings');
                    if (saved) {
                        this.apiSettings = JSON.parse(saved);
                        console.log('✅ API 설정 로드 완료:', this.apiSettings);
                    } else {
                        this.apiSettings = {
                            chatgpt: { enabled: false, apiKey: '', model: '' },
                            gemini: { enabled: false, apiKey: '', model: '' },
                            claude: { enabled: false, apiKey: '', model: '' }
                        };
                        console.log('✅ 기본 API 설정 초기화 완료');
                    }
                } catch (error) {
                    console.error('❌ API 설정 로드 실패:', error);
                    this.apiSettings = {
                        chatgpt: { enabled: false, apiKey: '', model: '' },
                        gemini: { enabled: false, apiKey: '', model: '' },
                        claude: { enabled: false, apiKey: '', model: '' }
                    };
                }
            }
            
            // 지식베이스 설정 로딩
            loadKnowledgeBaseSettings() {
                try {
                    const saved = localStorage.getItem('chatbotKnowledgeBase');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        this.knowledgeBase.enabled = parsed.enabled || false;
                        this.knowledgeBase.parsedData = parsed.parsedData || [];
                        console.log('✅ 지식베이스 설정 로드 완료:', this.knowledgeBase.parsedData.length, '개 Q&A');
                    }
                } catch (error) {
                    console.error('❌ 지식베이스 설정 로드 실패:', error);
                }
            }
            
            // API 상태 표시 업데이트
            updateApiStatusDisplay() {
                const apiStatus = document.getElementById('apiStatus');
                if (!apiStatus) return; // 요소가 없으면 리턴
                
                if (!this.hasActiveAPI()) {
                    apiStatus.textContent = '❌ AI API 설정 안됨';
                    apiStatus.style.background = '#f8f9fa';
                    apiStatus.style.color = '#6c757d';
                    return;
                }
                
                const activeApis = [];
                if (this.apiSettings?.chatgpt?.enabled && this.apiSettings.chatgpt?.apiKey) activeApis.push('ChatGPT');
                if (this.apiSettings?.gemini?.enabled && this.apiSettings.gemini?.apiKey) activeApis.push('Gemini');
                if (this.apiSettings?.claude?.enabled && this.apiSettings.claude?.apiKey) activeApis.push('Claude');
                
                apiStatus.textContent = `✅ AI API (${activeApis.join(', ')})`;
                apiStatus.style.background = '#d4edda';
                apiStatus.style.color = '#155724';
            }
            
            // 지식베이스 검색 (간소화된 버전)
            searchInKnowledgeBase(message) {
                if (!this.knowledgeBase.enabled || this.knowledgeBase.parsedData.length === 0) {
                    return null;
                }
                
                const query = message.toLowerCase().trim();
                let bestMatch = null;
                let bestScore = 0;
                
                for (const qa of this.knowledgeBase.parsedData) {
                    const question = qa.question.toLowerCase();
                    const answer = qa.answer.toLowerCase();
                    
                    let score = 0;
                    
                    // 완전 일치
                    if (question === query) score += 1000;
                    
                    // 부분 포함
                    if (question.includes(query) || query.includes(question)) score += 500;
                    
                    // 단어 매칭
                    const queryWords = query.split(/\s+/).filter(w => w.length > 1);
                    for (const word of queryWords) {
                        if (question.includes(word)) score += 100;
                        if (answer.includes(word)) score += 50;
                    }
                    
                    if (score > bestScore) {
                        bestScore = score;
                        bestMatch = qa;
                    }
                }
                
                if (bestScore >= 50) {
                    return `📚 <strong>피닉스 치과 전문 지식 답변</strong><br><br>
                            <strong>Q:</strong> ${bestMatch.question}<br><br>
                            <strong>A:</strong> ${bestMatch.answer}<br><br>
                            <small>💡 전문 지식 데이터베이스에서 제공된 답변입니다.</small>`;
                }
                
                return null;
            }
            
            // 콘텐츠 생성 메서드들
            createClinicHoursContent(lang) {
                const content = {
                    ko: '🕘 <strong>피닉스 치과 진료시간 안내</strong><br><br>📅 <strong>평일:</strong> 09:00 ~ 18:00<br>📅 <strong>토요일:</strong> 09:00 ~ 15:00<br>🍽️ <strong>점심시간:</strong> 12:30 ~ 13:30<br>🚫 <strong>휴진:</strong> 일요일, 공휴일<br><br>📞 <strong>예약 문의:</strong> 070-1234-1234',
                    en: '🕘 <strong>Phoenix Dental Clinic Hours</strong><br><br>📅 <strong>Weekdays:</strong> 09:00 ~ 18:00<br>📅 <strong>Saturday:</strong> 09:00 ~ 15:00<br>🍽️ <strong>Lunch Break:</strong> 12:30 ~ 13:30<br>🚫 <strong>Closed:</strong> Sunday, Holidays<br><br>📞 <strong>Reservation:</strong> 070-1234-1234',
                    ru: '🕘 <strong>Часы работы стоматологии Phoenix</strong><br><br>📅 <strong>Будни:</strong> 09:00 ~ 18:00<br>📅 <strong>Суббота:</strong> 09:00 ~ 15:00<br>🍽️ <strong>Обед:</strong> 12:30 ~ 13:30<br>🚫 <strong>Выходные:</strong> Воскресенье, праздники<br><br>📞 <strong>Запись:</strong> 070-1234-1234',
                    ja: '🕘 <strong>フェニックス歯科診療時間案内</strong><br><br>📅 <strong>平日:</strong> 09:00 ~ 18:00<br>📅 <strong>土曜日:</strong> 09:00 ~ 15:00<br>🍽️ <strong>昼休み:</strong> 12:30 ~ 13:30<br>🚫 <strong>休診:</strong> 日曜日、祝日<br><br>📞 <strong>予約問い合わせ:</strong> 070-1234-1234'
                };
                
                return content[lang] + `<br><br><div class="reservation-message">
                    <div class="reservation-message-text">자세한 문의는 방문 상담을 받아보세요</div>
                    <button class="reservation-button" onclick="window.open('reservation.html', '_blank')">📅 예약하기</button>
                </div>`;
            }
            
            createTreatmentCostContent(lang) {
                const content = {
                    ko: '💰 <strong>피닉스 치과 치료비용 안내</strong><br><br>🦷 <strong>일반 진료:</strong> 상담 후 안내<br>🦷 <strong>스케일링:</strong> 30,000원 ~ 50,000원<br>🦷 <strong>임플란트:</strong> 상담 후 개별 견적<br>🦷 <strong>교정:</strong> 상담 후 개별 견적<br><br>💡 <strong>정확한 비용은 진료 후 안내드립니다!</strong>',
                    en: '💰 <strong>Phoenix Dental Treatment Costs</strong><br><br>🦷 <strong>General Treatment:</strong> Consultation required<br>🦷 <strong>Scaling:</strong> 30,000 ~ 50,000 KRW<br>🦷 <strong>Implant:</strong> Individual estimate<br>🦷 <strong>Orthodontics:</strong> Individual estimate<br><br>💡 <strong>Exact costs provided after examination!</strong>',
                    ru: '💰 <strong>Стоимость лечения Phoenix</strong><br><br>🦷 <strong>Общее лечение:</strong> Требуется консультация<br>🦷 <strong>Чистка:</strong> 30,000 ~ 50,000 вон<br>🦷 <strong>Имплант:</strong> Индивидуальная оценка<br>🦷 <strong>Ортодонтия:</strong> Индивидуальная оценка<br><br>💡 <strong>Точная стоимость после обследования!</strong>',
                    ja: '💰 <strong>フェニックス歯科治療費案内</strong><br><br>🦷 <strong>一般診療:</strong> 相談後ご案内<br>🦷 <strong>スケーリング:</strong> 30,000円 ~ 50,000円<br>🦷 <strong>インプラント:</strong> 相談後個別見積もり<br>🦷 <strong>矯正:</strong> 相談後個別見積もり<br><br>💡 <strong>正確な費用は診療後にご案内！</strong>'
                };
                
                return content[lang] + `<br><br><div class="reservation-message">
                    <div class="reservation-message-text">자세한 문의는 방문 상담을 받아보세요</div>
                    <button class="reservation-button" onclick="window.open('reservation.html', '_blank')">📅 예약하기</button>
                </div>`;
            }
            
            createReservationContent(lang) {
                const content = {
                    ko: '📞 <strong>피닉스 치과 예약 문의</strong><br><br>🏥 <strong>병원명:</strong> 피닉스 치과<br>📞 <strong>전화번호:</strong> 070-1234-1234<br>💬 <strong>카카오톡:</strong> 피닉스치과<br>🌐 <strong>온라인 예약:</strong> 홈페이지 예약 시스템<br><br>💡 <strong>온라인 예약이 가장 편리합니다!</strong>',
                    en: '📞 <strong>Phoenix Dental Reservation</strong><br><br>🏥 <strong>Clinic:</strong> Phoenix Dental<br>📞 <strong>Phone:</strong> 070-1234-1234<br>💬 <strong>KakaoTalk:</strong> Phoenix Dental<br>🌐 <strong>Online:</strong> Website reservation system<br><br>💡 <strong>Online booking is most convenient!</strong>',
                    ru: '📞 <strong>Запись Phoenix Dental</strong><br><br>🏥 <strong>Клиника:</strong> Phoenix Dental<br>📞 <strong>Телефон:</strong> 070-1234-1234<br>💬 <strong>KakaoTalk:</strong> Phoenix Dental<br>🌐 <strong>Онлайн:</strong> Система записи на сайте<br><br>💡 <strong>Онлайн запись наиболее удобна!</strong>',
                    ja: '📞 <strong>フェニックス歯科予約</strong><br><br>🏥 <strong>病院名:</strong> フェニックス歯科<br>📞 <strong>電話番号:</strong> 070-1234-1234<br>💬 <strong>カカオトーク:</strong> フェニックス歯科<br>🌐 <strong>オンライン:</strong> ホームページ予約システム<br><br>💡 <strong>オンライン予約が最も便利です!</strong>'
                };
                
                return content[lang] + `<br><br><div class="reservation-message">
                    <div class="reservation-message-text">자세한 문의는 방문 상담을 받아보세요</div>
                    <button class="reservation-button" onclick="window.open('reservation.html', '_blank')">📅 예약하기</button>
                </div>`;
            }
            
            createDirectionsContent(lang) {
                const content = {
                    ko: '🗺️ <strong>피닉스 치과 오시는길</strong><br><br>📍 <strong>주소:</strong> 서울특별시 강남구 테헤란로 123<br>🚇 <strong>지하철:</strong> 2호선 강남역 3번 출구 도보 5분<br>🚌 <strong>버스:</strong> 강남역 정류장 하차<br>🚗 <strong>주차:</strong> 건물 지하 1층 (2시간 무료)',
                    en: '🗺️ <strong>Directions to Phoenix Dental</strong><br><br>📍 <strong>Address:</strong> 123 Teheran-ro, Gangnam-gu, Seoul<br>🚇 <strong>Subway:</strong> Line 2 Gangnam Station Exit 3, 5 min walk<br>🚌 <strong>Bus:</strong> Gangnam Station<br>🚗 <strong>Parking:</strong> Building B1 (2 hours free)',
                    ru: '🗺️ <strong>Как добраться до Phoenix Dental</strong><br><br>📍 <strong>Адрес:</strong> Сеул, Каннам-гу, Техеран-ро 123<br>🚇 <strong>Метро:</strong> Линия 2, станция Каннам, выход 3, 5 мин пешком<br>🚌 <strong>Автобус:</strong> Остановка Каннам<br>🚗 <strong>Парковка:</strong> Подземный этаж (2 часа бесплатно)',
                    ja: '🗺️ <strong>フェニックス歯科へのアクセス</strong><br><br>📍 <strong>住所:</strong> ソウル特別市江南区テヘラン路123<br>🚇 <strong>地下鉄:</strong> 2号線江南駅3番出口徒歩5分<br>🚌 <strong>バス:</strong> 江南駅停留所下車<br>🚗 <strong>駐車場:</strong> 建物地下1階（2時間無料）'
                };
                
                return content[lang] + `<br><br><div class="reservation-message">
                    <div class="reservation-message-text">자세한 문의는 방문 상담을 받아보세요</div>
                    <button class="reservation-button" onclick="window.open('reservation.html', '_blank')">📅 예약하기</button>
                </div>`;
            }
            
            // 관리자 기능 처리
            handleAdminCommand() {
                const adminLink = `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px; padding: 20px; margin: 15px 0; text-align: center;">
                        <h4 style="margin-bottom: 15px;">🤖 AI챗봇 관리 로그인</h4>
                        <p style="margin-bottom: 10px;">관리자 페이지에 접속하려면 아래 버튼을 클릭하세요.</p>
                        <p style="margin-bottom: 20px; font-size: 14px; opacity: 0.9;">💡 아이디: <strong>phoenix</strong> | 비밀번호: <strong>phoenix</strong></p>
                        <button onclick="openAdminPanel()" style="background: white; color: #667eea; border: none; padding: 12px 25px; border-radius: 25px; font-weight: bold; cursor: pointer; font-size: 16px; transition: all 0.3s; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
                            🔐 관리자 페이지 열기
                        </button>
                    </div>
                `;
                this.addBotMessage(adminLink);
            }
        }

        // 🎯 전역 챗봇 인스턴스 생성
        let chatbot;
        
        // 🎯 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 페이지 로드 완료 - 챗봇 초기화');
            chatbot = new PhoenixChatbot();
            window.chatbot = chatbot; // 전역으로 설정
        });

        // 🎯 전역 함수들 (기존 코드와의 호환성)
        function sendMessage() {
            const input = document.getElementById('chatbotInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            chatbot.addUserMessage(message);
            input.value = '';
            input.style.height = 'auto';
            
            chatbot.processMessage(message);
        }

        function toggleLanguageMenu() {
            const menu = document.getElementById('languageMenu');
            menu.classList.toggle('show');
        }

        function selectLanguage(language) {
            if (chatbot) {
                chatbot.currentLanguage = language;
                chatbot.updateLanguageUI();
                
                const changeMessages = {
                    ko: '🇰🇷 한국어로 언어가 변경되었습니다!',
                    en: '🇺🇸 Language changed to English!',
                    ru: '🇷🇺 Язык изменен на русский!',
                    ja: '🇯🇵 言語が日本語に変更されました！'
                };
                
                chatbot.addBotMessage(changeMessages[language] || changeMessages['ko']);
                document.getElementById('languageMenu').classList.remove('show');
            }
        }

        function adjustTextareaHeight(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        function handleInputKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function handleBackNavigation(event) {
            // 뒤로가기 로직
            if (document.referrer) {
                window.history.back();
            } else {
                window.location.href = 'index.html';
            }
        }

        // 🎯 관리자 패널 열기 (간소화된 버전)
        function openAdminPanel() {
            const username = prompt("🔐 관리자 로그인\n\n아이디를 입력하세요:");
            if (username !== "phoenix") {
                alert("❌ 아이디가 틀렸습니다.");
                return;
            }
            
            const password = prompt("비밀번호를 입력하세요:");
            if (password !== "phoenix") {
                alert("❌ 비밀번호가 틀렸습니다.");
                return;
            }
            
            console.log('✅ 관리자 로그인 성공');
            document.getElementById('chatbotAdminPage').style.display = 'block';
            
            // 관리자 페이지 이벤트 리스너 설정
            setTimeout(() => {
                setupAdminEventListeners();
            }, 100);
        }

        // 관리자 페이지 닫기
        function closeChatbotAdmin() {
            console.log('AI 챗봇 관리 페이지 닫기');
            document.getElementById('chatbotAdminPage').style.display = 'none';
        }

        // 관리자 페이지 이벤트 리스너 설정
        function setupAdminEventListeners() {
            console.log('🔧 관리자 페이지 이벤트 리스너 설정 시작');
            
            // API 설정 저장 버튼
            const saveApiBtn = document.getElementById('saveApiBtn');
            if (saveApiBtn) {
                saveApiBtn.addEventListener('click', function() {
                    try {
                        console.log('💾 API 설정 저장 시작');
                        
                        // 입력 필드에서 값 가져오기
                        const chatgptApiKey = document.getElementById('chatgptApiKey');
                        const chatgptModel = document.getElementById('chatgptModel');
                        const chatgptFinetuningModel = document.getElementById('chatgptFinetuningModel');
                        const geminiApiKey = document.getElementById('geminiApiKey');
                        const geminiModel = document.getElementById('geminiModel');
                        const claudeApiKey = document.getElementById('claudeApiKey');
                        const claudeModel = document.getElementById('claudeModel');
                        
                        if (!chatgptApiKey || !chatgptModel || !geminiApiKey || !geminiModel || !claudeApiKey || !claudeModel) {
                            throw new Error('필수 입력 필드를 찾을 수 없습니다.');
                        }
                        
                        const settings = {
                            chatgpt: {
                                enabled: chatgptApiKey.value.trim() !== '',
                                apiKey: chatgptApiKey.value.trim(),
                                model: chatgptModel.value,
                                finetuningModel: chatgptFinetuningModel ? chatgptFinetuningModel.value : ''
                            },
                            gemini: {
                                enabled: geminiApiKey.value.trim() !== '',
                                apiKey: geminiApiKey.value.trim(),
                                model: geminiModel.value
                            },
                            claude: {
                                enabled: claudeApiKey.value.trim() !== '',
                                apiKey: claudeApiKey.value.trim(),
                                model: claudeModel.value
                            }
                        };
                        
                        localStorage.setItem('chatbotApiSettings', JSON.stringify(settings));
                        console.log('✅ API 설정 저장 완료:', settings);
                        
                        // 상태 메시지 업데이트
                        const statusDiv = document.getElementById('apiStatus');
                        if (statusDiv) {
                            statusDiv.innerHTML = '<div style="color: green; padding: 10px; background: #d4edda; border-radius: 5px; margin-top: 10px;">✅ API 설정이 저장되었습니다!</div>';
                        }
                        
                        // 챗봇 인스턴스 업데이트
                        if (window.chatbot) {
                            window.chatbot.loadApiSettings();
                            window.chatbot.updateApiStatusDisplay();
                            console.log('✅ 챗봇 API 설정 업데이트 완료');
                        }
                        
                        // 성공 알림
                        alert('✅ API 설정이 성공적으로 저장되었습니다!');
                        
                    } catch (error) {
                        console.error('❌ API 설정 저장 실패:', error);
                        alert('❌ API 설정 저장에 실패했습니다: ' + error.message);
                    }
                });
                console.log('✅ API 설정 저장 버튼 이벤트 리스너 추가 완료');
            }

                    // API 연결 테스트 버튼
            const testApiBtn = document.getElementById('testApiBtn');
            if (testApiBtn) {
                testApiBtn.addEventListener('click', function() {
                    try {
                        console.log('🔗 API 연결 테스트 시작');
                        
                        const statusDiv = document.getElementById('apiStatus');
                        if (statusDiv) {
                            statusDiv.innerHTML = '<div style="color: #856404; padding: 10px; background: #fff3cd; border-radius: 5px; margin-top: 10px;">🔄 API 연결을 테스트하고 있습니다...</div>';
                        }
                        
                        setTimeout(() => {
                            try {
                                const settings = JSON.parse(localStorage.getItem('chatbotApiSettings') || '{}');
                                let activeApis = [];
                                
                                if (settings.chatgpt?.enabled && settings.chatgpt?.apiKey) activeApis.push('ChatGPT');
                                if (settings.gemini?.enabled && settings.gemini?.apiKey) activeApis.push('Gemini');
                                if (settings.claude?.enabled && settings.claude?.apiKey) activeApis.push('Claude');
                                
                                console.log('🔍 활성화된 API:', activeApis);
                                
                                if (activeApis.length > 0) {
                                    const successMessage = `✅ 연결 성공! 활성화된 API: ${activeApis.join(', ')}`;
                                    if (statusDiv) {
                                        statusDiv.innerHTML = `<div style="color: green; padding: 10px; background: #d4edda; border-radius: 5px; margin-top: 10px;">${successMessage}</div>`;
                                    }
                                    alert(successMessage);
                                    
                                    // 챗봇 인스턴스 업데이트
                                    if (window.chatbot) {
                                        window.chatbot.loadApiSettings();
                                        window.chatbot.updateApiStatusDisplay();
                                    }
                                } else {
                                    const errorMessage = '❌ 활성화된 API가 없습니다. API 키를 입력해주세요.';
                                    if (statusDiv) {
                                        statusDiv.innerHTML = `<div style="color: #721c24; padding: 10px; background: #f8d7da; border-radius: 5px; margin-top: 10px;">${errorMessage}</div>`;
                                    }
                                    alert(errorMessage);
                                }
                            } catch (error) {
                                console.error('❌ API 연결 테스트 중 오류:', error);
                                const errorMessage = '❌ API 연결 테스트 중 오류가 발생했습니다.';
                                if (statusDiv) {
                                    statusDiv.innerHTML = `<div style="color: #721c24; padding: 10px; background: #f8d7da; border-radius: 5px; margin-top: 10px;">${errorMessage}</div>`;
                                }
                                alert(errorMessage);
                            }
                        }, 1000);
                        
                    } catch (error) {
                        console.error('❌ API 연결 테스트 실패:', error);
                        alert('❌ API 연결 테스트에 실패했습니다. 다시 시도해주세요.');
                    }
                });
                console.log('✅ API 연결 테스트 버튼 이벤트 리스너 추가 완료');
            }

            // API 설정 초기화 버튼
            const resetApiBtn = document.getElementById('resetApiBtn');
            if (resetApiBtn) {
                resetApiBtn.addEventListener('click', function() {
                    try {
                        if (confirm('정말로 모든 API 설정을 초기화하시겠습니까?')) {
                            console.log('🔄 API 설정 초기화 시작');
                            
                            // 입력 필드 초기화
                            const fields = [
                                'chatgptApiKey', 'chatgptModel', 'chatgptFinetuningModel',
                                'geminiApiKey', 'geminiModel',
                                'claudeApiKey', 'claudeModel'
                            ];
                            
                            fields.forEach(fieldId => {
                                const element = document.getElementById(fieldId);
                                if (element) {
                                    element.value = '';
                                }
                            });
                            
                            // Finetuning 그룹 숨기기
                            const finetuningGroup = document.getElementById('chatgptFinetuningGroup');
                            if (finetuningGroup) {
                                finetuningGroup.style.display = 'none';
                            }
                            
                            // 로컬 스토리지에서 설정 제거
                            localStorage.removeItem('chatbotApiSettings');
                            console.log('✅ API 설정 초기화 완료');
                            
                            // 상태 메시지 업데이트
                            const statusDiv = document.getElementById('apiStatus');
                            if (statusDiv) {
                                statusDiv.innerHTML = '<div style="color: #856404; padding: 10px; background: #fff3cd; border-radius: 5px; margin-top: 10px;">🔄 API 설정이 초기화되었습니다.</div>';
                            }
                            
                            // 챗봇 인스턴스 업데이트
                            if (window.chatbot) {
                                window.chatbot.loadApiSettings();
                                window.chatbot.updateApiStatusDisplay();
                                console.log('✅ 챗봇 API 설정 초기화 완료');
                            }
                            
                            alert('✅ API 설정이 성공적으로 초기화되었습니다!');
                        }
                    } catch (error) {
                        console.error('❌ API 설정 초기화 실패:', error);
                        alert('❌ API 설정 초기화에 실패했습니다. 다시 시도해주세요.');
                    }
                });
                console.log('✅ API 설정 초기화 버튼 이벤트 리스너 추가 완료');
            }

            // ChatGPT 모델 선택 이벤트
            const chatgptModel = document.getElementById('chatgptModel');
            if (chatgptModel) {
                chatgptModel.addEventListener('change', function() {
                    const finetuningGroup = document.getElementById('chatgptFinetuningGroup');
                    if (finetuningGroup) {
                        if (this.value === 'finetuning') {
                            finetuningGroup.style.display = 'block';
                        } else {
                            finetuningGroup.style.display = 'none';
                        }
                    }
                });
                console.log('✅ ChatGPT 모델 선택 이벤트 리스너 추가 완료');
            }

            // 파일 업로드 이벤트
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.addEventListener('change', function(event) {
                    const files = event.target.files;
                    const fileList = document.getElementById('fileList');
                    
                    for (let file of files) {
                        if (file.type === 'text/plain' || file.name.endsWith('.txt')) {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                const content = e.target.result;
                                processKnowledgeFile(file.name, content);
                            };
                            reader.readAsText(file);
                        }
                    }
                });
                console.log('✅ 파일 업로드 이벤트 리스너 추가 완료');
            }

            // 파일 드래그 앤 드롭 이벤트
            const uploadArea = document.getElementById('uploadArea');
            if (uploadArea) {
                // 클릭 이벤트
                uploadArea.addEventListener('click', function() {
                    document.getElementById('fileInput').click();
                });
                
                // 드래그 오버 이벤트
                uploadArea.addEventListener('dragover', function(event) {
                    event.preventDefault();
                    this.style.borderColor = '#4facfe';
                });
                
                // 드래그 리브 이벤트
                uploadArea.addEventListener('dragleave', function(event) {
                    event.preventDefault();
                    this.style.borderColor = '#ddd';
                });
                
                // 드롭 이벤트
                uploadArea.addEventListener('drop', function(event) {
                    event.preventDefault();
                    this.style.borderColor = '#ddd';
                    
                    const files = event.dataTransfer.files;
                    const fileList = document.getElementById('fileList');
                    
                    for (let file of files) {
                        if (file.type === 'text/plain' || file.name.endsWith('.txt')) {
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                const content = e.target.result;
                                processKnowledgeFile(file.name, content);
                            };
                            reader.readAsText(file);
                        }
                    }
                });
                console.log('✅ 파일 드래그 앤 드롭 이벤트 리스너 추가 완료');
            }

            // 지식 파일 처리 함수
            function processKnowledgeFile(filename, content) {
                const fileList = document.getElementById('fileList');
                const fileDiv = document.createElement('div');
                fileDiv.className = 'file-item';
                fileDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 5px; margin-bottom: 10px;">
                        <div>
                            <strong>📄 ${filename}</strong>
                            <div style="font-size: 12px; color: #666;">크기: ${(content.length / 1024).toFixed(2)} KB</div>
                        </div>
                        <button onclick="this.parentElement.remove(); updateKnowledgeStatus();" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">삭제</button>
                    </div>
                `;
                fileList.appendChild(fileDiv);
                
                // Q&A 파싱
                const qaList = parseQAFromContent(content);
                if (qaList.length > 0) {
                    const knowledgeData = JSON.parse(localStorage.getItem('chatbotKnowledgeBase') || '{"enabled": false, "files": [], "parsedData": []}');
                    knowledgeData.parsedData = knowledgeData.parsedData.concat(qaList);
                    localStorage.setItem('chatbotKnowledgeBase', JSON.stringify(knowledgeData));
                }
                
                updateKnowledgeStatus();
            }

            // Q&A 파싱 함수
            function parseQAFromContent(content) {
                const lines = content.split('\n');
                const qaList = [];
                let currentQ = '';
                let currentA = '';
                
                for (let line of lines) {
                    line = line.trim();
                    if (line.startsWith('Q:') || line.startsWith('Q.') || line.startsWith('질문:')) {
                        if (currentQ && currentA) {
                            qaList.push({ question: currentQ, answer: currentA });
                        }
                        currentQ = line.replace(/^Q[:.]\s*|^질문:\s*/, '');
                        currentA = '';
                    } else if (line.startsWith('A:') || line.startsWith('A.') || line.startsWith('답변:')) {
                        currentA = line.replace(/^A[:.]\s*|^답변:\s*/, '');
                    } else if (currentA) {
                        currentA += ' ' + line;
                    } else if (currentQ) {
                        currentQ += ' ' + line;
                    }
                }
                
                if (currentQ && currentA) {
                    qaList.push({ question: currentQ, answer: currentA });
                }
                
                return qaList;
            }

            // 지식 상태 업데이트 함수
            function updateKnowledgeStatus() {
                const fileItems = document.querySelectorAll('.file-item');
                const knowledgeData = JSON.parse(localStorage.getItem('chatbotKnowledgeBase') || '{"enabled": false, "files": [], "parsedData": []}');
                
                const statusDiv = document.getElementById('knowledgeStatus');
                if (statusDiv) {
                    statusDiv.innerHTML = `📖 업로드된 지식 파일: ${fileItems.length}개 | 파싱된 Q&A: ${knowledgeData.parsedData.length}개 | 상태: ${knowledgeData.enabled ? '활성' : '비활성'}`;
                }
            }

            // 지식 설정 저장 버튼
            const saveKnowledgeBtn = document.getElementById('saveKnowledgeBtn');
            if (saveKnowledgeBtn) {
                saveKnowledgeBtn.addEventListener('click', function() {
                    const fileItems = document.querySelectorAll('.file-item');
                    const knowledgeData = JSON.parse(localStorage.getItem('chatbotKnowledgeBase') || '{"enabled": false, "files": [], "parsedData": []}');
                    
                    knowledgeData.enabled = fileItems.length > 0;
                    knowledgeData.files = Array.from(fileItems).map(item => item.querySelector('strong').textContent.replace('📄 ', ''));
                    
                    localStorage.setItem('chatbotKnowledgeBase', JSON.stringify(knowledgeData));
                    
                    const statusDiv = document.getElementById('knowledgeSettingsStatus');
                    if (statusDiv) {
                        statusDiv.innerHTML = '<div style="color: green; padding: 10px; background: #d4edda; border-radius: 5px; margin-top: 10px;">✅ 지식 설정이 저장되었습니다!</div>';
                    }
                    
                    if (window.chatbot) {
                        window.chatbot.loadKnowledgeBaseSettings();
                    }
                    
                    alert('✅ 지식 설정이 성공적으로 저장되었습니다!');
                });
                console.log('✅ 지식 설정 저장 버튼 이벤트 리스너 추가 완료');
            }

            // 지식 검색 테스트 버튼
            const testKnowledgeBtn = document.getElementById('testKnowledgeBtn');
            if (testKnowledgeBtn) {
                testKnowledgeBtn.addEventListener('click', function() {
                    const testQuery = prompt('검색할 질문을 입력하세요:');
                    if (!testQuery) return;
                    
                    const knowledgeData = JSON.parse(localStorage.getItem('chatbotKnowledgeBase') || '{"enabled": false, "files": [], "parsedData": []}');
                    
                    if (!knowledgeData.enabled || knowledgeData.parsedData.length === 0) {
                        alert('활성화된 지식베이스가 없습니다.');
                        return;
                    }
                    
                    const result = searchInKnowledgeBase(testQuery, knowledgeData.parsedData);
                    if (result) {
                        alert(`검색 결과:\n\nQ: ${result.question}\n\nA: ${result.answer}`);
                    } else {
                        alert('관련 답변을 찾을 수 없습니다.');
                    }
                });
                console.log('✅ 지식 검색 테스트 버튼 이벤트 리스너 추가 완료');
            }

            // 지식베이스 검색 함수
            function searchInKnowledgeBase(query, parsedData) {
                const normalizedQuery = query.toLowerCase().trim();
                let bestMatch = null;
                let bestScore = 0;
                
                for (const qa of parsedData) {
                    const question = qa.question.toLowerCase();
                    const answer = qa.answer.toLowerCase();
                    
                    let score = 0;
                    
                    if (question === normalizedQuery) score += 1000;
                    if (question.includes(normalizedQuery) || normalizedQuery.includes(question)) score += 500;
                    
                    const queryWords = normalizedQuery.split(/\s+/).filter(w => w.length > 1);
                    for (const word of queryWords) {
                        if (question.includes(word)) score += 100;
                        if (answer.includes(word)) score += 50;
                    }
                    
                    if (score > bestScore) {
                        bestScore = score;
                        bestMatch = qa;
                    }
                }
                
                return bestScore >= 50 ? bestMatch : null;
            }

            // 파싱된 데이터 보기 버튼
            const showParsedDataBtn = document.getElementById('showParsedDataBtn');
            if (showParsedDataBtn) {
                showParsedDataBtn.addEventListener('click', function() {
                    const knowledgeData = JSON.parse(localStorage.getItem('chatbotKnowledgeBase') || '{"enabled": false, "files": [], "parsedData": []}');
                    const viewDiv = document.getElementById('parsedDataView');
                    const contentDiv = document.getElementById('parsedDataContent');
                    
                    if (viewDiv && contentDiv) {
                        if (knowledgeData.parsedData.length === 0) {
                            contentDiv.innerHTML = '<p style="color: #666;">파싱된 Q&A 데이터가 없습니다.</p>';
                        } else {
                            let html = '';
                            knowledgeData.parsedData.forEach((qa, index) => {
                                html += `
                                    <div style="border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 5px;">
                                        <div style="font-weight: bold; color: #2c3e50; margin-bottom: 8px;">Q${index + 1}: ${qa.question}</div>
                                        <div style="color: #666;">A: ${qa.answer}</div>
                                    </div>
                                `;
                            });
                            contentDiv.innerHTML = html;
                        }
                        
                        viewDiv.style.display = viewDiv.style.display === 'none' ? 'block' : 'none';
                    }
                });
                console.log('✅ 파싱된 데이터 보기 버튼 이벤트 리스너 추가 완료');
            }

            // 모든 지식 삭제 버튼
            const clearKnowledgeBtn = document.getElementById('clearKnowledgeBtn');
            if (clearKnowledgeBtn) {
                clearKnowledgeBtn.addEventListener('click', function() {
                    if (confirm('정말로 모든 지식 데이터를 삭제하시겠습니까?')) {
                        const fileList = document.getElementById('fileList');
                        if (fileList) {
                            fileList.innerHTML = '';
                        }
                        localStorage.removeItem('chatbotKnowledgeBase');
                        updateKnowledgeStatus();
                        
                        const statusDiv = document.getElementById('knowledgeSettingsStatus');
                        if (statusDiv) {
                            statusDiv.innerHTML = '<div style="color: #856404; padding: 10px; background: #fff3cd; border-radius: 5px; margin-top: 10px;">🔄 모든 지식 데이터가 삭제되었습니다.</div>';
                        }
                        
                        if (window.chatbot) {
                            window.chatbot.loadKnowledgeBaseSettings();
                        }
                        
                        alert('✅ 모든 지식 데이터가 성공적으로 삭제되었습니다!');
                    }
                });
                console.log('✅ 모든 지식 삭제 버튼 이벤트 리스너 추가 완료');
            }
            
            console.log('✅ 관리자 페이지 이벤트 리스너 설정 완료');
        }

        // 페이지 로드 시 설정 로드
        document.addEventListener('DOMContentLoaded', function() {
            try {
                console.log('📋 관리자 페이지 설정 로드 시작');
                
                // 기존 설정 로드
                const apiSettings = JSON.parse(localStorage.getItem('chatbotApiSettings') || '{}');
                
                // ChatGPT 설정 로드
                if (apiSettings.chatgpt) {
                    const chatgptApiKey = document.getElementById('chatgptApiKey');
                    const chatgptModel = document.getElementById('chatgptModel');
                    const chatgptFinetuningModel = document.getElementById('chatgptFinetuningModel');
                    
                    if (chatgptApiKey) chatgptApiKey.value = apiSettings.chatgpt.apiKey || '';
                    if (chatgptModel) chatgptModel.value = apiSettings.chatgpt.model || '';
                    if (chatgptFinetuningModel) chatgptFinetuningModel.value = apiSettings.chatgpt.finetuningModel || '';
                    
                    // Finetuning 모델이 선택된 경우 그룹 표시
                    if (apiSettings.chatgpt.model === 'finetuning') {
                        const finetuningGroup = document.getElementById('chatgptFinetuningGroup');
                        if (finetuningGroup) {
                            finetuningGroup.style.display = 'block';
                        }
                    }
                }
                
                // Gemini 설정 로드
                if (apiSettings.gemini) {
                    const geminiApiKey = document.getElementById('geminiApiKey');
                    const geminiModel = document.getElementById('geminiModel');
                    
                    if (geminiApiKey) geminiApiKey.value = apiSettings.gemini.apiKey || '';
                    if (geminiModel) geminiModel.value = apiSettings.gemini.model || '';
                }
                
                // Claude 설정 로드
                if (apiSettings.claude) {
                    const claudeApiKey = document.getElementById('claudeApiKey');
                    const claudeModel = document.getElementById('claudeModel');
                    
                    if (claudeApiKey) claudeApiKey.value = apiSettings.claude.apiKey || '';
                    if (claudeModel) claudeModel.value = apiSettings.claude.model || '';
                }
                
                if (window.updateKnowledgeStatus) {
                    window.updateKnowledgeStatus();
                }
                console.log('✅ 관리자 페이지 설정 로드 완료');
                
            } catch (error) {
                console.error('❌ 관리자 페이지 설정 로드 실패:', error);
            }
        });

        console.log('✅ 피닉스 치과 AI 챗봇 초기화 완료 (최적화 버전)');
    </script>

    <!-- AI 챗봇 관리 페이지 -->
    <div class="popup-page" id="chatbotAdminPage" style="display: none;">
        <div class="admin-header">
            <div class="admin-title">🤖 AI 챗봇 관리 시스템</div>
            <div class="admin-nav">
                <button class="nav-btn" onclick="closeChatbotAdmin()">🏠 메인으로</button>
                <button class="nav-btn logout" onclick="closeChatbotAdmin()">로그아웃</button>
            </div>
        </div>
        
        <div class="admin-content">
            <!-- AI 모델 API 설정 -->
            <div class="admin-section">
                <div class="section-header">
                    <h3>🤖 챗봇 AI 모델 연결하기</h3>
                </div>
                
                <div class="api-form">
                    <!-- ChatGPT 설정 -->
                    <div class="form-group">
                        <label for="chatgptApiKey">ChatGPT API Key</label>
                        <input type="password" id="chatgptApiKey" placeholder="sk-proj-...">
                    </div>
                    <div class="form-group">
                        <label for="chatgptModel">ChatGPT 모델선택</label>
                        <select id="chatgptModel">
                            <option value="">-- ChatGPT 모델을 선택하세요 --</option>
                            <option value="gpt-4o">GPT-4o (최신 멀티모달)</option>
                            <option value="gpt-4o-mini">GPT-4o Mini (경제적)</option>
                            <option value="finetuning">Finetuning Model (커스텀 모델)</option>
                        </select>
                    </div>
                    <div class="form-group" id="chatgptFinetuningGroup" style="display: none;">
                        <label for="chatgptFinetuningModel">Finetuning 모델명 입력</label>
                        <input type="text" id="chatgptFinetuningModel" placeholder="ft:gpt-4o-mini-2024-07-18:...">
                    </div>

                    <!-- Gemini 설정 -->
                    <div class="form-group" style="margin-top: 25px;">
                        <label for="geminiApiKey">Gemini 모델 API Key</label>
                        <input type="password" id="geminiApiKey" placeholder="AIza...">
                    </div>
                    <div class="form-group">
                        <label for="geminiModel">Gemini 모델선택</label>
                        <select id="geminiModel">
                            <option value="">-- Gemini 모델을 선택하세요 --</option>
                            <option value="gemini-1.5-flash">Gemini 1.5 Flash (빠른 응답)</option>
                            <option value="gemini-1.5-pro">Gemini 1.5 Pro (고성능)</option>
                            <option value="gemini-1.0-pro">Gemini 1.0 Pro (안정성)</option>
                        </select>
                    </div>

                    <!-- Claude 설정 -->
                    <div class="form-group" style="margin-top: 25px;">
                        <label for="claudeApiKey">Claude 모델 API Key</label>
                        <input type="password" id="claudeApiKey" placeholder="sk-ant-...">
                    </div>
                    <div class="form-group">
                        <label for="claudeModel">Claude 모델선택</label>
                        <select id="claudeModel">
                            <option value="">-- Claude 모델을 선택하세요 --</option>
                            <option value="claude-3-haiku">Claude 3 Haiku (빠르고 효율적)</option>
                            <option value="claude-3-sonnet">Claude 3 Sonnet (균형적 성능)</option>
                            <option value="claude-3-opus">Claude 3 Opus (최고 성능)</option>
                            <option value="claude-3-5-sonnet">Claude 3.5 Sonnet (최신 모델)</option>
                        </select>
                    </div>

                    <div class="btn-group" style="margin-top: 30px;">
                        <button class="btn btn-primary" id="saveApiBtn">💾 설정 저장</button>
                        <button class="btn btn-success" id="testApiBtn">🔗 연결 테스트</button>
                        <button class="btn btn-danger" id="resetApiBtn">🔄 설정 초기화</button>
                    </div>
                    <div id="apiStatus" class="status-message"></div>
                </div>
            </div>

            <!-- AI 지식 파일 업로드 -->
            <div class="admin-section">
                <div class="section-header">
                    <h3>📚 AI 지식 파일 업로드</h3>
                </div>
                
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">📁</div>
                    <div class="upload-text">클릭하거나 파일을 여기로 드래그하세요</div>
                    <div class="upload-types">💡 <strong>지원 형식: 텍스트 파일(.txt)</strong><br>
                    <small style="color: #666;">※ PDF, Excel 파일은 내용을 복사해서 텍스트 파일로 저장 후 업로드해주세요</small></div>
                </div>
                <input type="file" id="fileInput" class="file-input" accept=".txt" multiple>
                
                <div class="file-list" id="fileList">
                    <!-- 업로드된 파일들이 여기에 표시됩니다 -->
                </div>
                
                <div id="knowledgeStatus" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px; font-size: 14px;">
                    📖 업로드된 지식 파일: 0개 | 상태: 비활성
                </div>
                
                <!-- 지식 파일 설정 저장 버튼 -->
                <div class="btn-group" style="margin-top: 20px;">
                    <button class="btn btn-success" id="saveKnowledgeBtn">💾 지식 파일 설정 저장</button>
                    <button class="btn btn-primary" id="testKnowledgeBtn">🔍 지식 검색 테스트</button>
                    <button class="btn" style="background: #17a2b8; color: white;" id="showParsedDataBtn">📋 파싱된 Q&A 보기</button>
                    <button class="btn btn-danger" id="clearKnowledgeBtn">🗑️ 모든 지식 삭제</button>
                </div>
                <div id="knowledgeSettingsStatus" class="status-message"></div>
                
                <!-- 파싱된 Q&A 표시 영역 -->
                <div id="parsedDataView" style="display: none; margin-top: 20px; background: white; border-radius: 10px; padding: 20px; max-height: 400px; overflow-y: auto; border: 1px solid #ddd;">
                    <h4 style="margin-bottom: 15px; color: #2c3e50;">📋 파싱된 Q&A 데이터</h4>
                    <div id="parsedDataContent"></div>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* 관리자 페이지 스타일 */
        .popup-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .admin-header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-title {
            font-size: 24px;
            font-weight: bold;
        }

        .admin-nav {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .nav-btn:hover {
            background: #2980b9;
        }

        .nav-btn.logout {
            background: #e74c3c;
        }

        .nav-btn.logout:hover {
            background: #c0392b;
        }

        .admin-content {
            padding: 30px;
            max-width: 1200px;
            margin: 0 auto;
            max-height: 80vh;
            overflow-y: auto;
        }

        .admin-section {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-header h3 {
            margin: 0;
            color: #2c3e50;
            font-size: 20px;
        }

        /* API 설정 스타일 */
        .api-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4facfe;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }

        .btn-primary {
            background: #4facfe;
            color: white;
        }

        .btn-primary:hover {
            background: #3d8bfe;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        /* 파일 업로드 스타일 */
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9fa;
        }

        .upload-area:hover {
            border-color: #4facfe;
            background: #f0f8ff;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .upload-types {
            font-size: 14px;
            color: #666;
        }

        .file-input {
            display: none;
        }

        .file-list {
            margin-top: 20px;
        }

        .file-item {
            margin-bottom: 10px;
        }

        .status-message {
            margin-top: 15px;
        }

        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .admin-content {
                padding: 15px;
                max-height: 90vh;
            }
            
            .admin-section {
                padding: 15px;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .upload-area {
                padding: 20px;
            }
            
            .upload-icon {
                font-size: 36px;
            }
            
            .upload-text {
                font-size: 16px;
            }
        }
    </style>
</body>
</html>